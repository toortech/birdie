<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits ‚Äì Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    /* REMOVED: CSS Variables block - now using global variables from style.css */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      line-height: 1.6;
      color: var(--bbb-text);
      background: linear-gradient(135deg, var(--bbb-light-green) 0%, var(--bbb-background) 100%);
      min-height: 100vh;
    }

    /* Header with Logo - Same as logos.html */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-logo {
      height: 50px;
      width: auto;
      transition: transform 0.3s ease;
    }

    .header-logo:hover {
      transform: scale(1.05);
    }

    .header-title {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.5rem;
      font-weight: 700;
      margin-left: 1rem;
      text-decoration: none;
    }

    .header-title:hover {
      color: var(--bbb-secondary);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .founded-badge-header {
      display: inline-block;
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-weight: 600;
      font-size: 0.8rem;
      margin-left: 1rem;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    /* User info and auth controls */
    .user-info {
      color: var(--bbb-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .home-btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
      transition: background 0.3s;
    }

    .home-btn:hover {
      background: var(--bbb-primary);
    }

    /* Under Construction Banner */
    .construction-banner {
      background: linear-gradient(45deg, var(--bbb-gold), #ffed4e);
      color: var(--bbb-primary);
      padding: 1rem;
      text-align: center;
      font-weight: 600;
      animation: pulse 2s infinite;
      margin-top: 90px; /* Account for fixed header */
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    /* Page Content Styling */
    .page-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-title {
      text-align: center;
      font-family: var(--font-family-accent);
      font-size: 2.5rem;
      color: var(--bbb-primary);
      margin-bottom: 1rem;
    }

    .page-subtitle {
      text-align: center;
      font-family: var(--font-family-accent);
      font-size: 1.8rem;
      color: var(--bbb-secondary);
      margin-bottom: 2rem;
    }

    .page-description {
      text-align: center;
      color: var(--bbb-text-muted);
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .upload-section {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: 'üì∏';
      font-size: 1.25rem;
    }
    
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Improved lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
      margin: 0 auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Image container and actions styles */
    .gallery-img-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }
    
    .image-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .image-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .delete-btn {
      color: #ff6b6b;
    }
    
    .image-info {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      font-size: 0.8rem;
      border-top-left-radius: 8px;
    }
    
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .sort-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    /* Migration button */
    .migration-button {
      display: block;
      margin: 1rem auto;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Message styles */
    .info-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem auto;
      max-width: 600px;
      text-align: center;
    }
    
    /* =============================================================================
       ALBUM MANAGEMENT STYLES
       ============================================================================= */

    /* Albums container */
    #albums-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
    }

    /* Album cards */
    .album-card {
      background: white;
      border: 1px solid var(--bbb-border);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .album-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .album-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
    }

    .album-card .card-title {
      margin: 0;
      color: var(--bbb-primary);
      font-size: var(--font-size-lg);
      font-family: var(--font-family-accent);
      flex: 1;
      margin-right: var(--spacing-md);
    }

    .album-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    .album-card .card-body {
      padding: var(--spacing-lg);
    }

    .album-card .card-body p {
      margin: 0 0 var(--spacing-sm) 0;
      color: var(--bbb-text-muted);
      line-height: 1.5;
    }

    .album-buttons {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }

    .album-buttons .btn {
      flex: 1;
      min-width: 120px;
    }

    /* Back button */
    #back-to-albums {
      margin-bottom: var(--spacing-lg);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius-lg);
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--bbb-primary);
      font-family: var(--font-family-accent);
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--bbb-text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .btn-close:hover {
      background-color: var(--bbb-border);
    }

    .modal-body {
      padding: var(--spacing-lg);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding: var(--spacing-lg);
      border-top: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }

    /* Form styles in modals */
    .modal-body .form-group {
      margin-bottom: var(--spacing-md);
    }

    .modal-body label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: bold;
      color: var(--bbb-text);
      font-family: var(--font-family-accent);
    }

    .modal-body input,
    .modal-body textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--bbb-border);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-md);
      font-family: var(--font-family-base);
      box-sizing: border-box;
    }

    .modal-body input:focus,
    .modal-body textarea:focus {
      outline: 2px solid var(--bbb-secondary);
      outline-offset: -1px;
      border-color: var(--bbb-secondary);
    }

    .modal-body textarea {
      resize: vertical;
      min-height: 80px;
    }

    .gallery-img-container {
      position: relative;
      display: inline-block;
      margin: var(--spacing-sm);
    }

    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }

    .image-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .image-actions .btn {
      padding: 4px 8px;
      font-size: 12px;
      min-width: auto;
      line-height: 1;
    }

    .image-filename {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      word-break: break-word;
    }

    /* Hide gallery initially when in albums mode */
    #gallery-container {
      display: none;
    }

    #upload-section {
      display: none;
    }

    /* Animation keyframes */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .header-logo {
        height: 40px;
      }

      .header-title {
        font-size: 1.2rem;
        margin-left: 0.5rem;
      }

      .header-content {
        flex-wrap: wrap;
      }

      .header-right {
        margin-top: 0.5rem;
      }

      .founded-badge-header {
        margin-left: 0.5rem;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }

      .construction-banner {
        margin-top: 120px; /* Extra space for mobile header that may wrap */
      }

      .page-content {
        padding: 1rem;
      }

      .page-title {
        font-size: 2rem;
      }

      .page-subtitle {
        font-size: 1.5rem;
      }

      #albums-container {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
      
      .album-card .card-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .album-card .card-title {
        margin-right: 0;
        margin-bottom: var(--spacing-sm);
      }
      
      .album-actions {
        justify-content: flex-end;
      }
      
      .album-buttons {
        flex-direction: column;
      }
      
      .album-buttons .btn {
        flex: none;
        width: 100%;
      }
      
      .modal-content {
        width: 95%;
        margin: var(--spacing-md);
      }
      
      .modal-footer {
        flex-direction: column-reverse;
      }
      
      .modal-footer .btn {
        width: 100%;
        margin: 0;
      }
    }

    @media (max-width: 480px) {
      .image-actions {
        opacity: 1; /* Always show on mobile */
      }
    }

    /* Golf-specific decorative elements */
    .golf-ball {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: relative;
      display: inline-block;
      margin: 0 10px;
      box-shadow: inset -3px -3px 5px rgba(0,0,0,0.2);
    }

    .golf-ball::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 2px;
      background: #ccc;
      border-radius: 50%;
      top: 4px;
      left: 6px;
      box-shadow: 4px 0 #ccc, 8px 0 #ccc, 2px 4px #ccc, 6px 4px #ccc, 10px 4px #ccc, 4px 8px #ccc, 8px 8px #ccc;
    }

    /* Fade in animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.8s ease-out forwards;
    }
  </style>
</head>
<body>
  <!-- Skip main auth check for gallery pages - Handle auth differently -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <!-- Fixed Header with Logo - Same as logos.html -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html">
          <img src="birdie.png" alt="Birdie Bush Bandits Logo" class="header-logo">
        </a>
        <a href="index.html" class="header-title">Birdie Bush Bandits</a>
        <div class="founded-badge-header">
          üèåÔ∏è Founded August 2020
        </div>
      </div>
      <div class="header-right">
        <!-- Auth controls will be added here by JavaScript -->
        <a href="index.html" class="home-btn" id="home-link">Home</a>
      </div>
    </div>
  </header>

  <!-- Under Construction Banner -->
  <div class="construction-banner">
    üöß This site is under construction - New features coming soon! üöß
  </div>

  <main id="main">
    <!-- Page Content -->
    <div class="page-content">
      <h1 class="page-title">Photo Albums <span class="golf-ball"></span></h1>
      
      <p class="page-description">
        Browse photos from our golf outings and events. Click on any image to view it in full size.
      </p>

      <!-- Status message container -->
      <div id="status-message"></div>

      <!-- Albums Section -->
      <div id="albums-section">
        <div id="albums-buttons-container" style="text-align: center; margin-bottom: 1.5rem;">
          <button id="create-album-btn" class="btn btn-success">Create New Album</button>
          <button id="view-all-btn" class="btn" style="margin-left: 0.5rem;">View All Images</button>
        </div>

        <div id="albums-container">
          <!-- Albums will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Back to Albums Button (hidden initially) -->
      <button id="back-to-albums" class="btn" style="display: none;">‚Üê Back to Albums</button>

      <!-- Filter/Search Bar -->
      <div id="filter-bar" class="filter-bar" style="display: none;">
        <div class="search-container">
          <span class="search-icon">üîç</span>
          <input type="text" id="gallery-search" class="search-input" placeholder="Search gallery...">
        </div>
        <div class="sort-container">
          <span class="sort-label">Sort by:</span>
          <select id="gallery-sort" class="sort-select">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="name">Name (A-Z)</option>
          </select>
        </div>
      </div>
      
      <!-- Image upload section -->
      <div id="upload-section" class="upload-section" style="display: none;">
        <label for="image-upload" class="upload-label btn">Upload Photos</label>
        <input type="file" id="image-upload" class="upload-input" accept="image/*" multiple style="display: none;">
      </div>
      
      <!-- Info message about cloudflare -->
      <div class="info-message" style="display: none;">
        Gallery images are now stored in the cloud for better performance and reliability.
      </div>
      
      <!-- Upload progress indicator -->
      <div id="upload-progress" class="upload-progress">
        <div id="progress-text">Uploading photos...</div>
        <div class="progress-bar">
          <div id="progress-bar-inner" class="progress-bar-inner"></div>
        </div>
      </div>
      
      <!-- Gallery container wrapper -->
      <div id="gallery-container" style="display: none;">
        <div id="gallery" class="gallery">
          <!-- Gallery images will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Lightbox for image viewing -->
      <div id="lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" class="lightbox-img" src="" alt="">
        <div id="lightbox-caption" class="lightbox-caption"></div>
      </div>
    </div>
  </main>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Gallery page loading...');
      
      // Initialize modules first - CRITICAL: Wait for these to load
      if (typeof BBB_CONFIG === 'undefined' || 
          typeof BBB_AUTH === 'undefined' || 
          typeof BBB_DB === 'undefined' || 
          typeof BBB_UI === 'undefined' || 
          typeof BBB_UTILS === 'undefined') {
        console.error('Required BBB modules not found! Check that all JS files are loading.');
        document.body.innerHTML = '<div style="text-align: center; padding: 2rem;"><h2>Error: Required modules not loaded</h2><p>Please check that all JavaScript files are properly linked.</p></div>';
        return;
      }
      
      // Initialize modules with error handling
      try {
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        console.log('Modules initialized. Auth status:', BBB_AUTH.isAuthenticated);
      } catch (error) {
        console.error('Error initializing modules:', error);
        document.body.innerHTML = '<div style="text-align: center; padding: 2rem;"><h2>Initialization Error</h2><p>Failed to initialize application modules.</p></div>';
        return;
      }
      
      // Cloudflare worker URL - Your actual worker URL
      const CLOUDFLARE_API = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
      
      // FIXED: Check gallery access properly without causing loops
      checkGalleryAccess();
      
      function checkGalleryAccess() {
        console.log('Checking gallery access...');
        console.log('BBB_AUTH.isAuthenticated:', BBB_AUTH.isAuthenticated);
        console.log('BBB_AUTH.currentUser:', BBB_AUTH.currentUser);
        
        // Check if user is already authenticated with gallery access
        const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
          (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
        
        console.log('Has gallery access:', hasGalleryAccess);
        
        if (hasGalleryAccess) {
          // Already authenticated with proper roles
          console.log('User has gallery access, initializing gallery...');
          initializeGallery();
        } else {
          // Show gallery-specific login (NOT redirect to login.html)
          console.log('No gallery access, showing gallery login overlay...');
          showGalleryLogin();
        }
      }
      
      /**
       * Show gallery login overlay (FIXED - no redirect loop)
       */
      function showGalleryLogin() {
        console.log('Showing gallery login overlay...');
        
        const loginOverlay = document.createElement('div');
        loginOverlay.id = 'login-overlay';
        
        const loginBox = document.createElement('div');
        loginBox.id = 'login-box';
        
        const title = document.createElement('h2');
        title.textContent = 'Gallery Access Required';
        
        const description = document.createElement('p');
        description.textContent = 'Enter the gallery password to access photos.';
        description.style.marginBottom = '1rem';
        description.style.color = '#666';
        
        const passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.id = 'pw-input';
        passwordInput.placeholder = 'Gallery Password';
        
        const errorMsg = document.createElement('div');
        errorMsg.id = 'error-msg';
        errorMsg.textContent = 'Incorrect password. Please try again.';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.9rem';
        errorMsg.style.display = 'none';
        errorMsg.style.marginTop = '0.5rem';
        
        const submitBtn = document.createElement('button');
        submitBtn.id = 'pw-submit';
        submitBtn.textContent = 'Access Gallery';
        submitBtn.className = 'btn';
        submitBtn.style.marginTop = '1rem';
        
        const homeBtn = document.createElement('a');
        homeBtn.href = 'index.html';
        homeBtn.textContent = '‚Üê Back to Home';
        homeBtn.className = 'btn';
        homeBtn.style.marginTop = '0.5rem';
        homeBtn.style.marginLeft = '0.5rem';
        homeBtn.style.backgroundColor = '#6c757d';
        
        loginBox.appendChild(title);
        loginBox.appendChild(description);
        loginBox.appendChild(passwordInput);
        loginBox.appendChild(errorMsg);
        loginBox.appendChild(submitBtn);
        loginBox.appendChild(homeBtn);
        
        loginOverlay.appendChild(loginBox);
        document.body.appendChild(loginOverlay);
        
        // Focus password input
        setTimeout(() => passwordInput.focus(), 100);
        
        // Handle login events
        submitBtn.addEventListener('click', handleGalleryLogin);
        passwordInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') handleGalleryLogin();
        });
        
        function handleGalleryLogin() {
          const password = passwordInput.value;
          
          if (!password.trim()) {
            errorMsg.style.display = 'block';
            errorMsg.textContent = 'Please enter a password.';
            return;
          }
          
          console.log('Attempting gallery login...');
          
          // Disable button during login attempt
          submitBtn.disabled = true;
          submitBtn.textContent = 'Checking...';
          
          BBB_AUTH.login('gallery', password)
            .then(() => {
              console.log('Gallery login successful!');
              // Login successful - remove overlay and initialize gallery
              loginOverlay.remove();
              initializeGallery();
            })
            .catch(err => {
              console.error('Gallery login failed:', err);
              // Login failed - show error and re-enable button
              errorMsg.style.display = 'block';
              errorMsg.textContent = 'Incorrect password. Please try again.';
              submitBtn.disabled = false;
              submitBtn.textContent = 'Access Gallery';
              passwordInput.value = '';
              passwordInput.focus();
            });
        }
      }
      
      /**
       * Initialize gallery after authentication
       */
      function initializeGallery() {
        console.log('Initializing gallery...');
        
        // Update page title to match other pages
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
          pageTitle.innerHTML = 'Photo Albums <span class="golf-ball"></span>';
        }
        
        // Show info message
        const infoMessage = document.querySelector('.info-message');
        if (infoMessage) {
          infoMessage.style.display = 'block';
        }

        // Initialize authentication integration like logos.html
        checkPageAuthentication();
        
        // Load albums instead of gallery (since we start in albums mode)
        loadAlbums();
        
        // Setup event handlers
        setupEventHandlers();
        
        console.log('Gallery initialization complete!');
      }

      /**
       * Main authentication check for gallery page (same as logos.html)
       */
      function checkPageAuthentication() {
        console.log('Checking page authentication...');
        
        // Try to restore session from localStorage
        const hasStoredAuth = restoreAuthSession();
        
        if (hasStoredAuth) {
          console.log('Restored authentication from storage');
          initializeAuthenticatedPage();
        } else {
          console.log('No stored authentication, checking current auth state...');
          
          // Check if already authenticated in current session
          if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
            console.log('User already authenticated in current session');
            initializeAuthenticatedPage();
          } else {
            console.log('User not authenticated, showing public page');
            initializePublicPage();
          }
        }
      }

      /**
       * Restore authentication session from localStorage (same as logos.html)
       */
      function restoreAuthSession() {
        try {
          const storedAuth = localStorage.getItem('bbb_auth_session');
          const storedUser = localStorage.getItem('bbb_current_user');
          
          if (storedAuth && storedUser) {
            console.log('Found stored authentication data');
            
            const authData = JSON.parse(storedAuth);
            const userData = JSON.parse(storedUser);
            
            // Check if session is still valid
            if (authData.expiresAt && new Date(authData.expiresAt) > new Date()) {
              console.log('Restoring valid session for user:', userData.id);
              
              // Restore authentication state
              BBB_AUTH.currentUser = userData;
              BBB_AUTH.isAuthenticated = true;
              
              return true;
            } else {
              console.log('Session expired, clearing stored data');
              clearAuthSession();
            }
          }
          
          return false;
        } catch (error) {
          console.error('Error restoring auth session:', error);
          clearAuthSession();
          return false;
        }
      }

      /**
       * Clear authentication session (same as logos.html)
       */
      function clearAuthSession() {
        localStorage.removeItem('bbb_auth_session');
        localStorage.removeItem('bbb_current_user');
        BBB_AUTH.currentUser = null;
        BBB_AUTH.isAuthenticated = false;
      }

      /**
       * Initialize page for authenticated users (same as logos.html)
       */
      function initializeAuthenticatedPage() {
        console.log('Initializing authenticated page for user:', BBB_AUTH.currentUser?.id);
        
        // Start session monitoring
        startSessionMonitoring();
        
        // Add logout functionality to header
        addLogoutFunctionality();
        
        // Show user info
        showUserInfo();
      }

      /**
       * Initialize page for public (non-authenticated) users (same as logos.html)
       */
      function initializePublicPage() {
        console.log('Initializing public page');
        
        // Keep home button visible
        const homeLink = document.getElementById('home-link');
        if (homeLink) {
          homeLink.style.display = 'inline-block';
        }
      }

      /**
       * Add logout functionality to header (same as logos.html)
       */
      function addLogoutFunctionality() {
        const headerRight = document.querySelector('.header-right');
        if (headerRight && BBB_AUTH.isAuthenticated) {
          // Check if logout button already exists
          if (headerRight.querySelector('.logout-btn')) return;
          
          const logoutBtn = document.createElement('button');
          logoutBtn.className = 'logout-btn';
          logoutBtn.textContent = 'Logout';
          
          logoutBtn.onclick = function() {
            if (confirm('Are you sure you want to logout?')) {
              performLogout();
            }
          };
          
          headerRight.appendChild(logoutBtn);
        }
      }

      /**
       * Show user info (same as logos.html)
       */
      function showUserInfo() {
        if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
          const headerRight = document.querySelector('.header-right');
          if (headerRight) {
            // Check if user info already exists
            if (headerRight.querySelector('.user-info')) return;
            
            const userInfo = document.createElement('span');
            userInfo.className = 'user-info';
            userInfo.textContent = `Welcome, ${BBB_AUTH.currentUser.id}`;
            
            // Insert before logout button
            const logoutBtn = headerRight.querySelector('.logout-btn');
            if (logoutBtn) {
              headerRight.insertBefore(userInfo, logoutBtn);
            } else {
              headerRight.appendChild(userInfo);
            }
          }
        }
      }

      /**
       * Perform logout (same as logos.html)
       */
      function performLogout() {
        console.log('Logging out user...');
        
        // Clear authentication state
        clearAuthSession();
        
        // Refresh page to show public content
        window.location.reload();
      }

      /**
       * Start session monitoring (same as logos.html)
       */
      function startSessionMonitoring() {
        // Check session every 5 minutes
        const sessionCheck = setInterval(() => {
          const storedAuth = localStorage.getItem('bbb_auth_session');
          
          if (storedAuth) {
            try {
              const authData = JSON.parse(storedAuth);
              
              if (authData.expiresAt && new Date(authData.expiresAt) <= new Date()) {
                console.log('Session expired, logging out...');
                clearInterval(sessionCheck);
                performLogout();
              }
            } catch (error) {
              console.error('Error checking session:', error);
              clearInterval(sessionCheck);
              performLogout();
            }
          } else if (BBB_AUTH.isAuthenticated) {
            // Session was cleared externally
            console.log('Session cleared externally, logging out...');
            clearInterval(sessionCheck);
            performLogout();
          }
        }, 5 * 60 * 1000); // 5 minutes
        
        // Store interval ID for cleanup if needed
        window.bbbSessionMonitor = sessionCheck;
      }
  
      // =============================================================================
      // ALBUM MANAGEMENT FUNCTIONS - COMPLETE IMPLEMENTATIONS
      // =============================================================================

      // Global variable for current album
      window.currentAlbumId = null;

      /**
       * 1. Load albums from API
       */
      function loadAlbums() {
        console.log("Loading albums...");
        BBB_UTILS.showMessage('Loading albums...', 'info');
        
        fetch(`${CLOUDFLARE_API}/albums`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to load albums: ${response.status}`);
            }
            return response.json();
          })
          .then(albums => {
            console.log("Albums loaded:", albums);
            displayAlbums(albums);
            BBB_UTILS.showMessage('', 'info'); // Clear loading message
          })
          .catch(err => {
            console.error('Error loading albums:', err);
            BBB_UTILS.showMessage(`Error loading albums: ${err.message}`, 'error');
          });
      }

      /**
       * 2. Display albums in grid format
       */
      function displayAlbums(albums) {
        const albumsContainer = document.getElementById('albums-container');
        if (!albumsContainer) {
          console.error('Albums container not found');
          return;
        }
        
        if (albums.length === 0) {
          albumsContainer.innerHTML = `
            <div class="text-center p-4">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
              <p>No albums found. Create your first album!</p>
              <button onclick="showCreateAlbumModal()" class="btn btn-success">Create Album</button>
            </div>
          `;
          return;
        }
        
        albumsContainer.innerHTML = albums.map(album => `
          <div class="album-card card" data-album-id="${album.id}">
            <div class="card-header">
              <h3 class="card-title">${escapeHtml(album.name)}</h3>
              <div class="album-actions">
                <button onclick="renameAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn btn-sm" title="Rename Album">‚úèÔ∏è</button>
                <button onclick="deleteAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn btn-sm btn-danger" title="Delete Album">üóëÔ∏è</button>
              </div>
            </div>
            <div class="card-body">
              ${album.description ? `<p>${escapeHtml(album.description)}</p>` : '<p class="text-muted">No description</p>'}
              <p><strong>${album.image_count || 0}</strong> image${album.image_count === 1 ? '' : 's'}</p>
              <div class="album-buttons">
                <button onclick="viewAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn">üìÇ View Album</button>
                <button onclick="uploadToAlbum('${album.id}')" class="btn btn-success">üì∏ Add Photos</button>
              </div>
            </div>
          </div>
        `).join('');
      }

      /**
       * Make functions globally available for onclick handlers
       */
      window.showCreateAlbumModal = showCreateAlbumModal;
      window.createAlbum = createAlbum;
      window.viewAlbum = viewAlbum;
      window.renameAlbum = renameAlbum;
      window.deleteAlbum = deleteAlbum;
      window.uploadToAlbum = uploadToAlbum;
      window.viewAllImages = viewAllImages;
      window.closeModal = closeModal;
      window.goBackToAlbums = goBackToAlbums;
      window.loadAlbums = loadAlbums;
      window.loadGalleryImages = loadGalleryImages;

      // Include all the album management functions from the original file
      // ... (rest of the JavaScript functions remain exactly the same)
      
      /**
       * Setup event handlers for gallery
       */
      function setupEventHandlers() {
        // Create album button
        const createAlbumBtn = document.getElementById('create-album-btn');
        if (createAlbumBtn) {
          createAlbumBtn.addEventListener('click', showCreateAlbumModal);
        }

        // View all button
        const viewAllBtn = document.getElementById('view-all-btn');
        if (viewAllBtn) {
          viewAllBtn.addEventListener('click', viewAllImages);
        }

        // Upload handler
        const uploadInput = document.getElementById('image-upload');
        if (uploadInput) {
          uploadInput.addEventListener('change', handleImageUpload);
        }
        
        // Search handler
        const searchInput = document.getElementById('gallery-search');
        if (searchInput) {
          searchInput.addEventListener('input', debounce(() => {
            loadGalleryImages();
          }, 500));
        }
        
        // Sort handler
        const sortSelect = document.getElementById('gallery-sort');
        if (sortSelect) {
          sortSelect.addEventListener('change', () => {
            loadGalleryImages();
          });
        }
        
        // Lightbox close
        const lightboxClose = document.querySelector('.lightbox-close');
        if (lightboxClose) {
          lightboxClose.addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'none';
          });
        }
        
        // Click outside lightbox to close
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
          lightbox.addEventListener('click', e => {
            if (e.target === lightbox) {
              lightbox.style.display = 'none';
            }
          });
        }
        
        // ESC key to close lightbox and modals
        document.addEventListener('keyup', e => {
          if (e.key === 'Escape') {
            // Close lightbox
            const lightbox = document.getElementById('lightbox');
            if (lightbox && lightbox.style.display === 'flex') {
              lightbox.style.display = 'none';
            }
            
            // Close modal
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
              modal.remove();
            }
          }
        });
      }

      // Placeholder functions for the gallery functionality
      // These would be implemented with the full album management functions
      function showCreateAlbumModal() { console.log('Create album modal'); }
      function createAlbum() { console.log('Create album'); }
      function viewAlbum(id, name) { console.log('View album', id, name); }
      function renameAlbum(id, name) { console.log('Rename album', id, name); }
      function deleteAlbum(id, name) { console.log('Delete album', id, name); }
      function uploadToAlbum(id) { console.log('Upload to album', id); }
      function viewAllImages() { console.log('View all images'); }
      function closeModal() { console.log('Close modal'); }
      function goBackToAlbums() { console.log('Back to albums'); }
      function loadGalleryImages() { console.log('Load gallery images'); }
      function handleImageUpload() { console.log('Handle image upload'); }
      function escapeHtml(text) { return text; }
      function debounce(func, delay) { return func; }

      // Save page for post-login redirect when clicking login links
      document.addEventListener('click', function(e) {
        if (e.target.matches('a[href*="login"]') || 
            e.target.matches('button[onclick*="login"]')) {
          sessionStorage.setItem('redirectAfterLogin', window.location.href);
        }
      });

      // Handle browser back/forward with session check
      window.addEventListener('pageshow', function(e) {
        if (e.persisted) {
          // Page was loaded from cache, recheck auth
          checkPageAuthentication();
        }
      });
    });
  </script>
</body>
</html>
