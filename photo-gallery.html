<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .upload-section {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: 'ðŸ“¸';
      font-size: 1.25rem;
    }
    
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Enhanced lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
      z-index: 1002;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .lightbox-nav {
      position: absolute;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
    }
    
    .nav-btn {
      color: white;
      font-size: 3rem;
      opacity: 0.7;
      cursor: pointer;
      padding: 20px;
      transition: opacity 0.3s, transform 0.2s;
      background: none;
      border: none;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    .nav-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .prev-btn {
      margin-left: 20px;
    }
    
    .next-btn {
      margin-right: 20px;
    }
    
    .image-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background-color: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .gallery-tools {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .gallery-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .gallery-filter select {
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .error-container {
      padding: 1rem;
      background-color: #f8d7da;
      color: #721c24;
      border-radius: 4px;
      margin: 1rem 0;
      display: none;
    }
    
    .error-list {
      margin-top: 0.5rem;
      padding-left: 1rem;
    }
    
    @media (max-width: 480px) {
      .nav-btn {
        font-size: 2rem;
        padding: 10px;
      }
      
      .prev-btn {
        margin-left: 5px;
      }
      
      .next-btn {
        margin-right: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>
  
  <!-- Rest of your page content -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    // Main Gallery Application
    const BBB_GALLERY = (function() {
      // Private variables
      let allImages = [];
      let currentImageIndex = 0;
      
      // Gallery configuration
      const config = {
        itemsPerPage: 24,
        lazyLoad: true,
        sortOrder: 'newest'
      };
      
      /**
       * Initialize the gallery
       */
      function init() {
        // Initialize modules
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        // Check if the user has access to the gallery
        const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
          (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
        
        if (!hasGalleryAccess) {
          // Not authorized - redirect to login
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.href = 'login.html';
          return;
        }
        
        // User is authenticated, initialize the gallery
        createGalleryUI();
        
        // Load gallery images
        loadGalleryImages()
          .then(() => {
            // Check if we need to migrate images from localStorage
            return migrateLocalStorageImages();
          })
          .catch(error => {
            console.error('Gallery initialization error:', error);
            showErrorMessage('Failed to initialize gallery. Please try refreshing the page.');
          });
      }
      
      /**
       * Create the main gallery UI elements
       */
      function createGalleryUI() {
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.textContent = 'Photo Gallery';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
        mainContent.appendChild(description);
        
        // Error container for displaying errors
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-container';
        errorContainer.id = 'error-container';
        
        const errorTitle = document.createElement('strong');
        errorTitle.id = 'error-title';
        errorTitle.textContent = 'Error';
        
        const errorList = document.createElement('ul');
        errorList.className = 'error-list';
        errorList.id = 'error-list';
        
        errorContainer.appendChild(errorTitle);
        errorContainer.appendChild(errorList);
        mainContent.appendChild(errorContainer);
        
        // Gallery tools section (filter, sort)
        const galleryTools = document.createElement('div');
        galleryTools.className = 'gallery-tools';
        
        // Upload button
        const uploadSection = document.createElement('div');
        uploadSection.className = 'upload-section';
        
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        
        // Sort options
        const sortFilter = document.createElement('div');
        sortFilter.className = 'gallery-filter';
        
        const sortLabel = document.createElement('label');
        sortLabel.htmlFor = 'sort-select';
        sortLabel.textContent = 'Sort by:';
        
        const sortSelect = document.createElement('select');
        sortSelect.id = 'sort-select';
        
        const sortOptions = [
          { value: 'newest', text: 'Newest first' },
          { value: 'oldest', text: 'Oldest first' }
        ];
        
        sortOptions.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = option.value;
          optionEl.textContent = option.text;
          sortSelect.appendChild(optionEl);
        });
        
        sortFilter.appendChild(sortLabel);
        sortFilter.appendChild(sortSelect);
        
        galleryTools.appendChild(uploadSection);
        galleryTools.appendChild(sortFilter);
        mainContent.appendChild(galleryTools);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';
        mainContent.appendChild(galleryContainer);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        // Lightbox close button
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        // Lightbox navigation
        const lightboxNav = document.createElement('div');
        lightboxNav.className = 'lightbox-nav';
        
        const prevBtn = document.createElement('button');
        prevBtn.className = 'nav-btn prev-btn';
        prevBtn.innerHTML = '&#10094;';
        prevBtn.setAttribute('aria-label', 'Previous image');
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'nav-btn next-btn';
        nextBtn.innerHTML = '&#10095;';
        nextBtn.setAttribute('aria-label', 'Next image');
        
        lightboxNav.appendChild(prevBtn);
        lightboxNav.appendChild(nextBtn);
        
        // Image counter
        const imageCounter = document.createElement('div');
        imageCounter.className = 'image-counter';
        imageCounter.id = 'image-counter';
        
        // Lightbox image
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        // Lightbox caption
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        // Add lightbox elements
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxNav);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        lightbox.appendChild(imageCounter);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Add event listeners
        setupEventHandlers();
      }
      
      /**
       * Set up all event handlers for the gallery
       */
      function setupEventHandlers() {
        // Upload handler
        const uploadInput = document.getElementById('image-upload');
        if (uploadInput) {
          uploadInput.addEventListener('change', handleImageUpload);
        }
        
        // Lightbox close button
        const lightboxClose = document.querySelector('.lightbox-close');
        if (lightboxClose) {
          lightboxClose.addEventListener('click', closeLightbox);
        }
        
        // Lightbox navigation buttons
        const prevBtn = document.querySelector('.prev-btn');
        if (prevBtn) {
          prevBtn.addEventListener('click', showPreviousImage);
        }
        
        const nextBtn = document.querySelector('.next-btn');
        if (nextBtn) {
          nextBtn.addEventListener('click', showNextImage);
        }
        
        // Sort select
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
          sortSelect.addEventListener('change', handleSortChange);
        }
        
        // Click outside lightbox to close
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
          lightbox.addEventListener('click', e => {
            if (e.target === lightbox) {
              closeLightbox();
            }
          });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', handleKeyboardNavigation);
      }
      
      /**
       * Handle keyboard navigation for lightbox
       * @param {KeyboardEvent} e - Keyboard event
       */
      function handleKeyboardNavigation(e) {
        const lightbox = document.getElementById('lightbox');
        if (!lightbox || lightbox.style.display !== 'flex') return;
        
        switch (e.key) {
          case 'Escape':
            closeLightbox();
            break;
          case 'ArrowLeft':
            showPreviousImage();
            break;
          case 'ArrowRight':
            showNextImage();
            break;
        }
      }
      
      /**
       * Handle sort option change
       * @param {Event} e - Change event
       */
      function handleSortChange(e) {
        const sortOrder = e.target.value;
        config.sortOrder = sortOrder;
        
        // Sort and render images
        sortImages();
        renderGallery(allImages);
      }
      
      /**
       * Sort images based on current sort order
       */
      function sortImages() {
        if (!allImages || !allImages.length) return;
        
        allImages.sort((a, b) => {
          const dateA = new Date(a.uploadedAt || 0);
          const dateB = new Date(b.uploadedAt || 0);
          
          if (config.sortOrder === 'newest') {
            return dateB - dateA;
          } else {
            return dateA - dateB;
          }
        });
      }
      
      /**
       * Load gallery images from database and preloaded sources
       * @returns {Promise} - Promise that resolves when images are loaded
       */
      function loadGalleryImages() {
        return new Promise((resolve, reject) => {
          // First load from database
          BBB_DB.getGalleryImages()
            .then(galleryData => {
              const dbImages = galleryData.images || [];
              
              // Add preloaded images (from original site)
              const preloadedImages = [
                { 
                  id: 'pre_1', 
                  src: 'images/photo1.jpg', 
                  alt: 'Band on the green',
                  uploadedAt: new Date('2020-08-01').toISOString()
                },
                { 
                  id: 'pre_2', 
                  src: 'images/photo2.jpg', 
                  alt: 'Group shot',
                  uploadedAt: new Date('2020-08-02').toISOString()
                },
                { 
                  id: 'pre_3', 
                  src: 'images/photo3.jpg', 
                  alt: 'Trophy presentation',
                  uploadedAt: new Date('2020-08-03').toISOString()
                },
                { 
                  id: 'pre_4', 
                  src: 'images/photo4.jpg', 
                  alt: 'Action shot',
                  uploadedAt: new Date('2020-08-04').toISOString()
                }
              ];
              
              // Merge database images with preloaded images
              allImages = [...preloadedImages, ...dbImages];
              
              // Sort images
              sortImages();
              
              // Render gallery
              renderGallery(allImages);
              
              resolve();
            })
            .catch(err => {
              console.error('Error loading gallery images:', err);
              showErrorMessage('Error loading gallery images. Please try again.');
              
              // Still try to render preloaded images
              const preloadedImages = [
                { 
                  id: 'pre_1', 
                  src: 'images/photo1.jpg', 
                  alt: 'Band on the green',
                  uploadedAt: new Date('2020-08-01').toISOString()
                },
                { 
                  id: 'pre_2', 
                  src: 'images/photo2.jpg', 
                  alt: 'Group shot',
                  uploadedAt: new Date('2020-08-02').toISOString()
                },
                { 
                  id: 'pre_3', 
                  src: 'images/photo3.jpg', 
                  alt: 'Trophy presentation',
                  uploadedAt: new Date('2020-08-03').toISOString()
                },
                { 
                  id: 'pre_4', 
                  src: 'images/photo4.jpg', 
                  alt: 'Action shot',
                  uploadedAt: new Date('2020-08-04').toISOString()
                }
              ];
              
              allImages = preloadedImages;
              renderGallery(allImages);
              
              reject(err);
            });
        });
      }
      
      /**
       * Render gallery with images
       * @param {Array} images - Array of image objects
       */
      function renderGallery(images) {
        const galleryElement = document.getElementById('gallery');
        if (!galleryElement) return;
        
        galleryElement.innerHTML = '';
        
        // Create gallery
        if (images && images.length > 0) {
          images.forEach((image, index) => {
            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || 'Gallery image';
            img.className = 'gallery-img';
            img.dataset.id = image.id;
            img.dataset.index = index;
            
            if (config.lazyLoad) {
              img.setAttribute('loading', 'lazy');
            }
            
            // Add click handler for lightbox
            img.addEventListener('click', () => {
              openLightbox(index);
            });
            
            galleryElement.appendChild(img);
          });
        } else {
          // If no images, show message
          const noImages = document.createElement('div');
          noImages.className = 'empty-gallery';
          
          const noImagesIcon = document.createElement('div');
          noImagesIcon.innerHTML = 'ðŸ“·';
          noImagesIcon.style.fontSize = '3rem';
          noImagesIcon.style.marginBottom = '1rem';
          
          const noImagesText = document.createElement('p');
          noImagesText.textContent = 'No images in the gallery yet. Upload some photos to get started!';
          
          noImages.appendChild(noImagesIcon);
          noImages.appendChild(noImagesText);
          galleryElement.appendChild(noImages);
        }
      }
      
      /**
       * Open lightbox and display image at specified index
       * @param {number} index - Index of image to display
       */
      function openLightbox(index) {
        if (!allImages || !allImages.length) return;
        
        // Validate index
        if (index < 0) index = 0;
        if (index >= allImages.length) index = allImages.length - 1;
        
        currentImageIndex = index;
        
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const imageCounter = document.getElementById('image-counter');
        
        // Update image and caption
        const image = allImages[index];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        updateImageCounter();
        
        // Show lightbox
        lightbox.style.display = 'flex';
        
        // Disable scrolling on body
        document.body.style.overflow = 'hidden';
      }
      
      /**
       * Close lightbox
       */
      function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.style.display = 'none';
        
        // Re-enable scrolling
        document.body.style.overflow = '';
      }
      
      /**
       * Show next image in lightbox
       */
      function showNextImage() {
        if (!allImages || !allImages.length) return;
        
        currentImageIndex = (currentImageIndex + 1) % allImages.length;
        
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        
        // Update image and caption
        const image = allImages[currentImageIndex];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        updateImageCounter();
      }
      
      /**
       * Show previous image in lightbox
       */
      function showPreviousImage() {
        if (!allImages || !allImages.length) return;
        
        currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
        
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        
        // Update image and caption
        const image = allImages[currentImageIndex];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        updateImageCounter();
      }
      
      /**
       * Update image counter in lightbox
       */
      function updateImageCounter() {
        const imageCounter = document.getElementById('image-counter');
        if (imageCounter) {
          imageCounter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
        }
      }
      
      /**
       * Handle image upload
       * @param {Event} e - Change event
       */
      function handleImageUpload(e) {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
          return;
        }
        
        // Clear previous errors
        clearErrorMessages();
        
        // Show progress container
        const progressContainer = document.getElementById('upload-progress');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        
        progressContainer.style.display = 'block';
        progressBarInner.style.width = '0%';
        progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
        
        let uploadedCount = 0;
        const failedUploads = [];
        
        files.forEach((file, index) => {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            failedUploads.push({ file, error: `"${file.name}" is not an image file` });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Validate file size
          if (file.size > BBB_CONFIG.gallery.maxUploadSize) {
            failedUploads.push({ 
              file, 
              error: `"${file.name}" is too large (max ${BBB_CONFIG.gallery.maxUploadSize / 1000000}MB)` 
            });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Read file as data URL
          const reader = new FileReader();
          
          reader.onload = function(event) {
            const dataURL = event.target.result;
            
            // Generate unique ID
            const imageId = `img_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
            
            // Create image object
            const imageData = {
              id: imageId,
              src: dataURL,
              alt: file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo',
              uploadedAt: new Date().toISOString()
            };
            
            // Save to database
            BBB_DB.saveGalleryImage(imageData)
              .then(() => {
                uploadedCount++;
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
                  finishUploads();
                }
              })
              .catch(err => {
                console.error('Error saving image:', err);
                failedUploads.push({ file, error: `Failed to save "${file.name}"` });
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
                  finishUploads();
                }
              });
          };
          
          reader.onerror = function() {
            failedUploads.push({ file, error: `Failed to read "${file.name}"` });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            
            // Check if all uploads complete
            if (uploadedCount + failedUploads.length === files.length) {
              finishUploads();
            }
          };
          
          reader.readAsDataURL(file);
        });
        
        // Reset file input
        e.target.value = '';
        
        /**
         * Update upload progress bar
         * @param {number} total - Total number of files
         * @param {number} completed - Number of completed uploads
         */
        function updateUploadProgress(total, completed) {
          const percentage = Math.round((completed / total) * 100);
          progressBarInner.style.width = `${percentage}%`;
          progressText.textContent = `Uploading ${completed} of ${total} (${percentage}%)`;
        }
        
        /**
         * Finish the upload process
         */
        function finishUploads() {
          // Hide progress container
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 1500);
          
          // Reload gallery
          loadGalleryImages();
          
          // Show error messages for failed uploads
          if (failedUploads.length > 0) {
            const errorMessages = failedUploads.map(item => item.error);
            showErrorMessage('Some uploads failed:', errorMessages);
          }
          
          // Show status message
          if (failedUploads.length === 0) {
            if (uploadedCount > 1) {
              BBB_UTILS.showMessage(`Successfully uploaded ${uploadedCount} images`, 'success');
            } else {
              BBB_UTILS.showMessage('Image uploaded successfully', 'success');
            }
          } else {
            if (uploadedCount > 0) {
              BBB_UTILS.showMessage(`Uploaded ${uploadedCount} images, ${failedUploads.length} failed`, 'warning');
            } else {
              BBB_UTILS.showMessage(`Failed to upload ${failedUploads.length} images`, 'error');
            }
          }
        }
      }
      
      /**
       * Migrate images from localStorage (original site) to new system
       * @returns {Promise} - Promise that resolves when migration completes
       */
      function migrateLocalStorageImages() {
        return new Promise((resolve) => {
          try {
            // Check if we have already migrated
            const migrated = localStorage.getItem('bbb_gallery_migrated');
            if (migrated === 'true') {
              return resolve();
            }
            
            // Get stored images from original code
            const storedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
            
            if (storedImages.length === 0) {
              // No images to migrate
              localStorage.setItem('bbb_gallery_migrated', 'true');
              return resolve();
            }
            
            // Show migration message
            BBB_UTILS.showMessage(`Migrating ${storedImages.length} existing images...`, 'info');
            
            // Convert and save each image
            let migrationCount = 0;
            const migrationPromises = [];
            
            storedImages.forEach((dataURL, index) => {
              // Create image object
              const imageData = {
                id: `migrated_${Date.now()}_${index}`,
                src: dataURL,
                alt: 'Migrated image',
                uploadedAt: new Date().toISOString()
              };
              
              // Save to database
              migrationPromises.push(
                BBB_DB.saveGalleryImage(imageData)
                  .then(() => {
                    migrationCount++;
                  })
                  .catch(err => {
                    console.error('Error migrating image:', err);
                  })
              );
            });
            
            // Wait for all migrations to complete
            Promise.all(migrationPromises)
              .then(() => {
                // Mark as migrated
                localStorage.setItem('bbb_gallery_migrated', 'true');
                
                // Reload gallery
                loadGalleryImages();
                
                // Show status message
                BBB_UTILS.showMessage(`Successfully migrated ${migrationCount} images`, 'success');
                
                resolve();
              })
              .catch(err => {
                console.error('Error during migration:', err);
                resolve();
              });
          } catch (err) {
            console.error('Error during gallery migration:', err);
            resolve();
          }
        });
      }
      
      /**
       * Show error message in error container
       * @param {string} message - Main error message
       * @param {Array} details - Optional array of error details
       */
      function showErrorMessage(message, details) {
        const errorContainer = document.getElementById('error-container');
        const errorTitle = document.getElementById('error-title');
        const errorList = document.getElementById('error-list');
        
        if (!errorContainer || !errorTitle || !errorList) return;
        
        errorTitle.textContent = message;
        errorList.innerHTML = '';
        
        if (Array.isArray(details) && details.length > 0) {
          details.forEach(detail => {
            const listItem = document.createElement('li');
            listItem.textContent = detail;
            errorList.appendChild(listItem);
          });
          errorList.style.display = 'block';
        } else {
          errorList.style.display = 'none';
        }
        
        errorContainer.style.display = 'block';
      }
      
      /**
       * Clear error messages
       */
      function clearErrorMessages() {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
          errorContainer.style.display = 'none';
        }
      }
      
      // Public methods
      return {
        init: init
      };
    })();
    
    // Initialize gallery when document is ready
    document.addEventListener('DOMContentLoaded', function() {
      BBB_GALLERY.init();
    });
  </script>
</body>
</html>
