<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits ‚Äì Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    /* Category styling */
    .category-tile {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      height: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .category-tile:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .category-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .category-info {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 12px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      text-align: left;
    }
    
    .category-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .category-count {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    
    .category-description {
      font-size: 0.85rem;
      margin-top: 4px;
      opacity: 0.9;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* For creating a new category tile */
    .new-category-tile {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #f8f9fa;
      border: 2px dashed #ddd;
      border-radius: 8px;
      height: 200px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .new-category-tile:hover {
      background-color: #e9ecef;
      transform: translateY(-5px);
      border-color: #adb5bd;
    }
    
    .new-category-tile .plus-icon {
      font-size: 3rem;
      color: #6c757d;
      margin-bottom: 8px;
    }
    
    .new-category-tile .text {
      color: #6c757d;
      font-weight: 500;
    }
    
    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-container {
      background-color: white;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    
    .modal-overlay.active .modal-container {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      margin: 0;
      font-size: 1.5rem;
    }
    
    .modal-close {
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #6c757d;
    }
    
    .modal-body {
      margin-bottom: 24px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--bbb-secondary);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Breadcrumb navigation */
    .breadcrumb {
      display: flex;
      align-items: center;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
    }
    
    .breadcrumb-item a {
      color: var(--bbb-secondary);
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .breadcrumb-separator {
      margin: 0 8px;
      color: #adb5bd;
    }
    
    .breadcrumb-item.active {
      color: var(--bbb-text);
      font-weight: 500;
    }
    
    /* Gallery actions */
    .gallery-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .gallery-actions .left-actions,
    .gallery-actions .right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Category selector for upload */
    .category-select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      min-width: 150px;
    }
    
    /* Upload button styling */
    .upload-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
    }
    
    .upload-label::before {
      content: 'üì∏';
      font-size: 1.1rem;
    }
    
    /* Empty states */
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    .empty-category {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Enhanced lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
      z-index: 1002;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .lightbox-nav {
      position: absolute;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
    }
    
    .nav-btn {
      color: white;
      font-size: 3rem;
      opacity: 0.7;
      cursor: pointer;
      padding: 20px;
      transition: opacity 0.3s, transform 0.2s;
      background: none;
      border: none;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    .nav-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .prev-btn {
      margin-left: 20px;
    }
    
    .next-btn {
      margin-right: 20px;
    }
    
    .image-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background-color: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    
    .category-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .error-container {
      padding: 1rem;
      background-color: #f8d7da;
      color: #721c24;
      border-radius: 4px;
      margin: 1rem 0;
      display: none;
    }
    
    .error-list {
      margin-top: 0.5rem;
      padding-left: 1rem;
    }
    
    @media (max-width: 480px) {
      .gallery-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .gallery-actions .left-actions,
      .gallery-actions .right-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .nav-btn {
        font-size: 2rem;
        padding: 10px;
      }
      
      .prev-btn {
        margin-left: 5px;
      }
      
      .next-btn {
        margin-right: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>
  
  <!-- Rest of your page content -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <!-- Create Category Modal Template -->
  <div id="category-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Create New Album</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <div class="form-group">
            <label for="category-name">Album Name</label>
            <input type="text" id="category-name" class="form-control" required placeholder="e.g. Tournament June 2023">
          </div>
          <div class="form-group">
            <label for="category-description">Description (optional)</label>
            <textarea id="category-description" class="form-control" rows="3" placeholder="Describe this collection of photos"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancel-category">Cancel</button>
        <button class="btn" id="save-category">Create Album</button>
      </div>
    </div>
  </div>
  
  <script>
    // Main Gallery Application
    const BBB_GALLERY = (function() {
      // Private variables
      let allImages = [];
      let allCategories = [];
      let currentImageIndex = 0;
      let currentCategoryId = null;
      
      // Gallery configuration
      const config = {
        itemsPerPage: 24,
        lazyLoad: true,
        sortOrder: 'newest',
        defaultCategory: {
          id: 'uncategorized',
          name: 'Uncategorized',
          description: 'Photos not assigned to any album',
        }
      };
      
      /**
       * Initialize the gallery
       */
      function init() {
        // Initialize modules
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        // Check if the user has access to the gallery
        const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
          (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
        
        if (!hasGalleryAccess) {
          // Not authorized - redirect to login
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.href = 'login.html';
          return;
        }
        
        // User is authenticated, initialize the gallery
        createGalleryUI();
        
        // Check URL parameters for category view
        const urlParams = new URLSearchParams(window.location.search);
        currentCategoryId = urlParams.get('category');
        
        // Load gallery data
        loadGalleryData()
          .then(() => {
            // Display the correct view based on URL parameters
            if (currentCategoryId) {
              showCategoryView(currentCategoryId);
            } else {
              showCategoriesView();
            }
            
            // Check if we need to migrate images from localStorage
            return migrateLocalStorageImages();
          })
          .catch(error => {
            console.error('Gallery initialization error:', error);
            showErrorMessage('Failed to initialize gallery. Please try refreshing the page.');
          });
          
        // Set up event handlers for modals
        setupModalHandlers();
      }
      
      /**
       * Create the main gallery UI elements
       */
      function createGalleryUI() {
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.textContent = 'Photo Gallery';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events organized into albums. Click on any album to view the photos inside.';
        mainContent.appendChild(description);
        
        // Error container for displaying errors
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-container';
        errorContainer.id = 'error-container';
        
        const errorTitle = document.createElement('strong');
        errorTitle.id = 'error-title';
        errorTitle.textContent = 'Error';
        
        const errorList = document.createElement('ul');
        errorList.className = 'error-list';
        errorList.id = 'error-list';
        
        errorContainer.appendChild(errorTitle);
        errorContainer.appendChild(errorList);
        mainContent.appendChild(errorContainer);
        
        // Breadcrumb navigation
        const breadcrumb = document.createElement('nav');
        breadcrumb.className = 'breadcrumb';
        breadcrumb.id = 'breadcrumb';
        breadcrumb.setAttribute('aria-label', 'Breadcrumb');
        mainContent.appendChild(breadcrumb);
        
        // Gallery actions container
        const galleryActions = document.createElement('div');
        galleryActions.className = 'gallery-actions';
        galleryActions.id = 'gallery-actions';
        
        // Left actions (Create Album, Upload)
        const leftActions = document.createElement('div');
        leftActions.className = 'left-actions';
        
        // Create Album button
        const createAlbumBtn = document.createElement('button');
        createAlbumBtn.className = 'btn';
        createAlbumBtn.id = 'create-album-btn';
        createAlbumBtn.innerHTML = '<span style="margin-right: 6px;">üìÅ</span> Create Album';
        createAlbumBtn.addEventListener('click', showCreateCategoryModal);
        
        // Upload section
        const uploadSection = document.createElement('div');
        uploadSection.className = 'upload-section';
        
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        
        // Category selector (for uploads) - will be shown in category view
        const categorySelectContainer = document.createElement('div');
        categorySelectContainer.id = 'category-select-container';
        categorySelectContainer.style.display = 'none';
        
        const categorySelectLabel = document.createElement('label');
        categorySelectLabel.htmlFor = 'category-select';
        categorySelectLabel.textContent = 'Album:';
        categorySelectLabel.style.marginRight = '8px';
        
        const categorySelect = document.createElement('select');
        categorySelect.id = 'category-select';
        categorySelect.className = 'category-select';
        
        categorySelectContainer.appendChild(categorySelectLabel);
        categorySelectContainer.appendChild(categorySelect);
        
        leftActions.appendChild(createAlbumBtn);
        leftActions.appendChild(uploadSection);
        leftActions.appendChild(categorySelectContainer);
        
        // Right actions (sorting, etc.)
        const rightActions = document.createElement('div');
        rightActions.className = 'right-actions';
        
        // Sort options
        const sortFilter = document.createElement('div');
        sortFilter.className = 'gallery-filter';
        
        const sortLabel = document.createElement('label');
        sortLabel.htmlFor = 'sort-select';
        sortLabel.textContent = 'Sort by:';
        
        const sortSelect = document.createElement('select');
        sortSelect.id = 'sort-select';
        
        const sortOptions = [
          { value: 'newest', text: 'Newest first' },
          { value: 'oldest', text: 'Oldest first' },
          { value: 'name-asc', text: 'Name (A-Z)' },
          { value: 'name-desc', text: 'Name (Z-A)' }
        ];
        
        sortOptions.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = option.value;
          optionEl.textContent = option.text;
          sortSelect.appendChild(optionEl);
        });
        
        sortFilter.appendChild(sortLabel);
        sortFilter.appendChild(sortSelect);
        
        rightActions.appendChild(sortFilter);
        
        galleryActions.appendChild(leftActions);
        galleryActions.appendChild(rightActions);
        mainContent.appendChild(galleryActions);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';
        mainContent.appendChild(galleryContainer);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        // Lightbox close button
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        // Lightbox navigation
        const lightboxNav = document.createElement('div');
        lightboxNav.className = 'lightbox-nav';
        
        const prevBtn = document.createElement('button');
        prevBtn.className = 'nav-btn prev-btn';
        prevBtn.innerHTML = '&#10094;';
        prevBtn.setAttribute('aria-label', 'Previous image');
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'nav-btn next-btn';
        nextBtn.innerHTML = '&#10095;';
        nextBtn.setAttribute('aria-label', 'Next image');
        
        lightboxNav.appendChild(prevBtn);
        lightboxNav.appendChild(nextBtn);
        
        // Image counter
        const imageCounter = document.createElement('div');
        imageCounter.className = 'image-counter';
        imageCounter.id = 'image-counter';
        
        // Category badge
        const categoryBadge = document.createElement('div');
        categoryBadge.className = 'category-badge';
        categoryBadge.id = 'lightbox-category';
        
        // Lightbox image
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        // Lightbox caption
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        // Add lightbox elements
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxNav);
        lightbox.appendChild(categoryBadge);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        lightbox.appendChild(imageCounter);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Add event listeners
        setupEventHandlers();
      }
      
      /**
       * Set up all event handlers for the gallery
       */
      function setupEventHandlers() {
        // Upload handler
        const uploadInput = document.getElementById('image-upload');
        if (uploadInput) {
          uploadInput.addEventListener('change', handleImageUpload);
        }
        
        // Lightbox close button
        const lightboxClose = document.querySelector('.lightbox-close');
        if (lightboxClose) {
          lightboxClose.addEventListener('click', closeLightbox);
        }
        
        // Lightbox navigation buttons
        const prevBtn = document.querySelector('.prev-btn');
        if (prevBtn) {
          prevBtn.addEventListener('click', showPreviousImage);
        }
        
        const nextBtn = document.querySelector('.next-btn');
        if (nextBtn) {
          nextBtn.addEventListener('click', showNextImage);
        }
        
        // Sort select
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
          sortSelect.addEventListener('change', handleSortChange);
        }
        
        // Click outside lightbox to close
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
          lightbox.addEventListener('click', e => {
            if (e.target === lightbox) {
              closeLightbox();
            }
          });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', handleKeyboardNavigation);
      }
      
      /**
       * Set up event handlers for modals
       */
      function setupModalHandlers() {
        // Category modal elements
        const categoryModal = document.getElementById('category-modal');
        const closeButtons = categoryModal.querySelectorAll('.modal-close, #cancel-category');
        const saveButton = document.getElementById('save-category');
        
        // Close modal handlers
        closeButtons.forEach(button => {
          button.addEventListener('click', () => {
            categoryModal.classList.remove('active');
          });
        });
        
        // Save category handler
        saveButton.addEventListener('click', createNewCategory);
        
        // Click outside to close
        categoryModal.addEventListener('click', e => {
          if (e.target === categoryModal) {
            categoryModal.classList.remove('active');
          }
        });
        
        // Listen for escape key to close modals
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape' && categoryModal.classList.contains('active')) {
            categoryModal.classList.remove('active');
          }
        });
      }
      
      /**
       * Show the create category modal
       */
      function showCreateCategoryModal() {
        const categoryModal = document.getElementById('category-modal');
        
        // Reset form
        const form = document.getElementById('category-form');
        if (form) form.reset();
        
        // Show modal
        categoryModal.classList.add('active');
        
        // Focus first input
        const nameInput = document.getElementById('category-name');
        if (nameInput) {
          setTimeout(() => nameInput.focus(), 100);
        }
      }
      
      /**
       * Create a new category
       */
      function createNewCategory() {
        const nameInput = document.getElementById('category-name');
        const descInput = document.getElementById('category-description');
        
        if (!nameInput.value.trim()) {
          alert('Please enter an album name');
          nameInput.focus();
          return;
        }
        
        const newCategory = {
          id: 'cat_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
          name: nameInput.value.trim(),
          description: descInput.value.trim(),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Add to categories
        allCategories.push(newCategory);
        
        // Save to database
        saveGalleryData()
          .then(() => {
            // Hide modal
            const categoryModal = document.getElementById('category-modal');
            categoryModal.classList.remove('active');
            
            // Show success message
            BBB_UTILS.showMessage(`Album "${newCategory.name}" created successfully`, 'success');
            
            // Refresh categories view
            showCategoriesView();
          })
          .catch(error => {
            console.error('Error creating category:', error);
            showErrorMessage('Failed to create album. Please try again.');
          });
      }
      
      /**
       * Handle keyboard navigation for lightbox
       * @param {KeyboardEvent} e - Keyboard event
       */
      function handleKeyboardNavigation(e) {
        const lightbox = document.getElementById('lightbox');
        if (!lightbox || lightbox.style.display !== 'flex') return;
        
        switch (e.key) {
          case 'Escape':
            closeLightbox();
            break;
          case 'ArrowLeft':
            showPreviousImage();
            break;
          case 'ArrowRight':
            showNextImage();
            break;
        }
      }
      
      /**
       * Handle sort option change
       * @param {Event} e - Change event
       */
      function handleSortChange(e) {
        const sortOrder = e.target.value;
        config.sortOrder = sortOrder;
        
        // Re-render current view
        if (currentCategoryId) {
          // Sort images in current category
          sortImages();
          showCategoryView(currentCategoryId);
        } else {
          // Sort categories
          sortCategories();
          showCategoriesView();
        }
      }
      
      /**
       * Sort categories based on current sort order
       */
      function sortCategories() {
        if (!allCategories || !allCategories.length) return;
        
        allCategories.sort((a, b) => {
          switch (config.sortOrder) {
            case 'newest':
              return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            case 'oldest':
              return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
            case 'name-asc':
              return a.name.localeCompare(b.name);
            case 'name-desc':
              return b.name.localeCompare(a.name);
            default:
              return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          }
        });
      }
      
      /**
       * Sort images based on current sort order
       */
      function sortImages() {
        if (!allImages || !allImages.length) return;
        
        allImages.sort((a, b) => {
          switch (config.sortOrder) {
            case 'newest':
              return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
            case 'oldest':
              return new Date(a.uploadedAt || 0) - new Date(b.uploadedAt || 0);
            case 'name-asc':
              return a.alt.localeCompare(b.alt);
            case 'name-desc':
              return b.alt.localeCompare(a.alt);
            default:
              return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
          }
        });
      }
      
      /**
       * Load gallery data from database
       * @returns {Promise} - Promise that resolves when data is loaded
       */
      function loadGalleryData() {
        return new Promise((resolve, reject) => {
          // First load from database
          BBB_DB.getGalleryImages()
            .then(galleryData => {
              // Get images
              const dbImages = galleryData.images || [];
              
              // Add preloaded images (from original site) if we don't have any yet
              if (dbImages.length < 4) {
                const preloadedImages = [
                  { 
                    id: 'pre_1', 
                    src: 'images/photo1.jpg', 
                    alt: 'Band on the green',
                    categoryId: null,
                    uploadedAt: new Date('2020-08-01').toISOString()
                  },
                  { 
                    id: 'pre_2', 
                    src: 'images/photo2.jpg', 
                    alt: 'Group shot',
                    categoryId: null,
                    uploadedAt: new Date('2020-08-02').toISOString()
                  },
                  { 
                    id: 'pre_3', 
                    src: 'images/photo3.jpg', 
                    alt: 'Trophy presentation',
                    categoryId: null,
                    uploadedAt: new Date('2020-08-03').toISOString()
                  },
                  { 
                    id: 'pre_4', 
                    src: 'images/photo4.jpg', 
                    alt: 'Action shot',
                    categoryId: null,
                    uploadedAt: new Date('2020-08-04').toISOString()
                  }
                ];
                
                // Add preloaded images only if they don't exist
                preloadedImages.forEach(img => {
                  if (!dbImages.some(dbImg => dbImg.id === img.id)) {
                    dbImages.push(img);
                  }
                });
              }
              
              // Get categories
              const dbCategories = galleryData.categories || [];
              
              // Store data
              allImages = dbImages;
              allCategories = dbCategories;
              
              // Sort based on current settings
              sortCategories();
              sortImages();
              
              resolve();
            })
            .catch(err => {
              console.error('Error loading gallery data:', err);
              showErrorMessage('Error loading gallery data. Please try again.');
              
              // Initialize with empty arrays
              allImages = [];
              allCategories = [];
              
              reject(err);
            });
        });
      }
      
      /**
       * Save gallery data to database
       * @returns {Promise} - Promise that resolves when data is saved
       */
      function saveGalleryData() {
        return new Promise((resolve, reject) => {
          // Create gallery data object
          const galleryData = {
            images: allImages,
            categories: allCategories
          };
          
          // Save to database
          BBB_DB.save(BBB_DB.collections.GALLERY, 'images', galleryData)
            .then(() => {
              resolve();
            })
            .catch(err => {
              console.error('Error saving gallery data:', err);
              reject(err);
            });
        });
      }
      
      /**
       * Render the categories view
       */
      function showCategoriesView() {
        // Set current category to null
        currentCategoryId = null;
        
        // Update URL
        history.pushState(null, '', window.location.pathname);
        
        // Update breadcrumb
        updateBreadcrumb();
        
        // Update category selector visibility
        document.getElementById('category-select-container').style.display = 'none';
        
        // Update gallery container
        const galleryElement = document.getElementById('gallery');
        if (!galleryElement) return;
        
        galleryElement.innerHTML = '';
        
        // Create grid of category tiles
        if (allCategories && allCategories.length > 0) {
          // First add the "New Category" tile
          const newCategoryTile = createNewCategoryTile();
          galleryElement.appendChild(newCategoryTile);
          
          // Then add all user-created categories
          allCategories.forEach(category => {
            const categoryTile = createCategoryTile(category);
            galleryElement.appendChild(categoryTile);
          });
          
          // Then add the "Uncategorized" category if it has images
          const uncategorizedImages = allImages.filter(img => !img.categoryId);
          if (uncategorizedImages.length > 0) {
            const uncategorizedTile = createCategoryTile({
              id: 'uncategorized',
              name: 'Uncategorized',
              description: 'Photos not assigned to any album',
              coverImage: uncategorizedImages[0].id
            }, uncategorizedImages.length);
            
            galleryElement.appendChild(uncategorizedTile);
          }
        } else {
          // No categories, show empty state with new category button
          const emptyGallery = document.createElement('div');
          emptyGallery.className = 'empty-gallery';
          
          const icon = document.createElement('div');
          icon.innerHTML = 'üìÅ';
          icon.style.fontSize = '3rem';
          icon.style.marginBottom = '1rem';
          
          const text = document.createElement('p');
          text.textContent = 'No albums yet. Create your first album to organize your photos.';
          
          const createButton = document.createElement('button');
          createButton.className = 'btn';
          createButton.innerHTML = '<span style="margin-right: 6px;">üìÅ</span> Create Album';
          createButton.style.marginTop = '1rem';
          createButton.addEventListener('click', showCreateCategoryModal);
          
          emptyGallery.appendChild(icon);
          emptyGallery.appendChild(text);
          emptyGallery.appendChild(createButton);
          
          galleryElement.appendChild(emptyGallery);
        }
        
        // Update sort options
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
          // Update sort options for categories
          sortSelect.innerHTML = '';
          
          const categoryOptions = [
            { value: 'newest', text: 'Newest first' },
            { value: 'oldest', text: 'Oldest first' },
            { value: 'name-asc', text: 'Name (A-Z)' },
            { value: 'name-desc', text: 'Name (Z-A)' }
          ];
          
          categoryOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            sortSelect.appendChild(optionEl);
          });
          
          sortSelect.value = config.sortOrder;
        }
      }
      
      /**
       * Render the category view showing images in a category
       * @param {string} categoryId - Category ID to display
       */
      function showCategoryView(categoryId) {
        // Set current category
        currentCategoryId = categoryId;
        
        // Special case for uncategorized
        const isUncategorized = categoryId === 'uncategorized';
        
        // Find category
        let category = null;
        if (isUncategorized) {
          category = config.defaultCategory;
        } else {
          category = allCategories.find(cat => cat.id === categoryId);
        }
        
        if (!category && !isUncategorized) {
          showErrorMessage('Album not found');
          showCategoriesView();
          return;
        }
        
        // Update URL
        history.pushState(null, '', `${window.location.pathname}?category=${categoryId}`);
        
        // Update breadcrumb
        updateBreadcrumb(category);
        
        // Update category selector
        updateCategorySelector();
        document.getElementById('category-select-container').style.display = 'inline-block';
        
        // Find images in this category
        let categoryImages = [];
        if (isUncategorized) {
          categoryImages = allImages.filter(img => !img.categoryId);
        } else {
          categoryImages = allImages.filter(img => img.categoryId === categoryId);
        }
        
        // Sort images
        categoryImages.sort((a, b) => {
          switch (config.sortOrder) {
            case 'newest':
              return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
            case 'oldest':
              return new Date(a.uploadedAt || 0) - new Date(b.uploadedAt || 0);
            case 'name-asc':
              return a.alt.localeCompare(b.alt);
            case 'name-desc':
              return b.alt.localeCompare(a.alt);
            default:
              return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
          }
        });
        
        // Update gallery container
        const galleryElement = document.getElementById('gallery');
        if (!galleryElement) return;
        
        galleryElement.innerHTML = '';
        
        // Create grid of images
        if (categoryImages.length > 0) {
          categoryImages.forEach((image, index) => {
            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || 'Gallery image';
            img.className = 'gallery-img';
            img.dataset.id = image.id;
            img.dataset.index = index;
            
            if (config.lazyLoad) {
              img.setAttribute('loading', 'lazy');
            }
            
            // Add click handler for lightbox
            img.addEventListener('click', () => {
              openLightbox(index, categoryImages);
            });
            
            galleryElement.appendChild(img);
          });
        } else {
          // No images in this category
          const emptyCategory = document.createElement('div');
          emptyCategory.className = 'empty-category';
          
          const icon = document.createElement('div');
          icon.innerHTML = 'üì∑';
          icon.style.fontSize = '3rem';
          icon.style.marginBottom = '1rem';
          
          const text = document.createElement('p');
          text.textContent = `No photos in this album yet. Upload some photos to "${category.name}".`;
          
          emptyCategory.appendChild(icon);
          emptyCategory.appendChild(text);
          
          galleryElement.appendChild(emptyCategory);
        }
        
        // Update sort options
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
          // Update sort options for images
          sortSelect.innerHTML = '';
          
          const imageOptions = [
            { value: 'newest', text: 'Newest first' },
            { value: 'oldest', text: 'Oldest first' },
            { value: 'name-asc', text: 'Name (A-Z)' },
            { value: 'name-desc', text: 'Name (Z-A)' }
          ];
          
          imageOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            sortSelect.appendChild(optionEl);
          });
          
          sortSelect.value = config.sortOrder;
        }
      }
      
      /**
       * Create a new category tile
       * @returns {HTMLElement} - New category tile element
       */
      function createNewCategoryTile() {
        const tile = document.createElement('div');
        tile.className = 'new-category-tile';
        tile.addEventListener('click', showCreateCategoryModal);
        
        const plusIcon = document.createElement('div');
        plusIcon.className = 'plus-icon';
        plusIcon.textContent = '+';
        
        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = 'Create New Album';
        
        tile.appendChild(plusIcon);
        tile.appendChild(text);
        
        return tile;
      }
      
      /**
       * Create a category tile
       * @param {Object} category - Category object
       * @param {number} imageCount - Optional count of images
       * @returns {HTMLElement} - Category tile element
       */
      function createCategoryTile(category, imageCount) {
        const tile = document.createElement('div');
        tile.className = 'category-tile';
        tile.dataset.id = category.id;
        tile.addEventListener('click', () => {
          showCategoryView(category.id);
        });
        
        // Find cover image
        let coverImage = null;
        
        if (category.id === 'uncategorized') {
          // For uncategorized, find first uncategorized image
          const uncategorizedImages = allImages.filter(img => !img.categoryId);
          if (uncategorizedImages.length > 0) {
            coverImage = uncategorizedImages[0];
          }
        } else if (category.coverImage) {
          // If category has a cover image, use it
          coverImage = allImages.find(img => img.id === category.coverImage);
        } else {
          // Otherwise find first image in this category
          coverImage = allImages.find(img => img.categoryId === category.id);
        }
        
        // Create cover image
        const cover = document.createElement('img');
        cover.className = 'category-cover';
        
        if (coverImage) {
          cover.src = coverImage.src;
          cover.alt = `Cover image for ${category.name}`;
        } else {
          // Default cover if no images found
          cover.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"%3E%3Crect width="200" height="200" fill="%23f0f0f0"/%3E%3Cpath d="M100,80 L120,120 L80,120 Z" fill="%23999"/%3E%3Ccircle cx="150" cy="50" r="15" fill="%23999"/%3E%3C/svg%3E';
          cover.alt = 'Default album cover';
        }
        
        // Create info section
        const info = document.createElement('div');
        info.className = 'category-info';
        
        const title = document.createElement('h3');
        title.className = 'category-title';
        title.textContent = category.name;
        
        // Calculate image count if not provided
        if (imageCount === undefined) {
          if (category.id === 'uncategorized') {
            imageCount = allImages.filter(img => !img.categoryId).length;
          } else {
            imageCount = allImages.filter(img => img.categoryId === category.id).length;
          }
        }
        
        const count = document.createElement('div');
        count.className = 'category-count';
        count.textContent = `${imageCount} photo${imageCount !== 1 ? 's' : ''}`;
        
        info.appendChild(title);
        info.appendChild(count);
        
        // Add description if available
        if (category.description) {
          const description = document.createElement('div');
          description.className = 'category-description';
          description.textContent = category.description;
          info.appendChild(description);
        }
        
        tile.appendChild(cover);
        tile.appendChild(info);
        
        return tile;
      }
      
      /**
       * Update the breadcrumb navigation
       * @param {Object} category - Current category (if in category view)
       */
      function updateBreadcrumb(category = null) {
        const breadcrumb = document.getElementById('breadcrumb');
        if (!breadcrumb) return;
        
        breadcrumb.innerHTML = '';
        
        // Home
        const homeItem = document.createElement('div');
        homeItem.className = 'breadcrumb-item';
        
        const homeLink = document.createElement('a');
        homeLink.href = '#';
        homeLink.textContent = 'Albums';
        homeLink.addEventListener('click', e => {
          e.preventDefault();
          showCategoriesView();
        });
        
        homeItem.appendChild(homeLink);
        breadcrumb.appendChild(homeItem);
        
        // Category
        if (category) {
          // Add separator
          const separator = document.createElement('div');
          separator.className = 'breadcrumb-separator';
          separator.textContent = '/';
          breadcrumb.appendChild(separator);
          
          // Add category
          const categoryItem = document.createElement('div');
          categoryItem.className = 'breadcrumb-item active';
          categoryItem.textContent = category.name;
          breadcrumb.appendChild(categoryItem);
        }
      }
      
      /**
       * Update the category selector dropdown
       */
      function updateCategorySelector() {
        const select = document.getElementById('category-select');
        if (!select) return;
        
        select.innerHTML = '';
        
        // Add all categories
        allCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          select.appendChild(option);
        });
        
        // Add uncategorized option
        const option = document.createElement('option');
        option.value = 'uncategorized';
        option.textContent = 'Uncategorized';
        select.appendChild(option);
        
        // Set current selection
        select.value = currentCategoryId;
      }
      
      /**
       * Open lightbox and display image at specified index
       * @param {number} index - Index of image to display
       * @param {Array} images - Array of images to navigate (defaults to all images)
       */
      function openLightbox(index, images = null) {
        // Use provided images or all images
        const imageList = images || allImages;
        
        if (!imageList || !imageList.length) return;
        
        // Validate index
        if (index < 0) index = 0;
        if (index >= imageList.length) index = imageList.length - 1;
        
        currentImageIndex = index;
        
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const imageCounter = document.getElementById('image-counter');
        const categoryBadge = document.getElementById('lightbox-category');
        
        // Update image and caption
        const image = imageList[index];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        imageCounter.textContent = `${index + 1} / ${imageList.length}`;
        
        // Update category badge
        if (image.categoryId) {
          const category = allCategories.find(cat => cat.id === image.categoryId);
          if (category) {
            categoryBadge.textContent = category.name;
            categoryBadge.style.display = 'block';
          } else {
            categoryBadge.style.display = 'none';
          }
        } else {
          categoryBadge.textContent = 'Uncategorized';
          categoryBadge.style.display = 'block';
        }
        
        // Show lightbox
        lightbox.style.display = 'flex';
        
        // Disable scrolling on body
        document.body.style.overflow = 'hidden';
      }
      
      /**
       * Close lightbox
       */
      function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.style.display = 'none';
        
        // Re-enable scrolling
        document.body.style.overflow = '';
      }
      
      /**
       * Show next image in lightbox
       */
      function showNextImage() {
        let imageList;
        if (currentCategoryId) {
          if (currentCategoryId === 'uncategorized') {
            imageList = allImages.filter(img => !img.categoryId);
          } else {
            imageList = allImages.filter(img => img.categoryId === currentCategoryId);
          }
        } else {
          imageList = allImages;
        }
        
        if (!imageList || !imageList.length) return;
        
        currentImageIndex = (currentImageIndex + 1) % imageList.length;
        
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const imageCounter = document.getElementById('image-counter');
        const categoryBadge = document.getElementById('lightbox-category');
        
        // Update image and caption
        const image = imageList[currentImageIndex];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        imageCounter.textContent = `${currentImageIndex + 1} / ${imageList.length}`;
        
        // Update category badge
        if (image.categoryId) {
          const category = allCategories.find(cat => cat.id === image.categoryId);
          if (category) {
            categoryBadge.textContent = category.name;
            categoryBadge.style.display = 'block';
          } else {
            categoryBadge.style.display = 'none';
          }
        } else {
          categoryBadge.textContent = 'Uncategorized';
          categoryBadge.style.display = 'block';
        }
      }
      
      /**
       * Show previous image in lightbox
       */
      function showPreviousImage() {
        let imageList;
        if (currentCategoryId) {
          if (currentCategoryId === 'uncategorized') {
            imageList = allImages.filter(img => !img.categoryId);
          } else {
            imageList = allImages.filter(img => img.categoryId === currentCategoryId);
          }
        } else {
          imageList = allImages;
        }
        
        if (!imageList || !imageList.length) return;
        
        currentImageIndex = (currentImageIndex - 1 + imageList.length) % imageList.length;
        
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const imageCounter = document.getElementById('image-counter');
        const categoryBadge = document.getElementById('lightbox-category');
        
        // Update image and caption
        const image = imageList[currentImageIndex];
        lightboxImg.src = image.src;
        lightboxCaption.textContent = image.alt || '';
        
        // Update counter
        imageCounter.textContent = `${currentImageIndex + 1} / ${imageList.length}`;
        
        // Update category badge
        if (image.categoryId) {
          const category = allCategories.find(cat => cat.id === image.categoryId);
          if (category) {
            categoryBadge.textContent = category.name;
            categoryBadge.style.display = 'block';
          } else {
            categoryBadge.style.display = 'none';
          }
        } else {
          categoryBadge.textContent = 'Uncategorized';
          categoryBadge.style.display = 'block';
        }
      }
      
      /**
       * Handle image upload
       * @param {Event} e - Change event
       */
      function handleImageUpload(e) {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
          return;
        }
        
        // Clear previous errors
        clearErrorMessages();
        
        // Get target category ID (if in category view)
        const categoryId = currentCategoryId === 'uncategorized' ? null : currentCategoryId;
        
        // If category selector is visible, use its value
        const categorySelect = document.getElementById('category-select');
        if (categorySelect && categorySelect.style.display !== 'none') {
          const selectedCategory = categorySelect.value;
          if (selectedCategory === 'uncategorized') {
            // Special case for uncategorized
            categoryId = null;
          } else {
            categoryId = selectedCategory;
          }
        }
        
        // Show progress container
        const progressContainer = document.getElementById('upload-progress');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        
        progressContainer.style.display = 'block';
        progressBarInner.style.width = '0%';
        progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
        
        let uploadedCount = 0;
        const failedUploads = [];
        
        files.forEach((file, index) => {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            failedUploads.push({ file, error: `"${file.name}" is not an image file` });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Validate file size
          if (file.size > BBB_CONFIG.gallery.maxUploadSize) {
            failedUploads.push({ 
              file, 
              error: `"${file.name}" is too large (max ${BBB_CONFIG.gallery.maxUploadSize / 1000000}MB)` 
            });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Read file as data URL
          const reader = new FileReader();
          
          reader.onload = function(event) {
            const dataURL = event.target.result;
            
            // Generate unique ID
            const imageId = `img_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
            
            // Create image object
            const imageData = {
              id: imageId,
              src: dataURL,
              alt: file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo',
              categoryId: categoryId,
              uploadedAt: new Date().toISOString()
            };
            
            // Add to allImages
            allImages.push(imageData);
            
            uploadedCount++;
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            
            // Check if all uploads complete
            if (uploadedCount + failedUploads.length === files.length) {
              finishUploads();
            }
          };
          
          reader.onerror = function() {
            failedUploads.push({ file, error: `Failed to read "${file.name}"` });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            
            // Check if all uploads complete
            if (uploadedCount + failedUploads.length === files.length) {
              finishUploads();
            }
          };
          
          reader.readAsDataURL(file);
        });
        
        // Reset file input
        e.target.value = '';
        
        /**
         * Update upload progress bar
         * @param {number} total - Total number of files
         * @param {number} completed - Number of completed uploads
         */
        function updateUploadProgress(total, completed) {
          const percentage = Math.round((completed / total) * 100);
          progressBarInner.style.width = `${percentage}%`;
          progressText.textContent = `Uploading ${completed} of ${total} (${percentage}%)`;
        }
        
        /**
         * Finish the upload process
         */
        function finishUploads() {
          // Save to database
          saveGalleryData()
            .then(() => {
              // Hide progress container
              setTimeout(() => {
                progressContainer.style.display = 'none';
              }, 1500);
              
              // Show error messages for failed uploads
              if (failedUploads.length > 0) {
                const errorMessages = failedUploads.map(item => item.error);
                showErrorMessage('Some uploads failed:', errorMessages);
              }
              
              // Show status message
              if (failedUploads.length === 0) {
                if (uploadedCount > 1) {
                  BBB_UTILS.showMessage(`Successfully uploaded ${uploadedCount} images`, 'success');
                } else {
                  BBB_UTILS.showMessage('Image uploaded successfully', 'success');
                }
              } else {
                if (uploadedCount > 0) {
                  BBB_UTILS.showMessage(`Uploaded ${uploadedCount} images, ${failedUploads.length} failed`, 'warning');
                } else {
                  BBB_UTILS.showMessage(`Failed to upload ${failedUploads.length} images`, 'error');
                }
              }
              
              // Refresh current view
              if (currentCategoryId) {
                showCategoryView(currentCategoryId);
              } else {
                showCategoriesView();
              }
            })
            .catch(error => {
              console.error('Error saving images:', error);
              showErrorMessage('Failed to save images. Please try again.');
              
              // Hide progress container
              progressContainer.style.display = 'none';
            });
        }
      }
      
      /**
       * Migrate images from localStorage (original site) to new system
       * @returns {Promise} - Promise that resolves when migration completes
       */
      function migrateLocalStorageImages() {
        return new Promise((resolve) => {
          try {
            // Check if we have already migrated
            const migrated = localStorage.getItem('bbb_gallery_migrated');
            if (migrated === 'true') {
              return resolve();
            }
            
            // Get stored images from original code
            const storedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
            
            if (storedImages.length === 0) {
              // No images to migrate
              localStorage.setItem('bbb_gallery_migrated', 'true');
              return resolve();
            }
            
            // Show migration message
            BBB_UTILS.showMessage(`Migrating ${storedImages.length} existing images...`, 'info');
            
            // Convert and save each image
            let migrationCount = 0;
            
            storedImages.forEach((dataURL, index) => {
              // Create image object
              const imageData = {
                id: `migrated_${Date.now()}_${index}`,
                src: dataURL,
                alt: 'Migrated image',
                categoryId: null,
                uploadedAt: new Date().toISOString()
              };
              
              // Add to allImages
              allImages.push(imageData);
              migrationCount++;
            });
            
            // Save to database
            saveGalleryData()
              .then(() => {
                // Mark as migrated
                localStorage.setItem('bbb_gallery_migrated', 'true');
                
                // Refresh current view
                if (currentCategoryId) {
                  showCategoryView(currentCategoryId);
                } else {
                  showCategoriesView();
                }
                
                // Show status message
                BBB_UTILS.showMessage(`Successfully migrated ${migrationCount} images`, 'success');
                
                resolve();
              })
              .catch(err => {
                console.error('Error during migration:', err);
                resolve();
              });
          } catch (err) {
            console.error('Error during gallery migration:', err);
            resolve();
          }
        });
      }
      
      /**
       * Show error message in error container
       * @param {string} message - Main error message
       * @param {Array} details - Optional array of error details
       */
      function showErrorMessage(message, details) {
        const errorContainer = document.getElementById('error-container');
        const errorTitle = document.getElementById('error-title');
        const errorList = document.getElementById('error-list');
        
        if (!errorContainer || !errorTitle || !errorList) return;
        
        errorTitle.textContent = message;
        errorList.innerHTML = '';
        
        if (Array.isArray(details) && details.length > 0) {
          details.forEach(detail => {
            const listItem = document.createElement('li');
            listItem.textContent = detail;
            errorList.appendChild(listItem);
          });
          errorList.style.display = 'block';
        } else {
          errorList.style.display = 'none';
        }
        
        errorContainer.style.display = 'block';
      }
      
      /**
       * Clear error messages
       */
      function clearErrorMessages() {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
          errorContainer.style.display = 'none';
        }
      }
      
      // Public methods
      return {
        init: init
      };
    })();
    
    // Initialize gallery when document is ready
    document.addEventListener('DOMContentLoaded', function() {
      BBB_GALLERY.init();
    });
  </script>
</body>
</html>
