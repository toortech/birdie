<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits – Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .upload-section {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: '📸';
      font-size: 1.25rem;
    }
    
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Improved lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
      margin: 0 auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Image container and actions styles */
    .gallery-img-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }
    
    .image-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .image-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .delete-btn {
      color: #ff6b6b;
    }
    
    .image-info {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      font-size: 0.8rem;
      border-top-left-radius: 8px;
    }
    
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .sort-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    /* Migration button */
    .migration-button {
      display: block;
      margin: 1rem auto;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Message styles */
    .info-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem auto;
      max-width: 600px;
      text-align: center;
    }
    
    /* Albums section styles */
    .albums-section {
      margin: 2rem 0;
    }

    .albums-title {
      margin-bottom: 1rem;
      color: var(--bbb-primary);
      font-weight: bold;
    }

    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .album-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .album-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .album-thumbnail {
      height: 150px;
      background-color: #f0f0f0;
      background-size: cover;
      background-position: center;
    }

    .album-info {
      padding: 1rem;
    }

    .album-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .album-count {
      font-size: 0.9rem;
      color: var(--bbb-text-muted);
    }
    
    /* Album selector for photos */
    .album-selector {
      margin-top: 0.5rem;
      position: relative;
    }
    
    .album-dropdown {
      position: absolute;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .album-option {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .album-option:hover {
      background-color: #f0f0f0;
    }
    
    .album-badge {
      position: absolute;
      top: 0;
      right: 0;
      background-color: var(--bbb-primary);
      color: white;
      padding: 3px 8px;
      font-size: 0.7rem;
      border-top-right-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    /* Create album modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: bold;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
    }
    
    .modal-body {
      margin-bottom: 1.5rem;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    /* Album management */
    .album-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    /* Album menu */
    .album-menu {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .album-card:hover .album-menu {
      opacity: 1;
    }

    .album-menu-dropdown {
      position: absolute;
      top: 40px;
      right: 5px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10;
      display: none;
    }

    .album-menu-option {
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .album-menu-option:hover {
      background-color: #f0f0f0;
    }
    
    .album-menu-option.delete {
      color: #dc3545;
    }

    /* Copy url */
    .copy-url-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .copy-url-button:hover {
      background-color: rgba(255,255,255,0.2);
    }

    /* Thumbnail selector */
    .thumbnail-selector {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1200;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .thumbnail-selector-header {
      color: white;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .thumbnail-selector-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .thumbnail-selector-close {
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    .thumbnail-selector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      overflow-y: auto;
      max-height: 80vh;
      width: 100%;
      max-width: 800px;
      padding: 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .thumbnail-option {
      cursor: pointer;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .thumbnail-option:hover {
      transform: scale(1.05);
    }

    .thumbnail-option.selected {
      border-color: var(--bbb-secondary);
    }

    .thumbnail-option img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .thumbnail-selector-actions {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>
  
  <!-- Rest of your page content -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <!-- Create Album Modal -->
  <div id="create-album-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Create New Album</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="album-name">Album Name</label>
          <input type="text" id="album-name" class="search-input" placeholder="Enter album name">
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="album-description">Description (optional)</label>
          <textarea id="album-description" class="search-input" placeholder="Enter album description" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="create-album-cancel">Cancel</button>
        <button class="btn" id="create-album-submit">Create Album</button>
      </div>
    </div>
  </div>

  <!-- Edit Album Modal -->
  <div id="edit-album-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Album</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="edit-album-name">Album Name</label>
          <input type="text" id="edit-album-name" class="search-input" placeholder="Enter album name">
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="edit-album-description">Description (optional)</label>
          <textarea id="edit-album-description" class="search-input" placeholder="Enter album description" rows="3"></textarea>
        </div>
        <input type="hidden" id="edit-album-id">
      </div>
      <div class="modal-footer">
        <button class="btn" id="edit-album-cancel">Cancel</button>
        <button class="btn" id="edit-album-submit">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Thumbnail Selector Modal -->
  <div id="thumbnail-selector" class="thumbnail-selector">
    <div class="thumbnail-selector-header">
      <div class="thumbnail-selector-title">Select Album Thumbnail</div>
      <button class="thumbnail-selector-close">&times;</button>
    </div>
    <div class="thumbnail-selector-grid" id="thumbnail-selector-grid">
      <!-- Thumbnail options will be added here -->
    </div>
    <div class="thumbnail-selector-actions">
      <button class="btn" id="thumbnail-selector-confirm">Set as Album Cover</button>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modules
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Cloudflare worker URL
      const CLOUDFLARE_API = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
      
      // Default albums to initialize with
      const DEFAULT_ALBUMS = [
        { id: 'all', title: 'All Photos', description: 'All photos in the gallery', thumbnail: 'images/photo1.jpg' },
        { id: 'events', title: 'Golf Events', description: 'Photos from golf events', thumbnail: 'images/photo2.jpg' },
        { id: 'tournaments', title: 'Tournaments', description: 'Tournament photos', thumbnail: 'images/photo3.jpg' },
        { id: 'members', title: 'Member Photos', description: 'Photos of our members', thumbnail: 'images/photo4.jpg' }
      ];
      
      // Default fallback images if API fails
      const DEFAULT_IMAGES = [
        { id: 'pre_1', src: 'images/photo1.jpg', alt: 'Band on the green', uploaded_at: '2023-06-15T12:30:00Z', uploaded_by: 'admin' },
        { id: 'pre_2', src: 'images/photo2.jpg', alt: 'Group shot', uploaded_at: '2023-06-20T14:45:00Z', uploaded_by: 'admin' },
        { id: 'pre_3', src: 'images/photo3.jpg', alt: 'Trophy presentation', uploaded_at: '2023-07-05T10:15:00Z', uploaded_by: 'admin' },
        { id: 'pre_4', src: 'images/photo4.jpg', alt: 'Action shot', uploaded_at: '2023-07-10T16:20:00Z', uploaded_by: 'admin' }
      ];
      
      // Track current album and selected thumbnail for album cover
      let currentAlbum = 'all';
      let selectedThumbnailUrl = null;
      let currentEditingAlbumId = null;
      
      // Check if the user has access to the gallery
      const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
        (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
      
      if (!hasGalleryAccess) {
        // Show gallery login overlay
        showGalleryLogin();
      } else {
        // Already authenticated, initialize gallery
        initializeGallery();
      }
      
      /**
       * Show gallery login overlay
       */
      function showGalleryLogin() {
        const loginOverlay = document.createElement('div');
        loginOverlay.id = 'login-overlay';
        
        const loginBox = document.createElement('div');
        loginBox.id = 'login-box';
        
        const title = document.createElement('h2');
        title.textContent = 'Enter Password';
        
        const passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.id = 'pw-input';
        passwordInput.placeholder = 'Password';
        
        const errorMsg = document.createElement('div');
        errorMsg.id = 'error-msg';
        errorMsg.textContent = 'Incorrect password';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.9rem';
        errorMsg.style.display = 'none';
        errorMsg.style.marginTop = '0.5rem';
        
        const submitBtn = document.createElement('button');
        submitBtn.id = 'pw-submit';
        submitBtn.textContent = 'Unlock Gallery';
        submitBtn.className = 'btn';
        submitBtn.style.marginTop = '1rem';
        
        loginBox.appendChild(title);
        loginBox.appendChild(passwordInput);
        loginBox.appendChild(errorMsg);
        loginBox.appendChild(submitBtn);
        
        loginOverlay.appendChild(loginBox);
        document.body.appendChild(loginOverlay);
        
        // Focus password input
        setTimeout(() => passwordInput.focus(), 100);
        
        // Handle login events
        submitBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') handleLogin();
        });
        
        function handleLogin() {
          const password = passwordInput.value;
          
          BBB_AUTH.login('gallery', password)
            .then(() => {
              // Login successful
              loginOverlay.remove();
              initializeGallery();
            })
            .catch(err => {
              // Login failed
              console.error('Login error:', err);
              errorMsg.style.display = 'block';
            });
        }
      }
      
      /**
       * Initialize gallery after authentication
       */
      function initializeGallery() {
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.textContent = 'Photo Gallery';
        subtitle.id = 'gallery-title';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
        mainContent.appendChild(description);
        
        // Create filter/search bar
        const filterBar = createFilterBar();
        mainContent.appendChild(filterBar);
        
        // Image upload section
        const uploadSection = document.createElement('div');
        uploadSection.className = 'upload-section';
        
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        mainContent.appendChild(uploadSection);
        
        // Info message about cloudflare
        const infoMessage = document.createElement('div');
        infoMessage.className = 'info-message';
        infoMessage.textContent = 'Gallery images are now stored in Cloudflare R2 storage for better performance and reliability.';
        mainContent.appendChild(infoMessage);
        
        // Initialize albums
        initializeAlbums();
        
        // Add albums section
        const albumsSection = createAlbumsSection();
        mainContent.appendChild(albumsSection);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';
        mainContent.appendChild(galleryContainer);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Load albums and gallery images from Cloudflare
        loadAlbums()
          .then(() => {
            loadGalleryImages();
          })
          .catch(err => {
            console.error('Error initializing gallery:', err);
            BBB_UTILS.showMessage('Error loading gallery, using fallback data', 'error');
            loadGalleryImages();
          });
        
        // Setup event handlers
        setupEventHandlers();
        
        // Setup create album modal
        setupCreateAlbumModal();
        
        // Setup edit album modal
        setupEditAlbumModal();
        
        // Setup thumbnail selector
        setupThumbnailSelector();
        
        /**
         * Initialize albums by checking if they exist on Cloudflare
         */
        function initializeAlbums() {
          // Will load albums from Cloudflare, initializing with defaults if needed
          loadAlbums();
        }
        
        /**
         * Load albums from Cloudflare
         * @returns {Promise} - Promise resolving to albums array
         */
        function loadAlbums() {
          return fetch(`${CLOUDFLARE_API}/albums`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error fetching albums: ${response.status}`);
              }
              return response.json();
            })
            .then(albums => {
              // If no albums, initialize with defaults
              if (!albums || albums.length === 0) {
                return initializeDefaultAlbums();
              }
              
              // Ensure 'all' album exists (special album that shows all photos)
              if (!albums.find(album => album.id === 'all')) {
                return fetch(`${CLOUDFLARE_API}/album`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    id: 'all',
                    title: 'All Photos',
                    description: 'All photos in the gallery',
                    thumbnail: 'images/photo1.jpg'
                  })
                })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`Error creating 'all' album: ${response.status}`);
                  }
                  return loadAlbums(); // Reload albums
                });
              }
              
              return albums;
            })
            .then(albums => {
              // Refresh albums section
              refreshAlbumsSection();
              return albums;
            });
        }
        
        /**
         * Initialize with default albums on Cloudflare
         * @returns {Promise} - Promise resolving to created albums
         */
        function initializeDefaultAlbums() {
          const createAlbumPromises = DEFAULT_ALBUMS.map(album => {
            return fetch(`${CLOUDFLARE_API}/album`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(album)
            });
          });
          
          return Promise.all(createAlbumPromises)
            .then(() => {
              return loadAlbums(); // Reload albums after creating defaults
            });
        }

        /**
         * Update album thumbnail on Cloudflare
         * @param {string} albumId - Album ID
         * @param {string} thumbnailUrl - Thumbnail URL
         * @returns {Promise} - Promise resolving when complete
         */
        function updateAlbumThumbnail(albumId, thumbnailUrl) {
          return fetch(`${CLOUDFLARE_API}/album/${albumId}/thumbnail`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ thumbnail: thumbnailUrl })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error updating album thumbnail: ${response.status}`);
            }
            return response.json();
          });
        }
        
        /**
         * Refresh the albums section
         */
        function refreshAlbumsSection() {
          return loadAlbums()
            .then(albums => {
              const albumsSection = document.querySelector('.albums-section');
              if (albumsSection) {
                const newAlbumsSection = createAlbumsSection(albums);
                albumsSection.parentNode.replaceChild(newAlbumsSection, albumsSection);
              }
            })
            .catch(err => {
              console.error('Error refreshing albums section:', err);
              BBB_UTILS.showMessage('Error refreshing albums', 'error');
            });
        }

        /**
         * Delete album from Cloudflare
         * @param {string} albumId - Album ID to delete
         * @returns {Promise} - Promise resolving when complete
         */
        function deleteAlbum(albumId) {
          // Special case: never delete 'all' album
          if (albumId === 'all') {
            return Promise.reject(new Error("Cannot delete the 'All Photos' album"));
          }
          
          return fetch(`${CLOUDFLARE_API}/album/${albumId}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error deleting album: ${response.status}`);
            }
            return response.json();
          });
        }
        
        /**
         * Create the albums section with albums
         * @param {Array} albums - Albums array (optional, will fetch if not provided)
         * @returns {HTMLElement} - Albums section element
         */
        function createAlbumsSection(albums) {
          // Create albums container
          const albumsSection = document.createElement('div');
          albumsSection.className = 'albums-section';
          
          // Add title and create album button
          const albumsActions = document.createElement('div');
          albumsActions.className = 'album-actions';
          
          const albumsTitle = document.createElement('h3');
          albumsTitle.className = 'albums-title';
          albumsTitle.textContent = 'Photo Albums';
          
          const createAlbumBtn = document.createElement('button');
          createAlbumBtn.className = 'btn';
          createAlbumBtn.textContent = 'Create New Album';
          createAlbumBtn.addEventListener('click', () => {
            const modal = document.getElementById('create-album-modal');
            modal.style.display = 'flex';
          });
          
          albumsActions.appendChild(albumsTitle);
          albumsActions.appendChild(createAlbumBtn);
          albumsSection.appendChild(albumsActions);
          
          // Create albums grid
          const albumsGrid = document.createElement('div');
          albumsGrid.className = 'albums-grid';
          
          // Function to create album card with actual albums
          const createAlbumsCards = (albumsData) => {
            // Create album cards
            albumsData.forEach(album => {
              const albumCard = document.createElement('div');
              albumCard.className = 'album-card';
              albumCard.dataset.albumId = album.id;
              
              // Add selected state to current album
              if (album.id === currentAlbum) {
                albumCard.style.borderLeft = '4px solid var(--bbb-primary)';
              }
              
              const albumThumb = document.createElement('div');
              albumThumb.className = 'album-thumbnail';
              
              // Use album thumbnail or default
              if (album.thumbnail) {
                // If it's a cloud URL, use it directly, otherwise build the URL
                if (album.thumbnail.startsWith('http')) {
                  albumThumb.style.backgroundImage = `url('${album.thumbnail}')`;
                } else if (album.thumbnail.startsWith('images/')) {
                  albumThumb.style.backgroundImage = `url('${album.thumbnail}')`;
                } else {
                  albumThumb.style.backgroundImage = `url('${CLOUDFLARE_API}/image/${album.thumbnail}')`;
                }
              } else {
                albumThumb.style.backgroundImage = `url('images/photo1.jpg')`;
              }
              
              // Album menu (for edit/delete) - only show for admin users and not for 'all' album
              if (BBB_AUTH.hasRole('admin') && album.id !== 'all') {
                const albumMenu = document.createElement('div');
                albumMenu.className = 'album-menu';
                albumMenu.innerHTML = '⋮';
                albumMenu.addEventListener('click', (e) => {
                  e.stopPropagation(); // Prevent album selection
                  toggleAlbumMenu(album.id);
                });
                
                // Album menu dropdown
                const menuDropdown = document.createElement('div');
                menuDropdown.className = 'album-menu-dropdown';
                menuDropdown.id = `album-menu-${album.id}`;
                
                // Edit option
                const editOption = document.createElement('div');
                editOption.className = 'album-menu-option';
                editOption.textContent = 'Edit Album';
                editOption.addEventListener('click', (e) => {
                  e.stopPropagation(); // Prevent album selection
                  openEditAlbumModal(album);
                });
                
                // Set thumbnail option
                const thumbnailOption = document.createElement('div');
                thumbnailOption.className = 'album-menu-option';
                thumbnailOption.textContent = 'Set Cover Photo';
                thumbnailOption.addEventListener('click', (e) => {
                  e.stopPropagation(); // Prevent album selection
                  openThumbnailSelector(album.id);
                });
                
                // Delete button (only show if admin or image was uploaded by current user)
            const canDelete = BBB_AUTH.hasRole('admin') || 
                            (image.uploadedBy && BBB_AUTH.currentUser && 
                             image.uploadedBy === BBB_AUTH.currentUser.id);
            
            if (canDelete) {
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'image-action-btn delete-btn';
              deleteBtn.innerHTML = '🗑️ Delete';
              
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent default click
                deleteImage(image.id);
              });
              imageActions.appendChild(deleteBtn);
            }
            
            // Add buttons in order
            imageActions.appendChild(albumBtn);
            imageActions.appendChild(copyUrlBtn);
            imageActions.appendChild(viewBtn);
            
            // Add click handler for lightbox
            img.addEventListener('click', () => {
              openLightbox(img);
            });
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(imageInfo);
            imgContainer.appendChild(imageActions);
            
            galleryElement.appendChild(imgContainer);
          });
          
          // If no images, show message
          if (images.length === 0) {
            const noImages = document.createElement('div');
            noImages.className = 'empty-gallery';
            
            const noImagesIcon = document.createElement('div');
            noImagesIcon.innerHTML = '📷';
            noImagesIcon.style.fontSize = '3rem';
            noImagesIcon.style.marginBottom = '1rem';
            
            const noImagesText = document.createElement('p');
            if (currentAlbum === 'all') {
              noImagesText.textContent = 'No images in the gallery yet. Upload some photos to get started!';
            } else {
              noImagesText.textContent = 'No images in this album yet. Add photos from the gallery!';
            }
            
            noImages.appendChild(noImagesIcon);
            noImages.appendChild(noImagesText);
            galleryElement.appendChild(noImages);
          }
        }
        
        /**
         * Show album selector dropdown for an image
         * @param {string} photoId - Photo ID
         * @param {HTMLElement} container - Container element
         */
        function showAlbumSelector(photoId, container) {
          // Remove any existing album selectors
          document.querySelectorAll('.album-selector').forEach(el => el.remove());
          
          // Create album selector
          const albumSelector = document.createElement('div');
          albumSelector.className = 'album-selector';
          
          // Create album dropdown
          const dropdown = document.createElement('div');
          dropdown.className = 'album-dropdown';
          dropdown.style.display = 'block';
          
          // Show loading indicator
          dropdown.innerHTML = '<div style="padding: 10px; text-align: center;">Loading albums...</div>';
          albumSelector.appendChild(dropdown);
          container.appendChild(albumSelector);
          
          // Get all albums from Cloudflare
          fetch(`${CLOUDFLARE_API}/albums`)
            .then(response => response.json())
            .then(albums => {
              dropdown.innerHTML = ''; // Clear loading
              
              // Get albums this photo is in from Cloudflare
              return fetch(`${CLOUDFLARE_API}/image/${photoId}/albums`)
                .then(response => response.json())
                .then(photoAlbums => {
                  // Add album options (except 'all')
                  albums.filter(album => album.id !== 'all').forEach(album => {
                    const option = document.createElement('div');
                    option.className = 'album-option';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `album-option-${album.id}`;
                    
                    // Check if photo is in this album
                    const isInAlbum = photoAlbums.some(a => a.id === album.id);
                    checkbox.checked = isInAlbum;
                    checkbox.style.marginRight = '8px';
                    
                    // Add change handler
                    checkbox.addEventListener('change', () => {
                      if (checkbox.checked) {
                        addImageToAlbum(photoId, album.id)
                          .then(() => {
                            BBB_UTILS.showMessage(`Added to album: ${album.title}`, 'success');
                            refreshAlbumsSection();
                          })
                          .catch(err => {
                            console.error('Error adding to album:', err);
                            BBB_UTILS.showMessage(`Error adding to album: ${err.message}`, 'error');
                            checkbox.checked = false;
                          });
                      } else {
                        removeImageFromAlbum(photoId, album.id)
                          .then(() => {
                            BBB_UTILS.showMessage(`Removed from album: ${album.title}`, 'success');
                            
                            // If we're viewing that album and removed the photo, reload images
                            if (currentAlbum === album.id) {
                              loadGalleryImages();
                            }
                            
                            refreshAlbumsSection();
                          })
                          .catch(err => {
                            console.error('Error removing from album:', err);
                            BBB_UTILS.showMessage(`Error removing from album: ${err.message}`, 'error');
                            checkbox.checked = true;
                          });
                      }
                    });
                    
                    const label = document.createElement('label');
                    label.setAttribute('for', `album-option-${album.id}`);
                    label.textContent = album.title;
                    label.style.cursor = 'pointer';
                    
                    option.appendChild(checkbox);
                    option.appendChild(label);
                    dropdown.appendChild(option);
                  });
                  
                  // Add close option
                  const closeOption = document.createElement('div');
                  closeOption.className = 'album-option';
                  closeOption.textContent = 'Close';
                  closeOption.style.textAlign = 'center';
                  closeOption.style.borderTop = '1px solid #eee';
                  closeOption.style.marginTop = '8px';
                  closeOption.style.paddingTop = '8px';
                  closeOption.style.cursor = 'pointer';
                  closeOption.addEventListener('click', () => {
                    albumSelector.remove();
                  });
                  dropdown.appendChild(closeOption);
                });
            })
            .catch(err => {
              console.error('Error loading albums for selector:', err);
              dropdown.innerHTML = '<div style="padding: 10px; color: red;">Error loading albums</div>';
              
              // Add close option
              const closeOption = document.createElement('div');
              closeOption.className = 'album-option';
              closeOption.textContent = 'Close';
              closeOption.style.textAlign = 'center';
              closeOption.style.borderTop = '1px solid #eee';
              closeOption.style.marginTop = '8px';
              closeOption.style.paddingTop = '8px';
              closeOption.style.cursor = 'pointer';
              closeOption.addEventListener('click', () => {
                albumSelector.remove();
              });
              dropdown.appendChild(closeOption);
            });
          
          // Close when clicking outside
          document.addEventListener('click', function closeDropdown(e) {
            if (!albumSelector.contains(e.target) && 
                !container.contains(e.target) || 
                e.target === container) {
              albumSelector.remove();
              document.removeEventListener('click', closeDropdown);
            }
          });
        }
        
        /**
         * Open lightbox with image
         * @param {HTMLElement} img - Image element to show in lightbox
         */
        function openLightbox(img) {
          const lightbox = document.getElementById('lightbox');
          const lightboxImg = document.getElementById('lightbox-img');
          const lightboxCaption = document.getElementById('lightbox-caption');
          
          lightboxImg.src = img.src;
          lightboxCaption.textContent = img.alt;
          lightbox.style.display = 'flex';
        }
        
        /**
         * Delete an image from Cloudflare
         * @param {string} imageId - Image ID
         */
        function deleteImage(imageId) {
          if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
            return;
          }
          
          BBB_UTILS.showMessage('Deleting image...', 'info');
          
          fetch(`${CLOUDFLARE_API}/image/${imageId}`, {
            method: 'DELETE'
          })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error deleting image: ${response.status} ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.success) {
                BBB_UTILS.showMessage('Image deleted successfully', 'success');
                
                // Remove image from DOM
                const imgContainer = document.querySelector(`.gallery-img-container[data-id="${imageId}"]`);
                if (imgContainer) {
                  imgContainer.remove();
                }
                
                // Update album counts
                refreshAlbumsSection();
                
                // Reload gallery if needed
                if (document.querySelectorAll('.gallery-img-container').length === 0) {
                  loadGalleryImages();
                }
              } else {
                BBB_UTILS.showMessage(`Error deleting image: ${data.error || 'Unknown error'}`, 'error');
              }
            })
            .catch(err => {
              console.error('Error deleting image:', err);
              BBB_UTILS.showMessage(`Error deleting image: ${err.message}`, 'error');
            });
        }
        
        /**
         * Handle image upload to Cloudflare
         * @param {Event} e - Change event
         */
        function handleImageUpload(e) {
          const files = Array.from(e.target.files);
          
          if (files.length === 0) {
            return;
          }
          
          // Show progress container
          const progressContainer = document.getElementById('upload-progress');
          const progressBarInner = document.getElementById('progress-bar-inner');
          const progressText = document.getElementById('progress-text');
          
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '0%';
          progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
          
          let uploadedCount = 0;
          const failedUploads = [];
          
          // Get current user if available
          const username = BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'anonymous';
          
          // Process each file
          files.forEach((file, index) => {
            // Validate file type
            if (!file.type.startsWith('image/')) {
              failedUploads.push({ file, error: 'Not an image file' });
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              return;
            }
            
            // Validate file size
            if (file.size > BBB_CONFIG.gallery.maxUploadSize) {
              failedUploads.push({ 
                file, 
                error: `File too large (max ${BBB_CONFIG.gallery.maxUploadSize / 1000000}MB)` 
              });
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              return;
            }
            
            // Create form data for upload
            const formData = new FormData();
            formData.append('image', file);
            formData.append('alt', file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo');
            formData.append('username', username);
            
            // Add to current album if not 'all'
            if (currentAlbum !== 'all') {
              formData.append('album', currentAlbum);
            }
            
            // Upload to Cloudflare Worker
            fetch(`${CLOUDFLARE_API}/upload`, {
              method: 'POST',
              body: formData
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Upload failed: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  uploadedCount++;
                } else {
                  failedUploads.push({ file, error: data.error || 'Upload failed' });
                }
                
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
                  finishUploads();
                }
              })
              .catch(err => {
                console.error('Error uploading image:', err);
                failedUploads.push({ file, error: 'Failed to upload' });
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
                  finishUploads();
                }
              });
          });
          
          // Reset file input
          e.target.value = '';
          
          /**
           * Update upload progress bar
           * @param {number} total - Total number of files
           * @param {number} completed - Number of completed uploads
           */
          function updateUploadProgress(total, completed) {
            const percentage = Math.round((completed / total) * 100);
            progressBarInner.style.width = `${percentage}%`;
            progressText.textContent = `Uploading ${completed} of ${total} (${percentage}%)`;
          }
          
          /**
           * Finish the upload process
           */
          function finishUploads() {
            // Hide progress container after a delay
            setTimeout(() => {
              progressContainer.style.display = 'none';
            }, 1500);
            
            // Reload gallery and albums
            refreshAlbumsSection()
              .then(() => {
                loadGalleryImages();
              });
            
            // Show status message
            if (failedUploads.length === 0) {
              if (uploadedCount > 1) {
                BBB_UTILS.showMessage(`Successfully uploaded ${uploadedCount} images`, 'success');
              } else {
                BBB_UTILS.showMessage('Image uploaded successfully', 'success');
              }
            } else {
              if (uploadedCount > 0) {
                BBB_UTILS.showMessage(`Uploaded ${uploadedCount} images, ${failedUploads.length} failed`, 'warning');
              } else {
                BBB_UTILS.showMessage(`Failed to upload ${failedUploads.length} images`, 'error');
              }
            }
          }
        }
        
        /**
         * Setup event handlers for gallery
         */
        function setupEventHandlers() {
          // Upload handler
          const uploadInput = document.getElementById('image-upload');
          uploadInput.addEventListener('change', handleImageUpload);
          
          // Search handler
          const searchInput = document.getElementById('gallery-search');
          searchInput.addEventListener('input', debounce(() => {
            loadGalleryImages();
          }, 500));
          
          // Sort handler
          const sortSelect = document.getElementById('gallery-sort');
          sortSelect.addEventListener('change', () => {
            loadGalleryImages();
          });
          
          // Lightbox close
          const lightboxClose = document.querySelector('.lightbox-close');
          lightboxClose.addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'none';
          });
          
          // Click outside lightbox to close
          document.getElementById('lightbox').addEventListener('click', e => {
            if (e.target === document.getElementById('lightbox')) {
              document.getElementById('lightbox').style.display = 'none';
            }
          });
          
          // ESC key to close lightbox and modals
          document.addEventListener('keyup', e => {
            if (e.key === 'Escape') {
              // Close lightbox
              document.getElementById('lightbox').style.display = 'none';
              
              // Close album selectors
              document.querySelectorAll('.album-selector').forEach(el => el.remove());
              
              // Close modals
              document.getElementById('create-album-modal').style.display = 'none';
              document.getElementById('edit-album-modal').style.display = 'none';
              document.getElementById('thumbnail-selector').style.display = 'none';
            }
          });
        }

        /**
         * Setup create album modal
         */
        function setupCreateAlbumModal() {
          const modal = document.getElementById('create-album-modal');
          const closeBtn = modal.querySelector('.modal-close');
          const cancelBtn = document.getElementById('create-album-cancel');
          const submitBtn = document.getElementById('create-album-submit');
          const nameInput = document.getElementById('album-name');
          const descInput = document.getElementById('album-description');
          
          // Close modal when clicking close or cancel
          closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
          });
          
          cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
          });
          
          // Submit form
          submitBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            
            if (!name) {
              BBB_UTILS.showMessage('Please enter an album name', 'error');
              return;
            }
            
            // Create new album
            const album = {
              id: 'album_' + Date.now(),
              title: name,
              description: description || name,
              thumbnail: 'images/photo1.jpg' // Default thumbnail
            };
            
            // Create album on Cloudflare
            fetch(`${CLOUDFLARE_API}/album`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(album)
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Error creating album: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  // Reset form
                  nameInput.value = '';
                  descInput.value = '';
                  
                  // Close modal
                  modal.style.display = 'none';
                  
                  // Show success message
                  BBB_UTILS.showMessage('Album created successfully', 'success');
                  
                  // Refresh albums section
                  refreshAlbumsSection();
                } else {
                  throw new Error(data.error || 'Unknown error creating album');
                }
              })
              .catch(err => {
                console.error('Error creating album:', err);
                BBB_UTILS.showMessage(`Error creating album: ${err.message}`, 'error');
              });
          });
          
          // Close when clicking outside the modal
          window.addEventListener('click', (event) => {
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          });
        }

        /**
         * Setup edit album modal
         */
        function setupEditAlbumModal() {
          const modal = document.getElementById('edit-album-modal');
          const closeBtn = modal.querySelector('.modal-close');
          const cancelBtn = document.getElementById('edit-album-cancel');
          const submitBtn = document.getElementById('edit-album-submit');
          const nameInput = document.getElementById('edit-album-name');
          const descInput = document.getElementById('edit-album-description');
          const idInput = document.getElementById('edit-album-id');
          
          // Close modal when clicking close or cancel
          closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
          });
          
          cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
          });
          
          // Submit form
          submitBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            const id = idInput.value;
            
            if (!name) {
              BBB_UTILS.showMessage('Please enter an album name', 'error');
              return;
            }
            
            if (!id) {
              BBB_UTILS.showMessage('No album ID provided', 'error');
              return;
            }
            
            // Update album on Cloudflare
            fetch(`${CLOUDFLARE_API}/album/${id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                title: name,
                description: description || name
              })
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Error updating album: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  // Close modal
                  modal.style.display = 'none';
                  
                  // Show success message
                  BBB_UTILS.showMessage('Album updated successfully', 'success');
                  
                  // Update gallery title if this is the current album
                  if (currentAlbum === id) {
                    const galleryTitle = document.getElementById('gallery-title');
                    if (galleryTitle) {
                      galleryTitle.textContent = `Photo Gallery - ${name}`;
                    }
                  }
                  
                  // Refresh albums section
                  refreshAlbumsSection();
                } else {
                  throw new Error(data.error || 'Unknown error updating album');
                }
              })
              .catch(err => {
                console.error('Error updating album:', err);
                BBB_UTILS.showMessage(`Error updating album: ${err.message}`, 'error');
              });
          });
          
          // Close when clicking outside the modal
          window.addEventListener('click', (event) => {
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          });
        }

        /**
         * Open edit album modal
         * @param {Object} album - Album object
         */
        function openEditAlbumModal(album) {
          const modal = document.getElementById('edit-album-modal');
          const nameInput = document.getElementById('edit-album-name');
          const descInput = document.getElementById('edit-album-description');
          const idInput = document.getElementById('edit-album-id');
          
          // Set form values
          nameInput.value = album.title || '';
          descInput.value = album.description || '';
          idInput.value = album.id || '';
          
          // Show modal
          modal.style.display = 'flex';
          
          // Focus name input
          setTimeout(() => nameInput.focus(), 100);
        }

        /**
         * Setup thumbnail selector
         */
        function setupThumbnailSelector() {
          const selector = document.getElementById('thumbnail-selector');
          const grid = document.getElementById('thumbnail-selector-grid');
          const closeBtn = selector.querySelector('.thumbnail-selector-close');
          const confirmBtn = document.getElementById('thumbnail-selector-confirm');
          
          // Close button
          closeBtn.addEventListener('click', () => {
            selector.style.display = 'none';
            selectedThumbnailUrl = null;
          });
          
          // Confirm button
          confirmBtn.addEventListener('click', () => {
            if (!selectedThumbnailUrl || !currentEditingAlbumId) {
              BBB_UTILS.showMessage('Please select a thumbnail image', 'error');
              return;
            }
            
            // Update album thumbnail
            updateAlbumThumbnail(currentEditingAlbumId, selectedThumbnailUrl)
              .then(() => {
                // Close selector
                selector.style.display = 'none';
                
                // Show success message
                BBB_UTILS.showMessage('Album thumbnail updated successfully', 'success');
                
                // Reset state
                selectedThumbnailUrl = null;
                currentEditingAlbumId = null;
                
                // Refresh albums section
                refreshAlbumsSection();
              })
              .catch(err => {
                console.error('Error updating album thumbnail:', err);
                BBB_UTILS.showMessage(`Error updating album thumbnail: ${err.message}`, 'error');
              });
          });
          
          // Close when clicking outside
          selector.addEventListener('click', e => {
            if (e.target === selector) {
              selector.style.display = 'none';
              selectedThumbnailUrl = null;
              currentEditingAlbumId = null;
            }
          });
        }

        /**
         * Open thumbnail selector
         * @param {string} albumId - Album ID
         */
        function openThumbnailSelector(albumId) {
          const selector = document.getElementById('thumbnail-selector');
          const grid = document.getElementById('thumbnail-selector-grid');
          
          // Clear previous thumbnails
          grid.innerHTML = '<div style="color: white; text-align: center; padding: 2rem;">Loading images...</div>';
          
          // Reset selection
          selectedThumbnailUrl = null;
          currentEditingAlbumId = albumId;
          
          // Show selector
          selector.style.display = 'flex';
          
          // Load images from Cloudflare
          fetch(`${CLOUDFLARE_API}/images`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error fetching images: ${response.status}`);
              }
              return response.json();
            })
            .then(images => {
              // Clear grid
              grid.innerHTML = '';
              
              if (images.length === 0) {
                grid.innerHTML = '<div style="color: white; text-align: center; padding: 2rem;">No images available</div>';
                return;
              }
              
              // Add thumbnails
              images.forEach(image => {
                const thumb = document.createElement('div');
                thumb.className = 'thumbnail-option';
                
                const img = document.createElement('img');
                img.src = image.src || `${CLOUDFLARE_API}/image/${image.id}`;
                img.alt = image.alt || 'Gallery image';
                
                thumb.appendChild(img);
                
                // Add click handler
                thumb.addEventListener('click', () => {
                  // Remove selected class from all thumbnails
                  document.querySelectorAll('.thumbnail-option').forEach(el => {
                    el.classList.remove('selected');
                  });
                  
                  // Add selected class to this thumbnail
                  thumb.classList.add('selected');
                  
                  // Store selected thumbnail URL or ID
                  selectedThumbnailUrl = image.id; // Store ID, not URL
                });
                
                grid.appendChild(thumb);
              });
            })
            .catch(err => {
              console.error('Error loading images for thumbnail selector:', err);
              grid.innerHTML = '<div style="color: white; text-align: center; padding: 2rem;">Error loading images</div>';
            });
        }
        
        /**
         * Debounce function to limit execution frequency
         * @param {Function} func - Function to debounce
         * @param {number} delay - Delay in milliseconds
         * @returns {Function} - Debounced function
         */
        function debounce(func, delay = 300) {
          let timerId;
          return function(...args) {
            clearTimeout(timerId);
            timerId = setTimeout(() => {
              func.apply(this, args);
            }, delay);
          };
        }
        
        /**
         * Copy image URL to clipboard
         * @param {string} url - URL to copy
         */
        function copyImageUrlToClipboard(url) {
          navigator.clipboard.writeText(url)
            .then(() => {
              BBB_UTILS.showMessage('Image URL copied to clipboard', 'success');
            })
            .catch(err => {
              console.error('Error copying to clipboard:', err);
              BBB_UTILS.showMessage('Failed to copy URL', 'error');
              
              // Fallback for older browsers
              const textarea = document.createElement('textarea');
              textarea.value = url;
              document.body.appendChild(textarea);
              textarea.select();
              
              try {
                document.execCommand('copy');
                BBB_UTILS.showMessage('Image URL copied to clipboard', 'success');
              } catch (err) {
                console.error('Error copying to clipboard (fallback):', err);
                BBB_UTILS.showMessage('Failed to copy URL', 'error');
              }
              
              document.body.removeChild(textarea);
            });
        }
        
        /**
         * Share image
         * @param {string} imageUrl - Image URL
         * @param {string} title - Image title
         */
        function shareImage(imageUrl, title) {
          if (navigator.share) {
            navigator.share({
              title: title || 'Shared Image',
              text: 'Check out this image from Birdie Bush Bandits Gallery',
              url: imageUrl
            })
              .then(() => {
                BBB_UTILS.showMessage('Image shared successfully', 'success');
              })
              .catch(err => {
                console.error('Error sharing:', err);
                // If sharing fails, fall back to copying URL
                copyImageUrlToClipboard(imageUrl);
              });
          } else {
            // Fallback for browsers that don't support navigator.share
            copyImageUrlToClipboard(imageUrl);
          }
        }
        
        /**
         * Download image
         * @param {string} imageUrl - Image URL
         * @param {string} filename - Filename to save as
         */
        function downloadImage(imageUrl, filename) {
          const a = document.createElement('a');
          a.href = imageUrl;
          a.download = filename || 'bbb-gallery-image.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          BBB_UTILS.showMessage('Image download started', 'success');
        }
        
        /**
         * View image in full screen
         * @param {HTMLElement} img - Image element
         */
        function viewFullscreen(img) {
          if (img.requestFullscreen) {
            img.requestFullscreen();
          } else if (img.webkitRequestFullscreen) { /* Safari */
            img.webkitRequestFullscreen();
          } else if (img.msRequestFullscreen) { /* IE11 */
            img.msRequestFullscreen();
          }
        }
        
        /**
         * Set active album in UI
         * @param {string} albumId - Album ID
         */
        function setActiveAlbum(albumId) {
          // Update current album
          currentAlbum = albumId;
          
          // Update all album cards
          document.querySelectorAll('.album-card').forEach(card => {
            if (card.dataset.albumId === albumId) {
              card.style.borderLeft = '4px solid var(--bbb-primary)';
            } else {
              card.style.borderLeft = 'none';
            }
          });
          
          // Fetch album title and update gallery title
          fetch(`${CLOUDFLARE_API}/album/${albumId}`)
            .then(response => response.json())
            .then(album => {
              const galleryTitle = document.getElementById('gallery-title');
              if (galleryTitle && album.title) {
                galleryTitle.textContent = `Photo Gallery - ${album.title}`;
              }
            })
            .catch(err => {
              console.error('Error fetching album details:', err);
            });
        }
      }
    });
  </script>
</body>
</html>
        
        /**
         * Copy image URL to clipboard
         * @param {string} url - URL to copy
         */
        function copyImageUrlToClipboard(url) {
          navigator.clipboard.writeText(url)
            .then(() => {
              BBB_UTILS.showMessage('Image URL copied to clipboard', 'success');
            })
            .catch(err => {
              console.error('Error copying to clipboard:', err);
              BBB_UTILS.showMessage('Failed to copy URL', 'error');
              
              // Fallback for older browsers
              const textarea = document.createElement('textarea');
              textarea.value = url;
              document.body.appendChild(textarea);
              textarea.select();
              
              try {
                document.execCommand('copy');
                BBB_UTILS.showMessage('Image URL copied to clipboard', 'success');
              } catch (err) {
                console.error('Error copying to clipboard (fallback):', err);
                BBB_UTILS.showMessage('Failed to copy URL', 'error');
              }
              
              document.body.removeChild(textarea);
            });
        }
        
        /**
         * Share image
         * @param {string} imageUrl - Image URL
         * @param {string} title - Image title
         */
        function shareImage(imageUrl, title) {
          if (navigator.share) {
            navigator.share({
              title: title || 'Shared Image',
              text: 'Check out this image from Birdie Bush Bandits Gallery',
              url: imageUrl
            })
              .then(() => {
                BBB_UTILS.showMessage('Image shared successfully', 'success');
              })
              .catch(err => {
                console.error('Error sharing:', err);
                // If sharing fails, fall back to copying URL
                copyImageUrlToClipboard(imageUrl);
              });
          } else {
            // Fallback for browsers that don't support navigator.share
            copyImageUrlToClipboard(imageUrl);
          }
        }
        
        /**
         * Download image
         * @param {string} imageUrl - Image URL
         * @param {string} filename - Filename to save as
         */
        function downloadImage(imageUrl, filename) {
          const a = document.createElement('a');
          a.href = imageUrl;
          a.download = filename || 'bbb-gallery-image.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          BBB_UTILS.showMessage('Image download started', 'success');
        }
        
        /**
         * View image in full screen
         * @param {HTMLElement} img - Image element
         */
        function viewFullscreen(img) {
          if (img.requestFullscreen) {
            img.requestFullscreen();
          } else if (img.webkitRequestFullscreen) { /* Safari */
            img.webkitRequestFullscreen();
          } else if (img.msRequestFullscreen) { /* IE11 */
            img.msRequestFullscreen();
          }
        }
        
        /**
         * Set active album in UI
         * @param {string} albumId - Album ID
         */
        function setActiveAlbum(albumId) {
          // Update current album
          currentAlbum = albumId;
          
          // Update all album cards
          document.querySelectorAll('.album-card').forEach(card => {
            if (card.dataset.albumId === albumId) {
              card.style.borderLeft = '4px solid var(--bbb-primary)';
            } else {
              card.style.borderLeft = 'none';
            }
          });
          
          // Fetch album title and update gallery title
          fetch(`${CLOUDFLARE_API}/album/${albumId}`)
            .then(response => response.json())
            .then(album => {
              const galleryTitle = document.getElementById('gallery-title');
              if (galleryTitle && album.title) {
                galleryTitle.textContent = `Photo Gallery - ${album.title}`;
              }
            })
            .catch(err => {
              console.error('Error fetching album details:', err);
            });
        }
      }
    });
  </script>
</body>
</html> option
                const deleteOption = document.createElement('div');
                deleteOption.className = 'album-menu-option delete';
                deleteOption.textContent = 'Delete Album';
                deleteOption.addEventListener('click', (e) => {
                  e.stopPropagation(); // Prevent album selection
                  if (confirm(`Are you sure you want to delete the album "${album.title}"?`)) {
                    deleteAlbum(album.id)
                      .then(() => {
                        BBB_UTILS.showMessage(`Album "${album.title}" deleted successfully`, 'success');
                        refreshAlbumsSection();
                        
                        // If current album was deleted, switch to 'all'
                        if (currentAlbum === album.id) {
                          currentAlbum = 'all';
                          loadGalleryImages();
                          
                          // Update gallery title
                          const galleryTitle = document.getElementById('gallery-title');
                          if (galleryTitle) {
                            galleryTitle.textContent = 'Photo Gallery - All Photos';
                          }
                        }
                      })
                      .catch(err => {
                        console.error('Error deleting album:', err);
                        BBB_UTILS.showMessage(`Error deleting album: ${err.message}`, 'error');
                      });
                  }
                });
                
                // Add options to dropdown
                menuDropdown.appendChild(editOption);
                menuDropdown.appendChild(thumbnailOption);
                menuDropdown.appendChild(deleteOption);
                
                // Add menu to album card
                albumCard.appendChild(albumMenu);
                albumCard.appendChild(menuDropdown);
              }
              
              const albumInfo = document.createElement('div');
              albumInfo.className = 'album-info';
              
              const albumTitle = document.createElement('div');
              albumTitle.className = 'album-title';
              albumTitle.textContent = album.title;
              
              // Get photo count for this album
              let photoCount = album.photoCount || 0;
              
              const albumCount = document.createElement('div');
              albumCount.className = 'album-count';
              albumCount.textContent = `${photoCount} photos`;
              
              albumInfo.appendChild(albumTitle);
              albumInfo.appendChild(albumCount);
              
              albumCard.appendChild(albumThumb);
              albumCard.appendChild(albumInfo);
              
              // Add click handler to view album
              albumCard.addEventListener('click', () => {
                // Set current album
                currentAlbum = album.id;
                
                // Update gallery title
                const galleryTitle = document.getElementById('gallery-title');
                if (galleryTitle) {
                  galleryTitle.textContent = `Photo Gallery - ${album.title}`;
                }
                
                // Reload images with album filter
                loadGalleryImages();
                
                // Update active state in albums
                document.querySelectorAll('.album-card').forEach(card => {
                  if (card.dataset.albumId === album.id) {
                    card.style.borderLeft = '4px solid var(--bbb-primary)';
                  } else {
                    card.style.borderLeft = 'none';
                  }
                });
                
                // Show info message
                BBB_UTILS.showMessage(`Viewing album: ${album.title}`, 'info');
              });
              
              albumsGrid.appendChild(albumCard);
            });
          };
          
          // If albums were passed in, use them, otherwise fetch
          if (albums) {
            createAlbumsCards(albums);
          } else {
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.textContent = 'Loading albums...';
            loadingDiv.style.textAlign = 'center';
            loadingDiv.style.padding = '1rem';
            albumsGrid.appendChild(loadingDiv);
            
            // Fetch albums from Cloudflare
            fetch(`${CLOUDFLARE_API}/albums`)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Error fetching albums: ${response.status}`);
                }
                return response.json();
              })
              .then(albumsData => {
                // Clear loading
                albumsGrid.innerHTML = '';
                
                // Create album cards
                createAlbumsCards(albumsData);
              })
              .catch(err => {
                console.error('Error loading albums:', err);
                albumsGrid.innerHTML = '<div style="text-align: center; padding: 1rem;">Error loading albums</div>';
              });
          }
          
          albumsSection.appendChild(albumsGrid);
          return albumsSection;
        }
        
        /**
         * Toggle album menu dropdown
         * @param {string} albumId - Album ID
         */
        function toggleAlbumMenu(albumId) {
          // Hide all other menus
          document.querySelectorAll('.album-menu-dropdown').forEach(menu => {
            if (menu.id !== `album-menu-${albumId}`) {
              menu.style.display = 'none';
            }
          });
          
          // Toggle this menu
          const menu = document.getElementById(`album-menu-${albumId}`);
          if (menu) {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            
            // Add event listener to close when clicking outside
            if (menu.style.display === 'block') {
              setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                  if (!menu.contains(e.target) && !e.target.closest('.album-menu')) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                  }
                });
              }, 0);
            }
          }
        }
        
        /**
         * Create filter/search bar
         */
        function createFilterBar() {
          const filterBar = document.createElement('div');
          filterBar.className = 'filter-bar';
          
          // Search
          const searchContainer = document.createElement('div');
          searchContainer.className = 'search-container';
          
          const searchIcon = document.createElement('span');
          searchIcon.className = 'search-icon';
          searchIcon.innerHTML = '🔍';
          
          const searchInput = document.createElement('input');
          searchInput.type = 'text';
          searchInput.className = 'search-input';
          searchInput.placeholder = 'Search gallery...';
          searchInput.id = 'gallery-search';
          
          searchContainer.appendChild(searchIcon);
          searchContainer.appendChild(searchInput);
          
          // Sort
          const sortContainer = document.createElement('div');
          sortContainer.className = 'sort-container';
          
          const sortLabel = document.createElement('span');
          sortLabel.className = 'sort-label';
          sortLabel.textContent = 'Sort by:';
          
          const sortSelect = document.createElement('select');
          sortSelect.className = 'sort-select';
          sortSelect.id = 'gallery-sort';
          
          const sortOptions = [
            { value: 'newest', text: 'Newest first' },
            { value: 'oldest', text: 'Oldest first' },
            { value: 'name', text: 'Name (A-Z)' }
          ];
          
          sortOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            sortSelect.appendChild(optionEl);
          });
          
          sortContainer.appendChild(sortLabel);
          sortContainer.appendChild(sortSelect);
          
          filterBar.appendChild(searchContainer);
          filterBar.appendChild(sortContainer);
          
          return filterBar;
        }
        
        /**
         * Load gallery images from Cloudflare
         */
        function loadGalleryImages() {
          BBB_UTILS.showMessage('Loading gallery images...', 'info');
          
          // Check sort and search options
          const sortSelect = document.getElementById('gallery-sort');
          const searchInput = document.getElementById('gallery-search');
          
          const sortValue = sortSelect ? sortSelect.value : 'newest';
          const searchValue = searchInput ? searchInput.value.trim() : '';
          
          // Build the API URL with any search parameters
          let apiUrl = `${CLOUDFLARE_API}/images`;
          
          const params = new URLSearchParams();
          
          if (searchValue) {
            params.append('search', searchValue);
          }
          
          if (currentAlbum && currentAlbum !== 'all') {
            params.append('album', currentAlbum);
          }
          
          params.append('sort', sortValue);
          
          // Add params to URL if any exist
          if (params.toString()) {
            apiUrl += `?${params.toString()}`;
          }
          
          // Fetch from Cloudflare
          fetch(apiUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error fetching gallery: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // Convert to our format if needed
              const images = Array.isArray(data) ? data : [];
              
              // Map images to ensure they have the correct URL format
              const processedImages = images.map(img => ({
                id: img.id,
                src: img.src || `${CLOUDFLARE_API}/image/${img.id}`,
                alt: img.alt || 'Gallery image',
                uploadedAt: img.uploaded_at || img.uploadedAt,
                uploadedBy: img.uploaded_by || img.uploadedBy,
                albums: img.albums || []
              }));
              
              // Render gallery
              renderGallery(processedImages);
              
              // Hide loading message
              BBB_UTILS.showMessage('', 'info');
            })
            .catch(err => {
              console.error('Error loading gallery images:', err);
              BBB_UTILS.showMessage('Error loading gallery images', 'error');
              
              // Show fallback gallery with preloaded images
              renderGallery(DEFAULT_IMAGES);
            });
            
          // Check if we need to migrate images from localStorage
          checkMigrationNeeded();
        }
        
        /**
         * Add image to album on Cloudflare
         * @param {string} imageId - Image ID
         * @param {string} albumId - Album ID
         * @returns {Promise} - Promise resolving when complete
         */
        function addImageToAlbum(imageId, albumId) {
          return fetch(`${CLOUDFLARE_API}/album/${albumId}/image/${imageId}`, {
            method: 'POST'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error adding image to album: ${response.status}`);
            }
            return response.json();
          });
        }
        
        /**
         * Remove image from album on Cloudflare
         * @param {string} imageId - Image ID
         * @param {string} albumId - Album ID
         * @returns {Promise} - Promise resolving when complete
         */
        function removeImageFromAlbum(imageId, albumId) {
          return fetch(`${CLOUDFLARE_API}/album/${albumId}/image/${imageId}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error removing image from album: ${response.status}`);
            }
            return response.json();
          });
        }
        
        /**
         * Check if migration is needed
         */
        function checkMigrationNeeded() {
          try {
            // Check if we have already migrated
            const migrated = localStorage.getItem('bbb_gallery_migrated_to_cloudflare');
            if (migrated === 'true') {
              return;
            }
            
            // Get stored images from original localStorage
            const storedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
            
            if (storedImages.length === 0) {
              // No images to migrate
              localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
              return;
            }
            
            // Create migration button
            const migrationBtn = document.createElement('button');
            migrationBtn.className = 'btn migration-button';
            migrationBtn.textContent = `Migrate ${storedImages.length} Images to Cloud`;
            migrationBtn.addEventListener('click', () => migrateLocalStorageImages(storedImages));
            
            // Add before the gallery
            const galleryElement = document.getElementById('gallery');
            galleryElement.parentNode.insertBefore(migrationBtn, galleryElement);
            
            // Show migration message
            BBB_UTILS.showMessage(`Found ${storedImages.length} images in your browser. Click the migration button to move them to the cloud.`, 'info');
          } catch (err) {
            console.error('Error checking for migration:', err);
          }
        }
        
        /**
         * Migrate images from localStorage to Cloudflare
         * @param {Array} storedImages - Array of data URLs
         */
        function migrateLocalStorageImages(storedImages) {
          // Show migration message
          BBB_UTILS.showMessage(`Migrating ${storedImages.length} existing images to cloud storage...`, 'info');
          
          // Get migration button and disable it
          const migrationBtn = document.querySelector('.migration-button');
          if (migrationBtn) {
            migrationBtn.disabled = true;
            migrationBtn.textContent = 'Migration in progress...';
          }
          
          // Show progress container
          const progressContainer = document.getElementById('upload-progress');
          const progressBarInner = document.getElementById('progress-bar-inner');
          const progressText = document.getElementById('progress-text');
          
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '0%';
          progressText.textContent = 'Preparing migration...';
          
          // Convert and upload each image
          let migrationCount = 0;
          let migrationErrors = 0;
          
          storedImages.forEach((dataURL, index) => {
            try {
              // Convert data URL to blob
              const blob = dataURLtoBlob(dataURL);
              
              // Create form data for upload
              const formData = new FormData();
              formData.append('image', blob, `migrated_image_${index}.jpg`);
              formData.append('alt', `Migrated image ${index + 1}`);
              formData.append('username', BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'migration');
              
              // Add to 'members' album by default
              formData.append('album', 'members');
              
              // Update progress text
              progressText.textContent = `Migrating image ${index + 1} of ${storedImages.length}...`;
              progressBarInner.style.width = `${Math.round((index / storedImages.length) * 100)}%`;
              
              // Upload to Cloudflare Worker
              fetch(`${CLOUDFLARE_API}/upload`, {
                method: 'POST',
                body: formData
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                  }
                  return response.json();
                })
                .then(data => {
                  if (data.success) {
                    migrationCount++;
                  } else {
                    migrationErrors++;
                  }
                  
                  // Update progress
                  const completed = migrationCount + migrationErrors;
                  const percentage = Math.round((completed / storedImages.length) * 100);
                  progressBarInner.style.width = `${percentage}%`;
                  progressText.textContent = `Migrated ${migrationCount} of ${storedImages.length} images (${percentage}%)`;
                  
                  // Check if all migrations complete
                  if (completed === storedImages.length) {
                    finishMigration();
                  }
                })
                .catch(err => {
                  console.error('Error migrating image:', err);
                  migrationErrors++;
                  
                  // Update progress
                  const completed = migrationCount + migrationErrors;
                  const percentage = Math.round((completed / storedImages.length) * 100);
                  progressBarInner.style.width = `${percentage}%`;
                  progressText.textContent = `Migrated ${migrationCount} of ${storedImages.length} images (${percentage}%)`;
                  
                  // Check if all migrations complete
                  if (completed === storedImages.length) {
                    finishMigration();
                  }
                });
            } catch (err) {
              console.error('Error processing image for migration:', err);
              migrationErrors++;
              
              // Update progress
              const completed = migrationCount + migrationErrors;
              const percentage = Math.round((completed / storedImages.length) * 100);
              progressBarInner.style.width = `${percentage}%`;
              
              // Check if all migrations complete
              if (completed === storedImages.length) {
                finishMigration();
              }
            }
          });
          
          /**
           * Convert data URL to Blob
           * @param {string} dataURL - Data URL string
           * @returns {Blob} - Blob data
           */
          function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
              u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], { type: mime });
          }
          
          /**
           * Finish the migration process
           */
          function finishMigration() {
            // Mark as migrated
            localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
            
            // Clear old localStorage to free up space
            localStorage.removeItem('uploadedImages');
            
            // Hide progress
            progressContainer.style.display = 'none';
            
            // Remove migration button
            if (migrationBtn) {
              migrationBtn.remove();
            }
            
            // Reload gallery and albums
            refreshAlbumsSection()
              .then(() => {
                loadGalleryImages();
              });
            
            // Show status message
            if (migrationErrors === 0) {
              BBB_UTILS.showMessage(`Successfully migrated ${migrationCount} images to cloud storage`, 'success');
            } else {
              BBB_UTILS.showMessage(`Migrated ${migrationCount} images, failed to migrate ${migrationErrors} images`, 'warning');
            }
          }
        }
        
        /**
         * Render gallery with images
         * @param {Array} images - Array of image objects
         */
        function renderGallery(images) {
          const galleryElement = document.getElementById('gallery');
          galleryElement.innerHTML = '';
          
          // Create gallery
          images.forEach(image => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'gallery-img-container';
            imgContainer.dataset.id = image.id;
            
            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || 'Gallery image';
            img.className = 'gallery-img';
            img.setAttribute('loading', 'lazy'); // Add lazy loading
            
            // Add timestamp info
            const imageInfo = document.createElement('div');
            imageInfo.className = 'image-info';
            
            let uploadDate = 'Unknown date';
            if (image.uploadedAt) {
              uploadDate = new Date(image.uploadedAt).toLocaleDateString();
            }
            
            imageInfo.textContent = uploadDate;
            
            // Add album badge if not in 'all' album view
            if (currentAlbum !== 'all') {
              const albumBadge = document.createElement('div');
              albumBadge.className = 'album-badge';
              
              // Get album name from current album
              fetch(`${CLOUDFLARE_API}/album/${currentAlbum}`)
                .then(response => response.json())
                .then(album => {
                  if (album && album.title) {
                    albumBadge.textContent = album.title;
                  } else {
                    albumBadge.textContent = 'Album';
                  }
                })
                .catch(() => {
                  albumBadge.textContent = 'Album';
                });
              
              imgContainer.appendChild(albumBadge);
            }
            
            // Add action buttons
            const imageActions = document.createElement('div');
            imageActions.className = 'image-actions';
            
            // View button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'image-action-btn view-btn';
            viewBtn.innerHTML = '👁️ View';
            viewBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent default click
              openLightbox(img);
            });
            
            // Add to album button
            const albumBtn = document.createElement('button');
            albumBtn.className = 'image-action-btn';
            albumBtn.innerHTML = '📁 Album';
            albumBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent default click
              showAlbumSelector(image.id, imgContainer);
            });
            
            // Copy URL button
            const copyUrlBtn = document.createElement('button');
            copyUrlBtn.className = 'image-action-btn copy-url-button';
            copyUrlBtn.innerHTML = '🔗 Copy URL';
            copyUrlBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent default click
              
              // Copy full URL to clipboard
              navigator.clipboard.writeText(image.src)
                .then(() => {
                  BBB_UTILS.showMessage('Image URL copied to clipboard', 'success');
                })
                .catch(err => {
                  console.error('Could not copy URL: ', err);
                  BBB_UTILS.showMessage('Could not copy URL', 'error');
                });
            });
            
            // Delete
