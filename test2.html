<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    /* Gallery layout */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    /* Gallery image styles */
    .gallery-img-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      aspect-ratio: 1 / 1;
      background-color: #f0f0f0;
    }
    
    .gallery-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease, filter 0.3s ease;
      cursor: pointer;
    }
    
    .gallery-img-container:hover .gallery-img {
      transform: scale(1.03);
    }
    
    /* Image info and actions */
    .image-info {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      font-size: 0.75rem;
      border-top-left-radius: 8px;
      transition: opacity 0.3s;
    }
    
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }
    
    /* Album indicator badge */
    .album-badge {
      position: absolute;
      top: 0;
      right: 0;
      background-color: var(--bbb-secondary);
      color: white;
      padding: 4px 8px;
      font-size: 0.75rem;
      border-top-right-radius: 8px;
      max-width: 60%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Action buttons */
    .image-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .image-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .delete-btn {
      color: #ff6b6b;
    }
    
    /* Upload section */
    .upload-section {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem 0;
      flex-wrap: wrap;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: 'ðŸ“¸';
      font-size: 1.25rem;
    }
    
    .create-album-btn::before {
      content: 'ðŸ“‚';
      font-size: 1.25rem;
    }
    
    /* Upload progress */
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
      margin: 0 auto;
      box-shadow: var(--shadow-sm);
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Empty state */
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
      box-shadow: var(--shadow-sm);
    }
    
    /* Improved lightbox */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .lightbox-album {
      color: #bbdefb;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .lightbox-navigation {
      position: absolute;
      top: 50%;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 2rem;
      transform: translateY(-50%);
      pointer-events: none;
    }
    
    .lightbox-nav-btn {
      color: white;
      font-size: 3rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s;
      background: rgba(0,0,0,0.5);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    
    .lightbox-nav-btn:hover {
      opacity: 1;
    }
    
    /* Filter bar */
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
      flex-wrap: wrap;
      gap: 1rem;
      background-color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .sort-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    /* Album filter dropdown */
    .album-filter {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .album-filter-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .album-filter-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      min-width: 140px;
    }
    
    /* Album section styles */
    .albums-section {
      margin: 2rem 0;
      animation: fadeIn 0.5s ease;
    }
    
    .albums-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .albums-title {
      margin: 0;
      font-size: 1.5rem;
      color: var(--bbb-primary);
    }
    
    .albums-toggle {
      background: none;
      border: none;
      color: var(--bbb-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      padding: 4px 8px;
    }
    
    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }
    
    .album-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .album-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .album-card.active {
      border: 3px solid var(--bbb-secondary);
    }
    
    .album-thumbnail {
      height: 150px;
      background-color: #f0f0f0;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .album-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      height: 100%;
    }
    
    .album-grid-img {
      background-size: cover;
      background-position: center;
    }
    
    .album-info {
      padding: 1rem;
    }
    
    .album-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .album-count {
      font-size: 0.85rem;
      color: var(--bbb-text-muted);
    }
    
    .album-options {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .album-card:hover .album-options {
      opacity: 1;
    }
    
    .album-option-btn {
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 0.25rem;
    }
    
    /* Create album modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-container {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: modalSlideIn 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    .modal-form-group {
      margin-bottom: 1.25rem;
    }
    
    .modal-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .modal-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .modal-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
      resize: vertical;
    }
    
    /* Edit image modal */
    .image-edit-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .image-preview {
      background-color: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-preview img {
      max-width: 100%;
      max-height: 200px;
    }
    
    .image-form-fields {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    @media (max-width: 768px) {
      .image-edit-form {
        grid-template-columns: 1fr;
      }
    }
    
    /* Add image to album modal */
    .album-select-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
    }
    
    .album-select-item {
      border: 2px solid #eee;
      border-radius: 6px;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .album-select-item:hover {
      background-color: #f0f0f0;
    }
    
    .album-select-item.selected {
      border-color: var(--bbb-secondary);
      background-color: rgba(0, 70, 173, 0.05);
    }
    
    .album-select-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .album-select-name {
      font-size: 0.85rem;
      word-break: break-word;
    }
    
    /* Message banner */
    .info-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem 0;
      text-align: center;
    }
    
    /* Gallery breadcrumb */
    .gallery-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    
    .breadcrumb-home {
      color: var(--bbb-text-muted);
      text-decoration: none;
      cursor: pointer;
    }
    
    .breadcrumb-separator {
      color: var(--bbb-text-muted);
    }
    
    .breadcrumb-current {
      font-weight: 500;
      color: var(--bbb-secondary);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Migration section */
    .migration-section {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 6px;
      padding: 1rem;
      margin: 1.5rem 0;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .migration-icon {
      font-size: 2rem;
    }
    
    .migration-content {
      flex: 1;
    }
    
    .migration-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .migration-text {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .migration-button {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>
  
  <!-- Rest of your page content -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <!-- Album Creation Modal -->
  <div id="create-album-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Create New Album</h3>
        <button class="modal-close" id="close-album-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="album-form">
          <div class="modal-form-group">
            <label for="album-name" class="modal-label">Album Name</label>
            <input type="text" id="album-name" class="modal-input" placeholder="Enter album name" required>
          </div>
          <div class="modal-form-group">
            <label for="album-description" class="modal-label">Description (optional)</label>
            <textarea id="album-description" class="modal-textarea" placeholder="Enter album description"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancel-album">Cancel</button>
        <button class="btn" id="create-album-submit">Create Album</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Image Modal -->
  <div id="edit-image-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Edit Image Details</h3>
        <button class="modal-close" id="close-edit-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="edit-image-form" class="image-edit-form">
          <div class="image-preview">
            <img id="edit-image-preview" src="" alt="Image preview">
          </div>
          <div class="image-form-fields">
            <div class="modal-form-group">
              <label for="image-title" class="modal-label">Image Title</label>
              <input type="text" id="image-title" class="modal-input" placeholder="Enter image title">
            </div>
            <div class="modal-form-group">
              <label for="image-album" class="modal-label">Album</label>
              <select id="image-album" class="modal-input">
                <option value="">None</option>
                <!-- Album options will be populated by JavaScript -->
              </select>
            </div>
            <input type="hidden" id="edit-image-id">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancel-edit">Cancel</button>
        <button class="btn" id="save-image-details">Save Changes</button>
      </div>
    </div>
  </div>
  
  <!-- Add to Album Modal -->
  <div id="add-to-album-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Add to Album</h3>
        <button class="modal-close" id="close-add-album-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p>Select an album to add this photo to:</p>
        <div id="album-select-grid" class="album-select-grid">
          <!-- Album options will be populated by JavaScript -->
        </div>
        <div class="modal-form-group">
          <label for="new-album-name" class="modal-label">Or create a new album:</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="new-album-name" class="modal-input" placeholder="New album name">
            <button class="btn" id="quick-create-album">Create</button>
          </div>
        </div>
        <input type="hidden" id="add-to-album-image-id">
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancel-add-to-album">Cancel</button>
        <button class="btn" id="confirm-add-to-album">Add to Album</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Cloudflare worker URL - Your actual worker URL or backend API
      const API_URL = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
      
      // Album structure
      const albums = {
        list: [], // will store album objects
        activeAlbum: null // currently active album id
      };
      
      // Image collection for filtering
      let allImages = [];
      
      // Initialize modules
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Check if the user has access to the gallery
      const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
        (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
      
      if (!hasGalleryAccess) {
        // Show gallery login overlay
        showGalleryLogin();
      } else {
        // Already authenticated, initialize gallery
        initializeGallery();
      }
      
      /**
       * Show gallery login overlay
       */
      function showGalleryLogin() {
        BBB_AUTH.showGalleryLogin()
          .then(() => {
            // Login successful
            initializeGallery();
          })
          .catch(err => {
            console.error('Gallery login error:', err);
            // Redirect to login page
            window.location.href = 'login.html';
          });
      }
      
      /**
       * Initialize gallery after authentication
       */
      function initializeGallery() {
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.textContent = 'Photo Gallery';
        subtitle.id = 'gallery-title';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add gallery breadcrumb
        const breadcrumb = document.createElement('div');
        breadcrumb.className = 'gallery-breadcrumb';
        breadcrumb.id = 'gallery-breadcrumb';
        breadcrumb.style.display = 'none'; // Initially hidden
        
        const breadcrumbHome = document.createElement('span');
        breadcrumbHome.className = 'breadcrumb-home';
        breadcrumbHome.textContent = 'All Albums';
        breadcrumbHome.addEventListener('click', () => {
          // Return to album view
          albums.activeAlbum = null;
          updateGalleryView();
        });
        
        const breadcrumbSeparator = document.createElement('span');
        breadcrumbSeparator.className = 'breadcrumb-separator';
        breadcrumbSeparator.textContent = '/';
        
        const breadcrumbCurrent = document.createElement('span');
        breadcrumbCurrent.className = 'breadcrumb-current';
        breadcrumbCurrent.id = 'breadcrumb-current';
        breadcrumbCurrent.textContent = '';
        
        breadcrumb.appendChild(breadcrumbHome);
        breadcrumb.appendChild(breadcrumbSeparator);
        breadcrumb.appendChild(breadcrumbCurrent);
        mainContent.appendChild(breadcrumb);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
        mainContent.appendChild(description);
        
        // Create filter/search bar
        const filterBar = createFilterBar();
        mainContent.appendChild(filterBar);
        
        // Image upload section
        const uploadSection = document.createElement('div');
        uploadSection.className = 'upload-section';
        
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        // Create album button
        const createAlbumBtn = document.createElement('button');
        createAlbumBtn.id = 'create-album-btn';
        createAlbumBtn.className = 'create-album-btn btn';
        createAlbumBtn.textContent = 'Create Album';
        createAlbumBtn.addEventListener('click', showCreateAlbumModal);
        
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        uploadSection.appendChild(createAlbumBtn);
        mainContent.appendChild(uploadSection);
        
        // Add albums section
        const albumsSection = createAlbumsSection();
        albumsSection.id = 'albums-section';
        mainContent.appendChild(albumsSection);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';
        mainContent.appendChild(galleryContainer);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        const lightboxAlbum = document.createElement('div');
        lightboxAlbum.id = 'lightbox-album';
        lightboxAlbum.className = 'lightbox-album';
        
        // Lightbox navigation
        const lightboxNav = document.createElement('div');
        lightboxNav.className = 'lightbox-navigation';
        
        const prevBtn = document.createElement('div');
        prevBtn.className = 'lightbox-nav-btn prev-btn';
        prevBtn.innerHTML = '&#10094;';
        prevBtn.addEventListener('click', navigateLightbox.bind(null, 'prev'));
        
        const nextBtn = document.createElement('div');
        nextBtn.className = 'lightbox-nav-btn next-btn';
        nextBtn.innerHTML = '&#10095;';
        nextBtn.addEventListener('click', navigateLightbox.bind(null, 'next'));
        
        lightboxNav.appendChild(prevBtn);
        lightboxNav.appendChild(nextBtn);
        
        lightbox.appendChild(lightboxNav);
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        lightbox.appendChild(lightboxAlbum);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Load albums and gallery images
        loadAlbums()
          .then(() => {
            // After albums are loaded, load images
            loadGalleryImages();
          })
          .catch(err => {
            console.error('Error loading gallery data:', err);
            BBB_UTILS.showMessage('Error loading gallery data', 'error');
          });
        
        // Setup event handlers
        setupEventHandlers();
        setupModalHandlers();
        
        /**
         * Create filter/search bar
         */
        function createFilterBar() {
          const filterBar = document.createElement('div');
          filterBar.className = 'filter-bar';
          filterBar.id = 'filter-bar';
          
          // Search
          const searchContainer = document.createElement('div');
          searchContainer.className = 'search-container';
          
          const searchIcon = document.createElement('span');
          searchIcon.className = 'search-icon';
          searchIcon.innerHTML = 'ðŸ”';
          
          const searchInput = document.createElement('input');
          searchInput.type = 'text';
          searchInput.className = 'search-input';
          searchInput.placeholder = 'Search gallery...';
          searchInput.id = 'gallery-search';
          
          searchContainer.appendChild(searchIcon);
          searchContainer.appendChild(searchInput);
          
          // Album filter
          const albumFilter = document.createElement('div');
          albumFilter.className = 'album-filter';
          
          const albumFilterLabel = document.createElement('span');
          albumFilterLabel.className = 'album-filter-label';
          albumFilterLabel.textContent = 'Album:';
          
          const albumFilterSelect = document.createElement('select');
          albumFilterSelect.className = 'album-filter-select';
          albumFilterSelect.id = 'album-filter-select';
          
          albumFilter.appendChild(albumFilterLabel);
          albumFilter.appendChild(albumFilterSelect);
          
          // Sort
          const sortContainer = document.createElement('div');
          sortContainer.className = 'sort-container';
          
          const sortLabel = document.createElement('span');
          sortLabel.className = 'sort-label';
          sortLabel.textContent = 'Sort by:';
          
          const sortSelect = document.createElement('select');
          sortSelect.className = 'sort-select';
          sortSelect.id = 'gallery-sort';
          
          const sortOptions = [
            { value: 'newest', text: 'Newest first' },
            { value: 'oldest', text: 'Oldest first' },
            { value: 'name', text: 'Name (A-Z)' }
          ];
          
          sortOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            sortSelect.appendChild(optionEl);
          });
          
          sortContainer.appendChild(sortLabel);
          sortContainer.appendChild(sortSelect);
          
          filterBar.appendChild(searchContainer);
          filterBar.appendChild(albumFilter);
          filterBar.appendChild(sortContainer);
          
          return filterBar;
        }
        
        /**
         * Create the albums section
         */
        function createAlbumsSection() {
          // Create albums container
          const albumsSection = document.createElement('div');
          albumsSection.className = 'albums-section';
          
          const albumsHeader = document.createElement('div');
          albumsHeader.className = 'albums-header';
          
          const albumsTitle = document.createElement('h3');
          albumsTitle.className = 'albums-title';
          albumsTitle.textContent = 'Albums';
          
          const albumsToggle = document.createElement('button');
          albumsToggle.className = 'albums-toggle';
          albumsToggle.id = 'albums-toggle';
          albumsToggle.textContent = 'Hide Albums';
          albumsToggle.addEventListener('click', toggleAlbumsSection);
          
          albumsHeader.appendChild(albumsTitle);
          albumsHeader.appendChild(albumsToggle);
          albumsSection.appendChild(albumsHeader);
          
          // Create albums grid
          const albumsGrid = document.createElement('div');
          albumsGrid.className = 'albums-grid';
          albumsGrid.id = 'albums-grid';
          albumsSection.appendChild(albumsGrid);
          
          return albumsSection;
        }
        
        /**
         * Toggle visibility of albums section
         */
        function toggleAlbumsSection() {
          const albumsGrid = document.getElementById('albums-grid');
          const albumsToggle = document.getElementById('albums-toggle');
          
          if (albumsGrid.style.display === 'none') {
            albumsGrid.style.display = 'grid';
            albumsToggle.textContent = 'Hide Albums';
          } else {
            albumsGrid.style.display = 'none';
            albumsToggle.textContent = 'Show Albums';
          }
        }
        
        /**
         * Load albums from API
         */
        async function loadAlbums() {
          try {
            // First load from database
            const response = await fetch(`${API_URL}/albums`);
            if (!response.ok) {
              throw new Error(`Error fetching albums: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Add an "All Photos" album at the beginning
            albums.list = [
              { 
                id: 'all',
                name: 'All Photos', 
                description: 'All photos in the gallery', 
                createdAt: new Date(0).toISOString(),
                imageCount: 0, // This will be updated after loading images
                coverImages: []
              },
              ...data
            ];
            
            // Update album filter dropdown
            updateAlbumDropdown();
            
            return albums.list;
          } catch (err) {
            console.error('Error loading albums:', err);
            
            // Fallback with at least the "All Photos" album
            albums.list = [
              { 
                id: 'all',
                name: 'All Photos', 
                description: 'All photos in the gallery',
                createdAt: new Date(0).toISOString(),
                imageCount: 0,
                coverImages: []
              }
            ];
            
            updateAlbumDropdown();
            return albums.list;
          }
        }
        
        /**
         * Update album dropdown with current album list
         */
        function updateAlbumDropdown() {
          const dropdown = document.getElementById('album-filter-select');
          const imageAlbumDropdown = document.getElementById('image-album');
          
          if (dropdown) {
            dropdown.innerHTML = '';
            
            // Add album options
            albums.list.forEach(album => {
              const option = document.createElement('option');
              option.value = album.id;
              option.textContent = album.name;
              dropdown.appendChild(option);
            });
            
            // Add event listener
            dropdown.addEventListener('change', () => {
              const selectedAlbumId = dropdown.value;
              if (selectedAlbumId === 'all') {
                albums.activeAlbum = null;
              } else {
                albums.activeAlbum = selectedAlbumId;
              }
              
              updateGalleryView();
            });
          }
          
          // Also update album dropdown in edit image modal
          if (imageAlbumDropdown) {
            imageAlbumDropdown.innerHTML = '<option value="">None</option>';
            
            // Skip the "All Photos" album (index 0)
            albums.list.slice(1).forEach(album => {
              const option = document.createElement('option');
              option.value = album.id;
              option.textContent = album.name;
              imageAlbumDropdown.appendChild(option);
            });
          }
        }
        
        /**
         * Render albums in the albums grid
         */
        function renderAlbums() {
          const albumsGrid = document.getElementById('albums-grid');
          albumsGrid.innerHTML = '';
          
          // Create album cards
          albums.list.forEach(album => {
            // Skip rendering the "All Photos" album if we're in an album view
            if (albums.activeAlbum && album.id === 'all') {
              return;
            }
            
            const albumCard = document.createElement('div');
            albumCard.className = `album-card ${albums.activeAlbum === album.id ? 'active' : ''}`;
            albumCard.dataset.albumId = album.id;
            
            // Create thumbnail with grid of images
            const albumThumb = document.createElement('div');
            albumThumb.className = 'album-thumbnail';
            
            // If we have cover images, create a grid
            if (album.coverImages && album.coverImages.length > 0) {
              const albumGrid = document.createElement('div');
              albumGrid.className = 'album-grid';
              
              // Create grid of up to 4 images
              const maxImages = Math.min(4, album.coverImages.length);
              for (let i = 0; i < maxImages; i++) {
                const gridImg = document.createElement('div');
                gridImg.className = 'album-grid-img';
                gridImg.style.backgroundImage = `url('${album.coverImages[i]}')`;
                albumGrid.appendChild(gridImg);
              }
              
              // If we have fewer than 4 images, fill with solid color
              for (let i = album.coverImages.length; i < 4; i++) {
                const gridImg = document.createElement('div');
                gridImg.className = 'album-grid-img';
                gridImg.style.backgroundColor = '#e0e0e0';
                albumGrid.appendChild(gridImg);
              }
              
              albumThumb.appendChild(albumGrid);
            } else {
              // Default background for albums without images
              albumThumb.style.backgroundColor = '#e0e0e0';
              
              // Add folder icon
              const folderIcon = document.createElement('div');
              folderIcon.textContent = 'ðŸ“';
              folderIcon.style.fontSize = '3rem';
              folderIcon.style.color = '#666';
              folderIcon.style.display = 'flex';
              folderIcon.style.alignItems = 'center';
              folderIcon.style.justifyContent = 'center';
              folderIcon.style.height = '100%';
              
              albumThumb.appendChild(folderIcon);
            }
            
            const albumInfo = document.createElement('div');
            albumInfo.className = 'album-info';
            
            const albumTitle = document.createElement('div');
            albumTitle.className = 'album-title';
            albumTitle.textContent = album.name;
            
            const albumCount = document.createElement('div');
            albumCount.className = 'album-count';
            albumCount.textContent = `${album.imageCount} photo${album.imageCount !== 1 ? 's' : ''}`;
            
            albumInfo.appendChild(albumTitle);
            albumInfo.appendChild(albumCount);
            
            // Album options (admin only)
            if (BBB_AUTH.hasRole('admin') && album.id !== 'all') {
              const albumOptions = document.createElement('div');
              albumOptions.className = 'album-options';
              
              const editBtn = document.createElement('button');
              editBtn.className = 'album-option-btn';
              editBtn.innerHTML = 'âœï¸';
              editBtn.title = 'Edit Album';
              editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // This would open an edit album modal
                alert(`Edit album: ${album.name}`);
              });
              
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'album-option-btn';
              deleteBtn.innerHTML = 'ðŸ—‘ï¸';
              deleteBtn.title = 'Delete Album';
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Are you sure you want to delete the album "${album.name}"? This will not delete the photos in the album.`)) {
                  deleteAlbum(album.id);
                }
              });
              
              albumOptions.appendChild(editBtn);
              albumOptions.appendChild(deleteBtn);
              albumCard.appendChild(albumOptions);
            }
            
            // Add click handler for album selection
            albumCard.addEventListener('click', () => {
              albums.activeAlbum = album.id;
              updateGalleryView();
            });
            
            albumCard.appendChild(albumThumb);
            albumCard.appendChild(albumInfo);
            albumsGrid.appendChild(albumCard);
          });
        }
        
        /**
         * Delete an album
         * @param {string} albumId - Album ID to delete
         */
        async function deleteAlbum(albumId) {
          try {
            BBB_UTILS.showMessage('Deleting album...', 'info');
            
            const response = await fetch(`${API_URL}/album/${albumId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`Error deleting album: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
              // Remove album from list
              albums.list = albums.list.filter(album => album.id !== albumId);
              
              // Update album view
              updateAlbumDropdown();
              renderAlbums();
              
              // Remove album from images
              allImages = allImages.map(image => {
                if (image.albumId === albumId) {
                  return { ...image, albumId: null };
                }
                return image;
              });
              
              // Reload images if we're in that album
              if (albums.activeAlbum === albumId) {
                albums.activeAlbum = null;
              }
              
              updateGalleryView();
              
              BBB_UTILS.showMessage('Album deleted successfully', 'success');
            } else {
              BBB_UTILS.showMessage(`Error deleting album: ${data.error || 'Unknown error'}`, 'error');
            }
          } catch (err) {
            console.error('Error deleting album:', err);
            BBB_UTILS.showMessage(`Error deleting album: ${err.message}`, 'error');
          }
        }
        
        /**
         * Update the gallery view based on active album
         */
        function updateGalleryView() {
          const galleryTitle = document.getElementById('gallery-title');
          const breadcrumb = document.getElementById('gallery-breadcrumb');
          const breadcrumbCurrent = document.getElementById('breadcrumb-current');
          const albumsSection = document.getElementById('albums-section');
          const filterBar = document.getElementById('filter-bar');
          
          if (albums.activeAlbum && albums.activeAlbum !== 'all') {
            // We're viewing a specific album
            const album = albums.list.find(a => a.id === albums.activeAlbum);
            
            if (album) {
              // Update title and breadcrumb
              galleryTitle.textContent = album.name;
              breadcrumbCurrent.textContent = album.name;
              breadcrumb.style.display = 'flex';
              
              // Hide albums section and show filter bar
              albumsSection.style.display = 'none';
              filterBar.style.display = 'flex';
              
              // Update album filter dropdown
              const albumFilter = document.getElementById('album-filter-select');
              if (albumFilter) {
                albumFilter.value = album.id;
              }
              
              // Filter images by this album
              const albumImages = allImages.filter(image => image.albumId === album.id);
              renderGallery(albumImages);
            } else {
              // Album not found, reset to all photos
              albums.activeAlbum = null;
              updateGalleryView();
            }
          } else {
            // Show all photos
            galleryTitle.textContent = 'Photo Gallery';
            breadcrumb.style.display = 'none';
            
            // Show albums section and filter bar
            albumsSection.style.display = 'block';
            filterBar.style.display = 'flex';
            
            // Update album filter dropdown
            const albumFilter = document.getElementById('album-filter-select');
            if (albumFilter) {
              albumFilter.value = 'all';
            }
            
            // Render all albums
            renderAlbums();
            
            // Render all images or filter by search
            const searchInput = document.getElementById('gallery-search');
            const searchValue = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            if (searchValue) {
              const filteredImages = allImages.filter(image => 
                image.alt.toLowerCase().includes(searchValue)
              );
              renderGallery(filteredImages);
            } else {
              renderGallery(allImages);
            }
          }
        }
        
        /**
         * Load gallery images from API
         */
        async function loadGalleryImages() {
          try {
            BBB_UTILS.showMessage('Loading gallery images...', 'info');
            
            // Check sort and search options
            const sortSelect = document.getElementById('gallery-sort');
            const searchInput = document.getElementById('gallery-search');
            
            const sortValue = sortSelect ? sortSelect.value : 'newest';
            const searchValue = searchInput ? searchInput.value.trim() : '';
            
            // Build the API URL with any search parameters
            let apiUrl = `${API_URL}/images`;
            
            if (searchValue) {
              apiUrl += `?search=${encodeURIComponent(searchValue)}`;
            }
            
            // Fetch from API
            const response = await fetch(apiUrl);
            if (!response.ok) {
              throw new Error(`Error fetching gallery: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Convert to our format
            allImages = data.map(img => ({
              id: img.id,
              src: `${API_URL}/image/${img.id}`,
              alt: img.alt || 'Gallery image',
              albumId: img.album_id || null,
              uploadedAt: img.uploaded_at,
              uploadedBy: img.uploaded_by
            }));
            
            // Sort images
            sortImages(sortValue);
            
            // Update album cover images
            updateAlbumCovers();
            
            // Update image counts for albums
            updateAlbumImageCounts();
            
            // Render albums
            renderAlbums();
            
            // Update gallery view based on active album
            updateGalleryView();
            
            // Hide loading message
            BBB_UTILS.showMessage('', 'info');
            
            // Check if we need to migrate images from localStorage
            checkMigrationNeeded();
            
            return allImages;
          } catch (err) {
            console.error('Error loading gallery images:', err);
            BBB_UTILS.showMessage('Error loading gallery images', 'error');
            
            // Render empty gallery
            renderGallery([]);
            return [];
          }
        }
        
        /**
         * Sort images based on sort value
         * @param {string} sortValue - Sort option
         */
        function sortImages(sortValue) {
          if (sortValue === 'oldest') {
            allImages.sort((a, b) => new Date(a.uploadedAt) - new Date(b.uploadedAt));
          } else if (sortValue === 'name') {
            allImages.sort((a, b) => a.alt.localeCompare(b.alt));
          } else {
            // Default: newest first
            allImages.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
          }
        }
        
        /**
         * Update album cover images
         */
        function updateAlbumCovers() {
          // For each album (except the "All Photos" album)
          albums.list.slice(1).forEach(album => {
            // Find images in this album
            const albumImages = allImages.filter(img => img.albumId === album.id);
            
            // Get up to 4 images for the cover
            album.coverImages = albumImages.slice(0, 4).map(img => img.src);
          });
          
          // "All Photos" album gets the 4 most recent photos
          if (albums.list.length > 0) {
            albums.list[0].coverImages = allImages.slice(0, 4).map(img => img.src);
          }
        }
        
        /**
         * Update image counts for albums
         */
        function updateAlbumImageCounts() {
          // For each album (except the "All Photos" album)
          albums.list.slice(1).forEach(album => {
            // Count images in this album
            album.imageCount = allImages.filter(img => img.albumId === album.id).length;
          });
          
          // "All Photos" album gets the total count
          if (albums.list.length > 0) {
            albums.list[0].imageCount = allImages.length;
          }
        }
        
        /**
         * Render gallery with images
         * @param {Array} images - Array of image objects
         */
        function renderGallery(images) {
          const galleryElement = document.getElementById('gallery');
          galleryElement.innerHTML = '';
          
          // Create gallery
          images.forEach(image => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'gallery-img-container';
            imgContainer.dataset.id = image.id;
            
            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || 'Gallery image';
            img.className = 'gallery-img';
            img.setAttribute('loading', 'lazy');
            
            // Add timestamp info
            const imageInfo = document.createElement('div');
            imageInfo.className = 'image-info';
            
            let uploadDate = 'Unknown date';
            if (image.uploadedAt) {
              uploadDate = new Date(image.uploadedAt).toLocaleDateString();
            }
            
            imageInfo.textContent = uploadDate;
            
            // Add album badge if the image has an album
            if (image.albumId && image.albumId !== 'all') {
              const album = albums.list.find(a => a.id === image.albumId);
              if (album) {
                const albumBadge = document.createElement('div');
                albumBadge.className = 'album-badge';
                albumBadge.textContent = album.name;
                imgContainer.appendChild(albumBadge);
              }
            }
            
            // Add action buttons
            const imageActions = document.createElement('div');
            imageActions.className = 'image-actions';
            
            // View button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'image-action-btn view-btn';
            viewBtn.innerHTML = 'ðŸ‘ï¸ View';
            viewBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              openLightbox(image, images);
            });
            
            // Edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'image-action-btn edit-btn';
            editBtn.innerHTML = 'âœï¸ Edit';
            editBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              showEditImageModal(image);
            });
            
            // Add to album button
            const albumBtn = document.createElement('button');
            albumBtn.className = 'image-action-btn album-btn';
            albumBtn.innerHTML = 'ðŸ“‚ Album';
            albumBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              showAddToAlbumModal(image);
            });
            
            // Delete button (only show if admin or image was uploaded by current user)
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'image-action-btn delete-btn';
            deleteBtn.innerHTML = 'ðŸ—‘ï¸ Delete';
            
            const canDelete = BBB_AUTH.hasRole('admin') || 
                              (image.uploadedBy && BBB_AUTH.currentUser && 
                               image.uploadedBy === BBB_AUTH.currentUser.id);
            
            imageActions.appendChild(viewBtn);
            imageActions.appendChild(editBtn);
            imageActions.appendChild(albumBtn);
            
            if (canDelete) {
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
                  deleteImage(image.id);
                }
              });
              imageActions.appendChild(deleteBtn);
            }
            
            // Add click handler for lightbox
            imgContainer.addEventListener('click', () => {
              openLightbox(image, images);
            });
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(imageInfo);
            imgContainer.appendChild(imageActions);
            
            galleryElement.appendChild(imgContainer);
          });
          
          // If no images, show message
          if (images.length === 0) {
            const noImages = document.createElement('div');
            noImages.className = 'empty-gallery';
            
            const noImagesIcon = document.createElement('div');
            noImagesIcon.innerHTML = 'ðŸ“·';
            noImagesIcon.style.fontSize = '3rem';
            noImagesIcon.style.marginBottom = '1rem';
            
            const noImagesText = document.createElement('p');
            
            if (albums.activeAlbum && albums.activeAlbum !== 'all') {
              noImagesText.textContent = 'No images in this album yet. Upload some photos and add them to this album!';
            } else if (document.getElementById('gallery-search').value.trim()) {
              noImagesText.textContent = 'No images match your search. Try a different search term.';
            } else {
              noImagesText.textContent = 'No images in the gallery yet. Upload some photos to get started!';
            }
            
            noImages.appendChild(noImagesIcon);
            noImages.appendChild(noImagesText);
            galleryElement.appendChild(noImages);
          }
        }
        
        /**
         * Setup event handlers for gallery
         */
        function setupEventHandlers() {
          // Upload handler
          const uploadInput = document.getElementById('image-upload');
          uploadInput.addEventListener('change', handleImageUpload);
          
          // Search handler
          const searchInput = document.getElementById('gallery-search');
          searchInput.addEventListener('input', debounce(() => {
            const searchValue = searchInput.value.trim().toLowerCase();
            
            if (albums.activeAlbum && albums.activeAlbum !== 'all') {
              // Filter within the active album
              const filteredImages = allImages.filter(image => 
                image.albumId === albums.activeAlbum && 
                image.alt.toLowerCase().includes(searchValue)
              );
              renderGallery(filteredImages);
            } else {
              // Filter all images
              const filteredImages = allImages.filter(image => 
                image.alt.toLowerCase().includes(searchValue)
              );
              renderGallery(filteredImages);
            }
          }, 500));
          
          // Sort handler
          const sortSelect = document.getElementById('gallery-sort');
          sortSelect.addEventListener('change', () => {
            const sortValue = sortSelect.value;
            sortImages(sortValue);
            
            // Re-render current view
            if (albums.activeAlbum && albums.activeAlbum !== 'all') {
              // Filter by active album
              const albumImages = allImages.filter(image => image.albumId === albums.activeAlbum);
              renderGallery(albumImages);
            } else {
              renderGallery(allImages);
            }
          });
