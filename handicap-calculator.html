<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Handicap Calculator</title>
  <meta name="description" content="Calculate your golf handicap using the World Handicap System standard.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize auth system
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      // Initialize database
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Create header
      const headerElements = BBB_UI.createHeader({
        fixed: true,
        showHomeLinkText: true
      });
      
      document.body.insertBefore(headerElements.header, document.body.firstChild);
      
      // Get main content element
      const main = document.getElementById('main');
      main.appendChild(headerElements.mainWrapper);
      
      // Create page content
      const mainContent = document.createElement('div');
      
      // Create page title
      const titleContainer = BBB_UI.createPageTitle({
        title: 'Birdie Bush Bandits',
        showFoundedText: true,
        showGolfballs: true
      });
      mainContent.appendChild(titleContainer);
      
      // Add page subtitle
      const subtitle = document.createElement('h2');
      subtitle.textContent = 'Handicap Calculator';
      mainContent.appendChild(subtitle);
      
      // Create status message container
      const statusMessage = BBB_UI.createStatusMessage();
      mainContent.appendChild(statusMessage);
      
      // Create calculator container
      const calculatorContainer = document.createElement('div');
      calculatorContainer.id = 'handicap-calculator';
      calculatorContainer.className = 'calculator';
      
      // Create member selection section
      const memberSection = document.createElement('div');
      memberSection.className = 'member-selection-section';
      
      const memberLabel = document.createElement('label');
      memberLabel.textContent = 'Calculate Handicap For:';
      memberLabel.htmlFor = 'member-select';
      
      const memberSelect = document.createElement('select');
      memberSelect.id = 'member-select';
      memberSelect.className = 'member-select';
      
      // Populate members dropdown
      if (BBB_CONFIG.members && BBB_CONFIG.members.length > 0) {
        // Add a "Select Member" option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Select Member --';
        memberSelect.appendChild(defaultOption);
        
        // Add all members from config
        BBB_CONFIG.members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.toLowerCase();
          option.textContent = member;
          
          // If logged in user matches this member, select it by default
          if (BBB_AUTH.isAuthenticated && 
              BBB_AUTH.currentUser && 
              BBB_AUTH.currentUser.id === member.toLowerCase()) {
            option.selected = true;
          }
          
          memberSelect.appendChild(option);
        });
      } else {
        // If no members in config, create a default option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No members found';
        memberSelect.appendChild(option);
      }
      
      // Add admin message for permissions
      const adminMessage = document.createElement('div');
      adminMessage.className = 'admin-message';
      adminMessage.style.display = 'none';
      adminMessage.innerHTML = '<small>As an admin, you can calculate and save handicaps for any member.</small>';
      
      // Check if user is an admin and show message
      if (BBB_AUTH.isAuthenticated && BBB_AUTH.hasRole('admin')) {
        adminMessage.style.display = 'block';
      }
      
      // Add elements to member section
      memberSection.appendChild(memberLabel);
      memberSection.appendChild(memberSelect);
      memberSection.appendChild(adminMessage);
      
      // Create help section
      const helpToggle = document.createElement('button');
      helpToggle.className = 'btn help-toggle';
      helpToggle.textContent = 'Show Help';
      helpToggle.onclick = function() {
        const helpSection = document.getElementById('help-section');
        if (helpSection.style.display === 'none') {
          helpSection.style.display = 'block';
          helpToggle.textContent = 'Hide Help';
        } else {
          helpSection.style.display = 'none';
          helpToggle.textContent = 'Show Help';
        }
      };
      
      const helpSection = document.createElement('div');
      helpSection.id = 'help-section';
      helpSection.className = 'help-section';
      helpSection.style.display = 'none';
      helpSection.innerHTML = `
        <h3>How to Use the Handicap Calculator</h3>
        <ol>
          <li>Select the member whose handicap you want to calculate.</li>
          <li>Enter details for at least 3 rounds of golf (up to 20).</li>
          <li>For each round, select the course and tee color played.</li>
          <li>Enter the gross score for the round.</li>
          <li>The course rating and slope rating will be filled automatically.</li>
          <li>Your score differential will be calculated automatically.</li>
          <li>Click "Calculate Handicap" to get the handicap index.</li>
          <li>Click "Save Handicap" to save it to the member's profile.</li>
        </ol>
        <p>The handicap index is calculated using the World Handicap System (WHS) formula.</p>
      `;
      
      // Create result display
      const resultDisplay = document.createElement('div');
      resultDisplay.id = 'handicap-result';
      resultDisplay.className = 'result';
      
      // Create instructions text
      const instructions = document.createElement('p');
      instructions.textContent = 'Enter up to 20 rounds. Minimum 3 to calculate.';
      
      // Rounds container
      const roundsContainer = document.createElement('div');
      roundsContainer.id = 'rounds-container';
      
      // Create button container
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-group';
      
      // Add Round button
      const addButton = document.createElement('button');
      addButton.id = 'add-round';
      addButton.className = 'btn';
      addButton.textContent = 'Add Round';
      addButton.onclick = function() {
        if (roundsContainer.children.length < 20) {
          addRoundInput();
          updateAllDifferentials();
        } else {
          BBB_UTILS.showMessage('Maximum 20 rounds allowed.', 'warning');
        }
      };
      
      // Calculate button
      const calculateButton = document.createElement('button');
      calculateButton.id = 'calculate';
      calculateButton.className = 'btn';
      calculateButton.textContent = 'Calculate Handicap';
      calculateButton.onclick = calculateHandicap;
      
      // Reset button
      const resetButton = document.createElement('button');
      resetButton.id = 'reset';
      resetButton.className = 'btn';
      resetButton.textContent = 'Reset';
      resetButton.onclick = resetCalculator;
      
      // Save button
      const saveButton = document.createElement('button');
      saveButton.id = 'save';
      saveButton.className = 'btn';
      saveButton.textContent = 'Save Handicap';
      saveButton.disabled = true;
      saveButton.onclick = saveHandicap;
      
      // Export button
      const exportButton = document.createElement('button');
      exportButton.id = 'export';
      exportButton.className = 'btn';
      exportButton.textContent = 'Export to CSV';
      exportButton.onclick = exportToCSV;
      
      // Add buttons to container
      buttonContainer.appendChild(addButton);
      buttonContainer.appendChild(calculateButton);
      buttonContainer.appendChild(resetButton);
      buttonContainer.appendChild(saveButton);
      buttonContainer.appendChild(exportButton);
      
      // Create handicap history section
      const historySection = document.createElement('div');
      historySection.id = 'handicap-history';
      historySection.className = 'history-section';
      historySection.style.display = 'none';
      
      // Add elements to calculator container
      calculatorContainer.appendChild(memberSection);
      calculatorContainer.appendChild(helpToggle);
      calculatorContainer.appendChild(helpSection);
      calculatorContainer.appendChild(resultDisplay);
      calculatorContainer.appendChild(instructions);
      calculatorContainer.appendChild(createTableHeader());
      calculatorContainer.appendChild(roundsContainer);
      calculatorContainer.appendChild(buttonContainer);
      calculatorContainer.appendChild(historySection);
      
      // Add calculator container to page
      mainContent.appendChild(calculatorContainer);
      
      // Add content to main wrapper
      headerElements.mainWrapper.appendChild(mainContent);
      
      // Add initial rounds
      for (let i = 0; i < 3; i++) {
        addRoundInput();
      }
      
      // Setup member select change event
      memberSelect.addEventListener('change', function() {
        loadSavedHandicap(this.value);
      });
      
      // Load saved handicap data for current selection
      if (memberSelect.value) {
        loadSavedHandicap(memberSelect.value);
      }
      
      // Function to create table header
      function createTableHeader() {
        const table = document.createElement('table');
        table.id = 'rounds-table';
        table.className = 'rounds-table';
        
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // Define column headers
        const headers = [
          '#', 'Course', 'Tee', 'Score', 'Course Rating', 'Slope Rating', 'Differential', 'Action'
        ];
        
        // Create header cells
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        tbody.id = 'rounds-tbody';
        table.appendChild(tbody);
        
        return table;
      }
      
      // Function to add a round input
      function addRoundInput() {
        const tbody = document.getElementById('rounds-tbody');
        const roundIndex = tbody.children.length;
        
        const row = document.createElement('tr');
        row.id = `round-${roundIndex}`;
        row.className = 'round-row';
        
        // Round number
        const numCell = document.createElement('td');
        numCell.textContent = roundIndex + 1;
        
        // Course selection
        const courseCell = document.createElement('td');
        const courseSelect = document.createElement('select');
        courseSelect.className = 'course-select';
        courseSelect.id = `course-${roundIndex}`;
        
        // Add course options from config
        for (const courseName in BBB_CONFIG.courses) {
          const option = document.createElement('option');
          option.value = courseName;
          option.textContent = courseName;
          courseSelect.appendChild(option);
        }
        
        courseCell.appendChild(courseSelect);
        
        // Tee selection
        const teeCell = document.createElement('td');
        const teeSelect = document.createElement('select');
        teeSelect.className = 'tee-select';
        teeSelect.id = `tee-${roundIndex}`;
        
        // Add tee options from config
        for (const teeValue in BBB_CONFIG.teeColors) {
          const option = document.createElement('option');
          option.value = teeValue;
          option.textContent = BBB_CONFIG.teeColors[teeValue];
          teeSelect.appendChild(option);
        }
        
        teeCell.appendChild(teeSelect);
        
        // Score input
        const scoreCell = document.createElement('td');
        const scoreInput = document.createElement('input');
        scoreInput.type = 'number';
        scoreInput.min = '0';
        scoreInput.className = 'score-input';
        scoreInput.id = `score-${roundIndex}`;
        scoreCell.appendChild(scoreInput);
        
        // Course Rating display
        const crCell = document.createElement('td');
        const crInput = document.createElement('input');
        crInput.type = 'number';
        crInput.step = '0.1';
        crInput.className = 'cr-input';
        crInput.id = `cr-${roundIndex}`;
        crCell.appendChild(crInput);
        
        // Slope Rating display
        const srCell = document.createElement('td');
        const srInput = document.createElement('input');
        srInput.type = 'number';
        srInput.min = '55';
        srInput.max = '155';
        srInput.className = 'sr-input';
        srInput.id = `sr-${roundIndex}`;
        srCell.appendChild(srInput);
        
        // Differential display
        const diffCell = document.createElement('td');
        const diffSpan = document.createElement('span');
        diffSpan.className = 'differential';
        diffSpan.id = `diff-${roundIndex}`;
        diffCell.appendChild(diffSpan);
        
        // Remove button
        const actionCell = document.createElement('td');
        const removeButton = document.createElement('button');
        removeButton.className = 'remove-btn';
        removeButton.textContent = 'âœ•';
        removeButton.onclick = function() {
          if (tbody.children.length > 3) {
            row.remove();
            // Renumber rows
            Array.from(tbody.children).forEach((row, idx) => {
              row.querySelector('td:first-child').textContent = idx + 1;
              row.id = `round-${idx}`;
            });
          } else {
            BBB_UTILS.showMessage('Minimum 3 rounds required.', 'warning');
          }
        };
        actionCell.appendChild(removeButton);
        
        // Add all cells to row
        row.appendChild(numCell);
        row.appendChild(courseCell);
        row.appendChild(teeCell);
        row.appendChild(scoreCell);
        row.appendChild(crCell);
        row.appendChild(srCell);
        row.appendChild(diffCell);
        row.appendChild(actionCell);
        
        // Add row to table
        tbody.appendChild(row);
        
        // Set up event handlers to update ratings and differential
        function updateRatings() {
          const selectedCourse = courseSelect.value;
          const selectedTee = teeSelect.value;
          
          // Get ratings from config
          if (BBB_CONFIG.courses[selectedCourse] && 
              BBB_CONFIG.courses[selectedCourse].tees && 
              BBB_CONFIG.courses[selectedCourse].tees[selectedTee]) {
            crInput.value = BBB_CONFIG.courses[selectedCourse].tees[selectedTee].courseRating;
            srInput.value = BBB_CONFIG.courses[selectedCourse].tees[selectedTee].slopeRating;
          }
          
          updateDifferential(roundIndex);
        }
        
        // Add event listeners
        courseSelect.addEventListener('change', updateRatings);
        teeSelect.addEventListener('change', updateRatings);
        scoreInput.addEventListener('input', function() { updateDifferential(roundIndex); });
        crInput.addEventListener('input', function() { updateDifferential(roundIndex); });
        srInput.addEventListener('input', function() { updateDifferential(roundIndex); });
        
        // Initial update
        updateRatings();
      }
      
      // Update differential for a specific round
      function updateDifferential(index) {
        const scoreInput = document.getElementById(`score-${index}`);
        const crInput = document.getElementById(`cr-${index}`);
        const srInput = document.getElementById(`sr-${index}`);
        const diffSpan = document.getElementById(`diff-${index}`);
        
        const score = parseFloat(scoreInput.value);
        const courseRating = parseFloat(crInput.value);
        const slopeRating = parseFloat(srInput.value);
        
        if (!isNaN(score) && !isNaN(courseRating) && !isNaN(slopeRating)) {
          // Calculate differential using formula: (Score - CR) * (113 / SR)
          const differential = ((score - courseRating) * 113 / slopeRating).toFixed(1);
          diffSpan.textContent = differential;
          diffSpan.dataset.value = differential; // Store for calculation
        } else {
          diffSpan.textContent = '';
          diffSpan.dataset.value = '';
        }
      }
      
      // Update all differentials
      function updateAllDifferentials() {
        const tbody = document.getElementById('rounds-tbody');
        Array.from(tbody.children).forEach((row, idx) => {
          updateDifferential(idx);
        });
      }
      
      // Calculate handicap
      function calculateHandicap() {
        const differentials = [];
        const tbody = document.getElementById('rounds-tbody');
        
        // Collect all differentials
        Array.from(tbody.children).forEach(row => {
          const diffSpan = row.querySelector('.differential');
          const diffValue = parseFloat(diffSpan.dataset.value);
          
          if (!isNaN(diffValue)) {
            differentials.push(diffValue);
          }
        });
        
        // Check if we have enough differentials
        if (differentials.length < 3) {
          BBB_UTILS.showMessage('Please enter at least 3 complete rounds.', 'error');
          return;
        }
        
        // Get selected member
        const memberSelect = document.getElementById('member-select');
        const selectedMember = memberSelect.options[memberSelect.selectedIndex].text;
        
        // Calculate handicap using BBB_UTILS if available
        let handicapIndex;
        if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.calculateHandicapIndex === 'function') {
          handicapIndex = BBB_UTILS.calculateHandicapIndex(differentials);
        } else {
          // Directly calculate if not available
          differentials.sort((a, b) => a - b);
          
          // Determine how many scores to use based on the number of differentials
          let countToUse;
          if (differentials.length <= 3) countToUse = 1;
          else if (differentials.length <= 6) countToUse = 2;
          else if (differentials.length <= 8) countToUse = 3;
          else if (differentials.length <= 11) countToUse = 4;
          else if (differentials.length <= 14) countToUse = 5;
          else if (differentials.length <= 16) countToUse = 6;
          else if (differentials.length <= 18) countToUse = 7;
          else if (differentials.length <= 19) countToUse = 8;
          else countToUse = 10;
          
          // Calculate average of best differentials
          const bestDifferentials = differentials.slice(0, countToUse);
          const average = bestDifferentials.reduce((sum, diff) => sum + diff, 0) / countToUse;
          
          // Apply 0.96 multiplier
          handicapIndex = (average * 0.96).toFixed(1);
        }
        
        // Display result
        const resultDisplay = document.getElementById('handicap-result');
        resultDisplay.innerHTML = `
          <div class="handicap-result-inner">
            <h3>${selectedMember}'s Handicap Index is</h3>
            <div class="handicap-value">${handicapIndex}</div>
            <div class="handicap-info">Calculated using ${differentials.length} rounds</div>
          </div>
        `;
        resultDisplay.style.display = 'block';
        
        // Enable save button if user is authenticated and member is selected
        const memberSelect = document.getElementById('member-select');
        if (BBB_AUTH.isAuthenticated && memberSelect.value) {
          document.getElementById('save').disabled = false;
        }
        
        // Store for later saving
        resultDisplay.dataset.value = handicapIndex;
        
        BBB_UTILS.showMessage('Handicap calculated successfully!', 'success');
      }
      
      // Reset calculator
      function resetCalculator() {
        if (confirm('Are you sure you want to reset the calculator? This will clear all rounds.')) {
          // Clear existing rounds
          const tbody = document.getElementById('rounds-tbody');
          tbody.innerHTML = '';
          
          // Add 3 initial rounds
          for (let i = 0; i < 3; i++) {
            addRoundInput();
          }
          
          // Clear result
          const resultDisplay = document.getElementById('handicap-result');
          resultDisplay.innerHTML = '';
          resultDisplay.style.display = 'none';
          delete resultDisplay.dataset.value;
          
          // Disable save button
          document.getElementById('save').disabled = true;
          
          BBB_UTILS.showMessage('Calculator has been reset.', 'success');
        }
      }
      
      // Save handicap to user profile
      function saveHandicap() {
        if (!BBB_AUTH.isAuthenticated) {
          BBB_UTILS.showMessage('Please log in to save handicap.', 'error');
          return;
        }
        
        const resultDisplay = document.getElementById('handicap-result');
        const handicapIndex = resultDisplay.dataset.value;
        
        if (!handicapIndex) {
          BBB_UTILS.showMessage('Please calculate handicap first.', 'error');
          return;
        }
        
        // Get selected member
        const memberSelect = document.getElementById('member-select');
        const selectedMemberId = memberSelect.value;
        
        if (!selectedMemberId) {
          BBB_UTILS.showMessage('Please select a member.', 'error');
          return;
        }
        
        // Check permissions for saving to other members' profiles
        if (selectedMemberId !== BBB_AUTH.currentUser.id && !BBB_AUTH.hasRole('admin')) {
          BBB_UTILS.showMessage('You can only save handicaps to your own profile unless you are an admin.', 'error');
          return;
        }
        
        // Collect differentials
        const differentials = [];
        const tbody = document.getElementById('rounds-tbody');
        
        Array.from(tbody.children).forEach(row => {
          const diffSpan = row.querySelector('.differential');
          const diffValue = parseFloat(diffSpan.dataset.value);
          
          if (!isNaN(diffValue)) {
            differentials.push(diffValue);
          }
        });
        
        // Create handicap data
        const handicapData = {
          index: handicapIndex,
          calculatedAt: new Date().toISOString(),
          rounds: differentials.length,
          differentials: differentials
        };
        
        // Save to database
        if (typeof BBB_DB !== 'undefined' && typeof BBB_DB.saveMemberHandicap === 'function') {
          BBB_DB.saveMemberHandicap(selectedMemberId, handicapData)
            .then(() => {
              BBB_UTILS.showMessage('Handicap saved successfully!', 'success');
              loadSavedHandicap(selectedMemberId);
            })
            .catch(err => {
              console.error('Error saving handicap:', err);
              BBB_UTILS.showMessage('Error saving handicap.', 'error');
            });
        } else {
          // Fallback to localStorage
          try {
            const savedHandicaps = JSON.parse(localStorage.getItem('handicap_history') || '[]');
            savedHandicaps.push({
              ...handicapData,
              savedAt: new Date().toISOString(),
              id: `hcp_${Date.now()}`,
              memberId: selectedMemberId
            });
            localStorage.setItem('handicap_history', JSON.stringify(savedHandicaps));
            BBB_UTILS.showMessage('Handicap saved to browser storage!', 'success');
            loadSavedHandicap(selectedMemberId);
          } catch (error) {
            console.error('Error saving to localStorage:', error);
            BBB_UTILS.showMessage('Error saving handicap.', 'error');
          }
        }
      }
      
      // Load saved handicap data for a specific member
      function loadSavedHandicap(memberId) {
        if (!memberId) return;
        
        const historySection = document.getElementById('handicap-history');
        
        if (typeof BBB_DB !== 'undefined' && typeof BBB_DB.getMemberHandicap === 'function') {
          BBB_DB.getMemberHandicap(memberId)
            .then(data => {
              if (data) {
                displayHandicapHistory([data], memberId);
              } else {
                // If no data found, clear history
                historySection.innerHTML = '';
                historySection.style.display = 'none';
              }
            })
            .catch(err => {
              console.error('Error loading handicap history:', err);
              historySection.innerHTML = '';
              historySection.style.display = 'none';
            });
        } else {
          // Fallback to localStorage
          try {
            const savedHandicaps = JSON.parse(localStorage.getItem('handicap_history') || '[]');
            const memberHandicaps = savedHandicaps.filter(h => h.memberId === memberId);
            
            if (memberHandicaps.length > 0) {
              displayHandicapHistory(memberHandicaps, memberId);
            } else {
              // If no data found, clear history
              historySection.innerHTML = '';
              historySection.style.display = 'none';
            }
          } catch (error) {
            console.error('Error loading from localStorage:', error);
            historySection.innerHTML = '';
            historySection.style.display = 'none';
          }
        }
      }
      
      // Display handicap history
      function displayHandicapHistory(handicapData, memberId) {
        if (!handicapData || handicapData.length === 0) return;
        
        const historySection = document.getElementById('handicap-history');
        const memberSelect = document.getElementById('member-select');
        const memberName = Array.from(memberSelect.options).find(opt => opt.value === memberId)?.text || 'Selected Member';
        
        historySection.innerHTML = '';
        historySection.style.display = 'block';
        
        // Create heading
        const heading = document.createElement('h3');
        heading.textContent = `${memberName}'s Handicap History`;
        historySection.appendChild(heading);
        
        // Create history cards container
        const cardsContainer = document.createElement('div');
        cardsContainer.className = 'history-cards';
        
        // Add cards for each handicap calculation
        handicapData.forEach(item => {
          const card = document.createElement('div');
          card.className = 'history-card';
          
          const indexValue = document.createElement('div');
          indexValue.className = 'history-index';
          indexValue.textContent = `Index: ${item.index}`;
          
          const dateValue = document.createElement('div');
          dateValue.className = 'history-date';
          dateValue.textContent = `Calculated: ${new Date(item.calculatedAt).toLocaleDateString()}`;
          
          const roundsValue = document.createElement('div');
          roundsValue.className = 'history-rounds';
          roundsValue.textContent = `Rounds used: ${item.rounds || item.differentials?.length || 'Unknown'}`;
          
          card.appendChild(indexValue);
          card.appendChild(dateValue);
          card.appendChild(roundsValue);
          
          cardsContainer.appendChild(card);
        });
        
        historySection.appendChild(cardsContainer);
      }
      
      // Export data to CSV
      function exportToCSV() {
        const tbody = document.getElementById('rounds-tbody');
        
        if (tbody.children.length === 0) {
          BBB_UTILS.showMessage('No rounds to export.', 'error');
          return;
        }
        
        // Get selected member
        const memberSelect = document.getElementById('member-select');
        const selectedMember = memberSelect.options[memberSelect.selectedIndex].text;
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += `Handicap Data for ${selectedMember}\n`;
        csvContent += "Course,Tee,Score,Course Rating,Slope Rating,Differential\n";
        
        Array.from(tbody.children).forEach(row => {
          const course = row.querySelector('.course-select').value;
          const tee = row.querySelector('.tee-select').value;
          const score = row.querySelector('.score-input').value;
          const cr = row.querySelector('.cr-input').value;
          const sr = row.querySelector('.sr-input').value;
          const diff = row.querySelector('.differential').textContent;
          
          csvContent += `${course},${tee},${score},${cr},${sr},${diff}\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${selectedMember.replace(/\s+/g, '_')}_handicap_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        BBB_UTILS.showMessage('Exported to CSV file.', 'success');
      }
    });
  </script>
  
  <style>
    /* Handicap Calculator Specific Styles */
    .calculator {
      background: #f9f9f9;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 1.5rem;
    }
    
    .member-selection-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #ddd;
    }
    
    .member-selection-section label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    
    .member-select {
      width: 100%;
      max-width: 300px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    
    .admin-message {
      color: #666;
      font-style: italic;
    }
    
    .help-toggle {
      margin-bottom: 1rem;
      background-color: #004d00;
    }
    
    .help-section {
      background-color: #e7f5ff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border: 1px solid #cce5ff;
    }
    
    .help-section h3 {
      margin-top: 0;
      color: #004085;
    }
    
    .help-section ol {
      padding-left: 1.5rem;
    }
    
    .help-section li {
      margin-bottom: 0.5rem;
    }
    
    .rounds-table {
      width: 100%;
      margin-bottom: 1.5rem;
      border-collapse: collapse;
    }
    
    .rounds-table th {
      background-color: #f2f2f2;
      padding: 0.75rem;
      text-align: left;
      border-bottom: 2px solid #ddd;
    }
    
    .rounds-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #ddd;
    }
    
    .rounds-table input,
    .rounds-table select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .rounds-table .score-input,
    .rounds-table .cr-input,
    .rounds-table .sr-input {
      width: 80px;
    }
    
    .remove-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
    }
    
    .remove-btn:hover {
      background-color: #c82333;
    }
    
    .button-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    
    .handicap-result-inner {
      background-color: #d4edda;
      color: #155724;
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1.5rem;
      border: 1px solid #c3e6cb;
    }
    
    .handicap-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }
    
    .handicap-info {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .history-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #ddd;
    }
    
    .history-section h3 {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    
    .history-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .history-card {
      background-color: #f2f2f2;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .history-index {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .history-date,
    .history-rounds {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .rounds-table {
        font-size: 0.9rem;
      }
      
      .rounds-table th,
      .rounds-table td {
        padding: 0.5rem;
      }
      
      .handicap-value {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 576px) {
      .calculator {
        padding: 1rem;
      }
      
      .rounds-table {
        display: block;
        overflow-x: auto;
      }
      
      .history-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</body>
</html>
