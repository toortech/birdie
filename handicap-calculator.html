<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Handicap Calculator</title>
  <meta name="description" content="Calculate your golf handicap using the World Handicap System standard.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Load Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS for React component styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide React Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>

  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize auth system
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      // Initialize database
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Create header
      const headerElements = BBB_UI.createHeader({
        fixed: true,
        showHomeLinkText: true
      });
      
      document.body.insertBefore(headerElements.header, document.body.firstChild);
      
      // Get main content element
      const main = document.getElementById('main');
      main.appendChild(headerElements.mainWrapper);
      
      // Create page content
      const mainContent = document.createElement('div');
      
      // Create page title
      const titleContainer = BBB_UI.createPageTitle({
        title: 'Birdie Bush Bandits',
        showFoundedText: true,
        showGolfballs: true
      });
      mainContent.appendChild(titleContainer);
      
      // Add page subtitle
      const subtitle = document.createElement('h2');
      subtitle.textContent = 'Handicap Calculator';
      mainContent.appendChild(subtitle);
      
      // Create status message container
      const statusMessage = BBB_UI.createStatusMessage();
      mainContent.appendChild(statusMessage);
      
      // Create React root container
      const reactRoot = document.createElement('div');
      reactRoot.id = 'handicap-calculator-root';
      mainContent.appendChild(reactRoot);
      
      // Add content to main wrapper
      headerElements.mainWrapper.appendChild(mainContent);
    });
  </script>
  
  <!-- React component -->
  <script type="text/babel">
    // Import necessary components from Lucide
    const { Save, PlusCircle, MinusCircle, Calculator, Database, HelpCircle, Download, Upload } = lucide.icons;
    
    // Main Handicap Calculator Component
    const HandicapCalculator = () => {
      // State for rounds
      const [rounds, setRounds] = React.useState([]);
      const [calculatedHandicap, setCalculatedHandicap] = React.useState(null);
      const [errorMessage, setErrorMessage] = React.useState('');
      const [successMessage, setSuccessMessage] = React.useState('');
      const [isAuthenticated, setIsAuthenticated] = React.useState(false);
      const [currentUser, setCurrentUser] = React.useState(null);
      const [savedCalculations, setSavedCalculations] = React.useState([]);
      const [showHelp, setShowHelp] = React.useState(false);

      // State for courses and tees
      const [courses, setCourses] = React.useState({});
      const [teeColors, setTeeColors] = React.useState({});

      // Initialize with some rounds
      React.useEffect(() => {
        // Check if BBB_CONFIG and other modules are available
        if (typeof window.BBB_CONFIG !== 'undefined') {
          setCourses(window.BBB_CONFIG.courses);
          setTeeColors(window.BBB_CONFIG.teeColors);
        }

        if (typeof window.BBB_AUTH !== 'undefined') {
          setIsAuthenticated(window.BBB_AUTH.isAuthenticated);
          setCurrentUser(window.BBB_AUTH.currentUser);
        }

        // Add initial rounds
        if (rounds.length === 0) {
          const initialRounds = [];
          for (let i = 0; i < 3; i++) {
            initialRounds.push(createEmptyRound(i));
          }
          setRounds(initialRounds);
        }

        // Load saved calculations if user is authenticated
        loadSavedCalculations();
      }, []);

      // Create an empty round
      const createEmptyRound = (index) => {
        return {
          id: Date.now() + index,
          course: Object.keys(courses)[0] || '',
          tee: 'white',
          score: '',
          courseRating: '',
          slopeRating: '',
          differential: ''
        };
      };

      // Add a new round
      const addRound = () => {
        if (rounds.length >= 20) {
          showError('Maximum of 20 rounds allowed.');
          return;
        }
        
        setRounds([...rounds, createEmptyRound(rounds.length)]);
        showSuccess('Round added');
      };

      // Remove a round
      const removeRound = (id) => {
        if (rounds.length <= 3) {
          showError('Minimum of 3 rounds required.');
          return;
        }
        
        setRounds(rounds.filter(round => round.id !== id));
        showSuccess('Round removed');
      };

      // Update round data
      const updateRound = (id, field, value) => {
        const updatedRounds = rounds.map(round => {
          if (round.id === id) {
            const updatedRound = { ...round, [field]: value };
            
            // Auto-update course rating and slope rating if course and tee are set
            if ((field === 'course' || field === 'tee') && courses[updatedRound.course] && courses[updatedRound.course].tees && courses[updatedRound.course].tees[updatedRound.tee]) {
              updatedRound.courseRating = courses[updatedRound.course].tees[updatedRound.tee].courseRating;
              updatedRound.slopeRating = courses[updatedRound.course].tees[updatedRound.tee].slopeRating;
            }
            
            // Calculate differential if we have all the required values
            if (
              updatedRound.score && 
              updatedRound.courseRating && 
              updatedRound.slopeRating &&
              !isNaN(parseFloat(updatedRound.score)) &&
              !isNaN(parseFloat(updatedRound.courseRating)) &&
              !isNaN(parseFloat(updatedRound.slopeRating))
            ) {
              const score = parseFloat(updatedRound.score);
              const courseRating = parseFloat(updatedRound.courseRating);
              const slopeRating = parseFloat(updatedRound.slopeRating);
              
              // Calculate directly
              updatedRound.differential = ((score - courseRating) * 113 / slopeRating).toFixed(1);
            } else {
              updatedRound.differential = '';
            }
            
            return updatedRound;
          }
          return round;
        });
        
        setRounds(updatedRounds);
      };

      // Calculate handicap
      const calculateHandicap = () => {
        // Validate rounds
        const validRounds = rounds.filter(round => 
          round.score && 
          round.courseRating && 
          round.slopeRating && 
          round.differential
        );
        
        if (validRounds.length < 3) {
          showError('Please enter at least 3 complete rounds.');
          return;
        }
        
        // Extract differentials
        const differentials = validRounds.map(round => 
          parseFloat(round.differential)
        ).filter(diff => !isNaN(diff));
        
        // Calculate handicap using BBB_UTILS if available
        let handicapIndex;
        if (typeof window.BBB_UTILS !== 'undefined' && typeof window.BBB_UTILS.calculateHandicapIndex === 'function') {
          handicapIndex = window.BBB_UTILS.calculateHandicapIndex(differentials);
        } else {
          // Implement calculation directly if BBB_UTILS not available
          differentials.sort((a, b) => a - b);
          
          let countToUse;
          if (differentials.length <= 3) countToUse = 1;
          else if (differentials.length <= 6) countToUse = 2;
          else if (differentials.length <= 8) countToUse = 3;
          else if (differentials.length <= 11) countToUse = 4;
          else if (differentials.length <= 14) countToUse = 5;
          else if (differentials.length <= 16) countToUse = 6;
          else if (differentials.length <= 18) countToUse = 7;
          else if (differentials.length <= 19) countToUse = 8;
          else countToUse = 10;
          
          const bestDifferentials = differentials.slice(0, countToUse);
          const average = bestDifferentials.reduce((sum, diff) => sum + diff, 0) / countToUse;
          handicapIndex = (average * 0.96).toFixed(1);
        }
        
        setCalculatedHandicap(handicapIndex);
        showSuccess(`Your Handicap Index is ${handicapIndex}`);
      };

      // Save handicap calculation
      const saveHandicap = () => {
        if (!calculatedHandicap) {
          showError('Please calculate your handicap first.');
          return;
        }
        
        if (!isAuthenticated) {
          showError('Please log in to save your handicap.');
          return;
        }
        
        const handicapData = {
          index: calculatedHandicap,
          calculatedAt: new Date().toISOString(),
          rounds: rounds.filter(round => round.differential).length,
          differentials: rounds.filter(round => round.differential).map(round => parseFloat(round.differential))
        };
        
        if (typeof window.BBB_DB !== 'undefined' && typeof window.BBB_DB.saveMemberHandicap === 'function') {
          window.BBB_DB.saveMemberHandicap(currentUser.id, handicapData)
            .then(() => {
              showSuccess('Handicap saved successfully!');
              loadSavedCalculations();
            })
            .catch(err => {
              console.error('Error saving handicap:', err);
              showError('Error saving handicap.');
            });
        } else {
          // Fallback to localStorage if BBB_DB not available
          try {
            const savedHandicaps = JSON.parse(localStorage.getItem('handicap_history') || '[]');
            savedHandicaps.push({
              ...handicapData,
              savedAt: new Date().toISOString(),
              id: `hcp_${Date.now()}`
            });
            localStorage.setItem('handicap_history', JSON.stringify(savedHandicaps));
            showSuccess('Handicap saved to browser storage!');
            loadSavedCalculations();
          } catch (error) {
            console.error('Error saving to localStorage:', error);
            showError('Error saving handicap.');
          }
        }
      };

      // Load saved calculations
      const loadSavedCalculations = () => {
        if (typeof window.BBB_DB !== 'undefined' && typeof window.BBB_DB.getMemberHandicap === 'function' && currentUser) {
          window.BBB_DB.getMemberHandicap(currentUser.id)
            .then(data => {
              if (data) {
                setSavedCalculations([data]);
              }
            })
            .catch(err => {
              console.error('Error loading handicap history:', err);
            });
        } else {
          // Fallback to localStorage
          try {
            const savedHandicaps = JSON.parse(localStorage.getItem('handicap_history') || '[]');
            setSavedCalculations(savedHandicaps);
          } catch (error) {
            console.error('Error loading from localStorage:', error);
          }
        }
      };

      // Export calculations to CSV
      const exportToCSV = () => {
        if (rounds.length === 0) {
          showError('No rounds to export.');
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Course,Tee,Score,Course Rating,Slope Rating,Differential\n";
        
        rounds.forEach(round => {
          csvContent += `${round.course},${round.tee},${round.score},${round.courseRating},${round.slopeRating},${round.differential}\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `handicap_calculation_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccess('Exported to CSV file.');
      };

      // Show error message
      const showError = (message) => {
        setErrorMessage(message);
        setSuccessMessage('');
        setTimeout(() => setErrorMessage(''), 5000);
      };

      // Show success message
      const showSuccess = (message) => {
        setSuccessMessage(message);
        setErrorMessage('');
        setTimeout(() => setSuccessMessage(''), 5000);
      };

      // Reset calculator
      const resetCalculator = () => {
        if (confirm('Are you sure you want to reset the calculator? This will clear all entered rounds.')) {
          const initialRounds = [];
          for (let i = 0; i < 3; i++) {
            initialRounds.push(createEmptyRound(i));
          }
          setRounds(initialRounds);
          setCalculatedHandicap(null);
          showSuccess('Calculator has been reset.');
        }
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6 max-w-4xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-green-800">Handicap Calculator</h1>
            <button 
              onClick={() => setShowHelp(!showHelp)}
              className="flex items-center text-blue-600 hover:text-blue-800"
            >
              <HelpCircle size={16} className="mr-1" />
              {showHelp ? 'Hide Help' : 'Show Help'}
            </button>
          </div>

          {showHelp && (
            <div className="bg-blue-50 p-4 rounded-md mb-6 text-sm">
              <h2 className="font-bold text-blue-800 mb-2">How to Use the Handicap Calculator</h2>
              <ol className="list-decimal pl-5 space-y-1">
                <li>Enter details for at least 3 rounds of golf (up to 20).</li>
                <li>For each round, select the course and tee color you played.</li>
                <li>Enter your gross score for the round.</li>
                <li>The course rating and slope rating will be filled automatically.</li>
                <li>Your score differential will be calculated automatically.</li>
                <li>Click "Calculate Handicap" to get your handicap index.</li>
                <li>If logged in, you can save your handicap to your profile.</li>
              </ol>
              <p className="mt-2 text-blue-700">
                The handicap index is calculated using the World Handicap System (WHS) formula.
              </p>
            </div>
          )}

          {errorMessage && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {errorMessage}
            </div>
          )}

          {successMessage && (
            <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
              {successMessage}
            </div>
          )}

          {calculatedHandicap && (
            <div className="bg-green-50 p-6 rounded-lg mb-6 text-center">
              <h2 className="text-xl font-bold text-green-800 mb-1">Your Handicap Index</h2>
              <p className="text-4xl font-bold text-green-700">{calculatedHandicap}</p>
              <p className="text-sm text-green-600 mt-2">
                Calculated using {rounds.filter(r => r.differential).length} rounds
              </p>
            </div>
          )}

          <div className="mb-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-semibold">Your Rounds</h2>
              <div className="flex gap-2">
                <button 
                  onClick={addRound}
                  className="flex items-center bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded"
                  disabled={rounds.length >= 20}
                >
                  <PlusCircle size={16} className="mr-1" />
                  Add Round
                </button>
                <button 
                  onClick={resetCalculator}
                  className="flex items-center bg-gray-600 hover:bg-gray-700 text-white py-1 px-3 rounded"
                >
                  Reset
                </button>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="min-w-full bg-white rounded">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="py-2 px-3 text-left">#</th>
                    <th className="py-2 px-3 text-left">Course</th>
                    <th className="py-2 px-3 text-left">Tee</th>
                    <th className="py-2 px-3 text-left">Score</th>
                    <th className="py-2 px-3 text-left">C.R.</th>
                    <th className="py-2 px-3 text-left">S.R.</th>
                    <th className="py-2 px-3 text-left">Diff.</th>
                    <th className="py-2 px-3 text-left">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {rounds.map((round, index) => (
                    <tr key={round.id} className="border-t hover:bg-gray-50">
                      <td className="py-2 px-3">{index + 1}</td>
                      <td className="py-2 px-3">
                        <select 
                          value={round.course}
                          onChange={(e) => updateRound(round.id, 'course', e.target.value)}
                          className="w-full border rounded py-1 px-2"
                        >
                          {Object.keys(courses).map(course => (
                            <option key={course} value={course}>
                              {course}
                            </option>
                          ))}
                        </select>
                      </td>
                      <td className="py-2 px-3">
                        <select
                          value={round.tee}
                          onChange={(e) => updateRound(round.id, 'tee', e.target.value)}
                          className="w-full border rounded py-1 px-2"
                        >
                          {Object.keys(teeColors).map(tee => (
                            <option key={tee} value={tee}>
                              {teeColors[tee]}
                            </option>
                          ))}
                        </select>
                      </td>
                      <td className="py-2 px-3">
                        <input 
                          type="number"
                          value={round.score}
                          onChange={(e) => updateRound(round.id, 'score', e.target.value)}
                          placeholder="Gross"
                          min="0"
                          className="w-16 border rounded py-1 px-2"
                        />
                      </td>
                      <td className="py-2 px-3">
                        <input 
                          type="number"
                          value={round.courseRating}
                          onChange={(e) => updateRound(round.id, 'courseRating', e.target.value)}
                          placeholder="C.R."
                          step="0.1"
                          className="w-16 border rounded py-1 px-2"
                        />
                      </td>
                      <td className="py-2 px-3">
                        <input 
                          type="number"
                          value={round.slopeRating}
                          onChange={(e) => updateRound(round.id, 'slopeRating', e.target.value)}
                          placeholder="S.R."
                          className="w-16 border rounded py-1 px-2"
                        />
                      </td>
                      <td className="py-2 px-3 font-semibold">
                        {round.differential}
                      </td>
                      <td className="py-2 px-3">
                        <button 
                          onClick={() => removeRound(round.id)}
                          className="text-red-600 hover:text-red-800"
                          disabled={rounds.length <= 3}
                        >
                          <MinusCircle size={16} />
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="flex flex-wrap gap-2 mt-6 justify-center">
              <button 
                onClick={calculateHandicap}
                className="flex items-center bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded"
              >
                <Calculator size={18} className="mr-2" />
                Calculate Handicap
              </button>
              
              <button 
                onClick={saveHandicap}
                disabled={!calculatedHandicap || !isAuthenticated}
                className={`flex items-center ${!calculatedHandicap || !isAuthenticated ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'} text-white py-2 px-4 rounded`}
              >
                <Save size={18} className="mr-2" />
                Save Handicap
              </button>
              
              <button 
                onClick={exportToCSV}
                className="flex items-center bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded"
              >
                <Download size={18} className="mr-2" />
                Export to CSV
              </button>
            </div>
          </div>

          {savedCalculations.length > 0 && (
            <div className="mt-8 border-t pt-6">
              <h2 className="text-lg font-semibold mb-4">Handicap History</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {savedCalculations.map((calc, index) => (
                  <div key={index} className="bg-gray-50 rounded p-4 border">
                    <div className="text-lg font-bold mb-1">Index: {calc.index}</div>
                    <div className="text-sm text-gray-600">
                      Calculated: {new Date(calc.calculatedAt).toLocaleDateString()}
                    </div>
                    <div className="text-sm text-gray-600">
                      Rounds used: {calc.rounds || calc.differentials?.length || 'Unknown'}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the component
    ReactDOM.createRoot(document.getElementById('handicap-calculator-root')).render(
      <HandicapCalculator />
    );
  </script>

  <!-- Add style override for consistent BBB appearance -->
  <style>
    #handicap-calculator-root {
      font-family: var(--font-family-base);
      margin: 2rem 0;
    }
    
    #handicap-calculator-root h1, 
    #handicap-calculator-root h2 {
      font-family: var(--font-family-accent);
    }
    
    /* Ensure Tailwind doesn't conflict with BBB styles outside our component */
    #handicap-calculator-root * {
      box-sizing: border-box;
    }
  </style>
</body>
</html>
