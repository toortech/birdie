<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits – Handicap Calculator</title>
  <meta name="description" content="Calculate your golf handicap using the World Handicap System standard.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>

  <style>
    /* Enhanced CSS Variables */
    :root {
      --bbb-primary: #004d00;
      --bbb-secondary: #0046ad;
      --bbb-gold: #ffd700;
      --bbb-light-green: #e8f5e8;
      --bbb-background: #f5f5f5;
      --bbb-text: #212529;
      --bbb-text-muted: #6c757d;
      --bbb-border: #dee2e6;
      --font-family-base: 'Inter', sans-serif;
      --font-family-accent: 'Montserrat', serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      line-height: 1.6;
      color: var(--bbb-text);
      background: linear-gradient(135deg, var(--bbb-light-green) 0%, var(--bbb-background) 100%);
      min-height: 100vh;
    }

    /* Header with Logo */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-logo {
      height: 50px;
      width: auto;
      transition: transform 0.3s ease;
    }

    .header-logo:hover {
      transform: scale(1.05);
    }

    .header-title {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.5rem;
      font-weight: 700;
      margin-left: 1rem;
      text-decoration: none;
    }

    .header-title:hover {
      color: var(--bbb-secondary);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .founded-badge-header {
      display: inline-block;
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-weight: 600;
      font-size: 0.8rem;
      margin-left: 1rem;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    /* User info and auth controls */
    .user-info {
      color: var(--bbb-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .home-btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
      transition: background 0.3s;
    }

    .home-btn:hover {
      background: var(--bbb-primary);
    }

    /* Calculator Hero Section */
    .calculator-hero {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
      color: var(--bbb-text);
      text-align: center;
      padding: 4rem 2rem 3rem 2rem;
      position: relative;
      overflow: hidden;
      border-bottom: 3px solid #dee2e6;
      margin-top: 90px;
    }

    .calculator-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0, 77, 0, 0.03) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .calculator-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
    }

    .calculator-hero h1 {
      font-family: var(--font-family-accent);
      font-size: clamp(2rem, 4vw, 3.5rem);
      font-weight: 700;
      color: var(--bbb-primary);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      animation: fadeInUp 1s ease-out;
      margin: 0 0 1rem 0;
    }

    .calculator-hero .tagline {
      font-size: clamp(1rem, 2vw, 1.3rem);
      color: var(--bbb-text-muted);
      max-width: 600px;
      margin: 0 auto;
      animation: fadeInUp 1s ease-out 0.3s both;
      font-weight: 500;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calculator-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Golf-specific decorative elements */
    .golf-ball {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: relative;
      display: inline-block;
      margin: 0 10px;
      box-shadow: inset -3px -3px 5px rgba(0,0,0,0.2);
    }

    .golf-ball::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 2px;
      background: #ccc;
      border-radius: 50%;
      top: 4px;
      left: 6px;
      box-shadow: 4px 0 #ccc, 8px 0 #ccc, 2px 4px #ccc, 6px 4px #ccc, 10px 4px #ccc, 4px 8px #ccc, 8px 8px #ccc;
    }

    /* Calculator Container */
    .calculator {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: 4rem 0;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .calculator:hover {
      border-color: var(--bbb-gold);
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    /* Member Selection Section */
    .member-selection-section {
      background: linear-gradient(135deg, var(--bbb-light-green), rgba(255, 215, 0, 0.1));
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      border-left: 4px solid var(--bbb-gold);
      transition: transform 0.3s ease;
    }

    .member-selection-section:hover {
      transform: translateX(10px);
    }

    .member-selection-section label {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
    }

    .member-select {
      width: 100%;
      max-width: 300px;
      padding: 0.75rem;
      border: 2px solid var(--bbb-border);
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      font-family: var(--font-family-base);
      transition: border-color 0.3s ease;
    }

    .member-select:focus {
      outline: none;
      border-color: var(--bbb-secondary);
      box-shadow: 0 0 0 3px rgba(0, 70, 173, 0.1);
    }

    .admin-message {
      color: var(--bbb-text-muted);
      font-style: italic;
      margin-top: 0.5rem;
      font-family: var(--font-family-base);
    }

    /* Buttons */
    .btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-family: var(--font-family-accent);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 70, 173, 0.2);
      text-decoration: none;
      display: inline-block;
      text-align: center;
      margin: 0.25rem;
    }

    .btn:hover {
      background: var(--bbb-primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 70, 173, 0.3);
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.help-toggle {
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      margin-bottom: 1.5rem;
    }

    .btn.help-toggle:hover {
      background: #e6c200;
      color: var(--bbb-primary);
    }

    /* Help Section */
    .help-section {
      background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      border: 2px solid #bbdefb;
      display: none;
    }

    .help-section h3 {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .help-section ol {
      padding-left: 1.5rem;
      font-family: var(--font-family-base);
    }

    .help-section li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    /* Status Messages */
    #status-message {
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 8px;
      text-align: center;
      display: none;
      font-family: var(--font-family-base);
      font-weight: 500;
    }

    .success {
      background: linear-gradient(135deg, #d4edda, #e8f5e9);
      color: #155724;
      border: 2px solid #c3e6cb;
    }

    .error {
      background: linear-gradient(135deg, #f8d7da, #ffebee);
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .warning {
      background: linear-gradient(135deg, #fff3cd, #fffde7);
      color: #856404;
      border: 2px solid #ffeeba;
    }

    .info {
      background: linear-gradient(135deg, #d1ecf1, #e3f2fd);
      color: #0c5460;
      border: 2px solid #bee5eb;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .header-logo {
        height: 40px;
      }

      .header-title {
        font-size: 1.2rem;
        margin-left: 0.5rem;
      }

      .calculator-hero {
        padding: 2rem 1rem 1.5rem 1rem;
        margin-top: 120px;
      }

      .calculator-main {
        padding: 0 1rem;
      }

      .calculator {
        padding: 1.5rem;
        margin: 2rem 0;
      }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <!-- Fixed Header with Logo -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html">
          <img src="birdie.png" alt="Birdie Bush Bandits Logo" class="header-logo">
        </a>
        <a href="index.html" class="header-title">Birdie Bush Bandits</a>
        <div class="founded-badge-header">
          🏌️ Founded August 2020
        </div>
      </div>
      <div class="header-right">
        <!-- Auth controls will be added here by JavaScript -->
        <a href="index.html" class="home-btn" id="home-link">Home</a>
      </div>
    </div>
  </header>
  
  <main id="main">
    <!-- Hero Section -->
    <section class="calculator-hero">
      <div class="calculator-hero-content">
        <h1>Handicap Calculator <span class="golf-ball"></span></h1>
        <p class="tagline">Calculate your official handicap using the World Handicap System</p>
      </div>
    </section>

    <!-- Main Calculator Content -->
    <div class="calculator-main">
      <div id="status-message"></div>
      
      <div id="handicap-calculator" class="calculator">
        <!-- Member selection -->
        <div class="member-selection-section">
          <label for="member-select">Calculate Handicap For:</label>
          <select id="member-select" class="member-select">
            <option value="">-- Select Member --</option>
            <!-- Members will be populated by JavaScript -->
          </select>
          <div id="admin-message" class="admin-message" style="display: none;">
            <small>As an admin, you can calculate and save handicaps for any member.</small>
          </div>
        </div>
        
        <!-- Help section toggle -->
        <button id="help-toggle" class="btn help-toggle">Show Help</button>
        
        <!-- Help section content -->
        <div id="help-section" class="help-section">
          <h3>How to Use the Handicap Calculator</h3>
          <ol>
            <li>Select the member whose handicap you want to calculate.</li>
            <li>Enter details for at least 3 rounds of golf (up to 20).</li>
            <li>For each round, select the course and tee color played.</li>
            <li>Enter the gross score for the round.</li>
            <li>The course rating and slope rating will be filled automatically.</li>
            <li>Your score differential will be calculated automatically.</li>
            <li>Click "Calculate Handicap" to get the handicap index.</li>
            <li>Click "Save Handicap" to save it to the member's profile.</li>
          </ol>
          <p>The handicap index is calculated using the World Handicap System (WHS) formula.</p>
        </div>
        
        <!-- Simple test buttons for now -->
        <div style="text-align: center; padding: 2rem; border: 2px dashed #ccc; border-radius: 8px; background: #f8f9fa;">
          <h3>Calculator Ready</h3>
          <p>Member dropdown should now be populated from your config files.</p>
          <button class="btn" onclick="testCalculator()">Test Calculator Functions</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Clean Initialization Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("=== HANDICAP CALCULATOR INITIALIZATION ===");
      
      // Simple initialization - no complex async logic
      initializeCalculator();
    });
    
    function initializeCalculator() {
      console.log("Initializing calculator...");
      
      // Initialize modules if available
      if (typeof BBB_AUTH !== 'undefined' && BBB_AUTH.init) {
        try {
          BBB_AUTH.init({
            cloudflareEnabled: BBB_CONFIG ? BBB_CONFIG.cloudflareEnabled : false
          });
          console.log("✓ BBB_AUTH initialized");
        } catch (error) {
          console.warn("BBB_AUTH initialization failed:", error);
        }
      }
      
      if (typeof BBB_DB !== 'undefined' && BBB_DB.init) {
        try {
          BBB_DB.init({
            useCloudflare: BBB_CONFIG ? BBB_CONFIG.cloudflareEnabled : false,
            localStoragePrefix: 'bbb_'
          });
          console.log("✓ BBB_DB initialized");
        } catch (error) {
          console.warn("BBB_DB initialization failed:", error);
        }
      }
      
      // Load members from config
      populateMembersDropdown();
      
      // Set up basic event handlers
      setupEventHandlers();
      
      // Check authentication
      checkAuthentication();
      
      console.log("Calculator initialization complete");
    }
    
    function populateMembersDropdown() {
      console.log("Populating members dropdown...");
      
      const memberSelect = document.getElementById('member-select');
      if (!memberSelect) {
        console.error("Member select element not found!");
        return;
      }
      
      // Clear existing options
      memberSelect.innerHTML = '<option value="">-- Select Member --</option>';
      
      let members = [];
      let source = 'none';
      
      // Try to get members from BBB_CONFIG
      if (typeof BBB_CONFIG !== 'undefined') {
        console.log("BBB_CONFIG found, checking for members...");
        
        if (BBB_CONFIG.members && Array.isArray(BBB_CONFIG.members) && BBB_CONFIG.members.length > 0) {
          members = BBB_CONFIG.members;
          source = 'BBB_CONFIG.members';
          console.log(`Found ${members.length} members in BBB_CONFIG.members`);
        } else if (BBB_CONFIG.staticMembers && Array.isArray(BBB_CONFIG.staticMembers) && BBB_CONFIG.staticMembers.length > 0) {
          members = BBB_CONFIG.staticMembers;
          source = 'BBB_CONFIG.staticMembers';
          console.log(`Found ${members.length} members in BBB_CONFIG.staticMembers`);
        } else {
          console.warn("BBB_CONFIG found but no members array");
        }
      } else {
        console.warn("BBB_CONFIG not found");
      }
      
      // Fallback to hardcoded members if config fails
      if (members.length === 0) {
        console.log("Using hardcoded member fallback");
        members = [
          "Amrit", "Kam", "Vish", "Ravi", "Bal", "Vick", 
          "Michael", "Justy", "Phuperjee", "Indy", "Maj", "Sama"
        ];
        source = 'hardcoded fallback';
      }
      
      // Populate dropdown
      members.forEach((member, index) => {
        const option = document.createElement('option');
        option.value = typeof member === 'string' ? member.toLowerCase() : member.id || member.username;
        option.textContent = typeof member === 'string' ? member : member.display_name || member.username;
        memberSelect.appendChild(option);
      });
      
      console.log(`✓ Successfully populated ${members.length} members from ${source}`);
      showMessage(`Loaded ${members.length} members from ${source}`, 'success');
      
      // Auto-select current user if authenticated
      if (typeof BBB_AUTH !== 'undefined' && BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
        const userOption = Array.from(memberSelect.options).find(opt => opt.value === BBB_AUTH.currentUser.id);
        if (userOption) {
          userOption.selected = true;
          console.log(`Auto-selected current user: ${BBB_AUTH.currentUser.id}`);
        }
      }
    }
    
    function setupEventHandlers() {
      console.log("Setting up event handlers...");
      
      // Help toggle
      const helpToggle = document.getElementById('help-toggle');
      const helpSection = document.getElementById('help-section');
      
      if (helpToggle && helpSection) {
        helpToggle.addEventListener('click', function() {
          if (helpSection.style.display === 'none') {
            helpSection.style.display = 'block';
            helpToggle.textContent = 'Hide Help';
          } else {
            helpSection.style.display = 'none';
            helpToggle.textContent = 'Show Help';
          }
        });
      }
      
      // Member selection change
      const memberSelect = document.getElementById('member-select');
      if (memberSelect) {
        memberSelect.addEventListener('change', function() {
          console.log(`Member selected: ${this.value}`);
          // TODO: Load handicap history for selected member
        });
      }
    }
    
    function checkAuthentication() {
      console.log("Checking authentication...");
      
      if (typeof BBB_AUTH === 'undefined') {
        console.log("BBB_AUTH not available, skipping auth check");
        return;
      }
      
      // Try to restore session
      try {
        const storedAuth = localStorage.getItem('bbb_auth_session');
        const storedUser = localStorage.getItem('bbb_current_user');
        
        if (storedAuth && storedUser) {
          const authData = JSON.parse(storedAuth);
          const userData = JSON.parse(storedUser);
          
          if (authData.expiresAt && new Date(authData.expiresAt) > new Date()) {
            BBB_AUTH.currentUser = userData;
            BBB_AUTH.isAuthenticated = true;
            console.log(`✓ Restored session for user: ${userData.id}`);
            
            // Add auth controls to header
            addAuthControls();
            
            // Show admin message if user is admin
            if (BBB_AUTH.hasRole && BBB_AUTH.hasRole('admin')) {
              const adminMessage = document.getElementById('admin-message');
              if (adminMessage) {
                adminMessage.style.display = 'block';
              }
            }
          }
        }
      } catch (error) {
        console.warn("Auth restoration failed:", error);
      }
    }
    
    function addAuthControls() {
      const headerRight = document.querySelector('.header-right');
      if (!headerRight || !BBB_AUTH.isAuthenticated) return;
      
      // Add user info
      if (!headerRight.querySelector('.user-info')) {
        const userInfo = document.createElement('span');
        userInfo.className = 'user-info';
        userInfo.textContent = `Welcome, ${BBB_AUTH.currentUser.id}`;
        headerRight.insertBefore(userInfo, headerRight.firstChild);
      }
      
      // Add logout button
      if (!headerRight.querySelector('.logout-btn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'logout-btn';
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = function() {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('bbb_auth_session');
            localStorage.removeItem('bbb_current_user');
            window.location.reload();
          }
        };
        headerRight.appendChild(logoutBtn);
      }
    }
    
    function showMessage(message, type = 'info') {
      const statusElement = document.getElementById('status-message');
      if (!statusElement) return;
      
      statusElement.textContent = message;
      statusElement.className = type;
      statusElement.style.display = 'block';
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function testCalculator() {
      console.log("Testing calculator functions...");
      
      const memberSelect = document.getElementById('member-select');
      const memberCount = memberSelect ? memberSelect.options.length - 1 : 0; // -1 for default option
      
      showMessage(`Calculator ready! Found ${memberCount} members. BBB_CONFIG: ${typeof BBB_CONFIG !== 'undefined' ? 'Available' : 'Missing'}`, 'info');
      
      // Log current state
      console.log("Current state:", {
        membersLoaded: memberCount,
        configAvailable: typeof BBB_CONFIG !== 'undefined',
        authAvailable: typeof BBB_AUTH !== 'undefined',
        isAuthenticated: BBB_AUTH ? BBB_AUTH.isAuthenticated : false
      });
    }
  </script>
</body>
</html>
