<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits – Handicap Calculator</title>
  <meta name="description" content="Calculate your golf handicap using the World Handicap System standard.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>

  <style>
    /* Enhanced CSS Variables */
    :root {
      --bbb-primary: #004d00;
      --bbb-secondary: #0046ad;
      --bbb-gold: #ffd700;
      --bbb-light-green: #e8f5e8;
      --bbb-background: #f5f5f5;
      --bbb-text: #212529;
      --bbb-text-muted: #6c757d;
      --bbb-border: #dee2e6;
      --font-family-base: 'Inter', sans-serif;
      --font-family-accent: 'Montserrat', serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      line-height: 1.6;
      color: var(--bbb-text);
      background: linear-gradient(135deg, var(--bbb-light-green) 0%, var(--bbb-background) 100%);
      min-height: 100vh;
    }

    /* Header with Logo */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-logo {
      height: 50px;
      width: auto;
      transition: transform 0.3s ease;
    }

    .header-logo:hover {
      transform: scale(1.05);
    }

    .header-title {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.5rem;
      font-weight: 700;
      margin-left: 1rem;
      text-decoration: none;
    }

    .header-title:hover {
      color: var(--bbb-secondary);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .founded-badge-header {
      display: inline-block;
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-weight: 600;
      font-size: 0.8rem;
      margin-left: 1rem;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    /* User info and auth controls */
    .user-info {
      color: var(--bbb-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .home-btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
      transition: background 0.3s;
    }

    .home-btn:hover {
      background: var(--bbb-primary);
    }

    /* Calculator Hero Section */
    .calculator-hero {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
      color: var(--bbb-text);
      text-align: center;
      padding: 4rem 2rem 3rem 2rem;
      position: relative;
      overflow: hidden;
      border-bottom: 3px solid #dee2e6;
      margin-top: 90px;
    }

    .calculator-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0, 77, 0, 0.03) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .calculator-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
    }

    .calculator-hero h1 {
      font-family: var(--font-family-accent);
      font-size: clamp(2rem, 4vw, 3.5rem);
      font-weight: 700;
      color: var(--bbb-primary);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      animation: fadeInUp 1s ease-out;
      margin: 0 0 1rem 0;
    }

    .calculator-hero .tagline {
      font-size: clamp(1rem, 2vw, 1.3rem);
      color: var(--bbb-text-muted);
      max-width: 600px;
      margin: 0 auto;
      animation: fadeInUp 1s ease-out 0.3s both;
      font-weight: 500;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calculator-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Golf-specific decorative elements */
    .golf-ball {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: relative;
      display: inline-block;
      margin: 0 10px;
      box-shadow: inset -3px -3px 5px rgba(0,0,0,0.2);
    }

    .golf-ball::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 2px;
      background: #ccc;
      border-radius: 50%;
      top: 4px;
      left: 6px;
      box-shadow: 4px 0 #ccc, 8px 0 #ccc, 2px 4px #ccc, 6px 4px #ccc, 10px 4px #ccc, 4px 8px #ccc, 8px 8px #ccc;
    }

    /* Calculator Container */
    .calculator {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: 4rem 0;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .calculator:hover {
      border-color: var(--bbb-gold);
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    /* Member Selection Section */
    .member-selection-section {
      background: linear-gradient(135deg, var(--bbb-light-green), rgba(255, 215, 0, 0.1));
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      border-left: 4px solid var(--bbb-gold);
      transition: transform 0.3s ease;
    }

    .member-selection-section:hover {
      transform: translateX(10px);
    }

    .member-selection-section label {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
    }

    .member-select {
      width: 100%;
      max-width: 300px;
      padding: 0.75rem;
      border: 2px solid var(--bbb-border);
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      font-family: var(--font-family-base);
      transition: border-color 0.3s ease;
    }

    .member-select:focus {
      outline: none;
      border-color: var(--bbb-secondary);
      box-shadow: 0 0 0 3px rgba(0, 70, 173, 0.1);
    }

    .admin-message {
      color: var(--bbb-text-muted);
      font-style: italic;
      margin-top: 0.5rem;
      font-family: var(--font-family-base);
    }

    /* Help Section */
    .help-section {
      background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      border: 2px solid #bbdefb;
      display: none;
    }

    .help-section h3 {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .help-section ol {
      padding-left: 1.5rem;
      font-family: var(--font-family-base);
    }

    .help-section li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    /* Button Group */
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 2rem 0;
    }

    /* Buttons */
    .btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-family: var(--font-family-accent);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 70, 173, 0.2);
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn:hover {
      background: var(--bbb-primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 70, 173, 0.3);
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.help-toggle {
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      margin-bottom: 1.5rem;
    }

    .btn.help-toggle:hover {
      background: #e6c200;
      color: var(--bbb-primary);
    }

    .btn-success {
      background: #28a745;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    /* Table Styles */
    .rounds-table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .rounds-table th {
      background: linear-gradient(135deg, var(--bbb-primary), var(--bbb-secondary));
      color: white;
      padding: 1rem 0.75rem;
      font-family: var(--font-family-accent);
      font-weight: 600;
      text-align: left;
      border: none;
    }

    .rounds-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--bbb-border);
      background: white;
    }

    .rounds-table tr:hover td {
      background: var(--bbb-light-green);
    }

    .rounds-table input,
    .rounds-table select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--bbb-border);
      border-radius: 6px;
      font-family: var(--font-family-base);
      transition: border-color 0.3s ease;
    }

    .rounds-table input:focus,
    .rounds-table select:focus {
      outline: none;
      border-color: var(--bbb-secondary);
      box-shadow: 0 0 0 2px rgba(0, 70, 173, 0.1);
    }

    .rounds-table .score-input,
    .rounds-table .cr-input,
    .rounds-table .sr-input {
      max-width: 80px;
    }

    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .remove-btn:hover {
      background: #c82333;
    }

    /* Result Display */
    .handicap-result-inner {
      background: linear-gradient(135deg, #d4edda, #e8f5e9);
      color: #155724;
      padding: 2rem;
      border-radius: 15px;
      text-align: center;
      margin: 2rem 0;
      border: 2px solid #c3e6cb;
      box-shadow: 0 5px 20px rgba(21, 87, 36, 0.1);
    }

    .handicap-result-inner h3 {
      font-family: var(--font-family-accent);
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .handicap-value {
      font-size: 3rem;
      font-weight: bold;
      font-family: var(--font-family-accent);
      margin: 1rem 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .handicap-info {
      font-size: 1rem;
      opacity: 0.8;
      font-family: var(--font-family-base);
    }

    /* History Section */
    .history-section {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      margin-top: 2rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border: 2px solid var(--bbb-border);
    }

    .history-section h3 {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    .history-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .history-card {
      background: linear-gradient(135deg, var(--bbb-light-green), white);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--bbb-border);
      transition: all 0.3s ease;
    }

    .history-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      border-color: var(--bbb-gold);
    }

    .history-index {
      font-size: 1.3rem;
      font-weight: bold;
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      margin-bottom: 0.5rem;
    }

    .history-date,
    .history-rounds {
      font-size: 0.95rem;
      color: var(--bbb-text-muted);
      margin-bottom: 0.25rem;
      font-family: var(--font-family-base);
    }

    /* Status Messages */
    #status-message {
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 8px;
      text-align: center;
      display: none;
      font-family: var(--font-family-base);
      font-weight: 500;
    }

    .success {
      background: linear-gradient(135deg, #d4edda, #e8f5e9);
      color: #155724;
      border: 2px solid #c3e6cb;
    }

    .error {
      background: linear-gradient(135deg, #f8d7da, #ffebee);
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .warning {
      background: linear-gradient(135deg, #fff3cd, #fffde7);
      color: #856404;
      border: 2px solid #ffeeba;
    }

    .info {
      background: linear-gradient(135deg, #d1ecf1, #e3f2fd);
      color: #0c5460;
      border: 2px solid #bee5eb;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .header-logo {
        height: 40px;
      }

      .header-title {
        font-size: 1.2rem;
        margin-left: 0.5rem;
      }

      .header-content {
        flex-wrap: wrap;
      }

      .header-right {
        margin-top: 0.5rem;
      }

      .founded-badge-header {
        margin-left: 0.5rem;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }

      .calculator-hero {
        padding: 2rem 1rem 1.5rem 1rem;
        margin-top: 120px;
      }

      .calculator-hero h1 {
        font-size: 2rem;
        line-height: 1.2;
      }

      .calculator-hero .tagline {
        font-size: 1rem;
        padding: 0 1rem;
      }

      .calculator-main {
        padding: 0 1rem;
      }

      .calculator {
        padding: 1.5rem;
        margin: 2rem 0;
      }

      .button-group {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .rounds-table {
        font-size: 0.9rem;
        overflow-x: auto;
        display: block;
        white-space: nowrap;
      }

      .rounds-table th,
      .rounds-table td {
        padding: 0.5rem;
      }

      .handicap-value {
        font-size: 2rem;
      }

      .history-cards {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .calculator-hero {
        padding: 1.5rem 0.75rem 1rem 0.75rem;
      }

      .calculator-hero h1 {
        font-size: 1.75rem;
      }

      .calculator-hero .tagline {
        font-size: 0.95rem;
      }

      .calculator-main {
        padding: 0 0.75rem;
      }

      .calculator {
        padding: 1.25rem;
      }

      .member-selection-section,
      .help-section {
        padding: 1.25rem;
      }

      .handicap-value {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <!-- Fixed Header with Logo -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html">
          <img src="birdie.png" alt="Birdie Bush Bandits Logo" class="header-logo">
        </a>
        <a href="index.html" class="header-title">Birdie Bush Bandits</a>
        <div class="founded-badge-header">
          🏌️ Founded August 2020
        </div>
      </div>
      <div class="header-right">
        <!-- Auth controls will be added here by JavaScript -->
        <a href="index.html" class="home-btn" id="home-link">Home</a>
      </div>
    </div>
  </header>
  
  <main id="main">
    <!-- Hero Section -->
    <section class="calculator-hero">
      <div class="calculator-hero-content">
        <h1>Handicap Calculator <span class="golf-ball"></span></h1>
        <p class="tagline">Calculate your official handicap using the World Handicap System</p>
      </div>
    </section>

    <!-- Main Calculator Content -->
    <div class="calculator-main">
      <div id="status-message"></div>
      
      <div id="handicap-calculator" class="calculator">
        <!-- Member selection -->
        <div class="member-selection-section">
          <label for="member-select">Calculate Handicap For:</label>
          <select id="member-select" class="member-select">
            <option value="">-- Select Member --</option>
            <!-- Members will be populated by JavaScript -->
          </select>
          <div id="admin-message" class="admin-message" style="display: none;">
            <small>As an admin, you can calculate and save handicaps for any member.</small>
          </div>
        </div>
        
        <!-- Help section toggle -->
        <button id="help-toggle" class="btn help-toggle">Show Help</button>
        
        <!-- Help section content -->
        <div id="help-section" class="help-section">
          <h3>How to Use the Handicap Calculator</h3>
          <ol>
            <li>Select the member whose handicap you want to calculate.</li>
            <li>Enter details for at least 3 rounds of golf (up to 20).</li>
            <li>For each round, select the course and tee color played.</li>
            <li>Enter the gross score for the round.</li>
            <li>The course rating and slope rating will be filled automatically.</li>
            <li>Your score differential will be calculated automatically.</li>
            <li>Click "Calculate Handicap" to get the handicap index.</li>
            <li>Click "Save Handicap" to save it to the member's profile.</li>
          </ol>
          <p>The handicap index is calculated using the World Handicap System (WHS) formula.</p>
        </div>
        
        <!-- Result display -->
        <div id="handicap-result" class="result" style="display: none;"></div>
        
        <!-- Instructions -->
        <p style="text-align: center; margin: 1.5rem 0; font-family: var(--font-family-base); color: var(--bbb-text-muted);">
          Enter up to 20 rounds. Minimum 3 to calculate.
        </p>
        
        <!-- Rounds table -->
        <table id="rounds-table" class="rounds-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Course</th>
              <th>Tee</th>
              <th>Score</th>
              <th>Course Rating</th>
              <th>Slope Rating</th>
              <th>Differential</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rounds-tbody">
            <!-- Round rows will be added by JavaScript -->
          </tbody>
        </table>
        
        <!-- Buttons -->
        <div class="button-group">
          <button id="add-round" class="btn">Add Round</button>
          <button id="calculate" class="btn">Calculate Handicap</button>
          <button id="reset" class="btn">Reset</button>
          <button id="save" class="btn" disabled>Save Handicap</button>
          <button id="export" class="btn">Export to CSV</button>
        </div>
        
        <!-- Handicap history section -->
        <div id="handicap-history" class="history-section" style="display: none;"></div>
      </div>
    </div>
  </main>

  <!-- Enhanced Calculator Script with DB Integration -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("=== HANDICAP CALCULATOR WITH DB INTEGRATION ===");
      
      // Initialize calculator
      initializeCalculator();
    });
    
    function initializeCalculator() {
      console.log("Initializing calculator with DB integration...");
      
      // Initialize modules if available
      if (typeof BBB_AUTH !== 'undefined' && BBB_AUTH.init) {
        try {
          BBB_AUTH.init({
            cloudflareEnabled: BBB_CONFIG ? BBB_CONFIG.cloudflareEnabled : false
          });
          console.log("✓ BBB_AUTH initialized");
        } catch (error) {
          console.warn("BBB_AUTH initialization failed:", error);
        }
      }
      
      if (typeof BBB_DB !== 'undefined' && BBB_DB.init) {
        try {
          BBB_DB.init({
            useCloudflare: BBB_CONFIG ? BBB_CONFIG.cloudflareEnabled : false,
            localStoragePrefix: 'bbb_'
          });
          console.log("✓ BBB_DB initialized");
        } catch (error) {
          console.warn("BBB_DB initialization failed:", error);
        }
      }
      
      // Load members and courses
      populateMembersDropdown();
      
      // Set up event handlers
      setupEventHandlers();
      
      // Check authentication
      checkAuthentication();
      
      // Add initial rounds
      for (let i = 0; i < 3; i++) {
        addRoundInput();
      }
      
      console.log("Calculator initialization complete");
    }
    
    function populateMembersDropdown() {
      console.log("Populating members dropdown...");
      
      const memberSelect = document.getElementById('member-select');
      if (!memberSelect) {
        console.error("Member select element not found!");
        return;
      }
      
      // Clear existing options
      memberSelect.innerHTML = '<option value="">-- Select Member --</option>';
      
      let members = [];
      let source = 'none';
      
      // Try to get members from BBB_CONFIG (your merged config approach)
      if (typeof BBB_CONFIG !== 'undefined') {
        console.log("BBB_CONFIG found, checking for members...");
        
        if (BBB_CONFIG.members && Array.isArray(BBB_CONFIG.members) && BBB_CONFIG.members.length > 0) {
          members = BBB_CONFIG.members;
          source = 'BBB_CONFIG.members';
          console.log(`Found ${members.length} members in BBB_CONFIG.members`);
        } else if (BBB_CONFIG.staticMembers && Array.isArray(BBB_CONFIG.staticMembers) && BBB_CONFIG.staticMembers.length > 0) {
          members = BBB_CONFIG.staticMembers;
          source = 'BBB_CONFIG.staticMembers';
          console.log(`Found ${members.length} members in BBB_CONFIG.staticMembers`);
        }
      }
      
      // Fallback to hardcoded members if config fails
      if (members.length === 0) {
        console.log("Using hardcoded member fallback");
        members = [
          "Amrit", "Kam", "Vish", "Ravi", "Bal", "Vick", 
          "Michael", "Justy", "Phuperjee", "Indy", "Maj", "Sama"
        ];
        source = 'hardcoded fallback';
      }
      
      // Populate dropdown
      members.forEach(member => {
        const option = document.createElement('option');
        option.value = typeof member === 'string' ? member.toLowerCase() : member.id || member.username;
        option.textContent = typeof member === 'string' ? member : member.display_name || member.username;
        memberSelect.appendChild(option);
      });
      
      console.log(`✓ Successfully populated ${members.length} members from ${source}`);
      showMessage(`Loaded ${members.length} members from ${source}`, 'success');
      
      // Auto-select current user if authenticated
      if (typeof BBB_AUTH !== 'undefined' && BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
        const userOption = Array.from(memberSelect.options).find(opt => opt.value === BBB_AUTH.currentUser.id);
        if (userOption) {
          userOption.selected = true;
          console.log(`Auto-selected current user: ${BBB_AUTH.currentUser.id}`);
        }
      }
    }
    
    function setupEventHandlers() {
      console.log("Setting up event handlers...");
      
      // Get DOM elements
      const helpToggle = document.getElementById('help-toggle');
      const helpSection = document.getElementById('help-section');
      const memberSelect = document.getElementById('member-select');
      const addButton = document.getElementById('add-round');
      const calculateButton = document.getElementById('calculate');
      const resetButton = document.getElementById('reset');
      const saveButton = document.getElementById('save');
      const exportButton = document.getElementById('export');
      
      // Help toggle
      if (helpToggle && helpSection) {
        helpToggle.addEventListener('click', function() {
          if (helpSection.style.display === 'none') {
            helpSection.style.display = 'block';
            helpToggle.textContent = 'Hide Help';
          } else {
            helpSection.style.display = 'none';
            helpToggle.textContent = 'Show Help';
          }
        });
      }
      
      // Member selection change
      if (memberSelect) {
        memberSelect.addEventListener('change', function() {
          console.log(`Member selected: ${this.value}`);
          loadSavedHandicap(this.value);
        });
      }
      
      // Button handlers
      if (addButton) addButton.addEventListener('click', addRoundInput);
      if (calculateButton) calculateButton.addEventListener('click', calculateHandicap);
      if (resetButton) resetButton.addEventListener('click', resetCalculator);
      if (saveButton) saveButton.addEventListener('click', saveHandicap);
      if (exportButton) exportButton.addEventListener('click', exportToCSV);
    }
    
    function addRoundInput() {
      const roundsTbody = document.getElementById('rounds-tbody');
      const roundIndex = roundsTbody.children.length;
      
      if (roundIndex >= 20) {
        showMessage('Maximum 20 rounds allowed.', 'warning');
        return;
      }
      
      const row = document.createElement('tr');
      row.id = `round-${roundIndex}`;
      row.className = 'round-row';
      
      // Round number
      const numCell = document.createElement('td');
      numCell.textContent = roundIndex + 1;
      
      // Course selection
      const courseCell = document.createElement('td');
      const courseSelect = document.createElement('select');
      courseSelect.className = 'course-select';
      courseSelect.id = `course-${roundIndex}`;
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Select Course --';
      courseSelect.appendChild(defaultOption);
      
      // Add course options from BBB_DB
      if (typeof BBB_DB !== 'undefined' && BBB_DB.getCourseNames) {
        try {
          const courseNames = BBB_DB.getCourseNames();
          courseNames.forEach(courseName => {
            const option = document.createElement('option');
            option.value = courseName;
            option.textContent = courseName;
            courseSelect.appendChild(option);
          });
          console.log(`Added ${courseNames.length} courses from BBB_DB`);
        } catch (error) {
          console.warn('Error loading courses from BBB_DB:', error);
          addFallbackCourses(courseSelect);
        }
      } else {
        addFallbackCourses(courseSelect);
      }
      
      courseCell.appendChild(courseSelect);
      
      // Tee selection
      const teeCell = document.createElement('td');
      const teeSelect = document.createElement('select');
      teeSelect.className = 'tee-select';
      teeSelect.id = `tee-${roundIndex}`;
      
      // Add default option
      const defaultTeeOption = document.createElement('option');
      defaultTeeOption.value = '';
      defaultTeeOption.textContent = '-- Select Tee --';
      teeSelect.appendChild(defaultTeeOption);
      
      // Add tee options
      const teeColors = { white: "White", yellow: "Yellow", red: "Red" };
      for (const teeValue in teeColors) {
        const option = document.createElement('option');
        option.value = teeValue;
        option.textContent = teeColors[teeValue];
        teeSelect.appendChild(option);
      }
      
      teeCell.appendChild(teeSelect);
      
      // Score input
      const scoreCell = document.createElement('td');
      const scoreInput = document.createElement('input');
      scoreInput.type = 'number';
      scoreInput.min = '50';
      scoreInput.max = '150';
      scoreInput.className = 'score-input';
      scoreInput.id = `score-${roundIndex}`;
      scoreInput.placeholder = 'Score';
      scoreCell.appendChild(scoreInput);
      
      // Course Rating display
      const crCell = document.createElement('td');
      const crInput = document.createElement('input');
      crInput.type = 'number';
      crInput.step = '0.1';
      crInput.className = 'cr-input';
      crInput.id = `cr-${roundIndex}`;
      crInput.placeholder = 'CR';
      crInput.readOnly = true;
      crCell.appendChild(crInput);
      
      // Slope Rating display
      const srCell = document.createElement('td');
      const srInput = document.createElement('input');
      srInput.type = 'number';
      srInput.min = '55';
      srInput.max = '155';
      srInput.className = 'sr-input';
      srInput.id = `sr-${roundIndex}`;
      srInput.placeholder = 'SR';
      srInput.readOnly = true;
      srCell.appendChild(srInput);
      
      // Differential display
      const diffCell = document.createElement('td');
      const diffSpan = document.createElement('span');
      diffSpan.className = 'differential';
      diffSpan.id = `diff-${roundIndex}`;
      diffSpan.textContent = '--';
      diffCell.appendChild(diffSpan);
      
      // Remove button
      const actionCell = document.createElement('td');
      const removeButton = document.createElement('button');
      removeButton.className = 'remove-btn';
      removeButton.textContent = '✕';
      removeButton.title = 'Remove this round';
      removeButton.onclick = function() {
        removeRound(roundIndex);
      };
      actionCell.appendChild(removeButton);
      
      // Add all cells to row
      row.appendChild(numCell);
      row.appendChild(courseCell);
      row.appendChild(teeCell);
      row.appendChild(scoreCell);
      row.appendChild(crCell);
      row.appendChild(srCell);
      row.appendChild(diffCell);
      row.appendChild(actionCell);
      
      // Add row to table
      roundsTbody.appendChild(row);
      
      // Set up event handlers for this row
      setupRowEventHandlers(roundIndex);
      
      console.log(`Added round ${roundIndex + 1}`);
    }
    
    function addFallbackCourses(courseSelect) {
      const fallbackCourses = [
        "Richings Park Golf Club",
        "Thorney Park Golf Club", 
        "London Airlinks Golf Club",
        "Royal Ascot Golf Club",
        "Stoke Park Golf Club",
        "Inspirations Golf Club"
      ];
      
      fallbackCourses.forEach(courseName => {
        const option = document.createElement('option');
        option.value = courseName;
        option.textContent = courseName;
        courseSelect.appendChild(option);
      });
      
      console.log('Added fallback courses');
    }
    
    function setupRowEventHandlers(roundIndex) {
      const courseSelect = document.getElementById(`course-${roundIndex}`);
      const teeSelect = document.getElementById(`tee-${roundIndex}`);
      const scoreInput = document.getElementById(`score-${roundIndex}`);
      const crInput = document.getElementById(`cr-${roundIndex}`);
      const srInput = document.getElementById(`sr-${roundIndex}`);
      
      // Update ratings when course or tee changes
      function updateRatings() {
        const selectedCourse = courseSelect.value;
        const selectedTee = teeSelect.value;
        
        if (!selectedCourse || !selectedTee) {
          crInput.value = '';
          srInput.value = '';
          updateDifferential(roundIndex);
          return;
        }
        
        // Get ratings from BBB_DB
        if (typeof BBB_DB !== 'undefined' && BBB_DB.getCourseRatings) {
          try {
            const ratings = BBB_DB.getCourseRatings(selectedCourse, selectedTee);
            
            if (ratings) {
              crInput.value = ratings.courseRating;
              srInput.value = ratings.slopeRating;
              console.log(`Updated ratings for ${selectedCourse}, ${selectedTee}: CR=${ratings.courseRating}, SR=${ratings.slopeRating}`);
            } else {
              console.warn(`No ratings found for ${selectedCourse}, ${selectedTee}`);
              crInput.value = '';
              srInput.value = '';
            }
          } catch (error) {
            console.error('Error getting course ratings:', error);
            crInput.value = '';
            srInput.value = '';
          }
        } else {
          console.warn('BBB_DB.getCourseRatings not available');
          crInput.value = '';
          srInput.value = '';
        }
        
        updateDifferential(roundIndex);
      }
      
      // Add event listeners
      courseSelect.addEventListener('change', updateRatings);
      teeSelect.addEventListener('change', updateRatings);
      scoreInput.addEventListener('input', function() { 
        updateDifferential(roundIndex); 
      });
    }
    
    function updateDifferential(roundIndex) {
      const scoreInput = document.getElementById(`score-${roundIndex}`);
      const crInput = document.getElementById(`cr-${roundIndex}`);
      const srInput = document.getElementById(`sr-${roundIndex}`);
      const diffSpan = document.getElementById(`diff-${roundIndex}`);
      
      const score = parseFloat(scoreInput.value);
      const courseRating = parseFloat(crInput.value);
      const slopeRating = parseFloat(srInput.value);
      
      if (!isNaN(score) && !isNaN(courseRating) && !isNaN(slopeRating) && score > 0) {
        // Use BBB_DB calculation if available
        if (typeof BBB_DB !== 'undefined' && BBB_DB.calculateDifferential) {
          const courseSelect = document.getElementById(`course-${roundIndex}`);
          const teeSelect = document.getElementById(`tee-${roundIndex}`);
          
          const differential = BBB_DB.calculateDifferential(
            score, 
            courseSelect.value, 
            teeSelect.value
          );
          
          if (differential !== null) {
            diffSpan.textContent = differential.toFixed(1);
            diffSpan.dataset.value = differential;
            console.log(`Updated differential for round ${roundIndex + 1}: ${differential.toFixed(1)}`);
          } else {
            diffSpan.textContent = '--';
            diffSpan.dataset.value = '';
          }
        } else {
          // Fallback calculation
          const differential = ((score - courseRating) * 113) / slopeRating;
          diffSpan.textContent = differential.toFixed(1);
          diffSpan.dataset.value = differential;
          console.log(`Updated differential for round ${roundIndex + 1}: ${differential.toFixed(1)} (fallback calc)`);
        }
      } else {
        diffSpan.textContent = '--';
        diffSpan.dataset.value = '';
      }
    }
    
    function removeRound(roundIndex) {
      const roundsTbody = document.getElementById('rounds-tbody');
      
      if (roundsTbody.children.length <= 3) {
        showMessage('Minimum 3 rounds required.', 'warning');
        return;
      }
      
      const row = document.getElementById(`round-${roundIndex}`);
      if (row) {
        row.remove();
        renumberRounds();
      }
    }
    
    function renumberRounds() {
      const roundsTbody = document.getElementById('rounds-tbody');
      
      Array.from(roundsTbody.children).forEach((row, index) => {
        // Update row ID
        row.id = `round-${index}`;
        
        // Update round number
        const numCell = row.querySelector('td:first-child');
        if (numCell) {
          numCell.textContent = index + 1;
        }
        
        // Update all input/select IDs and event handlers
        const courseSelect = row.querySelector('.course-select');
        const teeSelect = row.querySelector('.tee-select');
        const scoreInput = row.querySelector('.score-input');
        const crInput = row.querySelector('.cr-input');
        const srInput = row.querySelector('.sr-input');
        const diffSpan = row.querySelector('.differential');
        const removeBtn = row.querySelector('.remove-btn');
        
        if (courseSelect) {
          courseSelect.id = `course-${index}`;
          courseSelect.onchange = () => updateDifferential(index);
        }
        if (teeSelect) {
          teeSelect.id = `tee-${index}`;
          teeSelect.onchange = () => updateDifferential(index);
        }
        if (scoreInput) {
          scoreInput.id = `score-${index}`;
          scoreInput.oninput = () => updateDifferential(index);
        }
        if (crInput) crInput.id = `cr-${index}`;
        if (srInput) srInput.id = `sr-${index}`;
        if (diffSpan) diffSpan.id = `diff-${index}`;
        if (removeBtn) {
          removeBtn.onclick = () => removeRound(index);
        }
        
        // Re-setup event handlers for this row
        setupRowEventHandlers(index);
      });
      
      console.log('Renumbered rounds');
    }
    
    function calculateHandicap() {
      console.log('Calculating handicap...');
      
      const memberSelect = document.getElementById('member-select');
      const selectedMember = memberSelect.options[memberSelect.selectedIndex].text;
      
      if (!memberSelect.value) {
        showMessage('Please select a member first.', 'error');
        return;
      }
      
      // Collect round data
      const rounds = [];
      const roundsTbody = document.getElementById('rounds-tbody');
      
      Array.from(roundsTbody.children).forEach((row, index) => {
        const courseSelect = row.querySelector('.course-select');
        const teeSelect = row.querySelector('.tee-select');
        const scoreInput = row.querySelector('.score-input');
        const diffSpan = row.querySelector('.differential');
        
        const score = parseFloat(scoreInput.value);
        const courseName = courseSelect.value;
        const teeColor = teeSelect.value;
        const differential = parseFloat(diffSpan.dataset.value);
        
        if (score && courseName && teeColor && !isNaN(differential)) {
          rounds.push({
            score: score,
            courseName: courseName,
            teeColor: teeColor,
            differential: differential
          });
        }
      });
      
      if (rounds.length < 3) {
        showMessage('Please enter at least 3 complete rounds with valid scores.', 'error');
        return;
      }
      
      console.log(`Calculating handicap from ${rounds.length} rounds:`, rounds);
      
      // Use BBB_DB enhanced calculation if available
      let result;
      if (typeof BBB_DB !== 'undefined' && BBB_DB.calculateHandicapFromRounds) {
        try {
          result = BBB_DB.calculateHandicapFromRounds(rounds);
          console.log('Used BBB_DB.calculateHandicapFromRounds:', result);
        } catch (error) {
          console.error('Error with BBB_DB calculation:', error);
          result = fallbackHandicapCalculation(rounds);
        }
      } else {
        result = fallbackHandicapCalculation(rounds);
      }
      
      if (result.error) {
        showMessage(result.error, 'error');
        return;
      }
      
      // Display result
      const resultDisplay = document.getElementById('handicap-result');
      resultDisplay.innerHTML = `
        <div class="handicap-result-inner">
          <h3>${selectedMember}'s Handicap Index</h3>
          <div class="handicap-value">${result.handicapIndex}</div>
          <div class="handicap-info">
            Calculated using ${rounds.length} rounds<br>
            Best ${result.roundsUsed} differentials averaged
          </div>
        </div>
      `;
      resultDisplay.style.display = 'block';
      
      // Store result for saving
      resultDisplay.dataset.value = result.handicapIndex;
      resultDisplay.dataset.rounds = JSON.stringify(rounds);
      
      // Enable save button
      const saveButton = document.getElementById('save');
      if (saveButton && typeof BBB_AUTH !== 'undefined' && BBB_AUTH.isAuthenticated) {
        saveButton.disabled = false;
      }
      
      showMessage('Handicap calculated successfully!', 'success');
    }
    
    function fallbackHandicapCalculation(rounds) {
      const differentials = rounds.map(r => r.differential).sort((a, b) => a - b);
      
      // Number of differentials to use
      const countMap = {
        3: 1, 4: 1, 5: 1, 6: 2, 7: 2, 8: 2, 9: 3, 10: 3,
        11: 3, 12: 4, 13: 4, 14: 4, 15: 5, 16: 5, 17: 6,
        18: 7, 19: 8, 20: 10
      };
      
      const roundsToUse = countMap[differentials.length] || Math.min(10, Math.floor(differentials.length / 2));
      const bestDifferentials = differentials.slice(0, roundsToUse);
      const average = bestDifferentials.reduce((sum, diff) => sum + diff, 0) / roundsToUse;
      const handicapIndex = (average * 0.96).toFixed(1);
      
      console.log('Fallback handicap calculation:', {
        differentials: differentials.length,
        roundsToUse,
        average,
        handicapIndex
      });
      
      return {
        handicapIndex: parseFloat(handicapIndex),
        roundsUsed: roundsToUse,
        differentials,
        calculatedAt: new Date().toISOString()
      };
    }
    
    function resetCalculator() {
      if (confirm('Are you sure you want to reset the calculator? This will clear all rounds.')) {
        const roundsTbody = document.getElementById('rounds-tbody');
        const resultDisplay = document.getElementById('handicap-result');
        const saveButton = document.getElementById('save');
        
        // Clear existing rounds
        roundsTbody.innerHTML = '';
        
        // Add 3 initial rounds
        for (let i = 0; i < 3; i++) {
          addRoundInput();
        }
        
        // Clear result
        resultDisplay.innerHTML = '';
        resultDisplay.style.display = 'none';
        delete resultDisplay.dataset.value;
        delete resultDisplay.dataset.rounds;
        
        // Disable save button
        if (saveButton) {
          saveButton.disabled = true;
        }
        
        showMessage('Calculator has been reset.', 'success');
      }
    }
    
    function saveHandicap() {
      const memberSelect = document.getElementById('member-select');
      const resultDisplay = document.getElementById('handicap-result');
      
      if (!BBB_AUTH || !BBB_AUTH.isAuthenticated) {
        showMessage('Please log in to save handicap.', 'error');
        return;
      }
      
      const handicapIndex = resultDisplay.dataset.value;
      const rounds = JSON.parse(resultDisplay.dataset.rounds || '[]');
      
      if (!handicapIndex) {
        showMessage('Please calculate handicap first.', 'error');
        return;
      }
      
      const selectedMemberId = memberSelect.value;
      if (!selectedMemberId) {
        showMessage('Please select a member.', 'error');
        return;
      }
      
      // Check permissions
      if (selectedMemberId !== BBB_AUTH.currentUser.id && 
          (!BBB_AUTH.hasRole || !BBB_AUTH.hasRole('admin'))) {
        showMessage('You can only save handicaps to your own profile unless you are an admin.', 'error');
        return;
      }
      
      const handicapData = {
        index: parseFloat(handicapIndex),
        calculatedAt: new Date().toISOString(),
        rounds: rounds.length,
        roundsData: rounds,
        calculatedBy: BBB_AUTH.currentUser.id
      };
      
      // Save using BBB_DB
      if (typeof BBB_DB !== 'undefined' && BBB_DB.saveMemberHandicap) {
        BBB_DB.saveMemberHandicap(selectedMemberId, handicapData)
          .then(() => {
            showMessage('Handicap saved successfully!', 'success');
            loadSavedHandicap(selectedMemberId);
          })
          .catch(err => {
            console.error('Error saving handicap:', err);
            showMessage('Error saving handicap.', 'error');
          });
      } else {
        // Fallback to localStorage
        try {
          const key = `bbb_handicap_${selectedMemberId}`;
          localStorage.setItem(key, JSON.stringify(handicapData));
          showMessage('Handicap saved to browser storage!', 'success');
          loadSavedHandicap(selectedMemberId);
        } catch (error) {
          console.error('Error saving to localStorage:', error);
          showMessage('Error saving handicap.', 'error');
        }
      }
    }
    
    function loadSavedHandicap(memberId) {
      if (!memberId) return;
      
      console.log("Loading saved handicap for:", memberId);
      
      // Try BBB_DB first
      if (typeof BBB_DB !== 'undefined' && BBB_DB.getMemberHandicap) {
        BBB_DB.getMemberHandicap(memberId)
          .then(data => {
            displayHandicapHistory(data ? [data] : [], memberId);
          })
          .catch(err => {
            console.error('Error loading handicap:', err);
            // Try localStorage fallback
            loadFromLocalStorage(memberId);
          });
      } else {
        loadFromLocalStorage(memberId);
      }
    }
    
    function loadFromLocalStorage(memberId) {
      try {
        const key = `bbb_handicap_${memberId}`;
        const data = localStorage.getItem(key);
        
        if (data) {
          const handicapData = JSON.parse(data);
          displayHandicapHistory([handicapData], memberId);
        } else {
          hideHandicapHistory();
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        hideHandicapHistory();
      }
    }
    
    function displayHandicapHistory(handicapData, memberId) {
      const historySection = document.getElementById('handicap-history');
      
      if (!handicapData || handicapData.length === 0) {
        hideHandicapHistory();
        return;
      }
      
      const memberName = document.getElementById('member-select').selectedOptions[0]?.text || 'Member';
      
      historySection.innerHTML = `
        <h3>${memberName}'s Handicap History</h3>
        <div class="history-cards">
          ${handicapData.map(item => `
            <div class="history-card">
              <div class="history-index">Index: ${item.index}</div>
              <div class="history-date">Calculated: ${new Date(item.calculatedAt).toLocaleDateString()}</div>
              <div class="history-rounds">Rounds used: ${item.rounds || 'Unknown'}</div>
              ${item.calculatedBy ? `<div class="history-rounds">By: ${item.calculatedBy}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      historySection.style.display = 'block';
    }
    
    function hideHandicapHistory() {
      const historySection = document.getElementById('handicap-history');
      if (historySection) {
        historySection.style.display = 'none';
      }
    }
    
    function exportToCSV() {
      const memberSelect = document.getElementById('member-select');
      const selectedMember = memberSelect.options[memberSelect.selectedIndex].text;
      const roundsTbody = document.getElementById('rounds-tbody');
      
      if (roundsTbody.children.length === 0) {
        showMessage('No rounds to export.', 'error');
        return;
      }
      
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += `Handicap Data for ${selectedMember}\n`;
      csvContent += "Course,Tee,Score,Course Rating,Slope Rating,Differential\n";
      
      Array.from(roundsTbody.children).forEach(row => {
        const course = row.querySelector('.course-select').value;
        const tee = row.querySelector('.tee-select').value;
        const score = row.querySelector('.score-input').value;
        const cr = row.querySelector('.cr-input').value;
        const sr = row.querySelector('.sr-input').value;
        const diff = row.querySelector('.differential').textContent;
        
        if (course && tee && score) {
          csvContent += `"${course}","${tee}",${score},${cr},${sr},${diff}\n`;
        }
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `${selectedMember.replace(/\s+/g, '_')}_handicap_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showMessage('Exported to CSV file.', 'success');
    }
    
    function checkAuthentication() {
      if (typeof BBB_AUTH === 'undefined') {
        return;
      }
      
      // Try to restore session
      try {
        const storedAuth = localStorage.getItem('bbb_auth_session');
        const storedUser = localStorage.getItem('bbb_current_user');
        
        if (storedAuth && storedUser) {
          const authData = JSON.parse(storedAuth);
          const userData = JSON.parse(storedUser);
          
          if (authData.expiresAt && new Date(authData.expiresAt) > new Date()) {
            BBB_AUTH.currentUser = userData;
            BBB_AUTH.isAuthenticated = true;
            console.log(`✓ Restored session for user: ${userData.id}`);
            
            addAuthControls();
            
            if (BBB_AUTH.hasRole && BBB_AUTH.hasRole('admin')) {
              const adminMessage = document.getElementById('admin-message');
              if (adminMessage) {
                adminMessage.style.display = 'block';
              }
            }
          }
        }
      } catch (error) {
        console.warn("Auth restoration failed:", error);
      }
    }
    
    function addAuthControls() {
      const headerRight = document.querySelector('.header-right');
      if (!headerRight || !BBB_AUTH.isAuthenticated) return;
      
      if (!headerRight.querySelector('.user-info')) {
        const userInfo = document.createElement('span');
        userInfo.className = 'user-info';
        userInfo.textContent = `Welcome, ${BBB_AUTH.currentUser.id}`;
        headerRight.insertBefore(userInfo, headerRight.firstChild);
      }
      
      if (!headerRight.querySelector('.logout-btn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'logout-btn';
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = function() {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('bbb_auth_session');
            localStorage.removeItem('bbb_current_user');
            window.location.reload();
          }
        };
        headerRight.appendChild(logoutBtn);
      }
    }
    
    function showMessage(message, type = 'info') {
      const statusElement = document.getElementById('status-message');
      if (!statusElement) return;
      
      statusElement.textContent = message;
      statusElement.className = type;
      statusElement.style.display = 'block';
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
  </script>
</body>
</html>
