<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Handicap Calculator</title>
  <meta name="description" content="Calculate your golf handicap using the World Handicap System standard.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize auth system
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      // Initialize database
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Create header
      const headerElements = BBB_UI.createHeader({
        fixed: true,
        showHomeLinkText: true
      });
      
      document.body.insertBefore(headerElements.header, document.body.firstChild);
      
      // Get main content element
      const main = document.getElementById('main');
      main.appendChild(headerElements.mainWrapper);
      
      // Create page content
      const mainContent = document.createElement('div');
      
      // Create page title
      const titleContainer = BBB_UI.createPageTitle({
        title: 'Birdie Bush Bandits',
        showFoundedText: true,
        showGolfballs: true
      });
      mainContent.appendChild(titleContainer);
      
      // Add page subtitle
      const subtitle = document.createElement('h2');
      subtitle.textContent = 'Handicap Calculator';
      mainContent.appendChild(subtitle);
      
      // Create status message container
      const statusMessage = BBB_UI.createStatusMessage();
      mainContent.appendChild(statusMessage);
      
      // Create handicap calculator
      const calculator = document.createElement('div');
      calculator.className = 'calculator';
      
      // Instructions text
      const instructions = document.createElement('p');
      instructions.textContent = 'Enter up to 20 rounds. Minimum 3 to calculate.';
      calculator.appendChild(instructions);
      
      // Rounds container
      const roundsContainer = document.createElement('div');
      roundsContainer.id = 'rounds-container';
      calculator.appendChild(roundsContainer);
      
      // Create buttons
      const addButton = BBB_UI.createButton({
        text: 'Add Round',
        id: 'add-round',
        onClick: function() {
          if (roundsContainer.children.length < 20) {
            addRound();
          } else {
            BBB_UTILS.showMessage('Maximum 20 rounds allowed.', 'warning');
          }
        }
      });
      
      const calculateButton = BBB_UI.createButton({
        text: 'Calculate Handicap',
        id: 'calculate',
        onClick: calculateHandicap
      });
      
      // Button container
      const buttonContainer = document.createElement('div');
      buttonContainer.style.marginTop = '1rem';
      buttonContainer.appendChild(addButton);
      buttonContainer.appendChild(document.createTextNode(' '));
      buttonContainer.appendChild(calculateButton);
      calculator.appendChild(buttonContainer);
      
      // Result display
      const resultDisplay = document.createElement('div');
      resultDisplay.className = 'result';
      resultDisplay.id = 'handicap-result';
      calculator.appendChild(resultDisplay);
      
      // Add calculator to page
      mainContent.appendChild(calculator);
      
      // Add content to main
      headerElements.mainWrapper.appendChild(mainContent);
      
      // Add initial rounds
      for (let i = 0; i < 3; i++) {
        addRound();
      }
      
      // Function to create a new round input
      function createRoundInput(idx) {
        const div = document.createElement('div');
        div.className = 'round';
        
        // Course selection
        const courseLabel = document.createElement('label');
        courseLabel.textContent = `Round ${idx + 1} Course`;
        
        const courseSelect = document.createElement('select');
        courseSelect.className = 'course-select';
        
        // Add course options from config
        Object.keys(BBB_CONFIG.courses).forEach(courseName => {
          const option = document.createElement('option');
          option.value = courseName;
          option.textContent = courseName;
          courseSelect.appendChild(option);
        });
        
        // Tee selection
        const teeLabel = document.createElement('label');
        teeLabel.textContent = 'Tee Colour';
        
        const teeSelect = document.createElement('select');
        teeSelect.className = 'tee-select';
        
        // Add tee options from config
        Object.keys(BBB_CONFIG.teeColors).forEach(teeValue => {
          const option = document.createElement('option');
          option.value = teeValue;
          option.textContent = BBB_CONFIG.teeColors[teeValue];
          teeSelect.appendChild(option);
        });
        
        // Score input
        const scoreLabel = document.createElement('label');
        scoreLabel.textContent = 'Gross Score';
        
        const scoreInput = document.createElement('input');
        scoreInput.type = 'number';
        scoreInput.className = 'score';
        scoreInput.min = 0;
        scoreInput.required = true;
        
        // Course Rating display
        const crLabel = document.createElement('label');
        crLabel.textContent = 'Course Rating';
        
        const crInput = document.createElement('input');
        crInput.type = 'number';
        crInput.className = 'course-rating';
        crInput.step = 0.1;
        crInput.required = true;
        
        // Slope Rating display
        const srLabel = document.createElement('label');
        srLabel.textContent = 'Slope Rating';
        
        const srInput = document.createElement('input');
        srInput.type = 'number';
        srInput.className = 'slope-rating';
        srInput.min = 55;
        srInput.max = 155;
        srInput.required = true;
        
        // Differential display
        const diffLabel = document.createElement('label');
        diffLabel.textContent = 'Differential';
        
        const diffInput = document.createElement('input');
        diffInput.type = 'text';
        diffInput.className = 'differential';
        diffInput.readOnly = true;
        
        // Add all elements to div
        div.appendChild(courseLabel);
        div.appendChild(courseSelect);
        div.appendChild(teeLabel);
        div.appendChild(teeSelect);
        div.appendChild(scoreLabel);
        div.appendChild(scoreInput);
        div.appendChild(crLabel);
        div.appendChild(crInput);
        div.appendChild(srLabel);
        div.appendChild(srInput);
        div.appendChild(diffLabel);
        div.appendChild(diffInput);
        
        // Setup event handlers to update course/slope ratings and differential
        function updateRatings() {
          const selectedCourse = courseSelect.value;
          const selectedTee = teeSelect.value;
          
          // Get ratings from config
          const courseData = BBB_CONFIG.courses[selectedCourse];
          if (courseData && courseData.tees && courseData.tees[selectedTee]) {
            crInput.value = courseData.tees[selectedTee].courseRating;
            srInput.value = courseData.tees[selectedTee].slopeRating;
          }
          
          // Update differential
          updateDifferential();
        }
        
        function updateDifferential() {
          const score = parseFloat(scoreInput.value);
          const courseRating = parseFloat(crInput.value);
          const slopeRating = parseFloat(srInput.value);
          
          if (!isNaN(score) && !isNaN(courseRating) && !isNaN(slopeRating)) {
            // Calculate differential using formula: (Score - CR) * (113 / SR)
            const differential = ((score - courseRating) * 113 / slopeRating).toFixed(1);
            diffInput.value = differential;
          } else {
            diffInput.value = '';
          }
        }
        
        // Add event listeners
        courseSelect.addEventListener('change', updateRatings);
        teeSelect.addEventListener('change', updateRatings);
        scoreInput.addEventListener('input', updateDifferential);
        crInput.addEventListener('input', updateDifferential);
        srInput.addEventListener('input', updateDifferential);
        
        // Initial update
        updateRatings();
        
        return div;
      }
      
      // Add a new round to the container
      function addRound() {
        const roundIndex = roundsContainer.children.length;
        const roundElement = createRoundInput(roundIndex);
        roundsContainer.appendChild(roundElement);
      }
      
      // Calculate handicap from entered rounds
      function calculateHandicap() {
        const resultEl = document.getElementById('handicap-result');
        const differentials = [];
        
        // Get all differentials from inputs
        roundsContainer.querySelectorAll('.round').forEach(div => {
          const score = parseFloat(div.querySelector('.score').value);
          const cr = parseFloat(div.querySelector('.course-rating').value);
          const sr = parseFloat(div.querySelector('.slope-rating').value);
          
          if (!isNaN(score) && !isNaN(cr) && !isNaN(sr)) {
            const differential = (score - cr) * 113 / sr;
            differentials.push(differential);
          }
        });
        
        // Check if we have enough rounds
        if (differentials.length < BBB_CONFIG.handicap.minRounds) {
          resultEl.textContent = `Enter at least ${BBB_CONFIG.handicap.minRounds} complete rounds.`;
          BBB_UTILS.showMessage(`Please enter at least ${BBB_CONFIG.handicap.minRounds} rounds.`, 'error');
          return;
        }
        
        // Calculate handicap using util function
        const handicapIndex = BBB_UTILS.calculateHandicapIndex(differentials);
        resultEl.textContent = `Your Handicap Index is ${handicapIndex}`;
        
        // Show success message
        BBB_UTILS.showMessage('Handicap calculated successfully!', 'success');
        
        // Save handicap if user is logged in
        if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
          const handicapData = {
            index: handicapIndex,
            calculatedAt: new Date().toISOString(),
            differentials: differentials,
            rounds: differentials.length
          };
          
          BBB_DB.saveMemberHandicap(BBB_AUTH.currentUser.id, handicapData)
            .then(() => {
              console.log('Handicap saved to database');
            })
            .catch(err => {
              console.error('Error saving handicap:', err);
            });
        }
      }
    });
  </script>
</body>
</html>
