<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Admin Dashboard - BBB</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #e8f5e8 0%, #f5f5f5 100%);
      min-height: 100vh;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #004d00, #006600);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .admin-tabs {
      display: flex;
      background: white;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .tab-button {
      flex: 1;
      padding: 1.2rem 1.5rem;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      background: white;
      color: #004d00;
      border-bottom-color: #004d00;
    }

    .tab-button:hover:not(.active) {
      background: #e9ecef;
      color: #004d00;
    }

    .tab-content {
      background: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 2rem;
      min-height: 600px;
    }

    .tab-panel {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafbfc;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #004d00;
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 77, 0, 0.1);
    }

    button {
      background: linear-gradient(135deg, #004d00, #006600);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 77, 0, 0.3);
    }

    button:disabled {
      background: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #5a6268);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .message {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
      text-align: center;
      border-left: 4px solid;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border-color: #28a745;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #17a2b8;
    }

    .hidden {
      display: none !important;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff, #f8f9fa);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      border-left: 4px solid #004d00;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #004d00;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-input {
      padding-left: 2.5rem;
      background: #f8f9fa;
      border: 2px solid #e1e5e9;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 1.1rem;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .users-table th,
    .users-table td {
      padding: 1rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }

    .users-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .users-table tr:hover {
      background: #f8f9fa;
    }

    .role-badge {
      padding: 0.3rem 0.7rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .role-admin {
      background: #ffd700;
      color: #856404;
    }

    .role-member {
      background: #d4edda;
      color: #155724;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      padding: 0.4rem;
      min-width: 2rem;
      height: 2rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #004d00;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .reset-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .reset-option {
      padding: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      background: #f8f9fa;
    }

    .reset-option.active {
      border-color: #004d00;
      background: #e8f5e8;
    }

    .audit-log {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border-left: 4px solid #004d00;
    }

    .audit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .audit-action {
      font-weight: 600;
      color: #004d00;
      font-size: 0.9rem;
    }

    .audit-time {
      font-size: 0.8rem;
      color: #666;
    }

    .audit-details {
      font-size: 0.9rem;
      color: #333;
    }

    .audit-user {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.25rem;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 3rem;
    }

    .back-link {
      text-align: center;
      margin-top: 2rem;
      padding: 1rem;
    }

    .back-link a {
      color: #004d00;
      text-decoration: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 1rem auto;
        padding: 0 1rem;
      }

      .header {
        padding: 1rem;
      }

      .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .admin-tabs {
        flex-direction: column;
      }

      .tab-button {
        border-radius: 0;
        border-bottom: 1px solid #ddd;
        border-left: 3px solid transparent;
      }

      .tab-button.active {
        border-left-color: #004d00;
        border-bottom-color: transparent;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .reset-options {
        grid-template-columns: 1fr;
      }

      .users-table {
        font-size: 0.8rem;
      }

      .users-table th,
      .users-table td {
        padding: 0.5rem;
      }

      .action-buttons {
        flex-direction: column;
      }

      .modal-content {
        margin: 1rem;
        width: calc(100% - 2rem);
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.4rem;
      }

      .tab-content {
        padding: 1rem;
      }

      .stat-number {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>🏌️ BBB Admin Dashboard</h1>
      <div class="user-info">
        <span id="adminUserInfo">Loading...</span>
        <button onclick="logout()" class="btn-secondary">🚪 Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Enhanced Admin Tabs -->
    <div class="admin-tabs">
      <button class="tab-button active" onclick="showTab('overview')">📊 Overview</button>
      <button class="tab-button" onclick="showTab('users')">👥 Users</button>
      <button class="tab-button" onclick="showTab('password-reset')">🔐 Password Reset</button>
      <button class="tab-button" onclick="showTab('logs')">📋 Audit Logs</button>
      <button class="tab-button" onclick="showTab('analytics')">📈 Analytics</button>
    </div>

    <div class="tab-content">
      <!-- Enhanced Overview Tab -->
      <div id="overview-tab" class="tab-panel active">
        <h2>System Overview</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">-</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="adminUsers">-</div>
            <div class="stat-label">Administrators</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="memberUsers">-</div>
            <div class="stat-label">Members</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeSessions">-</div>
            <div class="stat-label">Active Sessions</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeUsers">-</div>
            <div class="stat-label">Active Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="usersWithLogins">-</div>
            <div class="stat-label">Users With Logins</div>
          </div>
        </div>
        
        <div class="info">
          <strong>🎉 Welcome to the Enhanced BBB Admin Dashboard!</strong><br>
          Manage users, monitor activity, and control your golf group's digital presence with powerful new tools.
        </div>
      </div>

      <!-- Enhanced Users Tab -->
      <div id="users-tab" class="tab-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2>User Management</h2>
          <div>
            <button class="btn-success" onclick="showCreateUserModal()">➕ Add User</button>
            <button class="btn-small" onclick="loadUsers()">🔄 Refresh</button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-container">
          <span class="search-icon">🔍</span>
          <input type="text" class="search-input" id="userSearch" placeholder="Search users by name, email, or role..." oninput="filterUsers()">
        </div>
        
        <div id="usersLoading" class="loading hidden">Loading users...</div>
        <div id="usersContent">
          <table class="users-table" id="usersTable" style="display: none;">
            <thead>
              <tr>
                <th>User</th>
                <th>Role</th>
                <th>Email</th>
                <th>Last Login</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be populated here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Password Reset Tab -->
      <div id="password-reset-tab" class="tab-panel">
        <h2>Password Reset</h2>
        
        <div class="info">
          <strong>🔐 Admin Tool:</strong> Reset user passwords or set them to temporary for first-time setup.
        </div>

        <form id="resetForm">
          <div class="form-group">
            <label>Reset Type:</label>
            <div class="reset-options">
              <div class="reset-option active" onclick="selectResetType('temp')">
                <strong>Reset to Temporary</strong><br>
                <small>User sets new password on next login</small>
              </div>
              <div class="reset-option" onclick="selectResetType('specific')">
                <strong>Set Specific Password</strong><br>
                <small>Set a specific new password</small>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="resetUsername">
              Username to Reset:
              <button type="button" class="btn-small" onclick="loadUsersForReset()">🔄 Refresh</button>
            </label>
            <select id="resetUsername" required>
              <option value="">Select User</option>
            </select>
          </div>

          <div class="form-group hidden" id="resetPasswordGroup">
            <label for="resetNewPassword">New Password:</label>
            <input type="password" id="resetNewPassword" placeholder="Enter new password">
          </div>

          <button type="submit" id="resetBtn">🔒 Reset Password</button>
        </form>
      </div>

      <!-- Enhanced Audit Logs Tab -->
      <div id="logs-tab" class="tab-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2>Audit Logs</h2>
          <button class="btn-small" onclick="loadAuditLogs()">🔄 Refresh</button>
        </div>
        
        <div class="info">
          <strong>📋 Recent Activity:</strong> View login attempts, password changes, and other system events.
        </div>

        <div id="logsLoading" class="loading hidden">Loading audit logs...</div>
        <div id="logsContent">
          <div id="auditLogs">
            <!-- Audit logs will be populated here -->
          </div>
        </div>
      </div>

      <!-- New Analytics Tab -->
      <div id="analytics-tab" class="tab-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2>System Analytics</h2>
          <button class="btn-small" onclick="loadAnalytics()">🔄 Refresh</button>
        </div>
        
        <div id="analyticsLoading" class="loading hidden">Loading analytics...</div>
        <div id="analyticsContent">
          <!-- Analytics will be populated here -->
        </div>
      </div>
    </div>

    <!-- Global Messages -->
    <div id="globalMessage" class="message hidden"></div>

    <div class="back-link">
      <a href="index.html">← Back to Main Site</a>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" class="modal hidden" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">➕ Create New User</h3>
        <button class="close-btn" onclick="hideCreateUserModal()">&times;</button>
      </div>
      <form id="createUserForm">
        <div class="form-group">
          <label for="newUsername">Username (required):</label>
          <input type="text" id="newUsername" required placeholder="Enter username">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="newFirstName">First Name:</label>
            <input type="text" id="newFirstName" placeholder="Enter first name">
          </div>
          <div class="form-group">
            <label for="newLastName">Last Name:</label>
            <input type="text" id="newLastName" placeholder="Enter last name">
          </div>
        </div>

        <div class="form-group">
          <label for="newEmail">Email:</label>
          <input type="email" id="newEmail" placeholder="Enter email address">
        </div>

        <div class="form-group">
          <label for="newRole">Role (required):</label>
          <select id="newRole" required>
            <option value="">Select Role</option>
            <option value="member">Member</option>
            <option value="administrator">Administrator</option>
          </select>
        </div>

        <div class="form-group">
          <label for="newTempPassword">Temporary Password (optional):</label>
          <input type="password" id="newTempPassword" placeholder="Leave blank for user to set on first login">
          <small style="color: #666; font-size: 0.8rem;">If left blank, user will set password on first login</small>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button type="submit" id="createUserBtn" class="btn-success">➕ Create User</button>
          <button type="button" onclick="hideCreateUserModal()" class="btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="modal hidden" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">✏️ Edit User</h3>
        <button class="close-btn" onclick="hideEditUserModal()">&times;</button>
      </div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        
        <div class="form-group">
          <label for="editUsername">Username:</label>
          <input type="text" id="editUsername" disabled style="background: #f0f0f0;">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editFirstName">First Name:</label>
            <input type="text" id="editFirstName" placeholder="Enter first name">
          </div>
          <div class="form-group">
            <label for="editLastName">Last Name:</label>
            <input type="text" id="editLastName" placeholder="Enter last name">
          </div>
        </div>

        <div class="form-group">
          <label for="editEmail">Email:</label>
          <input type="email" id="editEmail" placeholder="Enter email address">
        </div>

        <div class="form-group">
          <label for="editRole">Role:</label>
          <select id="editRole" required>
            <option value="member">Member</option>
            <option value="administrator">Administrator</option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="editIsActive"> User is active
          </label>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button type="submit" id="editUserBtn">💾 Save Changes</button>
          <button type="button" onclick="hideEditUserModal()" class="btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let adminToken = null;
    let currentUser = null;
    let resetType = 'temp';
    let allUsers = [];
    let filteredUsers = [];

    // Initialize admin dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure modals are hidden on page load
      document.getElementById('createUserModal').style.display = 'none';
      document.getElementById('editUserModal').style.display = 'none';
      
      checkAdminAuth();
    });

    async function checkAdminAuth() {
      // Check if user is logged in and is admin
      const token = localStorage.getItem('bbb_session_token');
      const userData = localStorage.getItem('bbb_current_user');

      if (!token || !userData) {
        redirectToLogin();
        return;
      }

      try {
        const user = JSON.parse(userData);
        if (user.role !== 'administrator') {
          showGlobalMessage('Access denied. Admin privileges required.', 'error');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          return;
        }

        currentUser = user;
        adminToken = token;
        
        document.getElementById('adminUserInfo').textContent = `Welcome, ${user.username}`;
        
        // Load initial data
        loadOverviewData();
        
      } catch (error) {
        console.error('Auth check error:', error);
        redirectToLogin();
      }
    }

    function redirectToLogin() {
      sessionStorage.setItem('redirectAfterLogin', window.location.href);
      window.location.href = 'login.html';
    }

    function showTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab panels
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Load data for specific tabs
      if (tabName === 'users') {
        loadUsers();
      } else if (tabName === 'password-reset') {
        loadUsersForReset();
      } else if (tabName === 'logs') {
        loadAuditLogs();
      } else if (tabName === 'analytics') {
        loadAnalytics();
      }
    }

    async function loadOverviewData() {
      try {
        await Promise.all([
          loadUsers(true), // Silent load for stats
          loadAnalytics(true) // Silent load for enhanced stats
        ]);
      } catch (error) {
        console.error('Error loading overview data:', error);
      }
    }

    async function loadUsers(silent = false) {
      if (!silent) {
        document.getElementById('usersLoading').classList.remove('hidden');
        document.getElementById('usersTable').style.display = 'none';
      }

      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminToken })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load users');
        }

        allUsers = data.users;
        filteredUsers = [...allUsers];

        // Update stats
        const totalUsers = data.users.length;
        const adminUsers = data.users.filter(u => u.role === 'administrator').length;
        const memberUsers = data.users.filter(u => u.role === 'member').length;

        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('adminUsers').textContent = adminUsers;
        document.getElementById('memberUsers').textContent = memberUsers;

        // Update users table
        updateUsersTable(filteredUsers);

        if (!silent) {
          document.getElementById('usersTable').style.display = 'table';
          showGlobalMessage(`Loaded ${totalUsers} users successfully`, 'success');
          setTimeout(hideGlobalMessage, 3000);
        }

      } catch (error) {
        console.error('Load users error:', error);
        showGlobalMessage(error.message || 'Failed to load users', 'error');
      } finally {
        if (!silent) {
          document.getElementById('usersLoading').classList.add('hidden');
        }
      }
    }

    function updateUsersTable(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div><strong>${user.username}</strong></div>
            <div style="font-size: 0.8rem; color: #666;">${user.firstName || ''} ${user.lastName || ''}</div>
          </td>
          <td><span class="role-badge role-${user.role}">${user.role}</span></td>
          <td>${user.email || '-'}</td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
          <td>${user.isActive ? '✅ Active' : '❌ Inactive'}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" onclick="editUser('${user.id}')" title="Edit User">✏️</button>
              <button class="btn-icon btn-danger" onclick="resetUserPassword('${user.username}')" title="Reset Password">🔒</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      
      filteredUsers = allUsers.filter(user => 
        user.username.toLowerCase().includes(searchTerm) ||
        (user.email && user.email.toLowerCase().includes(searchTerm)) ||
        (user.firstName && user.firstName.toLowerCase().includes(searchTerm)) ||
        (user.lastName && user.lastName.toLowerCase().includes(searchTerm)) ||
        user.role.toLowerCase().includes(searchTerm)
      );

      updateUsersTable(filteredUsers);
    }

    // User Management Functions
    function showCreateUserModal() {
      document.getElementById('createUserModal').classList.remove('hidden');
    }

    function hideCreateUserModal() {
      document.getElementById('createUserModal').classList.add('hidden');
      document.getElementById('createUserForm').reset();
    }

    document.getElementById('createUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const username = document.getElementById('newUsername').value;
      const firstName = document.getElementById('newFirstName').value;
      const lastName = document.getElementById('newLastName').value;
      const email = document.getElementById('newEmail').value;
      const role = document.getElementById('newRole').value;
      const temporaryPassword = document.getElementById('newTempPassword').value;
      const createBtn = document.getElementById('createUserBtn');

      if (!username || !role) {
        showGlobalMessage('Username and role are required', 'error');
        return;
      }

      createBtn.disabled = true;
      createBtn.textContent = '⏳ Creating...';

      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/create-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminToken,
            username,
            firstName,
            lastName,
            email,
            role,
            temporaryPassword: temporaryPassword || undefined
          })
        });

        const data = await response.json();

        if (data.success) {
          showGlobalMessage(data.message, 'success');
          hideCreateUserModal();
          loadUsers();
        } else {
          throw new Error(data.error || 'User creation failed');
        }

      } catch (error) {
        console.error('Create user error:', error);
        showGlobalMessage(error.message || 'Failed to create user', 'error');
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = '➕ Create User';
      }
    });

    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editFirstName').value = user.firstName || '';
      document.getElementById('editLastName').value = user.lastName || '';
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editRole').value = user.role;
      document.getElementById('editIsActive').checked = user.isActive;

      document.getElementById('editUserModal').classList.remove('hidden');
    }

    function hideEditUserModal() {
      document.getElementById('editUserModal').classList.add('hidden');
      document.getElementById('editUserForm').reset();
    }

    document.getElementById('editUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;
      const firstName = document.getElementById('editFirstName').value;
      const lastName = document.getElementById('editLastName').value;
      const email = document.getElementById('editEmail').value;
      const role = document.getElementById('editRole').value;
      const isActive = document.getElementById('editIsActive').checked;
      const editBtn = document.getElementById('editUserBtn');

      editBtn.disabled = true;
      editBtn.textContent = '⏳ Saving...';

      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/update-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminToken,
            userId,
            firstName,
            lastName,
            email,
            role,
            isActive
          })
        });

        const data = await response.json();

        if (data.success) {
          showGlobalMessage(data.message, 'success');
          hideEditUserModal();
          loadUsers();
        } else {
          throw new Error(data.error || 'User update failed');
        }

      } catch (error) {
        console.error('Update user error:', error);
        showGlobalMessage(error.message || 'Failed to update user', 'error');
      } finally {
        editBtn.disabled = false;
        editBtn.textContent = '💾 Save Changes';
      }
    });

    async function loadUsersForReset() {
      const select = document.getElementById('resetUsername');
      
      try {
        select.innerHTML = '<option value="">Loading users...</option>';
        select.disabled = true;

        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminToken })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load users');
        }

        select.innerHTML = '<option value="">Select User</option>';
        
        data.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.username;
          option.textContent = `${user.username} (${user.role})`;
          if (user.email) {
            option.textContent += ` - ${user.email}`;
          }
          select.appendChild(option);
        });

      } catch (error) {
        console.error('Load users for reset error:', error);
        select.innerHTML = '<option value="">Failed to load users</option>';
        showGlobalMessage(error.message || 'Failed to load users', 'error');
      } finally {
        select.disabled = false;
      }
    }

    function selectResetType(type) {
      resetType = type;
      
      // Update UI
      document.querySelectorAll('.reset-option').forEach(el => el.classList.remove('active'));
      
      const options = document.querySelectorAll('.reset-option');
      if (type === 'temp') {
        options[0].classList.add('active');
      } else {
        options[1].classList.add('active');
      }
      
      // Show/hide password field
      const passwordGroup = document.getElementById('resetPasswordGroup');
      const newPasswordInput = document.getElementById('resetNewPassword');
      
      if (type === 'specific') {
        passwordGroup.classList.remove('hidden');
        newPasswordInput.required = true;
      } else {
        passwordGroup.classList.add('hidden');
        newPasswordInput.required = false;
        newPasswordInput.value = '';
      }
    }

    function resetUserPassword(username) {
      document.getElementById('resetUsername').value = username;
      showTab('password-reset');
      // Switch to password reset tab
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-button')[2].classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById('password-reset-tab').classList.add('active');
    }

    document.getElementById('resetForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const username = document.getElementById('resetUsername').value;
      const newPassword = document.getElementById('resetNewPassword').value;
      const resetBtn = document.getElementById('resetBtn');

      if (!username) {
        showGlobalMessage('Please select a user to reset', 'error');
        return;
      }

      if (resetType === 'specific' && !newPassword) {
        showGlobalMessage('Please enter a new password', 'error');
        return;
      }

      resetBtn.disabled = true;
      resetBtn.textContent = '⏳ Resetting...';

      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminToken,
            username,
            newPassword: resetType === 'specific' ? newPassword : undefined,
            resetToTemp: resetType === 'temp'
          })
        });

        const data = await response.json();

        if (data.success) {
          showGlobalMessage(data.message, 'success');
          document.getElementById('resetForm').reset();
          selectResetType('temp');
          loadUsersForReset();
        } else {
          throw new Error(data.error || 'Password reset failed');
        }

      } catch (error) {
        console.error('Reset error:', error);
        showGlobalMessage(error.message || 'Password reset failed', 'error');
      } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = '🔒 Reset Password';
      }
    });

    async function loadAuditLogs() {
      document.getElementById('logsLoading').classList.remove('hidden');
      
      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/audit-logs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminToken, limit: 50 })
        });

        const data = await response.json();

        if (data.success) {
          const logsContainer = document.getElementById('auditLogs');
          logsContainer.innerHTML = '';

          if (data.logs.length === 0) {
            logsContainer.innerHTML = '<div class="info">No audit logs found.</div>';
          } else {
            data.logs.forEach(log => {
              const logElement = document.createElement('div');
              logElement.className = 'audit-log';
              logElement.innerHTML = `
                <div class="audit-header">
                  <span class="audit-action">${log.action}</span>
                  <span class="audit-time">${new Date(log.timestamp).toLocaleString()}</span>
                </div>
                <div class="audit-details">${log.details}</div>
                <div class="audit-user">User: ${log.username} | IP: ${log.ipAddress}</div>
              `;
              logsContainer.appendChild(logElement);
            });
          }

          showGlobalMessage(`Loaded ${data.logs.length} audit logs`, 'success');
          setTimeout(hideGlobalMessage, 3000);
        } else {
          throw new Error(data.error || 'Failed to load audit logs');
        }

      } catch (error) {
        console.error('Load audit logs error:', error);
        document.getElementById('auditLogs').innerHTML = `
          <div class="error">
            <strong>Error loading audit logs:</strong> ${error.message}
          </div>
        `;
      } finally {
        document.getElementById('logsLoading').classList.add('hidden');
      }
    }

    async function loadAnalytics(silent = false) {
      if (!silent) {
        document.getElementById('analyticsLoading').classList.remove('hidden');
      }
      
      try {
        const response = await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/analytics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminToken })
        });

        const data = await response.json();

        if (data.success) {
          const analytics = data.analytics;
          
          // Update enhanced stats
          document.getElementById('activeSessions').textContent = analytics.sessions.active;
          document.getElementById('activeUsers').textContent = analytics.users.active;
          document.getElementById('usersWithLogins').textContent = analytics.users.withLogins;

          if (!silent) {
            const analyticsContainer = document.getElementById('analyticsContent');
            analyticsContainer.innerHTML = `
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-number">${analytics.users.total}</div>
                  <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">${analytics.users.administrators}</div>
                  <div class="stat-label">Administrators</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">${analytics.users.members}</div>
                  <div class="stat-label">Members</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">${analytics.users.active}</div>
                  <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">${analytics.sessions.active}</div>
                  <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">${analytics.sessions.uniqueUsers}</div>
                  <div class="stat-label">Active Unique Users</div>
                </div>
              </div>

              <h3 style="margin: 2rem 0 1rem 0;">📊 Recent Activity (Last 7 Days)</h3>
              <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                ${analytics.activity.recent.length === 0 ? 
                  '<p>No recent activity</p>' : 
                  analytics.activity.recent.map(day => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span>${day.date}</span>
                      <span><strong>${day.activity_count}</strong> actions by <strong>${day.unique_users}</strong> users</span>
                    </div>
                  `).join('')
                }
              </div>

              <h3 style="margin: 2rem 0 1rem 0;">🔥 Top Actions (Last 30 Days)</h3>
              <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                ${analytics.activity.topActions.length === 0 ? 
                  '<p>No recent actions</p>' : 
                  analytics.activity.topActions.map(action => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                      <span><strong>${action.action}</strong></span>
                      <span style="color: #004d00; font-weight: 600;">${action.count} times</span>
                    </div>
                  `).join('')
                }
              </div>

              <div style="margin-top: 2rem; padding: 1rem; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #004d00;">
                <strong>📈 System Health:</strong> Your BBB authentication system is running smoothly with ${analytics.users.active} active users and ${analytics.sessions.active} current sessions.
              </div>
            `;

            showGlobalMessage('Analytics loaded successfully', 'success');
            setTimeout(hideGlobalMessage, 3000);
          }
        } else {
          throw new Error(data.error || 'Failed to load analytics');
        }

      } catch (error) {
        console.error('Load analytics error:', error);
        if (!silent) {
          document.getElementById('analyticsContent').innerHTML = `
            <div class="error">
              <strong>Error loading analytics:</strong> ${error.message}
            </div>
          `;
        }
      } finally {
        if (!silent) {
          document.getElementById('analyticsLoading').classList.add('hidden');
        }
      }
    }

    async function logout() {
      if (!confirm('Are you sure you want to logout?')) return;

      try {
        if (adminToken) {
          await fetch('https://bbb-auth-worker.cf1demouk.workers.dev/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: adminToken })
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      }

      // Clear local storage and redirect
      localStorage.removeItem('bbb_session_token');
      localStorage.removeItem('bbb_current_user');
      localStorage.removeItem('bbb_session_expires');
      
      sessionStorage.setItem('justLoggedOut', 'true');
      window.location.href = 'login.html';
    }

    function showGlobalMessage(text, type) {
      const messageEl = document.getElementById('globalMessage');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
      messageEl.classList.remove('hidden');
    }

    function hideGlobalMessage() {
      document.getElementById('globalMessage').classList.add('hidden');
    }

    // Load data on page load
    window.addEventListener('load', function() {
      if (adminToken) {
        loadOverviewData();
      }
    });

    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.add('hidden');
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // ESC to close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.classList.add('hidden');
        });
      }
      
      // Ctrl/Cmd + N to create new user
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showCreateUserModal();
      }
    });

    // Auto-refresh data every 5 minutes
    setInterval(() => {
      if (adminToken && document.visibilityState === 'visible') {
        loadOverviewData();
      }
    }, 5 * 60 * 1000);

    // Mobile menu handling
    function handleMobileMenu() {
      const tabs = document.querySelector('.admin-tabs');
      if (window.innerWidth <= 768) {
        tabs.style.flexDirection = 'column';
      } else {
        tabs.style.flexDirection = 'row';
      }
    }

    window.addEventListener('resize', handleMobileMenu);
    handleMobileMenu(); // Initial call
  </script>
</body>
</html>
