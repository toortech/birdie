<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .upload-section {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: 'ðŸ“¸';
      font-size: 1.25rem;
    }
    
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Improved lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
      margin: 0 auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Image container and actions styles */
    .gallery-img-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }
    
    .image-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .image-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .delete-btn {
      color: #ff6b6b;
    }
    
    .image-info {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      font-size: 0.8rem;
      border-top-left-radius: 8px;
    }
    
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .sort-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    /* Migration button */
    .migration-button {
      display: block;
      margin: 1rem auto;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Message styles */
    .info-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem auto;
      max-width: 600px;
      text-align: center;
    }
    
    /* =============================================================================
       ALBUM MANAGEMENT STYLES
       ============================================================================= */

    /* Albums container */
    #albums-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
    }

    /* Album cards */
    .album-card {
      background: white;
      border: 1px solid var(--bbb-border);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .album-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .album-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
    }

    .album-card .card-title {
      margin: 0;
      color: var(--bbb-primary);
      font-size: var(--font-size-lg);
      font-family: var(--font-family-accent);
      flex: 1;
      margin-right: var(--spacing-md);
    }

    .album-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    .album-card .card-body {
      padding: var(--spacing-lg);
    }

    .album-card .card-body p {
      margin: 0 0 var(--spacing-sm) 0;
      color: var(--bbb-text-muted);
      line-height: 1.5;
    }

    .album-buttons {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }

    .album-buttons .btn {
      flex: 1;
      min-width: 120px;
    }

    /* Back button */
    #back-to-albums {
      margin-bottom: var(--spacing-lg);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius-lg);
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--bbb-primary);
      font-family: var(--font-family-accent);
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--bbb-text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .btn-close:hover {
      background-color: var(--bbb-border);
    }

    .modal-body {
      padding: var(--spacing-lg);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding: var(--spacing-lg);
      border-top: 1px solid var(--bbb-border);
      background-color: #f8f9fa;
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }

    /* Form styles in modals */
    .modal-body .form-group {
      margin-bottom: var(--spacing-md);
    }

    .modal-body label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: bold;
      color: var(--bbb-text);
      font-family: var(--font-family-accent);
    }

    .modal-body input,
    .modal-body textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--bbb-border);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-md);
      font-family: var(--font-family-base);
      box-sizing: border-box;
    }

    .modal-body input:focus,
    .modal-body textarea:focus {
      outline: 2px solid var(--bbb-secondary);
      outline-offset: -1px;
      border-color: var(--bbb-secondary);
    }

    .modal-body textarea {
      resize: vertical;
      min-height: 80px;
    }

    .gallery-img-container {
      position: relative;
      display: inline-block;
      margin: var(--spacing-sm);
    }

    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }

    .image-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .image-actions .btn {
      padding: 4px 8px;
      font-size: 12px;
      min-width: auto;
      line-height: 1;
    }

    .image-filename {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      word-break: break-word;
    }

    /* Hide gallery initially when in albums mode */
    #gallery-container {
      display: none;
    }

    #upload-section {
      display: none;
    }

    /* Animation keyframes */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #albums-container {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
      
      .album-card .card-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .album-card .card-title {
        margin-right: 0;
        margin-bottom: var(--spacing-sm);
      }
      
      .album-actions {
        justify-content: flex-end;
      }
      
      .album-buttons {
        flex-direction: column;
      }
      
      .album-buttons .btn {
        flex: none;
        width: 100%;
      }
      
      .modal-content {
        width: 95%;
        margin: var(--spacing-md);
      }
      
      .modal-footer {
        flex-direction: column-reverse;
      }
      
      .modal-footer .btn {
        width: 100%;
        margin: 0;
      }
    }

    @media (max-width: 480px) {
      .image-actions {
        opacity: 1; /* Always show on mobile */
      }
    }
  </style>
</head>
<body>
  <!-- Skip main auth check for gallery pages - Handle auth differently -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Gallery page loading...');
      
      // Initialize modules first - CRITICAL: Wait for these to load
      if (typeof BBB_CONFIG === 'undefined' || 
          typeof BBB_AUTH === 'undefined' || 
          typeof BBB_DB === 'undefined' || 
          typeof BBB_UI === 'undefined' || 
          typeof BBB_UTILS === 'undefined') {
        console.error('Required BBB modules not found! Check that all JS files are loading.');
        document.body.innerHTML = '<div style="text-align: center; padding: 2rem;"><h2>Error: Required modules not loaded</h2><p>Please check that all JavaScript files are properly linked.</p></div>';
        return;
      }
      
      // Initialize modules with error handling
      try {
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        console.log('Modules initialized. Auth status:', BBB_AUTH.isAuthenticated);
      } catch (error) {
        console.error('Error initializing modules:', error);
        document.body.innerHTML = '<div style="text-align: center; padding: 2rem;"><h2>Initialization Error</h2><p>Failed to initialize application modules.</p></div>';
        return;
      }
      
      // Cloudflare worker URL - Your actual worker URL
      const CLOUDFLARE_API = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
      
      // FIXED: Check gallery access properly without causing loops
      checkGalleryAccess();
      
      function checkGalleryAccess() {
        console.log('Checking gallery access...');
        console.log('BBB_AUTH.isAuthenticated:', BBB_AUTH.isAuthenticated);
        console.log('BBB_AUTH.currentUser:', BBB_AUTH.currentUser);
        
        // Check if user is already authenticated with gallery access
        const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
          (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
        
        console.log('Has gallery access:', hasGalleryAccess);
        
        if (hasGalleryAccess) {
          // Already authenticated with proper roles
          console.log('User has gallery access, initializing gallery...');
          initializeGallery();
        } else {
          // Show gallery-specific login (NOT redirect to login.html)
          console.log('No gallery access, showing gallery login overlay...');
          showGalleryLogin();
        }
      }
      
      /**
       * Show gallery login overlay (FIXED - no redirect loop)
       */
      function showGalleryLogin() {
        console.log('Showing gallery login overlay...');
        
        const loginOverlay = document.createElement('div');
        loginOverlay.id = 'login-overlay';
        
        const loginBox = document.createElement('div');
        loginBox.id = 'login-box';
        
        const title = document.createElement('h2');
        title.textContent = 'Gallery Access Required';
        
        const description = document.createElement('p');
        description.textContent = 'Enter the gallery password to access photos.';
        description.style.marginBottom = '1rem';
        description.style.color = '#666';
        
        const passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.id = 'pw-input';
        passwordInput.placeholder = 'Gallery Password';
        
        const errorMsg = document.createElement('div');
        errorMsg.id = 'error-msg';
        errorMsg.textContent = 'Incorrect password. Please try again.';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.9rem';
        errorMsg.style.display = 'none';
        errorMsg.style.marginTop = '0.5rem';
        
        const submitBtn = document.createElement('button');
        submitBtn.id = 'pw-submit';
        submitBtn.textContent = 'Access Gallery';
        submitBtn.className = 'btn';
        submitBtn.style.marginTop = '1rem';
        
        const homeBtn = document.createElement('a');
        homeBtn.href = 'index.html';
        homeBtn.textContent = 'â† Back to Home';
        homeBtn.className = 'btn';
        homeBtn.style.marginTop = '0.5rem';
        homeBtn.style.marginLeft = '0.5rem';
        homeBtn.style.backgroundColor = '#6c757d';
        
        loginBox.appendChild(title);
        loginBox.appendChild(description);
        loginBox.appendChild(passwordInput);
        loginBox.appendChild(errorMsg);
        loginBox.appendChild(submitBtn);
        loginBox.appendChild(homeBtn);
        
        loginOverlay.appendChild(loginBox);
        document.body.appendChild(loginOverlay);
        
        // Focus password input
        setTimeout(() => passwordInput.focus(), 100);
        
        // Handle login events
        submitBtn.addEventListener('click', handleGalleryLogin);
        passwordInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') handleGalleryLogin();
        });
        
        function handleGalleryLogin() {
          const password = passwordInput.value;
          
          if (!password.trim()) {
            errorMsg.style.display = 'block';
            errorMsg.textContent = 'Please enter a password.';
            return;
          }
          
          console.log('Attempting gallery login...');
          
          // Disable button during login attempt
          submitBtn.disabled = true;
          submitBtn.textContent = 'Checking...';
          
          BBB_AUTH.login('gallery', password)
            .then(() => {
              console.log('Gallery login successful!');
              // Login successful - remove overlay and initialize gallery
              loginOverlay.remove();
              initializeGallery();
            })
            .catch(err => {
              console.error('Gallery login failed:', err);
              // Login failed - show error and re-enable button
              errorMsg.style.display = 'block';
              errorMsg.textContent = 'Incorrect password. Please try again.';
              submitBtn.disabled = false;
              submitBtn.textContent = 'Access Gallery';
              passwordInput.value = '';
              passwordInput.focus();
            });
        }
      }
      
      /**
       * Initialize gallery after authentication
       */
      function initializeGallery() {
        console.log('Initializing gallery...');
        
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.id = 'page-title';
        subtitle.textContent = 'Photo Albums';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
        mainContent.appendChild(description);

        // Albums Section
        const albumsSection = document.createElement('div');
        albumsSection.id = 'albums-section';

        const albumsButtonsContainer = document.createElement('div');
        albumsButtonsContainer.className = 'text-center mb-3';

        const createAlbumBtn = document.createElement('button');
        createAlbumBtn.className = 'btn btn-success';
        createAlbumBtn.textContent = 'Create New Album';
        createAlbumBtn.onclick = showCreateAlbumModal;

        const viewAllBtn = document.createElement('button');
        viewAllBtn.className = 'btn';
        viewAllBtn.textContent = 'View All Images';
        viewAllBtn.onclick = viewAllImages;
        viewAllBtn.style.marginLeft = '0.5rem';
        
        albumsButtonsContainer.appendChild(createAlbumBtn);
        albumsButtonsContainer.appendChild(viewAllBtn);

        const albumsContainer = document.createElement('div');
        albumsContainer.id = 'albums-container';
        albumsSection.appendChild(albumsButtonsContainer);
        albumsSection.appendChild(albumsContainer);
        mainContent.appendChild(albumsSection);
        
        // Create filter/search bar
        const filterBar = createFilterBar();
        mainContent.appendChild(filterBar);
        
        // Image upload section
        const uploadSection = document.createElement('div');
        uploadSection.id = 'upload-section';
        uploadSection.className = 'upload-section';
        
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        mainContent.appendChild(uploadSection);
        
        // Info message about cloudflare
        const infoMessage = document.createElement('div');
        infoMessage.className = 'info-message';
        infoMessage.textContent = 'Gallery images are now stored in the cloud for better performance and reliability.';
        mainContent.appendChild(infoMessage);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container wrapper
        const galleryContainerWrapper = document.createElement('div');
        galleryContainerWrapper.id = 'gallery-container';

        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';

        galleryContainerWrapper.appendChild(galleryContainer);
        mainContent.appendChild(galleryContainerWrapper);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Load albums instead of gallery (since we start in albums mode)
        loadAlbums();
        
        // Setup event handlers
        setupEventHandlers();
        
        console.log('Gallery initialization complete!');
      }
  
      // =============================================================================
      // ALBUM MANAGEMENT FUNCTIONS
      // =============================================================================

      // Global variable for current album
      window.currentAlbumId = null;

      function loadAlbums() {
        console.log("Loading albums...");
        
        fetch(`${CLOUDFLARE_API}/albums`)
          .then(response => response.json())
          .then(albums => {
            console.log("Albums loaded:", albums);
            displayAlbums(albums);
          })
          .catch(err => {
            console.error('Error loading albums:', err);
            BBB_UTILS.showMessage(`Error loading albums: ${err.message}`, 'error');
          });
      }

      function displayAlbums(albums) {
        const albumsContainer = document.getElementById('albums-container');
        if (!albumsContainer) {
          console.error('Albums container not found');
          return;
        }
        
        if (albums.length === 0) {
          albumsContainer.innerHTML = `
            <div class="text-center p-4">
              <p>No albums found. Create your first album!</p>
              <button onclick="showCreateAlbumModal()" class="btn">Create Album</button>
            </div>
          `;
          return;
        }
        
        albumsContainer.innerHTML = albums.map(album => `
          <div class="album-card card" data-album-id="${album.id}">
            <div class="card-header">
              <h3 class="card-title">${escapeHtml(album.name)}</h3>
              <div class="album-actions">
                <button onclick="renameAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn btn-sm">Rename</button>
                <button onclick="deleteAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn btn-sm btn-danger">Delete</button>
              </div>
            </div>
            <div class="card-body">
              ${album.description ? `<p>${escapeHtml(album.description)}</p>` : ''}
              <p><strong>${album.image_count}</strong> images</p>
              <div class="album-buttons">
                <button onclick="viewAlbum('${album.id}', '${escapeHtml(album.name)}')" class="btn">View Album</button>
                <button onclick="uploadToAlbum('${album.id}')" class="btn btn-success">Add Photos</button>
              </div>
            </div>
          </div>
        `).join('');
      }

      function showCreateAlbumModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>Create New Album</h3>
              <button onclick="closeModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="album-name">Album Name *</label>
                <input type="text" id="album-name" required maxlength="100" placeholder="Enter album name">
              </div>
              <div class="form-group">
                <label for="album-description">Description (optional)</label>
                <textarea id="album-description" rows="3" maxlength="500" placeholder="Enter album description"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button onclick="closeModal()" class="btn">Cancel</button>
              <button onclick="createAlbum()" class="btn btn-success">Create Album</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('album-name').focus();
      }

      function createAlbum() {
        const name = document.getElementById('album-name').value.trim();
        const description = document.getElementById('album-description').value.trim();
        
        if (!name) {
          BBB_UTILS.showMessage('Album name is required', 'error');
          return;
        }
        
        BBB_UTILS.showMessage('Creating album...', 'info');
        
        fetch(`${CLOUDFLARE_API}/albums`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, description })
        })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              BBB_UTILS.showMessage('Album created successfully!', 'success');
              closeModal();
              loadAlbums();
            } else {
              BBB_UTILS.showMessage(`Error creating album: ${result.error}`, 'error');
            }
          })
          .catch(err => {
            console.error('Error creating album:', err);
            BBB_UTILS.showMessage(`Error creating album: ${err.message}`, 'error');
          });
      }

      function viewAllImages() {
        document.getElementById('page-title').textContent = 'All Images';
        
        const backButton = document.getElementById('back-to-albums') || createBackButton();
        backButton.style.display = 'block';
        
        document.getElementById('albums-section').style.display = 'none';
        document.getElementById('gallery-container').style.display = 'block';
        document.getElementById('upload-section').style.display = 'block';
        
        window.currentAlbumId = null;
        loadGalleryImages();
      }

      function closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
          modal.remove();
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function createBackButton() {
        const backButton = document.createElement('button');
        backButton.id = 'back-to-albums';
        backButton.className = 'btn mb-3';
        backButton.innerHTML = 'â† Back to Albums';
        backButton.onclick = goBackToAlbums;
        backButton.style.display = 'none';
        
        const pageTitle = document.getElementById('page-title');
        pageTitle.parentNode.insertBefore(backButton, pageTitle.nextSibling);
        
        return backButton;
      }

      function goBackToAlbums() {
        document.getElementById('page-title').textContent = 'Photo Albums';
        document.getElementById('back-to-albums').style.display = 'none';
        document.getElementById('albums-section').style.display = 'block';
        document.getElementById('gallery-container').style.display = 'none';
        document.getElementById('upload-section').style.display = 'none';
        
        window.currentAlbumId = null;
        loadAlbums();
      }

      /**
       * Create filter/search bar
       */
      function createFilterBar() {
        const filterBar = document.createElement('div');
        filterBar.className = 'filter-bar';
        
        // Search
        const searchContainer = document.createElement('div');
        searchContainer.className = 'search-container';
        
        const searchIcon = document.createElement('span');
        searchIcon.className = 'search-icon';
        searchIcon.innerHTML = 'ðŸ”';
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'search-input';
        searchInput.placeholder = 'Search gallery...';
        searchInput.id = 'gallery-search';
        
        searchContainer.appendChild(searchIcon);
        searchContainer.appendChild(searchInput);
        
        // Sort
        const sortContainer = document.createElement('div');
        sortContainer.className = 'sort-container';
        
        const sortLabel = document.createElement('span');
        sortLabel.className = 'sort-label';
        sortLabel.textContent = 'Sort by:';
        
        const sortSelect = document.createElement('select');
        sortSelect.className = 'sort-select';
        sortSelect.id = 'gallery-sort';
        
        const sortOptions = [
          { value: 'newest', text: 'Newest first' },
          { value: 'oldest', text: 'Oldest first' },
          { value: 'name', text: 'Name (A-Z)' }
        ];
        
        sortOptions.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = option.value;
          optionEl.textContent = option.text;
          sortSelect.appendChild(optionEl);
        });
        
        sortContainer.appendChild(sortLabel);
        sortContainer.appendChild(sortSelect);
        
        filterBar.appendChild(searchContainer);
        filterBar.appendChild(sortContainer);
        
        return filterBar;
      }
      
      /**
       * Load gallery images from Cloudflare
       */
      function loadGalleryImages() {
        BBB_UTILS.showMessage('Loading gallery images...', 'info');
        
        // Check sort and search options
        const sortSelect = document.getElementById('gallery-sort');
        const searchInput = document.getElementById('gallery-search');
        
        const sortValue = sortSelect ? sortSelect.value : 'newest';
        const searchValue = searchInput ? searchInput.value.trim() : '';
        
        // Build the API URL with any search parameters
        let apiUrl = `${CLOUDFLARE_API}/images`;
        
        if (searchValue) {
          apiUrl += `?search=${encodeURIComponent(searchValue)}`;
        }
        
        // Fetch from Cloudflare
        fetch(apiUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error fetching gallery: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // Convert to our format
            const images = data.map(img => ({
              id: img.id,
              src: `${CLOUDFLARE_API}/image/${img.id}`,
              alt: img.alt || 'Gallery image',
              uploadedAt: img.uploaded_at,
              uploadedBy: img.uploaded_by
            }));
            
            // Sort images
            if (sortValue === 'oldest') {
              images.sort((a, b) => new Date(a.uploadedAt) - new Date(b.uploadedAt));
            } else if (sortValue === 'name') {
              images.sort((a, b) => a.alt.localeCompare(b.alt));
            } else {
              // Default: newest first
              images.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
            }
            
            // Render gallery
            renderGallery(images);
            
            // Hide loading message
            BBB_UTILS.showMessage('', 'info');
          })
          .catch(err => {
            console.error('Error loading gallery images:', err);
            BBB_UTILS.showMessage('Error loading gallery images', 'error');
            
            // Show fallback gallery with preloaded images
            const preloadedImages = [
              { id: 'pre_1', src: 'images/photo1.jpg', alt: 'Band on the green' },
              { id: 'pre_2', src: 'images/photo2.jpg', alt: 'Group shot' },
              { id: 'pre_3', src: 'images/photo3.jpg', alt: 'Trophy presentation' },
              { id: 'pre_4', src: 'images/photo4.jpg', alt: 'Action shot' }
            ];
            
            renderGallery(preloadedImages);
          });
          
        // Check if we need to migrate images from localStorage
        checkMigrationNeeded();
      }
      
      /**
       * Render gallery with images
       */
      function renderGallery(images) {
        const galleryElement = document.getElementById('gallery');
        galleryElement.innerHTML = '';
        
        // Create gallery
        images.forEach(image => {
          const imgContainer = document.createElement('div');
          imgContainer.className = 'gallery-img-container';
          imgContainer.dataset.id = image.id;
          
          const img = document.createElement('img');
          img.src = image.src;
          img.alt = image.alt || 'Gallery image';
          img.className = 'gallery-img';
          img.setAttribute('loading', 'lazy'); // Add lazy loading
          
          // Add timestamp info
          const imageInfo = document.createElement('div');
          imageInfo.className = 'image-info';
          
          let uploadDate = 'Unknown date';
          if (image.uploadedAt) {
            uploadDate = new Date(image.uploadedAt).toLocaleDateString();
          }
          
          imageInfo.textContent = uploadDate;
          
          // Add action buttons
          const imageActions = document.createElement('div');
          imageActions.className = 'image-actions';
          
          // View button
          const viewBtn = document.createElement('button');
          viewBtn.className = 'image-action-btn view-btn';
          viewBtn.innerHTML = 'ðŸ‘ï¸ View';
          viewBtn.addEventListener('click', () => {
            openLightbox(img);
          });
          
          // Delete button (only show if admin or image was uploaded by current user)
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'image-action-btn delete-btn';
          deleteBtn.innerHTML = 'ðŸ—‘ï¸ Delete';
          
          const canDelete = BBB_AUTH.hasRole('admin') || 
                          (image.uploadedBy && BBB_AUTH.currentUser && 
                           image.uploadedBy === BBB_AUTH.currentUser.id);
          
          if (canDelete) {
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent lightbox
              deleteImage(image.id);
            });
            imageActions.appendChild(deleteBtn);
          }
          
          imageActions.appendChild(viewBtn);
          
          // Add click handler for lightbox
          img.addEventListener('click', () => {
            openLightbox(img);
          });
          
          imgContainer.appendChild(img);
          imgContainer.appendChild(imageInfo);
          imgContainer.appendChild(imageActions);
          
          galleryElement.appendChild(imgContainer);
        });
        
        // If no images, show message
        if (images.length === 0) {
          const noImages = document.createElement('div');
          noImages.className = 'empty-gallery';
          
          const noImagesIcon = document.createElement('div');
          noImagesIcon.innerHTML = 'ðŸ“·';
          noImagesIcon.style.fontSize = '3rem';
          noImagesIcon.style.marginBottom = '1rem';
          
          const noImagesText = document.createElement('p');
          noImagesText.textContent = 'No images in the gallery yet. Upload some photos to get started!';
          
          noImages.appendChild(noImagesIcon);
          noImages.appendChild(noImagesText);
          galleryElement.appendChild(noImages);
        }
      }
      
      /**
       * Setup event handlers for gallery
       */
      function setupEventHandlers() {
        // Upload handler
        const uploadInput = document.getElementById('image-upload');
        uploadInput.addEventListener('change', handleImageUpload);
        
        // Search handler
        const searchInput = document.getElementById('gallery-search');
        searchInput.addEventListener('input', debounce(() => {
          loadGalleryImages();
        }, 500));
        
        // Sort handler
        const sortSelect = document.getElementById('gallery-sort');
        sortSelect.addEventListener('change', () => {
          loadGalleryImages();
        });
        
        // Lightbox close
        const lightboxClose = document.querySelector('.lightbox-close');
        lightboxClose.addEventListener('click', () => {
          document.getElementById('lightbox').style.display = 'none';
        });
        
        // Click outside lightbox to close
        document.getElementById('lightbox').addEventListener('click', e => {
          if (e.target === document.getElementById('lightbox')) {
            document.getElementById('lightbox').style.display = 'none';
          }
        });
        
        // ESC key to close lightbox
        document.addEventListener('keyup', e => {
          if (e.key === 'Escape') {
            document.getElementById('lightbox').style.display = 'none';
          }
        });
      }
      
      /**
       * Debounce function to limit execution frequency
       */
      function debounce(func, delay = 300) {
        let timerId;
        return function(...args) {
          clearTimeout(timerId);
          timerId = setTimeout(() => {
            func.apply(this, args);
          }, delay);
        };
      }
      
      /**
       * Open lightbox with image
       */
      function openLightbox(img) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        
        lightboxImg.src = img.src;
        lightboxCaption.textContent = img.alt;
        lightbox.style.display = 'flex';
      }
      
      /**
       * Enhanced delete function for the photo gallery
       */
      function deleteImage(imageId) {
        // Validate input
        if (!imageId || imageId.trim() === '') {
          BBB_UTILS.showMessage('Invalid image ID provided', 'error');
          return;
        }

        if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
          return;
        }
        
        console.log("Attempting to delete image:", imageId);
        
        // Show loading message
        BBB_UTILS.showMessage('Deleting image...', 'info');
        
        // Construct the delete URL
        const deleteUrl = `${CLOUDFLARE_API}/delete/${encodeURIComponent(imageId)}`;
        console.log("Delete URL:", deleteUrl);
        
        // Make the delete request
        fetch(deleteUrl, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        })
          .then(response => {
            console.log("Delete response status:", response.status);
            console.log("Delete response headers:", [...response.headers.entries()]);
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return response.json().then(data => ({
                ok: response.ok,
                status: response.status,
                data: data
              }));
            } else {
              // Handle non-JSON response
              return response.text().then(text => ({
                ok: response.ok,
                status: response.status,
                data: { success: false, error: `Non-JSON response: ${text}` }
              }));
            }
          })
          .then(result => {
            console.log("Delete response result:", result);
            
            if (result.ok && result.data.success) {
              console.log("Delete successful");
              BBB_UTILS.showMessage('Image deleted successfully', 'success');
              
              // Remove image from DOM immediately
              const imgContainer = document.querySelector(`.gallery-img-container[data-id="${imageId}"]`);
              if (imgContainer) {
                imgContainer.style.transition = 'opacity 0.3s ease';
                imgContainer.style.opacity = '0';
                
                setTimeout(() => {
                  imgContainer.remove();
                  
                  // Check if gallery is empty and reload if needed
                  const remainingImages = document.querySelectorAll('.gallery-img-container');
                  if (remainingImages.length === 0) {
                    console.log("Gallery is empty, reloading...");
                    loadGalleryImages();
                  }
                }, 300);
              } else {
                console.log("Image container not found in DOM, reloading gallery");
                loadGalleryImages();
              }
              
            } else {
              console.error("Delete failed:", result.data);
              const errorMessage = result.data.error || `Delete failed with status ${result.status}`;
              BBB_UTILS.showMessage(`Error deleting image: ${errorMessage}`, 'error');
            }
          })
          .catch(err => {
            console.error('Network or parsing error during delete:', err);
            BBB_UTILS.showMessage(`Error deleting image: ${err.message}`, 'error');
          });
      }

      /**
       * Test function to check if the delete endpoint is working
       */
      function testDeleteEndpoint() {
        const testUrl = `${CLOUDFLARE_API}/health`;
        
        console.log("Testing worker health:", testUrl);
        
        fetch(testUrl)
          .then(response => response.json())
          .then(data => {
            console.log("Worker health check:", data);
            BBB_UTILS.showMessage(`Worker is ${data.status}. Environment check: Bucket=${data.environment.hasGalleryBucket}, DB=${data.environment.hasGalleryDB}`, 'info');
          })
          .catch(err => {
            console.error("Health check failed:", err);
            BBB_UTILS.showMessage(`Health check failed: ${err.message}`, 'error');
          });
      }

      /**
       * Debug function to list all images and their IDs
       */
      function debugListImages() {
        console.log("=== DEBUG: Listing all images ===");
        
        fetch(`${CLOUDFLARE_API}/images`)
          .then(response => response.json())
          .then(images => {
            console.log(`Found ${images.length} images:`);
            images.forEach((img, index) => {
              console.log(`${index + 1}. ID: ${img.id}, Filename: ${img.filename}, Path: ${img.path}`);
            });
            
            // Also check DOM elements
            const domImages = document.querySelectorAll('.gallery-img-container[data-id]');
            console.log(`Found ${domImages.length} images in DOM:`);
            domImages.forEach((container, index) => {
              console.log(`${index + 1}. DOM data-id: ${container.dataset.id}`);
            });
          })
          .catch(err => {
            console.error("Error listing images:", err);
          });
      }
      
      /**
       * Handle image upload
       */
      function handleImageUpload(e) {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
          return;
        }
        
        // Show progress container
        const progressContainer = document.getElementById('upload-progress');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        
        progressContainer.style.display = 'block';
        progressBarInner.style.width = '0%';
        progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
        
        let uploadedCount = 0;
        const failedUploads = [];
        
        // Get current user if available
        const username = BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'anonymous';
        
        // Process each file
        files.forEach((file, index) => {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            failedUploads.push({ file, error: 'Not an image file' });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Validate file size (10MB limit)
          const maxSize = 10 * 1024 * 1024;
          if (file.size > maxSize) {
            failedUploads.push({ 
              file, 
              error: `File too large (max 10MB)` 
            });
            updateUploadProgress(files.length, uploadedCount + failedUploads.length);
            return;
          }
          
          // Create form data for upload
          const formData = new FormData();
          formData.append('image', file);
          formData.append('alt', file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo');
          formData.append('username', username);
          
          // Upload to Cloudflare Worker
          fetch(`${CLOUDFLARE_API}/upload`, {
            method: 'POST',
            body: formData
          })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.success) {
                uploadedCount++;
              } else {
                failedUploads.push({ file, error: data.error || 'Upload failed' });
              }
              
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              
              // Check if all uploads complete
              if (uploadedCount + failedUploads.length === files.length) {
                finishUploads();
              }
            })
            .catch(err => {
              console.error('Error uploading image:', err);
              failedUploads.push({ file, error: 'Failed to upload' });
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              
              // Check if all uploads complete
              if (uploadedCount + failedUploads.length === files.length) {
                finishUploads();
              }
            });
        });
        
        // Reset file input
        e.target.value = '';
        
        function updateUploadProgress(total, completed) {
          const percentage = Math.round((completed / total) * 100);
          progressBarInner.style.width = `${percentage}%`;
          progressText.textContent = `Uploading ${completed} of ${total} (${percentage}%)`;
        }
        
        function finishUploads() {
          // Hide progress container after a delay
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 1500);
          
          // Reload gallery
          loadGalleryImages();
          
          // Show status message
          if (failedUploads.length === 0) {
            if (uploadedCount > 1) {
              BBB_UTILS.showMessage(`Successfully uploaded ${uploadedCount} images`, 'success');
            } else {
              BBB_UTILS.showMessage('Image uploaded successfully', 'success');
            }
          } else {
            if (uploadedCount > 0) {
              BBB_UTILS.showMessage(`Uploaded ${uploadedCount} images, ${failedUploads.length} failed`, 'warning');
            } else {
              BBB_UTILS.showMessage(`Failed to upload ${failedUploads.length} images`, 'error');
            }
          }
        }
      }
      
      /**
       * Check if image migration is needed
       */
      function checkMigrationNeeded() {
        try {
          // Check if we have already migrated
          const migrated = localStorage.getItem('bbb_gallery_migrated_to_cloudflare');
          if (migrated === 'true') {
            return;
          }
          
          // Get stored images from original localStorage
          const storedImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
          
          if (storedImages.length === 0) {
            // No images to migrate
            localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
            return;
          }
          
          // Create migration button
          const migrationBtn = document.createElement('button');
          migrationBtn.className = 'btn migration-button';
          migrationBtn.textContent = `Migrate ${storedImages.length} Images to Cloud`;
          migrationBtn.addEventListener('click', () => migrateLocalStorageImages(storedImages));
          
          // Add before the gallery
          const galleryElement = document.getElementById('gallery');
          galleryElement.parentNode.insertBefore(migrationBtn, galleryElement);
          
          // Show migration message
          BBB_UTILS.showMessage(`Found ${storedImages.length} images in your browser. Click the migration button to move them to the cloud.`, 'info');
        } catch (err) {
          console.error('Error checking for migration:', err);
        }
      }
      
      /**
       * Migrate images from localStorage to Cloudflare
       */
      function migrateLocalStorageImages(storedImages) {
        try {
          // Show migration message
          BBB_UTILS.showMessage(`Migrating ${storedImages.length} existing images to cloud storage...`, 'info');
          
          // Get migration button and disable it
          const migrationBtn = document.querySelector('.migration-button');
          if (migrationBtn) {
            migrationBtn.disabled = true;
            migrationBtn.textContent = 'Migration in progress...';
          }
          
          // Show progress container
          const progressContainer = document.getElementById('upload-progress');
          const progressBarInner = document.getElementById('progress-bar-inner');
          const progressText = document.getElementById('progress-text');
          
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '0%';
          progressText.textContent = 'Preparing migration...';
          
          // Convert and upload each image
          let migrationCount = 0;
          let migrationErrors = 0;
          
          storedImages.forEach((dataURL, index) => {
            try {
              // Convert data URL to blob
              const blob = dataURLtoBlob(dataURL);
              
              // Create form data for upload
              const formData = new FormData();
              formData.append('image', blob, `migrated_image_${index}.jpg`);
              formData.append('alt', `Migrated image ${index + 1}`);
              formData.append('username', BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'migration');
              
              // Update progress text
              progressText.textContent = `Migrating image ${index + 1} of ${storedImages.length}...`;
              progressBarInner.style.width = `${Math.round((index / storedImages.length) * 100)}%`;
              
              // Upload to Cloudflare Worker
              fetch(`${CLOUDFLARE_API}/upload`, {
                method: 'POST',
                body: formData
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                  }
                  return response.json();
                })
                .then(data => {
                  if (data.success) {
                    migrationCount++;
                  } else {
                    migrationErrors++;
                  }
                  
                  // Update progress
                  const completed = migrationCount + migrationErrors;
                  const percentage = Math.round((completed / storedImages.length) * 100);
                  progressBarInner.style.width = `${percentage}%`;
                  progressText.textContent = `Migrated ${migrationCount} of ${storedImages.length} images (${percentage}%)`;
                  
                  // Check if all migrations complete
                  if (completed === storedImages.length) {
                    finishMigration();
                  }
                })
                .catch(err => {
                  console.error('Error migrating image:', err);
                  migrationErrors++;
                  
                  // Update progress
                  const completed = migrationCount + migrationErrors;
                  const percentage = Math.round((completed / storedImages.length) * 100);
                  progressBarInner.style.width = `${percentage}%`;
                  progressText.textContent = `Migrated ${migrationCount} of ${storedImages.length} images (${percentage}%)`;
                  
                  // Check if all migrations complete
                  if (completed === storedImages.length) {
                    finishMigration();
                  }
                });
            } catch (err) {
              console.error('Error processing image for migration:', err);
              migrationErrors++;
              
              // Update progress
              const completed = migrationCount + migrationErrors;
              const percentage = Math.round((completed / storedImages.length) * 100);
              progressBarInner.style.width = `${percentage}%`;
              
              // Check if all migrations complete
              if (completed === storedImages.length) {
                finishMigration();
              }
            }
          });
          
          /**
           * Convert data URL to Blob
           */
          function dataURLtoBlob(dataURL) {
            try {
              const arr = dataURL.split(',');
              const mime = arr[0].match(/:(.*?);/)[1];
              const bstr = atob(arr[1]);
              let n = bstr.length;
              const u8arr = new Uint8Array(n);
              
              while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
              }
              
              return new Blob([u8arr], { type: mime });
            } catch (err) {
              console.error('Error converting data URL to blob:', err);
              throw err;
            }
          }
          
          /**
           * Finish the migration process
           */
          function finishMigration() {
            // Mark as migrated
            localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
            
            // Clear old localStorage to free up space
            localStorage.removeItem('uploadedImages');
            
            // Hide progress
            progressContainer.style.display = 'none';
            
            // Remove migration button
            if (migrationBtn) {
              migrationBtn.remove();
            }
            
            // Reload gallery
            loadGalleryImages();
            
            // Show status message
            if (migrationErrors === 0) {
              BBB_UTILS.showMessage(`Successfully migrated ${migrationCount} images to cloud storage`, 'success');
            } else {
              BBB_UTILS.showMessage(`Migrated ${migrationCount} images, failed to migrate ${migrationErrors} images`, 'warning');
            }
          }
        } catch (err) {
          console.error('Error during gallery migration:', err);
          BBB_UTILS.showMessage('Error migrating images: ' + err.message, 'error');
        }
      }

      // Make functions globally available for onclick handlers
      window.showCreateAlbumModal = showCreateAlbumModal;
      window.createAlbum = createAlbum;
      window.viewAllImages = viewAllImages;
      window.closeModal = closeModal;
      window.goBackToAlbums = goBackToAlbums;
      window.testDeleteEndpoint = testDeleteEndpoint;
      window.debugListImages = debugListImages;
    });
  </script>
</body>
</html>
