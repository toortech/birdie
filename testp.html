/**
     * Show a status message
     * @param {string} message - Message to display
     * @param {string} type - Message type (success, error, warning, info)
     */
    function showMessage(message, type = 'info') {
      try {
        // Try using BBB_UTILS if available
        if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.showMessage === 'function') {
          BBB_UTILS.showMessage(message, type);
          return;
        }
        
        // Fallback to manual message display
        const statusMessage = document.getElementById('status-message');
        if (!statusMessage) {
          // Create status message container if it doesn't exist
          const newStatusMessage = document.createElement('div');
          newStatusMessage.id = 'status-message';
          newStatusMessage.style.padding = '1rem';
          newStatusMessage.style.margin = '1rem 0';
          newStatusMessage.style.borderRadius = '4px';
          newStatusMessage.style.textAlign = 'center';
          newStatusMessage.style.display = 'none';
          
          // Insert after the first h2 if possible
          const h2 = document.querySelector('h2');
          if (h2 && h2.parentNode) {
            h2.parentNode.insertBefore(newStatusMessage, h2.nextSibling);
          } else {
            // Otherwise add to main
            const main = document.getElementById('main');
            if (main) {
              main.appendChild(newStatusMessage);
            }
          }
        }
        
        const messageEl = document.getElementById('status-message');
        if (!messageEl) return; // Give up if we still can't find it
        
        if (!message) {
          messageEl.style.display = 'none';
          return;
        }
        
        messageEl.textContent = message;
        messageEl.className = type || 'info';
        messageEl.style.display = 'block';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          messageEl.style.display = 'none';
        }, 3000);
      } catch (err) {
        console.error('Error showing message:', err);
        // Last resort - alert for critical errors
        if (type === 'error' && message) {
          console.error(message);
        }
      }
    }<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <style>
    /* Essential gallery styles - minimize by moving others to style.css */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .album-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    /* Progress bar for uploads */
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
      
      .albums-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
      
      .albums-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
  </style>
  
  <!-- Only this one script reference -->
  <!-- <script src="js/gallery.js" defer></script> -->
</head>
  <body>
  <!-- Skip link for accessibility -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <!-- Status message container -->
  <div id="status-message" style="display:none;"></div>
  
  <main id="main"></main>
  
  <script>
    // Global constants
    const CLOUDFLARE_API = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
    
    // State variables 
    let currentAlbumId = 'all';
    let galleryAlbums = [];
    let isAuthenticated = false;
    let isAdmin = false;
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modules
      try {
        if (typeof BBB_AUTH !== 'undefined') {
          BBB_AUTH.init({
            cloudflareEnabled: typeof BBB_CONFIG !== 'undefined' ? BBB_CONFIG.cloudflareEnabled : false
          });
        }
        
        if (typeof BBB_DB !== 'undefined') {
          BBB_DB.init({
            useCloudflare: typeof BBB_CONFIG !== 'undefined' ? BBB_CONFIG.cloudflareEnabled : false,
            localStoragePrefix: 'bbb_'
          });
        }
      } catch (e) {
        console.error('Error initializing modules:', e);
      }
      
      // Check if the user has access to the gallery
      try {
        const hasGalleryAccess = typeof BBB_AUTH !== 'undefined' && BBB_AUTH.isAuthenticated && 
          (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
          
        if (typeof BBB_AUTH !== 'undefined') {
          isAuthenticated = BBB_AUTH.isAuthenticated || false;
          isAdmin = BBB_AUTH.hasRole('admin') || false;
        }
        
        if (!hasGalleryAccess) {
          // Show gallery login overlay
          showGalleryLogin();
        } else {
          // Already authenticated, initialize gallery
          initializeGallery();
        }
      } catch (e) {
        console.error('Error checking gallery access:', e);
        // Assume access for now since there was an error checking
        initializeGallery();
      }
    });
    
    /**
     * Show gallery login overlay
     */
    function showGalleryLogin() {
      // Use BBB_AUTH.showGalleryLogin() if available
      if (typeof BBB_AUTH !== 'undefined' && typeof BBB_AUTH.showGalleryLogin === 'function') {
        BBB_AUTH.showGalleryLogin()
          .then(() => {
            initializeGallery();
          })
          .catch(err => {
            console.error('Login error:', err);
          });
        return;
      }
      
      // Fallback login implementation
      const loginOverlay = document.createElement('div');
      loginOverlay.id = 'login-overlay';
      loginOverlay.style.position = 'fixed';
      loginOverlay.style.top = '0';
      loginOverlay.style.left = '0';
      loginOverlay.style.width = '100%';
      loginOverlay.style.height = '100%';
      loginOverlay.style.background = 'rgba(0,0,0,0.8)';
      loginOverlay.style.display = 'flex';
      loginOverlay.style.alignItems = 'center';
      loginOverlay.style.justifyContent = 'center';
      loginOverlay.style.zIndex = '9999';
      
      const loginBox = document.createElement('div');
      loginBox.id = 'login-box';
      loginBox.style.background = 'white';
      loginBox.style.padding = '2rem';
      loginBox.style.borderRadius = '8px';
      loginBox.style.maxWidth = '400px';
      loginBox.style.width = '90%';
      
      const title = document.createElement('h2');
      title.textContent = 'Enter Password';
      title.style.marginTop = '0';
      
      const passwordInput = document.createElement('input');
      passwordInput.type = 'password';
      passwordInput.id = 'pw-input';
      passwordInput.placeholder = 'Password';
      passwordInput.style.width = '100%';
      passwordInput.style.padding = '0.75rem';
      passwordInput.style.marginTop = '1rem';
      passwordInput.style.border = '1px solid #ddd';
      passwordInput.style.borderRadius = '4px';
      
      const errorMsg = document.createElement('div');
      errorMsg.id = 'error-msg';
      errorMsg.textContent = 'Incorrect password';
      errorMsg.style.color = 'red';
      errorMsg.style.fontSize = '0.9rem';
      errorMsg.style.display = 'none';
      errorMsg.style.marginTop = '0.5rem';
      
      const submitBtn = document.createElement('button');
      submitBtn.id = 'pw-submit';
      submitBtn.textContent = 'Unlock Gallery';
      submitBtn.className = 'btn';
      submitBtn.style.width = '100%';
      submitBtn.style.marginTop = '1rem';
      
      loginBox.appendChild(title);
      loginBox.appendChild(passwordInput);
      loginBox.appendChild(errorMsg);
      loginBox.appendChild(submitBtn);
      
      loginOverlay.appendChild(loginBox);
      document.body.appendChild(loginOverlay);
      
      // Focus password input
      setTimeout(() => passwordInput.focus(), 100);
      
      // Handle login events
      submitBtn.addEventListener('click', handleLogin);
      passwordInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') handleLogin();
      });
      
      function handleLogin() {
        const password = passwordInput.value;
        
        BBB_AUTH.login('gallery', password)
          .then(() => {
            // Login successful
            loginOverlay.remove();
            initializeGallery();
          })
          .catch(err => {
            // Login failed
            console.error('Login error:', err);
            errorMsg.style.display = 'block';
          });
      }
    }
    
    /**
     * Initialize gallery after authentication
     */
    function initializeGallery() {
      // Create header
      const headerElements = BBB_UI.createHeader({
        fixed: true,
        showHomeLinkText: true
      });
      
      document.body.insertBefore(headerElements.header, document.body.firstChild);
      
      // Get main content element
      const main = document.getElementById('main');
      main.appendChild(headerElements.mainWrapper);
      
      // Create page content
      const mainContent = document.createElement('div');
      
      // Create page title
      const titleContainer = BBB_UI.createPageTitle({
        title: 'Birdie Bush Bandits',
        showFoundedText: true,
        showGolfballs: true
      });
      mainContent.appendChild(titleContainer);
      
      // Add page subtitle
      const subtitle = document.createElement('h2');
      subtitle.textContent = 'Photo Gallery';
      mainContent.appendChild(subtitle);
      
      // Create status message container
      const statusMessage = BBB_UI.createStatusMessage();
      mainContent.appendChild(statusMessage);
      
      // Add description text
      const description = document.createElement('p');
      description.className = 'gallery-description';
      description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
      mainContent.appendChild(description);
      
      // Create filter/search bar
      const filterBar = createFilterBar();
      mainContent.appendChild(filterBar);
      
      // Add back button (initially hidden)
      const backButton = document.createElement('a');
      backButton.href = '#';
      backButton.className = 'btn';
      backButton.textContent = 'â† Back to Albums';
      backButton.style.display = 'none';
      backButton.id = 'back-to-albums';
      backButton.addEventListener('click', (e) => {
        e.preventDefault();
        showAlbumsView();
      });
      mainContent.appendChild(backButton);
      
      // Image upload section
      const uploadSection = document.createElement('div');
      uploadSection.className = 'upload-section';
      
      const uploadLabel = document.createElement('label');
      uploadLabel.htmlFor = 'image-upload';
      uploadLabel.className = 'btn';
      uploadLabel.textContent = 'ðŸ“¸ Upload Photos';
      
      const uploadInput = document.createElement('input');
      uploadInput.type = 'file';
      uploadInput.id = 'image-upload';
      uploadInput.className = 'upload-input';
      uploadInput.setAttribute('accept', 'image/*');
      uploadInput.setAttribute('multiple', 'true');
      uploadInput.style.display = 'none';
      
      uploadSection.appendChild(uploadLabel);
      uploadSection.appendChild(uploadInput);
      mainContent.appendChild(uploadSection);
      
      // Album selector for uploads (initially hidden)
      const albumSelector = document.createElement('select');
      albumSelector.id = 'album-selector';
      albumSelector.style.marginLeft = '1rem';
      albumSelector.style.display = 'none';
      uploadSection.appendChild(albumSelector);
      
      // Upload progress indicator
      const progressContainer = document.createElement('div');
      progressContainer.className = 'upload-progress';
      progressContainer.id = 'upload-progress';
      progressContainer.style.display = 'none';
      progressContainer.style.margin = '1rem auto';
      progressContainer.style.maxWidth = '500px';
      progressContainer.style.padding = '1rem';
      progressContainer.style.backgroundColor = '#f8f9fa';
      progressContainer.style.borderRadius = '8px';
      progressContainer.style.textAlign = 'center';
      
      const progressText = document.createElement('div');
      progressText.id = 'progress-text';
      progressText.textContent = 'Uploading photos...';
      
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      
      const progressBarInner = document.createElement('div');
      progressBarInner.className = 'progress-bar-inner';
      progressBarInner.id = 'progress-bar-inner';
      
      progressBar.appendChild(progressBarInner);
      progressContainer.appendChild(progressText);
      progressContainer.appendChild(progressBar);
      mainContent.appendChild(progressContainer);
      
      // Albums section
      const albumsSection = document.createElement('div');
      albumsSection.id = 'albums-section';
      albumsSection.style.margin = '2rem 0';
      
      const albumsTitle = document.createElement('h3');
      albumsTitle.textContent = 'Photo Albums';
      albumsTitle.style.marginBottom = '1rem';
      albumsTitle.style.color = 'var(--bbb-primary)';
      albumsSection.appendChild(albumsTitle);
      
      const albumsGrid = document.createElement('div');
      albumsGrid.id = 'albums-grid';
      albumsGrid.className = 'albums-grid';
      albumsSection.appendChild(albumsGrid);
      
      mainContent.appendChild(albumsSection);
      
      // Gallery container
      const galleryContainer = document.createElement('div');
      galleryContainer.id = 'gallery';
      galleryContainer.className = 'gallery';
      galleryContainer.style.display = 'none'; // Initially hidden until album is selected
      mainContent.appendChild(galleryContainer);
      
      // Lightbox for image viewing
      const lightbox = document.createElement('div');
      lightbox.id = 'lightbox';
      lightbox.className = 'lightbox';
      
      const lightboxClose = document.createElement('span');
      lightboxClose.className = 'lightbox-close';
      lightboxClose.innerHTML = '&times;';
      lightboxClose.style.position = 'absolute';
      lightboxClose.style.top = '20px';
      lightboxClose.style.right = '25px';
      lightboxClose.style.fontSize = '2.5rem';
      lightboxClose.style.color = 'white';
      lightboxClose.style.cursor = 'pointer';
      
      const lightboxImg = document.createElement('img');
      lightboxImg.className = 'lightbox-img';
      lightboxImg.id = 'lightbox-img';
      lightboxImg.style.maxWidth = '90%';
      lightboxImg.style.maxHeight = '80%';
      lightboxImg.style.borderRadius = '4px';
      lightboxImg.style.boxShadow = '0 5px 25px rgba(0,0,0,0.5)';
      
      const lightboxCaption = document.createElement('div');
      lightboxCaption.id = 'lightbox-caption';
      lightboxCaption.className = 'lightbox-caption';
      lightboxCaption.style.color = 'white';
      lightboxCaption.style.marginTop = '1rem';
      lightboxCaption.style.fontSize = '1.1rem';
      lightboxCaption.style.maxWidth = '80%';
      lightboxCaption.style.textAlign = 'center';
      
      lightbox.appendChild(lightboxClose);
      lightbox.appendChild(lightboxImg);
      lightbox.appendChild(lightboxCaption);
      mainContent.appendChild(lightbox);
      
      // Add content to main wrapper
      headerElements.mainWrapper.appendChild(mainContent);
      
      // Load default albums and user albums
      loadAlbums();
      
      // Setup event handlers
      setupEventHandlers();
      
      // Check URL parameters for album
      const urlParams = new URLSearchParams(window.location.search);
      const albumParam = urlParams.get('album');
      if (albumParam) {
        currentAlbumId = albumParam;
        // We'll load this album when albums are loaded
      }
    }
    
    /**
     * Create filter/search bar
     */
    function createFilterBar() {
      const filterBar = document.createElement('div');
      filterBar.className = 'filter-bar';
      filterBar.style.display = 'flex';
      filterBar.style.justifyContent = 'space-between';
      filterBar.style.alignItems = 'center';
      filterBar.style.marginBottom = '1.5rem';
      filterBar.style.flexWrap = 'wrap';
      filterBar.style.gap = '1rem';
      
      // Search
      const searchContainer = document.createElement('div');
      searchContainer.style.position = 'relative';
      searchContainer.style.flexGrow = '1';
      searchContainer.style.maxWidth = '300px';
      
      const searchIcon = document.createElement('span');
      searchIcon.innerHTML = 'ðŸ”';
      searchIcon.style.position = 'absolute';
      searchIcon.style.left = '12px';
      searchIcon.style.top = '50%';
      searchIcon.style.transform = 'translateY(-50%)';
      searchIcon.style.color = '#666';
      
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.id = 'gallery-search';
      searchInput.placeholder = 'Search gallery...';
      searchInput.style.width = '100%';
      searchInput.style.padding = '8px 12px 8px 36px';
      searchInput.style.borderRadius = '20px';
      searchInput.style.border = '1px solid #ddd';
      searchInput.style.fontSize = '0.9rem';
      
      searchContainer.appendChild(searchIcon);
      searchContainer.appendChild(searchInput);
      
      // Sort
      const sortContainer = document.createElement('div');
      sortContainer.style.display = 'flex';
      sortContainer.style.alignItems = 'center';
      sortContainer.style.gap = '8px';
      
      const sortLabel = document.createElement('span');
      sortLabel.textContent = 'Sort by:';
      sortLabel.style.fontSize = '0.9rem';
      sortLabel.style.color = '#666';
      
      const sortSelect = document.createElement('select');
      sortSelect.id = 'gallery-sort';
      sortSelect.style.padding = '6px 12px';
      sortSelect.style.borderRadius = '4px';
      sortSelect.style.border = '1px solid #ddd';
      sortSelect.style.fontSize = '0.9rem';
      
      const sortOptions = [
        { value: 'newest', text: 'Newest first' },
        { value: 'oldest', text: 'Oldest first' },
        { value: 'name', text: 'Name (A-Z)' }
      ];
      
      sortOptions.forEach(option => {
        const optionEl = document.createElement('option');
        optionEl.value = option.value;
        optionEl.textContent = option.text;
        sortSelect.appendChild(optionEl);
      });
      
      sortContainer.appendChild(sortLabel);
      sortContainer.appendChild(sortSelect);
      
      filterBar.appendChild(searchContainer);
      filterBar.appendChild(sortContainer);
      
      return filterBar;
    }
    
    /**
     * Load albums from API
     */
    function loadAlbums() {
      // Default albums
      const defaultAlbums = [
        { id: 'all', title: 'All Photos', thumbnail: 'images/photo1.jpg', count: 0, default: true },
        { id: 'events', title: 'Golf Events', thumbnail: 'images/photo2.jpg', count: 0, default: true },
        { id: 'tournaments', title: 'Tournaments', thumbnail: 'images/photo3.jpg', count: 0, default: true },
        { id: 'members', title: 'Member Photos', thumbnail: 'images/photo4.jpg', count: 0, default: true }
      ];
      
      galleryAlbums = defaultAlbums;
      
      // Show loading state
      const albumsGrid = document.getElementById('albums-grid');
      if (albumsGrid) {
        albumsGrid.innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:2rem;">Loading albums...</div>';
      }
      
      // Try fetching albums from API, gracefully handle if error
      try {
        fetch(`${CLOUDFLARE_API}/albums`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error fetching albums: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data && Array.isArray(data)) {
              // Update default albums with counts
              galleryAlbums = galleryAlbums.map(defaultAlbum => {
                const apiAlbum = data.find(a => a.id === defaultAlbum.id);
                if (apiAlbum && apiAlbum.count !== undefined) {
                  return { ...defaultAlbum, count: apiAlbum.count };
                }
                return defaultAlbum;
              });
              
              // Add custom albums
              const customAlbums = data.filter(album => 
                !galleryAlbums.some(a => a.id === album.id)
              );
              
              galleryAlbums = [...galleryAlbums, ...customAlbums];
            }
            
            // Update album selector
            updateAlbumSelector();
            
            // Render albums
            renderAlbums();
            
            // If URL has album parameter, load that album
            if (currentAlbumId !== 'all') {
              const album = galleryAlbums.find(a => a.id === currentAlbumId);
              if (album) {
                viewAlbum(album);
              }
            }
          })
          .catch(err => {
            console.error('Error loading albums:', err);
            // Still show message but don't rely on BBB_UTILS in case it's not properly initialized
            try {
              if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.showMessage === 'function') {
                BBB_UTILS.showMessage('Error loading albums, using default albums instead', 'warning');
              }
            } catch (e) {
              console.error('Could not show error message:', e);
            }
            
            // Render default albums
            renderAlbums();
            
            // Check URL parameter for direct album view
            if (currentAlbumId !== 'all') {
              const album = galleryAlbums.find(a => a.id === currentAlbumId);
              if (album) {
                viewAlbum(album);
              }
            }
          });
      } catch (err) {
        console.error('Error in album loading process:', err);
        // Render default albums as fallback
        renderAlbums();
      }
    }
    
    /**
     * Update album selector dropdown
     */
    function updateAlbumSelector() {
      const albumSelector = document.getElementById('album-selector');
      if (!albumSelector) return;
      
      // Clear existing options
      albumSelector.innerHTML = '';
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select Album...';
      albumSelector.appendChild(defaultOption);
      
      // Add albums (except All Photos)
      galleryAlbums.filter(album => album.id !== 'all').forEach(album => {
        const option = document.createElement('option');
        option.value = album.id;
        option.textContent = album.title;
        
        // Select current album if viewing an album
        if (album.id === currentAlbumId) {
          option.selected = true;
        }
        
        albumSelector.appendChild(option);
      });
    }
    
    /**
     * Render albums in the grid
     */
    function renderAlbums() {
      const albumsGrid = document.getElementById('albums-grid');
      if (!albumsGrid) return;
      
      // Clear existing albums
      albumsGrid.innerHTML = '';
      
      // Render each album
      galleryAlbums.forEach(album => {
        const albumCard = document.createElement('div');
        albumCard.className = 'album-card';
        albumCard.dataset.albumId = album.id;
        
        const albumThumb = document.createElement('div');
        albumThumb.style.height = '150px';
        albumThumb.style.backgroundSize = 'cover';
        albumThumb.style.backgroundPosition = 'center';
        
        if (album.thumbnail) {
          albumThumb.style.backgroundImage = `url('${album.thumbnail}')`;
        } else {
          albumThumb.style.backgroundColor = '#e9ecef';
          albumThumb.style.display = 'flex';
          albumThumb.style.alignItems = 'center';
          albumThumb.style.justifyContent = 'center';
          albumThumb.style.fontSize = '3rem';
          albumThumb.innerHTML = 'ðŸ“·';
        }
        
        const albumInfo = document.createElement('div');
        albumInfo.style.padding = '1rem';
        
        const albumTitle = document.createElement('div');
        albumTitle.style.fontWeight = '600';
        albumTitle.style.marginBottom = '0.25rem';
        albumTitle.textContent = album.title;
        
        const albumCount = document.createElement('div');
        albumCount.style.fontSize = '0.9rem';
        albumCount.style.color = 'var(--bbb-text-muted)';
        albumCount.textContent = typeof album.count === 'number' ? 
                               `${album.count} photo${album.count !== 1 ? 's' : ''}` : 
                               'Loading...';
        
        albumInfo.appendChild(albumTitle);
        albumInfo.appendChild(albumCount);
        
        albumCard.appendChild(albumThumb);
        albumCard.appendChild(albumInfo);
        
        // Add click handler
        albumCard.addEventListener('click', () => {
          viewAlbum(album);
        });
        
        albumsGrid.appendChild(albumCard);
      });
    }
    
    /**
     * View a specific album
     * @param {Object} album - Album object
     */
    function viewAlbum(album) {
      // Update current album
      currentAlbumId = album.id;
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('album', album.id);
      window.history.pushState({}, '', url);
      
      // Update page title
      const subtitle = document.querySelector('h2');
      if (subtitle) {
        subtitle.textContent = `Photo Gallery - ${album.title}`;
      }
      
      // Show back button
      const backButton = document.getElementById('back-to-albums');
      if (backButton) {
        backButton.style.display = 'inline-block';
      }
      
      // Show album selector
      const albumSelector = document.getElementById('album-selector');
      if (albumSelector) {
        albumSelector.style.display = 'inline-block';
        
        // Select current album
        for (let i = 0; i < albumSelector.options.length; i++) {
          if (albumSelector.options[i].value === album.id) {
            albumSelector.selectedIndex = i;
            break;
          }
        }
      }
      
      // Hide albums section
      const albumsSection = document.getElementById('albums-section');
      if (albumsSection) {
        albumsSection.style.display = 'none';
      }
      
      // Show gallery
      const gallery = document.getElementById('gallery');
      if (gallery) {
        gallery.style.display = 'grid';
        gallery.innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:2rem;">Loading images...</div>';
      }
      
      // Load images
      loadGalleryImages(album.id);
    }
    
    /**
     * Show the albums view
     */
    function showAlbumsView() {
      // Update current album
      currentAlbumId = 'all';
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.delete('album');
      window.history.pushState({}, '', url);
      
      // Update page title
      const subtitle = document.querySelector('h2');
      if (subtitle) {
        subtitle.textContent = 'Photo Gallery';
      }
      
      // Hide back button
      const backButton = document.getElementById('back-to-albums');
      if (backButton) {
        backButton.style.display = 'none';
      }
      
      // Hide album selector
      const albumSelector = document.getElementById('album-selector');
      if (albumSelector) {
        albumSelector.style.display = 'none';
      }
      
      // Show albums section
      const albumsSection = document.getElementById('albums-section');
      if (albumsSection) {
        albumsSection.style.display = 'block';
      }
      
      // Hide gallery
      const gallery = document.getElementById('gallery');
      if (gallery) {
        gallery.style.display = 'none';
      }
      
      // Refresh albums
      loadAlbums();
    }
    
    /**
     * Load gallery images
     * @param {string} albumId - Album ID to load images for
     */
    function loadGalleryImages(albumId = 'all') {
      try {
        // First show a loading indicator
        const gallery = document.getElementById('gallery');
        if (gallery) {
          gallery.innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:2rem;">Loading images...</div>';
        }
        
        // Try to show a message if available
        try {
          if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.showMessage === 'function') {
            BBB_UTILS.showMessage('Loading gallery images...', 'info');
          }
        } catch (e) {
          console.warn('Could not show loading message:', e);
        }

        // Get sort and search values
        const sortSelect = document.getElementById('gallery-sort');
        const searchInput = document.getElementById('gallery-search');
        
        const sortValue = sortSelect ? sortSelect.value : 'newest';
        const searchValue = searchInput ? searchInput.value.trim() : '';
        
        // Build API URL
        let apiUrl = `${CLOUDFLARE_API}/images`;
        const params = new URLSearchParams();
        
        if (searchValue) {
          params.append('search', searchValue);
        }
        
        if (albumId && albumId !== 'all') {
          params.append('album', albumId);
        }
        
        params.append('sort', sortValue);
        
        if (params.toString()) {
          apiUrl += `?${params.toString()}`;
        }
        
        // Fetch images
        fetch(apiUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error fetching images: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // Format images
            const images = data.map(img => ({
              id: img.id,
              src: `${CLOUDFLARE_API}/image/${img.id}`,
              alt: img.alt || 'Gallery image',
              uploadedAt: img.uploaded_at,
              uploadedBy: img.uploaded_by
            }));
            
            // Render gallery
            renderGallery(images);
            
            // Update album count
            if (albumId !== 'all') {
              const album = galleryAlbums.find(a => a.id === albumId);
              if (album) {
                album.count = images.length;
              }
            }
            
            // Clear status message
            try {
              if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.showMessage === 'function') {
                BBB_UTILS.showMessage('', 'info');
              }
            } catch (e) {
              console.warn('Could not clear status message:', e);
            }
          })
          .catch(err => {
            console.error('Error loading images:', err);
            
            try {
              if (typeof BBB_UTILS !== 'undefined' && typeof BBB_UTILS.showMessage === 'function') {
                BBB_UTILS.showMessage('Error loading images, showing default images instead', 'warning');
              }
            } catch (e) {
              console.warn('Could not show error message:', e);
            }
            
            // Show fallback images
            const fallbackImages = [
              { id: 'pre_1', src: 'images/photo1.jpg', alt: 'Band on the green' },
              { id: 'pre_2', src: 'images/photo2.jpg', alt: 'Group shot' },
              { id: 'pre_3', src: 'images/photo3.jpg', alt: 'Trophy presentation' },
              { id: 'pre_4', src: 'images/photo4.jpg', alt: 'Action shot' }
            ];
            
            renderGallery(fallbackImages);
          });
          
      } catch (err) {
        console.error('Error in loadGalleryImages function:', err);
        // Show empty state as fallback
        renderGallery([]);
      }
      
      // Check if we need to migrate images from localStorage
      checkMigrationNeeded();
    }
    
    /**
     * Render gallery with images
     * @param {Array} images - Array of image objects
     */
    function renderGallery(images) {
      const gallery = document.getElementById('gallery');
      if (!gallery) return;
      
      gallery.innerHTML = '';
      
      if (images.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.style.textAlign = 'center';
        emptyState.style.gridColumn = '1/-1';
        emptyState.style.padding = '3rem';
        emptyState.style.backgroundColor = '#f8f9fa';
        emptyState.style.borderRadius = '8px';
        
        const emptyIcon = document.createElement('div');
        emptyIcon.innerHTML = 'ðŸ“·';
        emptyIcon.style.fontSize = '3rem';
        emptyIcon.style.marginBottom = '1rem';
        
        const emptyText = document.createElement('p');
        emptyText.textContent = 'No images found. Upload some photos or try a different search.';
        
        emptyState.appendChild(emptyIcon);
        emptyState.appendChild(emptyText);
        gallery.appendChild(emptyState);
        return;
      }
      
      // Create image elements
      images.forEach(image => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        imgContainer.style.overflow = 'hidden';
        imgContainer.style.borderRadius = '8px';
        
        const img = document.createElement('img');
        img.src = image.src;
        img.alt = image.alt || 'Gallery image';
        img.className = 'gallery-img';
        img.loading = 'lazy';
        
        // Image info overlay
        const imageInfo = document.createElement('div');
        imageInfo.style.position = 'absolute';
        imageInfo.style.bottom = '0';
        imageInfo.style.left = '0';
        imageInfo.style.right = '0';
        imageInfo.style.padding = '8px';
        imageInfo.style.background = 'rgba(0,0,0,0.7)';
        imageInfo.style.color = 'white';
        imageInfo.style.fontSize = '0.9rem';
        imageInfo.style.opacity = '0';
        imageInfo.style.transition = 'opacity 0.3s';
        
        const imageTitle = document.createElement('div');
        imageTitle.textContent = image.alt;
        imageTitle.style.overflow = 'hidden';
        imageTitle.style.textOverflow = 'ellipsis';
        imageTitle.style.whiteSpace = 'nowrap';
        
        const imageDate = document.createElement('div');
        imageDate.textContent = image.uploadedAt ? new Date(image.uploadedAt).toLocaleDateString() : 'Unknown date';
        imageDate.style.fontSize = '0.8rem';
        imageDate.style.opacity = '0.8';
        
        imageInfo.appendChild(imageTitle);
        imageInfo.appendChild(imageDate);
        
        // Show info on hover
        imgContainer.addEventListener('mouseenter', () => {
          imageInfo.style.opacity = '1';
        });
        
        imgContainer.addEventListener('mouseleave', () => {
          imageInfo.style.opacity = '0';
        });
        
        // Lightbox on click
        img.addEventListener('click', () => {
          openLightbox(img, image.alt);
        });
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(imageInfo);
        gallery.appendChild(imgContainer);
      });
    }
    
    /**
     * Open lightbox with image
     * @param {HTMLElement} img - Image element
     * @param {string} caption - Image caption
     */
    function openLightbox(img, caption) {
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');
      const lightboxCaption = document.getElementById('lightbox-caption');
      
      lightboxImg.src = img.src;
      lightboxCaption.textContent = caption || img.alt;
      lightbox.style.display = 'flex';
    }
    
    /**
     * Handle image upload
     * @param {Event} e - Input change event
     */
    function handleImageUpload(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      // Show progress
      const progressContainer = document.getElementById('upload-progress');
      const progressBarInner = document.getElementById('progress-bar-inner');
      const progressText = document.getElementById('progress-text');
      
      progressContainer.style.display = 'block';
      progressBarInner.style.width = '0%';
      progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
      
      let uploadedCount = 0;
      let failedCount = 0;
      
      // Get album ID
      const albumSelector = document.getElementById('album-selector');
      const albumId = albumSelector && albumSelector.style.display !== 'none' ? 
                    albumSelector.value : currentAlbumId;
      
      // Process each file
      files.forEach((file, index) => {
        // Validate file
        if (!file.type.startsWith('image/')) {
          failedCount++;
          updateProgress();
          return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('image', file);
        formData.append('alt', file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo');
        
        // Add album if we have one
        if (albumId && albumId !== 'all') {
          formData.append('album', albumId);
        }
        
        // Set username if available
        if (BBB_AUTH.currentUser && BBB_AUTH.currentUser.id) {
          formData.append('username', BBB_AUTH.currentUser.id);
        }
        
        // Upload to Cloudflare
        fetch(`${CLOUDFLARE_API}/upload`, {
          method: 'POST',
          body: formData
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Upload failed: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              uploadedCount++;
            } else {
              failedCount++;
            }
            updateProgress();
          })
          .catch(err => {
            console.error('Error uploading image:', err);
            failedCount++;
            updateProgress();
          });
      });
      
      // Reset input
      e.target.value = '';
      
      function updateProgress() {
        const completed = uploadedCount + failedCount;
        const percentage = Math.round((completed / files.length) * 100);
        
        progressBarInner.style.width = `${percentage}%`;
        progressText.textContent = `Uploaded ${uploadedCount} of ${files.length} (${percentage}%)`;
        
        if (completed === files.length) {
          // All uploads completed
          setTimeout(() => {
            progressContainer.style.display = 'none';
            
            if (failedCount === 0) {
              BBB_UTILS.showMessage(`Successfully uploaded ${uploadedCount} images`, 'success');
            } else if (uploadedCount > 0) {
              BBB_UTILS.showMessage(`Uploaded ${uploadedCount} images, ${failedCount} failed`, 'warning');
            } else {
              BBB_UTILS.showMessage(`Failed to upload ${failedCount} images`, 'error');
            }
            
            // Refresh the current view
            if (currentAlbumId !== 'all') {
              loadGalleryImages(currentAlbumId);
            } else {
              // Just refresh albums to update counts
              loadAlbums();
            }
          }, 1000);
        }
      }
    }
    
    /**
     * Check if image migration is needed
     */
    function checkMigrationNeeded() {
      try {
        const migrated = localStorage.getItem('bbb_gallery_migrated_to_cloudflare');
        if (migrated === 'true') return;
        
        const oldImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
        if (oldImages.length === 0) {
          localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
          return;
        }
        
        // Show migration button
        const migrationBtn = document.createElement('button');
        migrationBtn.className = 'btn';
        migrationBtn.textContent = `Migrate ${oldImages.length} Images to Cloud`;
        migrationBtn.style.display = 'block';
        migrationBtn.style.margin = '1rem auto';
        migrationBtn.style.animation = 'pulse 2s infinite';
        
        // Add migration button before gallery
        const gallery = document.getElementById('gallery');
        if (gallery && gallery.parentNode) {
          gallery.parentNode.insertBefore(migrationBtn, gallery);
        }
        
        // Add click handler
        migrationBtn.addEventListener('click', () => {
          migrateLocalStorageImages(oldImages, migrationBtn);
        });
        
        // Show message
        BBB_UTILS.showMessage(`Found ${oldImages.length} images to migrate`, 'info');
      } catch (err) {
        console.error('Error checking for migration:', err);
      }
    }
    
    /**
     * Migrate images from localStorage to Cloudflare
     * @param {Array} images - Array of image data URLs
     * @param {HTMLElement} button - Migration button element
     */
    function migrateLocalStorageImages(images, button) {
      // Disable button
      button.disabled = true;
      button.textContent = 'Migration in progress...';
      
      // Show progress
      const progressContainer = document.getElementById('upload-progress');
      const progressBarInner = document.getElementById('progress-bar-inner');
      const progressText = document.getElementById('progress-text');
      
      progressContainer.style.display = 'block';
      progressBarInner.style.width = '0%';
      progressText.textContent = 'Preparing migration...';
      
      let migratedCount = 0;
      let failedCount = 0;
      
      // Process each image
      images.forEach((dataURL, index) => {
        try {
          // Convert data URL to blob
          const blob = dataURLtoBlob(dataURL);
          
          // Create form data
          const formData = new FormData();
          formData.append('image', blob, `migrated_image_${index}.jpg`);
          formData.append('alt', `Migrated image ${index + 1}`);
          
          // Set username if available
          if (BBB_AUTH.currentUser && BBB_AUTH.currentUser.id) {
            formData.append('username', BBB_AUTH.currentUser.id);
          }
          
          // Upload to Cloudflare
          fetch(`${CLOUDFLARE_API}/upload`, {
            method: 'POST',
            body: formData
          })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Migration failed: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.success) {
                migratedCount++;
              } else {
                failedCount++;
              }
              updateProgress();
            })
            .catch(err => {
              console.error('Error migrating image:', err);
              failedCount++;
              updateProgress();
            });
        } catch (err) {
          console.error('Error processing image for migration:', err);
          failedCount++;
          updateProgress();
        }
      });
      
      /**
       * Convert data URL to blob
       * @param {string} dataURL - Data URL string
       * @returns {Blob} - Image blob
       */
      function dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        
        return new Blob([u8arr], { type: mime });
      }
      
      /**
       * Update migration progress
       */
      function updateProgress() {
        const completed = migratedCount + failedCount;
        const percentage = Math.round((completed / images.length) * 100);
        
        progressBarInner.style.width = `${percentage}%`;
        progressText.textContent = `Migrated ${migratedCount} of ${images.length} (${percentage}%)`;
        
        if (completed === images.length) {
          // All migrations completed
          setTimeout(() => {
            progressContainer.style.display = 'none';
            
            if (failedCount === 0) {
              BBB_UTILS.showMessage(`Successfully migrated ${migratedCount} images`, 'success');
            } else if (migratedCount > 0) {
              BBB_UTILS.showMessage(`Migrated ${migratedCount} images, ${failedCount} failed`, 'warning');
            } else {
              BBB_UTILS.showMessage(`Failed to migrate ${failedCount} images`, 'error');
            }
            
            // Mark as migrated
            localStorage.setItem('bbb_gallery_migrated_to_cloudflare', 'true');
            
            // Remove old data to free up space
            localStorage.removeItem('uploadedImages');
            
            // Remove migration button
            if (button && button.parentNode) {
              button.parentNode.removeChild(button);
            }
            
            // Refresh the current view
            if (currentAlbumId !== 'all') {
              loadGalleryImages(currentAlbumId);
            } else {
              loadAlbums();
            }
          }, 1000);
        }
      }
    }
    
    /**
     * Setup event handlers
     */
    function setupEventHandlers() {
      // Upload handler
      const uploadInput = document.getElementById('image-upload');
      if (uploadInput) {
        uploadInput.addEventListener('change', handleImageUpload);
      }
      
      // Search handler
      const searchInput = document.getElementById('gallery-search');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
          if (currentAlbumId !== 'all') {
            loadGalleryImages(currentAlbumId);
          }
        }, 500));
      }
      
      // Sort handler
      const sortSelect = document.getElementById('gallery-sort');
      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          if (currentAlbumId !== 'all') {
            loadGalleryImages(currentAlbumId);
          }
        });
      }
      
      // Album selector handler
      const albumSelector = document.getElementById('album-selector');
      if (albumSelector) {
        albumSelector.addEventListener('change', () => {
          const selectedAlbumId = albumSelector.value;
          if (selectedAlbumId && selectedAlbumId !== currentAlbumId) {
            const album = galleryAlbums.find(a => a.id === selectedAlbumId);
            if (album) {
              viewAlbum(album);
            }
          }
        });
      }
      
      // Lightbox close handler
      const lightboxClose = document.querySelector('.lightbox-close');
      if (lightboxClose) {
        lightboxClose.addEventListener('click', () => {
          document.getElementById('lightbox').style.display = 'none';
        });
      }
      
      // Click outside lightbox to close
      const lightbox = document.getElementById('lightbox');
      if (lightbox) {
        lightbox.addEventListener('click', e => {
          if (e.target === lightbox) {
            lightbox.style.display = 'none';
          }
        });
      }
      
      // ESC key to close lightbox
      document.addEventListener('keyup', e => {
        if (e.key === 'Escape') {
          const lightbox = document.getElementById('lightbox');
          if (lightbox) {
            lightbox.style.display = 'none';
          }
        }
      });
    }
    
    /**
     * Debounce function to limit execution frequency
     * @param {Function} func - Function to debounce
     * @param {number} delay - Delay in milliseconds
     * @returns {Function} - Debounced function
     */
    function debounce(func, delay = 300) {
      let timerId;
      return function(...args) {
        clearTimeout(timerId);
        timerId = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }
  </script>
</body>
</html>
