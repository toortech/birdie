<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members - Birdie Bush Bandits</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      /* Enhanced styles to match the full original */
      :root {
        --bbb-primary: #004d00;
        --bbb-secondary: #228B22;
        --bbb-gold: #FFD700;
        --bbb-light-green: #e8f5e8;
        --bbb-text: #333;
        --bbb-text-muted: #666;
        --bbb-border: #ddd;
        --font-family-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        --font-family-accent: 'Georgia', serif;
      }

      .fixed-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 3px solid var(--bbb-gold);
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-family-accent);
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bbb-primary);
      }

      .golf-ball {
        font-size: 1.2em;
        animation: swing 2s ease-in-out infinite;
      }

      @keyframes swing {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-10deg); }
        75% { transform: rotate(10deg); }
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .founded-badge-header {
        display: inline-block;
        background: var(--bbb-gold);
        color: var(--bbb-primary);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-weight: 600;
        font-size: 0.8rem;
        margin-left: 1rem;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
      }

      .user-info {
        color: var(--bbb-primary);
        font-weight: 500;
        font-size: 0.9rem;
      }

      .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      .home-btn {
        background: var(--bbb-secondary);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-block;
        transition: background 0.3s;
      }

      .home-btn:hover {
        background: var(--bbb-primary);
      }

      /* Members Page Hero */
      .members-hero {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
        color: var(--bbb-text);
        text-align: center;
        padding: 4rem 2rem 3rem 2rem;
        position: relative;
        overflow: hidden;
        border-bottom: 3px solid #dee2e6;
        margin-top: 90px;
      }

      .members-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0, 77, 0, 0.03) 0%, transparent 70%);
        animation: rotate 30s linear infinite;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .members-hero-content {
        position: relative;
        z-index: 2;
        max-width: 800px;
        margin: 0 auto;
      }

      .members-hero h1 {
        font-family: var(--font-family-accent);
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--bbb-primary);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }

      .members-hero p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        color: var(--bbb-text-muted);
        line-height: 1.6;
      }

      /* Stats Section */
      .stats-section {
        background: white;
        padding: 3rem 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(135deg, white, var(--bbb-light-green));
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        transition: left 0.5s;
      }

      .stat-card:hover::before {
        left: 100%;
      }

      .stat-card:hover {
        border-color: var(--bbb-gold);
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
      }

      .stat-card .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        position: relative;
        z-index: 2;
      }

      .stat-card .stat-number {
        font-family: var(--font-family-accent);
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--bbb-primary);
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
      }

      .stat-card .stat-label {
        font-size: 0.9rem;
        color: var(--bbb-text-muted);
        position: relative;
        z-index: 2;
      }

      /* Controls section */
      .controls-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin: 2rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }

      .controls-section h3 {
        font-family: var(--font-family-accent);
        color: var(--bbb-primary);
        margin: 0;
        font-size: 1.5rem;
      }

      .sort-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .sort-container label {
        font-family: var(--font-family-accent);
        font-weight: 600;
        color: var(--bbb-text-muted);
        margin-right: 0.5rem;
      }

      .sort-container select {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 2px solid var(--bbb-border);
        background: white;
        font-family: var(--font-family-base);
        transition: border-color 0.3s ease;
      }

      .sort-container select:focus {
        border-color: var(--bbb-secondary);
      }

      /* Enhanced member cards */
      .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
        margin: 2rem auto;
        max-width: 1200px;
        padding: 0 2rem;
      }

      .member-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 3px solid transparent;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
      }

      .member-card:hover {
        border-color: var(--bbb-gold);
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      }

      .member-card .card-header {
        background: linear-gradient(135deg, var(--bbb-light-green), white);
        padding: 1.5rem;
        border-bottom: 2px solid #f0f0f0;
        position: relative;
      }

      .member-card .card-content {
        padding: 1.5rem;
      }

      .member-card h3 {
        font-family: var(--font-family-accent);
        color: var(--bbb-primary);
        font-size: 1.3rem;
        margin-bottom: 0.5rem;
      }

      .data-source-indicator {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--bbb-primary);
      }

      .handicap-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
        text-align: center;
      }

      .handicap-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bbb-primary);
      }

      .recent-scores {
        margin-top: 1rem;
      }

      .recent-scores h4 {
        color: var(--bbb-primary);
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }

      .score-course {
        font-weight: 600;
        color: var(--bbb-primary);
      }

      .score-value {
        background: var(--bbb-secondary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: bold;
      }

      .score-date {
        color: var(--bbb-text-muted);
        font-size: 0.8rem;
      }

      .btn {
        background: linear-gradient(135deg, var(--bbb-secondary), var(--bbb-primary));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-family: var(--font-family-accent);
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, var(--bbb-primary), #001a00);
      }

      .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        width: 100%;
        margin-top: 1rem;
      }

      /* Member only sections */
      .member-only {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      /* Error and loading states */
      .loading-state, .error-state {
        text-align: center;
        padding: 3rem;
        margin: 2rem auto;
        max-width: 600px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--bbb-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .error-state {
        color: #dc3545;
      }

      .retry-btn {
        background: var(--bbb-primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
        transition: background 0.3s;
      }

      .retry-btn:hover {
        background: #003300;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .members-hero h1 {
          font-size: 2rem;
        }
        
        .members-hero p {
          font-size: 1rem;
        }
        
        .stats-row {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 1rem;
        }
        
        .controls-section {
          flex-direction: column;
          text-align: center;
        }
        
        .members-grid {
          grid-template-columns: 1fr;
          padding: 0 1rem;
        }
      }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <header class="fixed-header">
        <div class="header-container">
            <div class="header-left">
                <div class="logo">
                    <span class="golf-ball">⛳</span>
                    <span class="logo-text">Birdie Bush Bandits</span>
                    <span class="founded-badge-header">Est. 2020</span>
                </div>
            </div>
            <div class="header-right">
                <a href="index.html" id="home-link" class="home-btn">🏠 Home</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="members-hero">
            <div class="members-hero-content">
                <h1>Our Members <span class="golf-ball">⛳</span></h1>
                <p>Meet the legendary golfers of the Birdie Bush Bandits. From beginners to seasoned players, our diverse group enjoys friendly competition and camaraderie on the course.</p>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="stats-section">
            <div class="stats-row" id="stats-row">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </section>

        <!-- Member Only Section -->
        <section class="member-only">
            <div style="background: #e8f5e8; padding: 2rem; margin: 2rem 0; border-radius: 10px; text-align: center;">
                <h3 style="color: #004d00; margin-bottom: 1rem;">🏌️ Welcome Back, Member!</h3>
                <p>View detailed member profiles, handicaps, and recent performance statistics.</p>
            </div>
        </section>

        <!-- Controls section -->
        <section class="controls-section">
            <h3>Member Directory</h3>
            <div class="sort-container">
                <label for="sort-select">Sort by:</label>
                <select id="sort-select">
                    <option value="name-asc">Name A-Z</option>
                    <option value="name-desc">Name Z-A</option>
                    <option value="handicap-asc">Handicap (Low to High)</option>
                    <option value="handicap-desc">Handicap (High to Low)</option>
                </select>
            </div>
        </section>

        <!-- Members grid -->
        <div class="members-grid" id="members-grid">
            <!-- Member cards will be populated by JavaScript -->
        </div>
    </main>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="ui.js"></script>

    <!-- Enhanced Authentication Integration Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing members page with authentication...');
      
      // Check if BBB modules are loaded
      if (typeof BBB_CONFIG === 'undefined' || 
          typeof BBB_AUTH === 'undefined' || 
          typeof BBB_DB === 'undefined' || 
          typeof BBB_UI === 'undefined' || 
          typeof BBB_UTILS === 'undefined') {
        console.error('Required BBB modules not found!');
        initializePublicPage();
        return;
      }
      
      // Initialize modules
      try {
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        console.log('Modules initialized successfully');
      } catch (error) {
        console.error('Error initializing modules:', error);
        initializePublicPage();
        return;
      }
      
      // Check authentication and render page accordingly
      checkPageAuthentication();
      
      // Add scroll animations
      addScrollAnimations();
    });

    /**
     * Main authentication check for members page
     */
    function checkPageAuthentication() {
      console.log('Checking page authentication...');
      
      // Try to restore session from localStorage
      const hasStoredAuth = restoreAuthSession();
      
      if (hasStoredAuth) {
        console.log('Restored authentication from storage');
        initializeAuthenticatedPage();
      } else {
        console.log('No stored authentication, checking current auth state...');
        
        // Check if already authenticated in current session
        if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
          console.log('User already authenticated in current session');
          initializeAuthenticatedPage();
        } else {
          console.log('User not authenticated, showing public page');
          initializePublicPage();
        }
      }
    }

    /**
     * Restore authentication session from localStorage
     */
    function restoreAuthSession() {
      try {
        const storedAuth = localStorage.getItem('bbb_auth');
        const storedUser = localStorage.getItem('bbb_current_user');
        const storedExpires = localStorage.getItem('bbb_session_expires');
        
        if (storedAuth && storedUser && storedExpires) {
          const expiresTime = parseInt(storedExpires);
          const currentTime = Date.now();
          
          if (currentTime < expiresTime) {
            // Session is still valid
            const user = JSON.parse(storedUser);
            
            // Restore auth state
            BBB_AUTH.isAuthenticated = true;
            BBB_AUTH.currentUser = user;
            BBB_AUTH.userRoles = user.roles || [user.role];
            BBB_AUTH.sessionToken = storedAuth;
            
            console.log('Session restored for user:', user.username);
            return true;
          } else {
            // Session expired
            console.log('Stored session has expired');
            BBB_AUTH.clearSession();
            return false;
          }
        }
        return false;
      } catch (error) {
        console.error('Error restoring session:', error);
        return false;
      }
    }

    /**
     * Initialize page for authenticated users
     */
    function initializeAuthenticatedPage() {
      console.log('Initializing authenticated page');
      
      // Show authenticated content
      showAuthenticatedContent();
      
      // Add user info and logout functionality
      showUserInfo();
      
      // Add session monitoring
      startSessionMonitoring();
      
      // Load member data
      loadMemberData();
    }

    /**
     * Initialize page for public (non-authenticated) users
     */
    function initializePublicPage() {
      console.log('Initializing public page');
      
      // Show public content
      showPublicContent();
      
      // Keep home button visible
      const homeLink = document.getElementById('home-link');
      if (homeLink) {
        homeLink.style.display = 'inline-block';
      }
      
      // Load limited member data for public view
      loadMemberData();
    }

    /**
     * Show content for authenticated users
     */
    function showAuthenticatedContent() {
      // Show member-specific content
      const memberContent = document.querySelectorAll('.member-only');
      memberContent.forEach(element => {
        element.style.display = 'block';
      });
    }

    /**
     * Show content for public users
     */
    function showPublicContent() {
      // Hide member-only content
      const memberContent = document.querySelectorAll('.member-only');
      memberContent.forEach(element => {
        element.style.display = 'none';
      });
    }

    /**
     * Add logout functionality to header
     */
    function addLogoutFunctionality() {
      const headerRight = document.querySelector('.header-right');
      if (headerRight && BBB_AUTH.isAuthenticated) {
        // Check if logout button already exists
        if (headerRight.querySelector('.logout-btn')) return;
        
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'logout-btn';
        logoutBtn.textContent = 'Logout';
        
        logoutBtn.onclick = function() {
          if (confirm('Are you sure you want to logout?')) {
            performLogout();
          }
        };
        
        headerRight.appendChild(logoutBtn);
      }
    }

    /**
     * Show user information in header
     */
    function showUserInfo() {
      const headerRight = document.querySelector('.header-right');
      if (headerRight && BBB_AUTH.currentUser) {
        // Check if user info already exists
        if (headerRight.querySelector('.user-info')) return;
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.textContent = `Welcome, ${BBB_AUTH.currentUser.name || BBB_AUTH.currentUser.username}`;
        
        // Insert user info before home button
        const homeLink = headerRight.querySelector('#home-link');
        if (homeLink) {
          headerRight.insertBefore(userInfo, homeLink);
        } else {
          headerRight.appendChild(userInfo);
        }
        
        // Add logout functionality
        addLogoutFunctionality();
      }
    }

    /**
     * Perform logout
     */
    async function performLogout() {
      try {
        await BBB_AUTH.logout();
        
        // Redirect to home page
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        // Force redirect even if logout fails
        window.location.href = 'index.html';
      }
    }

    /**
     * Start session monitoring
     */
    function startSessionMonitoring() {
      // Check session validity every 5 minutes
      const sessionCheck = setInterval(async () => {
        if (BBB_AUTH.isAuthenticated && BBB_AUTH.sessionToken) {
          try {
            const isValid = await BBB_AUTH.validateSession();
            if (!isValid) {
              console.log('Session validation failed, logging out...');
              clearInterval(sessionCheck);
              performLogout();
            }
          } catch (error) {
            console.error('Error checking session:', error);
            clearInterval(sessionCheck);
            performLogout();
          }
        } else if (BBB_AUTH.isAuthenticated) {
          // Session was cleared externally
          console.log('Session cleared externally, logging out...');
          clearInterval(sessionCheck);
          performLogout();
        }
      }, 5 * 60 * 1000); // 5 minutes
      
      // Store interval ID for cleanup if needed
      window.bbbSessionMonitor = sessionCheck;
    }

    /**
     * FIXED Load member data with dynamic Cloudflare integration
     */
    async function loadMemberData() {
      console.log('Loading member data with dynamic integration...');
      
      // Show loading state
      const statsRow = document.getElementById('stats-row');
      const membersGrid = document.getElementById('members-grid');
      
      // Clear existing content
      if (statsRow) statsRow.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div>Loading member statistics...</div></div>';
      if (membersGrid) membersGrid.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div>Loading members...</div></div>';
      
      try {
        // Step 1: Load members using the new dynamic system - FIXED THIS LINE
        console.log('Step 1: Loading members from dynamic system...');
        const members = await BBB_DB.getMembers();
        
        if (!members || members.length === 0) {
          throw new Error('No members found');
        }
        
        console.log(`Loaded ${members.length} members from ${members[0]?.source || 'unknown'} source`);
        
        // Step 2: Load handicap data for each member
        console.log('Step 2: Loading handicap data for members...');
        const memberDataPromises = members.map(async member => {
          try {
            // Use member.id or member.username for handicap lookup
            const handicapId = member.id || member.username;
            const handicapData = await BBB_DB.getMemberHandicap(handicapId);
            
            return {
              member: member.display_name || member.username,
              handicap: handicapData,
              // Include all member data for enhanced profiles
              memberData: member
            };
          } catch (handicapError) {
            console.warn(`Failed to load handicap for ${member.display_name}:`, handicapError);
            return {
              member: member.display_name || member.username,
              handicap: null,
              memberData: member
            };
          }
        });
        
        const memberData = await Promise.all(memberDataPromises);
        console.log('Handicap data loaded for', memberData.length, 'members');
        
        // Step 3: Load scorecards for statistics
        console.log('Step 3: Loading scorecards for statistics...');
        const scorecards = await BBB_DB.getScorecards();
        const scorecardsArray = Object.values(scorecards);
        console.log('Loaded', scorecardsArray.length, 'scorecards');
        
        // Step 4: Update UI with loaded data
        console.log('Step 4: Updating UI...');
        updateStats(memberData, scorecardsArray);
        setupSorting(memberData, scorecardsArray);
        renderMembers(memberData, scorecardsArray, 'name-asc');
        
        // Show success message
        const dataSource = members[0]?.source || 'unknown';
        const sourceLabel = dataSource === 'cloudflare' ? '☁️ Live Data' : 
                           dataSource === 'database' ? '💾 Database' : '📄 Static Data';
        
        if (typeof BBB_UTILS !== 'undefined' && BBB_UTILS.showMessage) {
          BBB_UTILS.showMessage(`Successfully loaded ${members.length} members from ${sourceLabel}`, 'success', 3000);
        }
        
      } catch (error) {
        console.error('Error loading member data:', error);
        
        // Show error in UI
        if (statsRow) {
          statsRow.innerHTML = `
            <div class="error-state">
              <div style="font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
              <div style="font-size: 1.2rem; margin-bottom: 1rem;">Error Loading Member Data</div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 2rem;">${error.message}</div>
            </div>
          `;
        }
        
        if (membersGrid) {
          membersGrid.innerHTML = `
            <div class="error-state">
              <div style="font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
              <div style="font-size: 1.2rem; margin-bottom: 1rem;">Unable to Load Members</div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 2rem;">${error.message}</div>
              <button onclick="retryLoadMembers()" class="retry-btn">
                🔄 Retry Loading
              </button>
            </div>
          `;
        }
        
        // Try fallback to cached or static data
        try {
          console.log('Attempting fallback data loading...');
          const fallbackMembers = BBB_DB.getStaticMembers ? BBB_DB.getStaticMembers() : null;
          
          if (fallbackMembers && fallbackMembers.length > 0) {
            console.log('Using static members as fallback');
            const fallbackData = fallbackMembers.map(member => ({
              member: member.display_name,
              handicap: null,
              memberData: member
            }));
            
            updateStats(fallbackData, []);
            setupSorting(fallbackData, []);
            renderMembers(fallbackData, [], 'name-asc');
            
            if (typeof BBB_UTILS !== 'undefined' && BBB_UTILS.showMessage) {
              BBB_UTILS.showMessage('Loaded static member data as fallback', 'warning', 5000);
            }
          }
        } catch (fallbackError) {
          console.error('Fallback loading also failed:', fallbackError);
          if (typeof BBB_UTILS !== 'undefined' && BBB_UTILS.showMessage) {
            BBB_UTILS.showMessage('Failed to load member data. Please try refreshing the page.', 'error', 8000);
          }
        }
      }
    }

    /**
     * Retry loading members (called from retry button)
     */
    async function retryLoadMembers() {
      console.log('Retrying member data load...');
      
      // Clear cache to force fresh data
      if (typeof BBB_DB.clearMemberCache === 'function') {
        BBB_DB.clearMemberCache();
      }
      
      // Reload member data
      await loadMemberData();
    }

    /**
     * Enhanced updateStats function with member source information
     */
    function updateStats(memberData, scorecards) {
      const statsRow = document.getElementById('stats-row');
      
      // Clear existing stats
      statsRow.innerHTML = '';
      
      // Calculate stats
      let totalHandicap = 0;
      let membersWithHandicap = 0;
      let cloudflareMembers = 0;
      let staticMembers = 0;
      
      memberData.forEach(data => {
        // Count member sources
        if (data.memberData?.source === 'cloudflare') {
          cloudflareMembers++;
        } else {
          staticMembers++;
        }
        
        // Count handicaps
        if (data.handicap && data.handicap.index) {
          totalHandicap += parseFloat(data.handicap.index);
          membersWithHandicap++;
        }
      });
      
      // Create stat cards
      const createStatCard = (icon, number, label, subtitle = null) => {
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        
        const statIcon = document.createElement('div');
        statIcon.className = 'stat-icon';
        statIcon.innerHTML = icon;
        
        const statNumber = document.createElement('div');
        statNumber.className = 'stat-number';
        statNumber.textContent = number;
        
        const statLabel = document.createElement('div');
        statLabel.className = 'stat-label';
        statLabel.textContent = label;
        
        if (subtitle) {
          const statSubtitle = document.createElement('div');
          statSubtitle.style.fontSize = '0.8rem';
          statSubtitle.style.color = '#999';
          statSubtitle.style.marginTop = '0.25rem';
          statSubtitle.textContent = subtitle;
          statCard.appendChild(statSubtitle);
        }
        
        statCard.appendChild(statIcon);
        statCard.appendChild(statNumber);
        statCard.appendChild(statLabel);
        
        return statCard;
      };
      
      // Add basic stats
      statsRow.appendChild(createStatCard('👥', memberData.length, 'Total Members'));
      statsRow.appendChild(createStatCard('🏆', '4+', 'Years Active'));
      
      // Add courses count if available
      const coursesCount = (BBB_CONFIG?.courses && Object.keys(BBB_CONFIG.courses).length) || 3;
      statsRow.appendChild(createStatCard('⛳', coursesCount, 'Courses Played'));
      
      if (membersWithHandicap > 0) {
        const avgHandicap = (totalHandicap / membersWithHandicap).toFixed(1);
        statsRow.appendChild(createStatCard('📊', avgHandicap, 'Avg Handicap'));
      }
      
      // Add data source information
      if (cloudflareMembers > 0) {
        const sourceLabel = staticMembers > 0 ? 'Mixed Data' : 'Live Data';
        const sourceSubtitle = staticMembers > 0 ? 
          `${cloudflareMembers} live, ${staticMembers} static` : 
          `${cloudflareMembers} from Cloudflare`;
        statsRow.appendChild(createStatCard('☁️', cloudflareMembers, sourceLabel, sourceSubtitle));
      }
    }

    /**
     * Setup sorting functionality
     */
    function setupSorting(memberData, scorecards) {
      const sortSelect = document.getElementById('sort-select');
      if (sortSelect) {
        sortSelect.addEventListener('change', function() {
          renderMembers(memberData, scorecards, this.value);
        });
      }
    }

    /**
     * Enhanced createMemberCard function with rich member data
     */
    function createMemberCard(memberName, handicap, scorecards, memberData) {
      // Get member-specific scorecards
      const memberScores = scorecards.filter(score => 
        score.player?.toLowerCase() === memberName.toLowerCase()
      ).slice(0, 3); // Latest 3 scores
      
      const memberCard = document.createElement('div');
      memberCard.className = 'member-card';
      
      // Create card header
      const cardHeader = document.createElement('div');
      cardHeader.className = 'card-header';
      
      // Data source indicator
      const dataSource = memberData?.source || 'static';
      const sourceIcon = dataSource === 'cloudflare' ? '☁️' : 
                        dataSource === 'database' ? '💾' : '📄';
      const sourceLabel = dataSource === 'cloudflare' ? 'LIVE DATA' : 
                         dataSource === 'database' ? 'DATABASE' : 'STATIC DATA';
      
      const sourceIndicator = document.createElement('div');
      sourceIndicator.className = 'data-source-indicator';
      sourceIndicator.innerHTML = `${sourceIcon} ${sourceLabel}`;
      
      // Member name
      const memberNameEl = document.createElement('h3');
      memberNameEl.textContent = memberName;
      
      cardHeader.appendChild(memberNameEl);
      cardHeader.appendChild(sourceIndicator);
      
      // Create card content
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Enhanced member info section
      if (memberData?.email || memberData?.role) {
        const memberInfoSection = document.createElement('div');
        memberInfoSection.style.marginBottom = '1rem';
        
        if (memberData.email) {
          const emailDiv = document.createElement('div');
          emailDiv.style.fontSize = '0.9rem';
          emailDiv.style.color = '#666';
          emailDiv.style.marginBottom = '0.25rem';
          emailDiv.innerHTML = `<strong>Email:</strong> ${memberData.email}`;
          memberInfoSection.appendChild(emailDiv);
        }
        
        if (memberData.role) {
          const roleDiv = document.createElement('div');
          roleDiv.style.fontSize = '0.9rem';
          roleDiv.style.color = '#666';
          roleDiv.innerHTML = `<strong>Role:</strong> ${memberData.role}`;
          memberInfoSection.appendChild(roleDiv);
        }
        
        cardContent.appendChild(memberInfoSection);
      }
      
      // Handicap section
      const handicapSection = document.createElement('div');
      handicapSection.className = 'handicap-section';
      
      const handicapLabel = document.createElement('div');
      handicapLabel.style.fontSize = '0.9rem';
      handicapLabel.style.color = '#666';
      handicapLabel.style.marginBottom = '0.5rem';
      handicapLabel.textContent = 'Handicap Index';
      
      const handicapValue = document.createElement('div');
      handicapValue.className = 'handicap-value';
      handicapValue.textContent = handicap ? handicap.index : 'N/A';
      
      handicapSection.appendChild(handicapLabel);
      handicapSection.appendChild(handicapValue);
      cardContent.appendChild(handicapSection);
      
      // Recent scores section
      const scoresSection = document.createElement('div');
      scoresSection.className = 'recent-scores';
      
      const scoresTitle = document.createElement('h4');
      scoresTitle.textContent = 'Recent Scores';
      scoresSection.appendChild(scoresTitle);
      
      if (memberScores.length > 0) {
        const scoresList = document.createElement('div');
        
        memberScores.forEach(score => {
          const scoreItem = document.createElement('div');
          scoreItem.className = 'score-item';
          
          scoreItem.innerHTML = `
            <span class="score-course">${score.course}</span>
            <span class="score-value">${score.score}</span>
            <span class="score-date">${new Date(score.date).toLocaleDateString()}</span>
          `;
          
          scoresList.appendChild(scoreItem);
        });
        
        scoresSection.appendChild(scoresList);
        cardContent.appendChild(scoresSection);
      } else {
        // No scores message
        const noScores = document.createElement('p');
        noScores.style.color = '#666';
        noScores.style.fontStyle = 'italic';
        noScores.style.textAlign = 'center';
        noScores.style.marginTop = '1rem';
        noScores.textContent = 'No recent scores available';
        cardContent.appendChild(noScores);
      }
      
      // Add "View Profile" button
      const viewProfileBtn = document.createElement('button');
      viewProfileBtn.className = 'btn btn-sm';
      viewProfileBtn.textContent = 'View Full Profile';
      viewProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Use member data ID if available, otherwise fall back to name-based ID
        const profileId = memberData?.id || memberData?.username || memberName.toLowerCase();
        window.location.href = `member-profile.html?id=${encodeURIComponent(profileId)}`;
      });
      
      cardContent.appendChild(viewProfileBtn);
      memberCard.appendChild(cardHeader);
      memberCard.appendChild(cardContent);
      
      return memberCard;
    }

    /**
     * Enhanced renderMembers function with dynamic data support
     */
    function renderMembers(memberData, scorecards, sortCriteria) {
      const membersGrid = document.getElementById('members-grid');
      
      // Clear existing members
      membersGrid.innerHTML = '';
      
      // Sort the member data
      const sortedData = [...memberData].sort((a, b) => {
        switch(sortCriteria) {
          case 'name-asc':
            return a.member.localeCompare(b.member);
          case 'name-desc':
            return b.member.localeCompare(a.member);
          case 'handicap-asc':
            const hcpA = a.handicap ? parseFloat(a.handicap.index) : 999;
            const hcpB = b.handicap ? parseFloat(b.handicap.index) : 999;
            return hcpA - hcpB;
          case 'handicap-desc':
            const hcpA2 = a.handicap ? parseFloat(a.handicap.index) : -1;
            const hcpB2 = b.handicap ? parseFloat(b.handicap.index) : -1;
            return hcpB2 - hcpA2;
          default:
            return 0;
        }
      });
      
      // Create member cards
      sortedData.forEach(data => {
        const memberCard = createMemberCard(data.member, data.handicap, scorecards, data.memberData);
        membersGrid.appendChild(memberCard);
      });
      
      // Add scroll animations to new cards
      addScrollAnimations();
    }

    /**
     * Add scroll animations
     */
    function addScrollAnimations() {
      // Simple scroll animation for member cards
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      });

      // Observe all member cards when they're created
      setTimeout(() => {
        document.querySelectorAll('.member-card').forEach(card => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          observer.observe(card);
        });
      }, 100);
    }
    </script>
</body>
</html>
