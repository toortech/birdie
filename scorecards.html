<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stableford Scorecard ‚Äì Multiple Courses</title>
  <style>
    input.invalid-hcp { border: 2px solid red; background-color: #ffcccc; }
    body { background: #f5f5f5; color: #000000; font-family: sans-serif; padding: 1rem; margin: 0 auto; }
    h1 { color: #003300; font-size: 2rem; text-align: center; margin-bottom: 1rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .controls > div { background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 6px; flex: 1 1 200px; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    #table-container { overflow-x: auto; min-height: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 600px; }
    th, td { border: 1px solid #fff; padding: 0.5rem; text-align: center; }
    th { background: rgba(255,255,255,0.2); }
    input[type="number"] { width: 3rem; }
    select { padding: 0.25rem; width: 100%; }
    button { background: #004c99; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #003d7a; }
    #button-group { display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; }
    input.missing { border: 2px solid red; }
    .stroke-info { font-size: 0.75em; color: #ccc; margin-top: 0.25rem; }
    @media (max-width: 768px) {
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem; }
      input[type="number"] { width: 2rem; font-size: 0.75rem; }
      .controls { flex-direction: column; }
      .controls > div { flex: 1 1 auto; }
    }
    #table-container {
    position: relative;
    max-width: 100vw;
  }
  #table-container::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    width: 20px;
    background: linear-gradient(to right, transparent, rgba(0,0,0,0.2));
    pointer-events: none;
  }
  table {
    table-layout: auto;
    min-width: 800px;
  }
  th, td {
    white-space: nowrap;
  }
}
      th, td { padding: 0.2rem; }
      input[type="number"] { width: 1.8rem; font-size: 0.7rem; }
      select, button { font-size: 0.8rem; }
      .stroke-info { font-size: 0.6em; }
      #table-container { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
    }
  </style>
</head>
<div style="text-align: right; margin-bottom: 0.5rem;">
    <a href="index.html" style="color: #000; font-weight: bold; text-decoration: none;">üè† Home</a>
  </div>
<h1>Stableford Scorecard ‚Äì Multiple Courses</h1>
  <details id="setup-controls" open>
  <summary style="cursor:pointer; font-weight:bold; font-size:1.1em;">‚öôÔ∏è Setup Options</summary>
  <div class="controls">
    <div>
      <label for="course-select">Course:</label>
      <select id="course-select">
        <option value="Ritchings">Richings Park</option>
        <option value="Thorney">Thorney Park</option>
      </select>
    </div>
    <div>
      <label for="tee-select">Tee Colour:</label>
      <select id="tee-select">
        <option value="white">White</option>
        <option value="yellow">Yellow</option>
        <option value="red">Red</option>
      </select>
    </div>
    <div>
      <label>Players (max 4):</label>
      <label><input type="checkbox" name="player" value="Amrit"> Amrit</label>
<label><input type="checkbox" name="player" value="Kam"> Kam</label>
<label><input type="checkbox" name="player" value="Vish"> Vish</label>
<label><input type="checkbox" name="player" value="Ravi"> Ravi</label>
<label><input type="checkbox" name="player" value="Bal"> Bal</label>
<label><input type="checkbox" name="player" value="Vick"> Vick</label>
<label><input type="checkbox" name="player" value="Michael"> Michael</label>
<label><input type="checkbox" name="player" value="Justy"> Justy</label>
<label><input type="checkbox" name="player" value="Phuperjee"> Phuperjee</label>
<label><input type="checkbox" name="player" value="Indy"> Indy</label>
<label><input type="checkbox" name="player" value="Maj"> Maj</label>
<label><input type="checkbox" name="player" value="Sama"> Sama</label>
    </div>
    <div>
      <label>Holes:</label>
      <label><input type="radio" name="holes" value="18" checked> Full 18</label>
      <label><input type="radio" name="holes" value="9f"> Front 9</label>
      <label><input type="radio" name="holes" value="9b"> Back 9</label>
    </div>
  </div>
</details>
<div id="button-group" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
  <button id="build">Build Scorecard</button>
  <button id="reset">Reset</button>
  <button id="save" disabled>Save Scorecard</button>
  <button id="download-image">üì∏ Save Scorecard as Image</button>
  <a href="#" id="view-saved-link" style="background:#004c99;color:white;border-radius:4px;text-decoration:none;">üìÑ View Past Scorecards</a>
</div>
<div id="created-time"></div>
<div id="table-container"></div>
<script>
let scorecardBuilt = false;
let savedSuccessfully = false;

const buildBtn = document.getElementById('build');
const saveBtn = document.getElementById('save');
const resetBtn = document.getElementById('reset');
const tableContainer = document.getElementById('table-container');
const createdTime = document.getElementById('created-time');
const viewLink = document.getElementById('view-saved-link');

buildBtn.addEventListener('click', () => {
  const selectedPlayers = [...document.querySelectorAll('#player-checkboxes input[type=checkbox]:checked')];
  if (selectedPlayers.length === 0) {
    alert("‚ö†Ô∏è Please select at least one player.");
    return;
  }
  if (selectedPlayers.length > 4) {
    alert("‚ö†Ô∏è Please select no more than 4 players.");
    return;
  }

  let allHCPValid = true;
  selectedPlayers.forEach((cb, i) => {
    const hcpInput = document.getElementById(`hcp-${i}`);
    if (hcpInput && (hcpInput.value === '' || isNaN(hcpInput.value) || parseInt(hcpInput.value) <= 0)) {
      hcpInput?.classList?.add('invalid-hcp');
      allHCPValid = false;
    } else {
      hcpInput?.classList?.remove('invalid-hcp');
    }
  });

  if (!allHCPValid) {
    alert("‚ö†Ô∏è Please enter a valid handicap (greater than 0) for all selected players before building the scorecard.");
    return;
  }
  if (scorecardBuilt && !confirm('Rebuilding will erase all entered scores. Continue?')) return;
  build();
  document.getElementById('setup-controls').open = false;
  scorecardBuilt = true;
  saveBtn.disabled = false;
});

resetBtn.addEventListener('click', () => {
  if (confirm('‚ö†Ô∏è Are you sure you want to reset the scorecard? All entered data will be lost.')) {
    scorecardBuilt = false;
    savedSuccessfully = false;
    tableContainer.innerHTML = '';
    createdTime.textContent = '';
    saveBtn.disabled = true;
  }
});

viewLink.addEventListener('click', (e) => {
  if (scorecardBuilt && !savedSuccessfully) {
    e.preventDefault();
    alert('‚ö†Ô∏è Please save your current scorecard before viewing past ones.');
  } else {
    window.location.href = 'view-saved-scores.html';
  }
});

saveBtn.addEventListener('click', () => {
  const allInputs = tableContainer.querySelectorAll('tbody input[type=number]');
  let allFilled = true;
  allInputs.forEach(inp => {
    if (inp.value === '' || isNaN(parseInt(inp.value, 10))) {
      inp.classList.add('missing');
      allFilled = false;
    } else {
      inp.classList.remove('missing');
    }
  });
  if (!allFilled) {
    alert('‚ö†Ô∏è Please enter all scores before saving the scorecard.');
    return;
  }
  savedSuccessfully = true;
  alert('‚úÖ Scorecard has been saved successfully.');
});

window.addEventListener('beforeunload', function (e) {
  if (scorecardBuilt && !savedSuccessfully) {
    e.preventDefault();
    e.returnValue = 'You have unsaved scorecard data. Are you sure you want to leave?';
  }
});

document.getElementById('download-image').addEventListener('click', () => {
  const node = document.getElementById('table-container');
  if (!node || !node.firstChild) {
    alert('‚ö†Ô∏è No scorecard found to capture.');
    return;
  }
  // Apply print-friendly styles
  const originalStyles = node.getAttribute('style');
  node.style.backgroundColor = 'white';
  node.style.color = 'black';
  node.querySelectorAll('th, td').forEach(cell => {
    cell.style.color = 'black';
    cell.style.backgroundColor = 'white';
    cell.style.borderColor = '#000';
  });

  import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js').then(() => {
    html2canvas(node, { scale: 2 }).then(canvas => {
      const link = document.createElement('a');
      link.download = `scorecard_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL();
      link.click();

      // Revert original styles
      node.setAttribute('style', originalStyles || '');
      node.querySelectorAll('th, td').forEach(cell => {
        cell.removeAttribute('style');
      });
    });
  });
});

function build() {
  const courses = {
    Ritchings: {
      par: [4,3,5,4,4,3,4,4,4,3,4,4,4,3,4,4,5,4],
      si: [12,8,6,18,10,16,2,14,4,15,3,17,7,11,1,5,13,9],
      yards: {
        white: [365,140,495,350,370,160,385,375,360,155,380,370,395,145,400,360,510,375],
        yellow: [350,130,480,340,355,150,370,360,345,145,365,355,380,135,385,345,495,360],
        red: [330,120,460,320,335,140,350,340,325,135,345,335,360,125,365,325,470,340]
      }
    },
    Thorney: {
      par: [5,4,4,3,5,4,4,3,5,4,4,3,5,4,4,3,5,4],
      si: [9,15,1,17,5,13,3,11,7,16,2,14,6,18,4,12,8,10],
      yards: {
        white: [475,360,410,155,495,345,375,160,500,350,370,150,480,355,385,145,505,365],
        yellow: [460,345,395,145,480,330,360,150,485,335,355,140,465,340,370,135,490,350],
        red: [440,320,370,130,450,305,335,135,455,310,330,125,435,315,345,120,460,325]
      }
    }
  };
  const teeSlope = { white:128, yellow:121, red:115 };

  const courseKey = document.getElementById('course-select').value;
  const tee = document.getElementById('tee-select').value;
  const { par, si, yards } = courses[courseKey];
  const slope = teeSlope[tee];
  const players = [...document.querySelectorAll('#player-checkboxes input[type=checkbox]:checked')].map(cb => cb.value);
  const holes = document.querySelector('input[name=holes]:checked').value;
  if (players.length === 0) {
    alert("Please select at least one player.");
    return;
  }
  if (players.length > 4) {
    alert("‚ö†Ô∏è Please select no more than 4 players.");
    return;
  }

  let indices = [...Array(18).keys()];
  if (holes === '9f') indices = indices.slice(0,9);
  if (holes === '9b') indices = indices.slice(9);

  createdTime.textContent = `Scorecard created: ${new Date().toLocaleString()}`;
  tableContainer.innerHTML = '';

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  let hdr1 = '<tr><th>Hole</th><th>Par</th><th style="color:red;">SI</th><th>Yards</th>';
  players.forEach((p,i) => hdr1 += `<th colspan="2">${p}<br>HCP:<input id="hcp-${i}" type="number" value="0" min="1" max="36"></th>`);
  hdr1 += '</tr>';
  let hdr2 = '<tr><th></th><th></th><th></th><th></th>';
  players.forEach(() => hdr2 += '<th>Shots</th><th>STB Score</th>');
  hdr2 += '</tr>';
  thead.innerHTML = hdr1 + hdr2;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  indices.forEach(i => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${par[i]}</td><td style="color:red;">${si[i]}</td><td>${yards[tee][i]}</td>`;
    players.forEach((_,pi) => {
      tr.innerHTML += `<td><input data-player="${pi}" data-hole="${i}" type="number" min="0"></td>
      <td class="pts-${pi}"><div class="points"></div><div class="stroke-info" data-player="${pi}" data-hole="${i}"></div></td>`;
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  const tfoot = document.createElement('tfoot');
  ['Front 9','Back 9','Overall'].forEach((lbl,ri) => {
    let row = `<tr><td colspan="4">${lbl} Total</td>`;
    players.forEach((_,pi) => row += `<td id="str-${ri}-${pi}" style="font-weight:bold;"></td><td id="pts-${ri}-${pi}" style="font-weight:bold;"></td>`);
    row += '</tr>';
    tfoot.innerHTML += row;
  });
  table.appendChild(tfoot);
  tableContainer.appendChild(table);

  players.forEach((_,i) => {
    const hcpInput = document.getElementById(`hcp-${i}`);
    const adjSpan = document.createElement('span');
    adjSpan.id = `adjhcp-${i}`;
    adjSpan.style.fontWeight = 'bold';
    adjSpan.style.marginLeft = '0.5rem';
    adjSpan.textContent = 'Adj HCP: 0';
    hcpInput.insertAdjacentElement('afterend', adjSpan);

    const updateAdj = () => {
      const raw = parseInt(hcpInput.value, 10) || 0;
      const adj = Math.round(raw * slope / 113);
      adjSpan.textContent = `Adj HCP: ${adj}`;
      indices.forEach(h => {
        const strokeInfo = document.querySelector(`.stroke-info[data-player="${i}"][data-hole="${h}"]`);
        if (!strokeInfo) return;
        const siH = si[h];
        let strokes = 0;
        if (adj >= siH + 18) strokes = 2;
        else if (adj >= siH) strokes = 1;
        strokeInfo.textContent = `(${strokes} stroke${strokes !== 1 ? 's' : ''})`;
        strokeInfo.parentElement.style.backgroundColor = strokes > 0 ? 'rgba(255,165,0,0.6)' : '';
      });
    };

    hcpInput.addEventListener('input', () => {
      updateAdj();
      update(table, par, si, players, indices, slope);
    });

    updateAdj();
  });

  tbody.querySelectorAll('input[type=number]').forEach(inp => inp.addEventListener('input', () => {
    const playerIndex = inp.getAttribute('data-player');
    const hcpField = document.getElementById(`hcp-${playerIndex}`);
    inp.classList.remove('missing');
    if (!hcpField || hcpField.value === '' || isNaN(hcpField.value) || parseInt(hcpField.value, 10) <= 0) {
      alert(`‚ö†Ô∏è Please enter a valid handicap for player ${players[playerIndex]} before scoring.`);
      inp.value = '';
      return;
    }
    update(table, par, si, players, indices, slope);
  }));

  update(table, par, si, players, indices, slope);
}

function update(table, par, siArr, players, indices, slope) {
  const totals = players.map(() => ({fS:0,fP:0,bS:0,bP:0,oS:0,oP:0}));
  table.querySelectorAll('tbody tr').forEach((tr,idx) => {
    const h = indices[idx];
    const pr = par[h], sidx = siArr[h];
    const front = idx < 9;
    players.forEach((_,pi) => {
      const inp = tr.querySelector(`input[data-player="${pi}"][data-hole="${h}"]`);
      const sc = parseInt(inp.value,10);
      const ptsCell = tr.querySelector(`.pts-${pi}`);
      if (isNaN(sc)) return;
      const rawHcp = parseInt(document.getElementById(`hcp-${pi}`).value,10)||0;
      const adjHcp = Math.round(rawHcp * slope/113);
      let strokes = 0;
      if (adjHcp >= sidx + 18) strokes = 2;
      else if (adjHcp >= sidx) strokes = 1;
      const net = sc - strokes;
      let pts=0;
      if(net <= pr-2) pts=4;
      else if(net===pr-1) pts=3;
      else if(net===pr) pts=2;
      else if(net===pr+1) pts=1;
      const pointsDiv = ptsCell.querySelector('.points');
      const strokeInfo = ptsCell.querySelector('.stroke-info');
      if (pointsDiv) pointsDiv.textContent = pts;
      if (strokeInfo) strokeInfo.textContent = `(${strokes} stroke${strokes !== 1 ? 's' : ''})`;
      totals[pi].oS += sc;
      if(front) totals[pi].fS += sc; else totals[pi].bS += sc;
      totals[pi].oP += pts;
      if(front) totals[pi].fP += pts; else totals[pi].bP += pts;
    });
  });
  totals.forEach((t,pi) => [0,1,2].forEach(r => {
    document.getElementById(`str-${r}-${pi}`).textContent = r===0? t.fS: r===1? t.bS: t.oS;
    document.getElementById(`pts-${r}-${pi}`).textContent = r===0? t.fP: r===1? t.bP: t.oP;
  }));
}
</script>
</body>
</html>
