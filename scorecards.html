<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saved Scorecards - Birdie Bush Bandits</title>
  <meta name="description" content="View saved golf scorecards for Birdie Bush Bandits members.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules - MUST be loaded before authentication script -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>

  <style>
    /* Enhanced CSS Variables - Same as about.html */
    :root {
      --bbb-primary: #004d00;
      --bbb-secondary: #0046ad;
      --bbb-gold: #ffd700;
      --bbb-light-green: #e8f5e8;
      --bbb-background: #f5f5f5;
      --bbb-text: #212529;
      --bbb-text-muted: #6c757d;
      --bbb-border: #dee2e6;
      --font-family-base: 'Inter', sans-serif;
      --font-family-accent: 'Montserrat', serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      line-height: 1.6;
      color: var(--bbb-text);
      background: linear-gradient(135deg, var(--bbb-light-green) 0%, var(--bbb-background) 100%);
      min-height: 100vh;
    }

    /* Header with Logo - Same as about.html */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-logo {
      height: 50px;
      width: auto;
      transition: transform 0.3s ease;
    }

    .header-logo:hover {
      transform: scale(1.05);
    }

    .header-title {
      font-family: var(--font-family-accent);
      color: var(--bbb-primary);
      font-size: 1.5rem;
      font-weight: 700;
      margin-left: 1rem;
      text-decoration: none;
    }

    .header-title:hover {
      color: var(--bbb-secondary);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .founded-badge-header {
      display: inline-block;
      background: var(--bbb-gold);
      color: var(--bbb-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-weight: 600;
      font-size: 0.8rem;
      margin-left: 1rem;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    /* User info and auth controls */
    .user-info {
      color: var(--bbb-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .home-btn {
      background: var(--bbb-secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
      transition: background 0.3s;
    }

    .home-btn:hover {
      background: var(--bbb-primary);
    }

    /* Main Content Area */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      padding-top: 120px; /* Account for fixed header */
    }

    /* Page Hero Section */
    .page-hero {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
      color: var(--bbb-text);
      text-align: center;
      padding: 3rem 2rem 2rem 2rem;
      position: relative;
      overflow: hidden;
      border-bottom: 3px solid #dee2e6;
      margin-bottom: 3rem;
      border-radius: 20px;
    }

    .page-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0, 77, 0, 0.03) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .page-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
    }

    .page-hero h1 {
      font-family: var(--font-family-accent);
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      color: var(--bbb-primary);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      animation: fadeInUp 1s ease-out;
      margin: 0 0 1rem 0;
    }

    .page-hero .subtitle {
      font-size: clamp(1rem, 2vw, 1.2rem);
      color: var(--bbb-text-muted);
      max-width: 600px;
      margin: 0 auto;
      animation: fadeInUp 1s ease-out 0.3s both;
      font-weight: 500;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Golf ball decorative element */
    .golf-ball {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: relative;
      display: inline-block;
      margin: 0 10px;
      box-shadow: inset -3px -3px 5px rgba(0,0,0,0.2);
    }

    .golf-ball::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 2px;
      background: #ccc;
      border-radius: 50%;
      top: 4px;
      left: 6px;
      box-shadow: 4px 0 #ccc, 8px 0 #ccc, 2px 4px #ccc, 6px 4px #ccc, 10px 4px #ccc, 4px 8px #ccc, 8px 8px #ccc;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 2rem 0;
    }

    .btn {
      background: var(--bbb-secondary);
      color: white;
      padding: 1rem 2rem;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: inline-block;
      box-shadow: 0 4px 15px rgba(0, 70, 173, 0.2);
      min-width: 180px;
      text-align: center;
      border: none;
      cursor: pointer;
      font-family: var(--font-family-accent);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 70, 173, 0.3);
      background: var(--bbb-primary);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      min-width: 120px;
    }

    .btn-danger {
      background: #dc3545;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
    }

    .btn-danger:hover {
      background: #c82333;
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
    }

    /* Status Messages */
    #status-message {
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 10px;
      text-align: center;
      display: none;
      font-weight: 500;
      border: 2px solid transparent;
    }

    .success {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color: #1b5e20;
      border-color: #4caf50;
    }

    .error {
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      color: #b71c1c;
      border-color: #f44336;
    }

    .warning {
      background: linear-gradient(135deg, #fff8e1, #ffe082);
      color: #f57f17;
      border-color: #ffeb3b;
    }

    .info {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #0d47a1;
      border-color: #2196f3;
    }

    /* Info Message */
    .message {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin: 2rem 0;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border-left: 4px solid var(--bbb-gold);
    }

    .message a {
      color: var(--bbb-secondary);
      text-decoration: none;
      font-weight: 600;
    }

    .message a:hover {
      color: var(--bbb-primary);
      text-decoration: underline;
    }

    /* Scorecard List */
    .scorecard-list {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .scorecard-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .scorecard-card:hover {
      border-color: var(--bbb-gold);
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .scorecard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--bbb-primary), var(--bbb-secondary));
    }

    .scorecard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .scorecard-title {
      font-family: var(--font-family-accent);
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--bbb-primary);
      margin: 0;
    }

    .scorecard-date {
      font-size: 1rem;
      color: var(--bbb-text-muted);
      font-weight: 500;
      text-align: right;
    }

    .scorecard-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .player-info {
      background: linear-gradient(135deg, var(--bbb-light-green), rgba(255, 255, 255, 0.8));
      padding: 1.5rem;
      border-radius: 15px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .player-info:hover {
      border-color: var(--bbb-gold);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .player-name {
      font-family: var(--font-family-accent);
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--bbb-primary);
      margin-bottom: 0.5rem;
    }

    .player-stats {
      color: var(--bbb-text);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .card-actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--bbb-border);
    }

    /* No Scorecards Message */
    .no-scorecards {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 3px dashed var(--bbb-border);
      color: var(--bbb-text-muted);
      font-size: 1.1rem;
      margin: 2rem 0;
    }

    .no-scorecards::before {
      content: '‚õ≥';
      display: block;
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .header-logo {
        height: 40px;
      }

      .header-title {
        font-size: 1.2rem;
        margin-left: 0.5rem;
      }

      .header-content {
        flex-wrap: wrap;
      }

      .header-right {
        margin-top: 0.5rem;
      }

      .founded-badge-header {
        margin-left: 0.5rem;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }

      .main-content {
        padding: 0 1rem;
        padding-top: 140px; /* Extra space for mobile header that may wrap */
      }

      .page-hero {
        padding: 2rem 1rem 1.5rem 1rem;
        margin-bottom: 2rem;
      }

      .page-hero h1 {
        font-size: 2rem;
        line-height: 1.2;
      }

      .page-hero .subtitle {
        font-size: 1rem;
        padding: 0 1rem;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .btn {
        width: 100%;
        max-width: 280px;
        padding: 1rem;
        font-size: 1rem;
      }

      .scorecard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .scorecard-date {
        text-align: left;
      }

      .scorecard-details {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .player-info {
        padding: 1.25rem;
      }

      .card-actions {
        flex-direction: column;
        gap: 0.75rem;
      }

      .card-actions .btn {
        width: 100%;
        max-width: none;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .main-content {
        padding: 0 0.75rem;
        padding-top: 140px;
      }

      .page-hero {
        padding: 1.5rem 0.75rem 1rem 0.75rem;
      }

      .page-hero h1 {
        font-size: 1.75rem;
      }

      .page-hero .subtitle {
        font-size: 0.95rem;
      }

      .scorecard-card {
        padding: 1.5rem;
      }

      .player-info {
        padding: 1rem;
      }

      .btn {
        max-width: 260px;
        padding: 0.9rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <!-- Fixed Header with Logo -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html">
          <img src="birdie.png" alt="Birdie Bush Bandits Logo" class="header-logo">
        </a>
        <a href="index.html" class="header-title">Birdie Bush Bandits</a>
        <div class="founded-badge-header">
          üèåÔ∏è Founded August 2020
        </div>
      </div>
      <div class="header-right">
        <!-- Auth controls will be added here by JavaScript -->
        <a href="index.html" class="home-btn" id="home-link">Home</a>
      </div>
    </div>
  </header>
  
  <main id="main">
    <div class="main-content">
      <!-- Page Hero Section -->
      <section class="page-hero">
        <div class="page-hero-content">
          <h1>Saved Scorecards <span class="golf-ball"></span></h1>
          <p class="subtitle">View and manage your golf scorecards</p>
        </div>
      </section>

      <!-- Status Message Container -->
      <div id="status-message"></div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="scorecards.html" class="btn">Create New Scorecard</a>
        <button id="export-all-btn" class="btn">Export All Scorecards</button>
      </div>

      <!-- Info Message -->
      <div class="message">
        Scorecards are automatically saved when you complete and save them in the <a href="scorecards.html">Scorecard Builder</a>.
      </div>

      <!-- Scorecards Container -->
      <div id="scorecards-container">
        <div class="no-scorecards">Loading scorecards...</div>
      </div>
    </div>
  </main>

  <!-- Authentication Integration Script -->
  <script>
    // Enhanced Authentication Integration for Saved Scores Page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing saved scores page with authentication...');
      
      // Check if BBB modules are loaded
      if (typeof BBB_CONFIG === 'undefined' || 
          typeof BBB_AUTH === 'undefined' || 
          typeof BBB_DB === 'undefined' || 
          typeof BBB_UI === 'undefined' || 
          typeof BBB_UTILS === 'undefined') {
        console.error('Required BBB modules not found!');
        showError('System modules not loaded. Please refresh the page.');
        return;
      }
      
      // Initialize modules
      try {
        BBB_AUTH.init({
          cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
        });
        
        BBB_DB.init({
          useCloudflare: BBB_CONFIG.cloudflareEnabled,
          localStoragePrefix: 'bbb_'
        });
        
        console.log('Modules initialized successfully');
      } catch (error) {
        console.error('Error initializing modules:', error);
        showError('Error initializing system modules.');
        return;
      }
      
      // Check authentication and render page accordingly
      checkPageAuthentication();
      
      // Initialize page functionality
      initializePageFunctionality();
    });

    /**
     * Main authentication check for saved scores page
     */
    function checkPageAuthentication() {
      console.log('Checking page authentication...');
      
      // Try to restore session from localStorage
      const hasStoredAuth = restoreAuthSession();
      
      if (hasStoredAuth) {
        console.log('Restored authentication from storage');
        initializeAuthenticatedPage();
      } else {
        console.log('No stored authentication, checking current auth state...');
        
        // Check if already authenticated in current session
        if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
          console.log('User already authenticated in current session');
          initializeAuthenticatedPage();
        } else {
          console.log('User not authenticated, redirecting to login...');
          // Save the current URL to redirect back after login
          sessionStorage.setItem('redirectAfterLogin', window.location.href);
          window.location.href = 'login.html';
        }
      }
    }

    /**
     * Restore authentication session from localStorage
     */
    function restoreAuthSession() {
      try {
        const storedAuth = localStorage.getItem('bbb_auth_session');
        const storedUser = localStorage.getItem('bbb_current_user');
        
        if (storedAuth && storedUser) {
          console.log('Found stored authentication data');
          
          const authData = JSON.parse(storedAuth);
          const userData = JSON.parse(storedUser);
          
          // Check if session is still valid
          if (authData.expiresAt && new Date(authData.expiresAt) > new Date()) {
            console.log('Restoring valid session for user:', userData.id);
            
            // Restore authentication state
            BBB_AUTH.currentUser = userData;
            BBB_AUTH.isAuthenticated = true;
            
            return true;
          } else {
            console.log('Session expired, clearing stored data');
            clearAuthSession();
            return false;
          }
        }
        
        return false;
      } catch (error) {
        console.error('Error restoring auth session:', error);
        clearAuthSession();
        return false;
      }
    }

    /**
     * Clear authentication session
     */
    function clearAuthSession() {
      localStorage.removeItem('bbb_auth_session');
      localStorage.removeItem('bbb_current_user');
      BBB_AUTH.currentUser = null;
      BBB_AUTH.isAuthenticated = false;
    }

    /**
     * Initialize page for authenticated users
     */
    function initializeAuthenticatedPage() {
      console.log('Initializing authenticated page for user:', BBB_AUTH.currentUser?.id);
      
      // Start session monitoring
      startSessionMonitoring();
      
      // Add logout functionality to header
      addLogoutFunctionality();
      
      // Show user info
      showUserInfo();
      
      // Load scorecards
      loadScorecards();
    }

    /**
     * Add logout functionality to header
     */
    function addLogoutFunctionality() {
      const headerRight = document.querySelector('.header-right');
      if (headerRight && BBB_AUTH.isAuthenticated) {
        // Check if logout button already exists
        if (headerRight.querySelector('.logout-btn')) return;
        
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'logout-btn';
        logoutBtn.textContent = 'Logout';
        
        logoutBtn.onclick = function() {
          if (confirm('Are you sure you want to logout?')) {
            performLogout();
          }
        };
        
        headerRight.appendChild(logoutBtn);
      }
    }

    /**
     * Show user info
     */
    function showUserInfo() {
      if (BBB_AUTH.isAuthenticated && BBB_AUTH.currentUser) {
        const headerRight = document.querySelector('.header-right');
        if (headerRight) {
          // Check if user info already exists
          if (headerRight.querySelector('.user-info')) return;
          
          const userInfo = document.createElement('span');
          userInfo.className = 'user-info';
          userInfo.textContent = `Welcome, ${BBB_AUTH.currentUser.id}`;
          
          // Insert before logout button
          const logoutBtn = headerRight.querySelector('.logout-btn');
          if (logoutBtn) {
            headerRight.insertBefore(userInfo, logoutBtn);
          } else {
            headerRight.appendChild(userInfo);
          }
        }
      }
    }

    /**
     * Perform logout
     */
    function performLogout() {
      console.log('Logging out user...');
      
      // Clear authentication state
      clearAuthSession();
      
      // Redirect to login page
      window.location.href = 'login.html';
    }

    /**
     * Start session monitoring
     */
    function startSessionMonitoring() {
      // Check session every 5 minutes
      const sessionCheck = setInterval(() => {
        const storedAuth = localStorage.getItem('bbb_auth_session');
        
        if (storedAuth) {
          try {
            const authData = JSON.parse(storedAuth);
            
            if (authData.expiresAt && new Date(authData.expiresAt) <= new Date()) {
              console.log('Session expired, logging out...');
              clearInterval(sessionCheck);
              performLogout();
            }
          } catch (error) {
            console.error('Error checking session:', error);
            clearInterval(sessionCheck);
            performLogout();
          }
        } else if (BBB_AUTH.isAuthenticated) {
          // Session was cleared externally
          console.log('Session cleared externally, logging out...');
          clearInterval(sessionCheck);
          performLogout();
        }
      }, 5 * 60 * 1000); // 5 minutes
      
      // Store interval ID for cleanup if needed
      window.bbbSessionMonitor = sessionCheck;
    }

    /**
     * Initialize page functionality
     */
    function initializePageFunctionality() {
      // Export all button functionality
      const exportAllBtn = document.getElementById('export-all-btn');
      if (exportAllBtn) {
        exportAllBtn.addEventListener('click', exportAllScorecards);
      }
    }

    /**
     * Show error message
     */
    function showError(message) {
      const container = document.getElementById('scorecards-container');
      if (container) {
        container.innerHTML = `<div class="no-scorecards">‚ùå ${message}</div>`;
      }
    }

    /**
     * Load saved scorecards
     */
    function loadScorecards() {
      // Check for scorecards to migrate first
      checkForScorecardsToMigrate()
        .then(migrated => {
          if (migrated) {
            showMessage('Successfully migrated existing scorecards', 'success');
          }
          
          // Load scorecards from database
          return BBB_DB.getScorecards();
        })
        .then(scorecards => {
          // Convert object to array
          const scorecardsArray = Object.values(scorecards);
          
          if (scorecardsArray.length === 0) {
            document.getElementById('scorecards-container').innerHTML = '<div class="no-scorecards">No saved scorecards yet. Create your first scorecard!</div>';
            return;
          }
          
          // Sort by date, newest first
          scorecardsArray.sort((a, b) => {
            const dateA = new Date(a.date || a.createdAt || 0);
            const dateB = new Date(b.date || b.createdAt || 0);
            return dateB - dateA;
          });
          
          // Create scorecard list
          const list = document.createElement('div');
          list.className = 'scorecard-list';
          
          // Create cards for each scorecard
          scorecardsArray.forEach((scorecard, index) => {
            list.appendChild(createScorecardCard(scorecard, index));
          });
          
          // Update container
          const container = document.getElementById('scorecards-container');
          container.innerHTML = '';
          container.appendChild(list);
        })
        .catch(err => {
          console.error('Error loading scorecards:', err);
          showMessage('Error loading scorecards', 'error');
          document.getElementById('scorecards-container').innerHTML = '<div class="no-scorecards">‚ùå Error loading scorecards</div>';
        });
    }

    /**
     * Create a card for a scorecard
     */
    function createScorecardCard(scorecard, index) {
      const card = document.createElement('div');
      card.className = 'scorecard-card';
      
      // Format date
      const dateObj = new Date(scorecard.date || scorecard.createdAt || 0);
      const formattedDate = BBB_UTILS.formatDate(dateObj, 'short');
      
      // Header
      const header = document.createElement('div');
      header.className = 'scorecard-header';
      
      const title = document.createElement('div');
      title.className = 'scorecard-title';
      
      // Get proper tee name
      const teeName = BBB_CONFIG.teeColors[scorecard.tee] || scorecard.tee;
      title.textContent = `${scorecard.course} - ${teeName} Tees`;
      
      const dateEl = document.createElement('div');
      dateEl.className = 'scorecard-date';
      
      // Format holes display
      let holesText = 'Full 18';
      if (scorecard.holes === '9f') holesText = 'Front 9';
      if (scorecard.holes === '9b') holesText = 'Back 9';
      
      dateEl.textContent = `${formattedDate} (${holesText})`;
      
      header.appendChild(title);
      header.appendChild(dateEl);
      card.appendChild(header);
      
      // Player details
      const details = document.createElement('div');
      details.className = 'scorecard-details';
      
      // Check if scorecard has players
      if (scorecard.players && scorecard.players.length > 0) {
        scorecard.players.forEach(player => {
          const playerInfo = document.createElement('div');
          playerInfo.className = 'player-info';
          
          const name = document.createElement('div');
          name.className = 'player-name';
          name.textContent = player.name;
          
          const stats = document.createElement('div');
          stats.className = 'player-stats';
          
          // Calculate points if not already included
          const points = player.totalPoints !== undefined 
            ? player.totalPoints 
            : calculateTotalPoints(player, scorecard);
          
          stats.innerHTML = `
            Handicap: ${player.handicap} (CH: ${player.courseHandicap || '-'})<br>
            Strokes: ${player.totalShots || '-'}<br>
            Points: ${points || '-'}
          `;
          
          playerInfo.appendChild(name);
          playerInfo.appendChild(stats);
          details.appendChild(playerInfo);
        });
      } else {
        const noPlayers = document.createElement('div');
        noPlayers.className = 'player-info';
        noPlayers.innerHTML = '<div class="player-name">No player data available</div>';
        details.appendChild(noPlayers);
      }
      
      card.appendChild(details);
      
      // Add actions
      const actions = document.createElement('div');
      actions.className = 'card-actions';
      
      // Download image button
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-sm';
      downloadBtn.innerHTML = 'üì∏ Save as Image';
      downloadBtn.addEventListener('click', () => {
        downloadScorecardImage(scorecard);
      });
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this scorecard?')) {
          deleteScorecard(scorecard.id || `scorecard_${index}`);
        }
      });
      
      actions.appendChild(downloadBtn);
      actions.appendChild(deleteBtn);
      card.appendChild(actions);
      
      return card;
    }

    /**
     * Delete a scorecard
     */
    function deleteScorecard(id) {
      BBB_DB.deleteScorecard(id)
        .then(() => {
          showMessage('Scorecard deleted successfully', 'success');
          loadScorecards();
        })
        .catch(err => {
          console.error('Error deleting scorecard:', err);
          showMessage('Error deleting scorecard', 'error');
        });
    }

    /**
     * Download scorecard as image
     */
    function downloadScorecardImage(scorecard) {
      // Create a scorecard table for image capture
      const container = document.createElement('div');
      container.style.padding = '20px';
      container.style.background = 'white';
      container.style.position = 'fixed';
      container.style.left = '-9999px';
      container.style.top = '0';
      container.style.fontFamily = 'Inter, sans-serif';
      
      // Create title
      const title = document.createElement('h3');
      title.textContent = `${scorecard.course} - ${BBB_CONFIG.teeColors[scorecard.tee] || scorecard.tee} Tees`;
      title.style.textAlign = 'center';
      title.style.marginBottom = '10px';
      title.style.fontFamily = 'Montserrat, serif';
      title.style.color = '#004d00';
      container.appendChild(title);
      
      // Create date subtitle
      const subtitle = document.createElement('div');
      subtitle.textContent = `${BBB_UTILS.formatDate(new Date(scorecard.date || scorecard.createdAt), 'medium')}`;
      subtitle.style.textAlign = 'center';
      subtitle.style.marginBottom = '20px';
      subtitle.style.fontStyle = 'italic';
      subtitle.style.color = '#6c757d';
      container.appendChild(subtitle);
      
      // Create table
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.marginBottom = '20px';
      table.style.fontFamily = 'Inter, sans-serif';
      
      // Create header row with hole numbers
      const headerRow = document.createElement('tr');
      headerRow.appendChild(createCell('th', 'Player'));
      
      // Determine which holes to show based on scorecard.holes
      let holeIndexes = [...Array(18).keys()].map(i => i + 1); // 1-18
      
      if (scorecard.holes === '9f') {
        holeIndexes = holeIndexes.slice(0, 9); // 1-9
      } else if (scorecard.holes === '9b') {
        holeIndexes = holeIndexes.slice(9); // 10-18
      }
      
      // Add hole numbers
      holeIndexes.forEach(holeNum => {
        headerRow.appendChild(createCell('th', holeNum.toString()));
      });
      
      // Add total column
      headerRow.appendChild(createCell('th', 'Total'));
      table.appendChild(headerRow);
      
      // Add player rows
      if (scorecard.players && scorecard.players.length > 0) {
        scorecard.players.forEach(player => {
          // Create player row for strokes
          const strokesRow = document.createElement('tr');
          strokesRow.appendChild(createCell('td', `${player.name} (Strokes)`));
          
          // Add scores
          let totalStrokes = 0;
          if (player.scores && player.scores.length > 0) {
            player.scores.forEach(score => {
              strokesRow.appendChild(createCell('td', score.toString()));
              totalStrokes += score;
            });
          } else {
            holeIndexes.forEach(() => {
              strokesRow.appendChild(createCell('td', '-'));
            });
          }
          
          // Add total
          strokesRow.appendChild(createCell('td', totalStrokes > 0 ? totalStrokes.toString() : '-'));
          table.appendChild(strokesRow);
          
          // Create player row for points if available
          if (player.points && player.points.length > 0) {
            const pointsRow = document.createElement('tr');
            pointsRow.appendChild(createCell('td', `${player.name} (Points)`));
            
            // Add points
            let totalPoints = 0;
            player.points.forEach(points => {
              pointsRow.appendChild(createCell('td', points.toString()));
              totalPoints += points;
            });
            
            // Add total
            pointsRow.appendChild(createCell('td', totalPoints.toString()));
            table.appendChild(pointsRow);
          }
        });
      } else {
        const noDataRow = document.createElement('tr');
        noDataRow.appendChild(createCell('td', 'No player data available'));
        const emptyCell = createCell('td', '');
        emptyCell.colSpan = holeIndexes.length + 1;
        noDataRow.appendChild(emptyCell);
        table.appendChild(noDataRow);
      }
      
      container.appendChild(table);
      
      // Add BBB footer
      const footer = document.createElement('div');
      footer.textContent = 'Birdie Bush Bandits - Founded August 2020';
      footer.style.textAlign = 'center';
      footer.style.fontStyle = 'italic';
      footer.style.fontSize = '12px';
      footer.style.marginTop = '20px';
      footer.style.color = '#6c757d';
      container.appendChild(footer);
      
      // Add to document temporarily
      document.body.appendChild(container);
      
      // Use html2canvas if available, otherwise show error
      if (typeof html2canvas === 'function') {
        // Create loading message
        showMessage('Generating scorecard image...', 'info');
        
        // Capture the scorecard
        html2canvas(container, { scale: 2 })
          .then(canvas => {
            // Create download link
            const link = document.createElement('a');
            link.download = `scorecard_${scorecard.course}_${BBB_UTILS.formatDate(new Date(scorecard.date || scorecard.createdAt), 'short').replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // Clean up
            document.body.removeChild(container);
            
            showMessage('Scorecard image downloaded', 'success');
          })
          .catch(err => {
            console.error('Error generating image:', err);
            showMessage('Error generating scorecard image', 'error');
            
            // Clean up
            document.body.removeChild(container);
          });
      } else {
        // html2canvas not available
        document.body.removeChild(container);
        showMessage('html2canvas library not found, cannot generate image', 'error');
      }
    }

    /**
     * Helper function to create a table cell
     */
    function createCell(type, content, colspan) {
      const cell = document.createElement(type);
      cell.textContent = content;
      cell.style.border = '1px solid #dee2e6';
      cell.style.padding = '8px';
      cell.style.textAlign = 'center';
      cell.style.backgroundColor = type === 'th' ? '#f8f9fa' : 'white';
      cell.style.fontWeight = type === 'th' ? 'bold' : 'normal';
      
      if (colspan) {
        cell.colSpan = colspan;
      }
      
      return cell;
    }

    /**
     * Export all scorecards as JSON file
     */
    function exportAllScorecards() {
      BBB_DB.getScorecards()
        .then(scorecards => {
          // Convert object to array
          const scorecardsArray = Object.values(scorecards);
          
          if (scorecardsArray.length === 0) {
            showMessage('No scorecards to export', 'warning');
            return;
          }
          
          // Create export data
          const exportData = {
            exportDate: new Date().toISOString(),
            exportVersion: '1.0',
            scorecards: scorecardsArray
          };
          
          // Convert to JSON
          const jsonData = JSON.stringify(exportData, null, 2);
          
          // Create download link
          const blob = new Blob([jsonData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `birdie-bush-bandits-scorecards-${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          // Clean up
          URL.revokeObjectURL(url);
          
          showMessage(`Exported ${scorecardsArray.length} scorecards`, 'success');
        })
        .catch(err => {
          console.error('Error exporting scorecards:', err);
          showMessage('Error exporting scorecards', 'error');
        });
    }

    /**
     * Calculate total points for a player
     */
    function calculateTotalPoints(player, scorecard) {
      // If points are included, sum them
      if (player.points && player.points.length > 0) {
        return player.points.reduce((sum, points) => sum + points, 0);
      }
      
      // If no scores, return 0
      if (!player.scores || player.scores.length === 0) {
        return 0;
      }
      
      // Otherwise, return N/A as we don't have all the data needed for calculation
      return 'N/A';
    }

    /**
     * Check for scorecards to migrate from the original format
     */
    function checkForScorecardsToMigrate() {
      return new Promise((resolve, reject) => {
        try {
          // Check if we've already migrated
          if (localStorage.getItem('bbb_scorecards_migrated') === 'true') {
            resolve(false);
            return;
          }
          
          // Check for scorecards in original format
          const oldScorecards = JSON.parse(localStorage.getItem('golfScorecards') || '[]');
          
          if (oldScorecards.length === 0) {
            // No scorecards to migrate
            localStorage.setItem('bbb_scorecards_migrated', 'true');
            resolve(false);
            return;
          }
          
          // Show migration message
          showMessage(`Migrating ${oldScorecards.length} scorecards...`, 'info');
          
          // Convert and save each scorecard
          let migrationCount = 0;
          const migrationPromises = [];
          
          oldScorecards.forEach((oldCard, index) => {
            // Generate ID if needed
            const id = `migrated_${Date.now()}_${index}`;
            
            // Convert to new format
            const newScorecard = {
              id,
              date: oldCard.date || new Date().toISOString(),
              course: oldCard.course,
              tee: oldCard.tee,
              holes: oldCard.holes,
              players: oldCard.players || [],
              createdAt: oldCard.savedAt || new Date().toISOString(),
              migrated: true
            };
            
            // Save to database
            migrationPromises.push(
              BBB_DB.saveScorecard(newScorecard)
                .then(() => {
                  migrationCount++;
                })
                .catch(err => {
                  console.error('Error migrating scorecard:', err);
                })
            );
          });
          
          // Wait for all migrations to complete
          Promise.all(migrationPromises)
            .then(() => {
              // Mark as migrated
              localStorage.setItem('bbb_scorecards_migrated', 'true');
              
              resolve(true);
            })
            .catch(err => {
              console.error('Error during scorecard migration:', err);
              reject(err);
            });
        } catch (err) {
          console.error('Error checking for scorecard migration:', err);
          reject(err);
        }
      });
    }

    /**
     * Show status message
     */
    function showMessage(message, type = 'info') {
      if (typeof BBB_UTILS !== 'undefined' && BBB_UTILS.showMessage) {
        BBB_UTILS.showMessage(message, type);
      } else {
        // Fallback message display
        const statusEl = document.getElementById('status-message');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.className = type;
          statusEl.style.display = 'block';
          
          // Hide after 5 seconds
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 5000);
        }
      }
    }

    // Handle browser back/forward with session check
    window.addEventListener('pageshow', function(e) {
      if (e.persisted) {
        // Page was loaded from cache, recheck auth
        checkPageAuthentication();
      }
    });
  </script>

  <!-- Load html2canvas for image generation (optional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
