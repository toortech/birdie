<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stableford Scorecard ‚Äì Multiple Courses</title>
  <style>
    .invalid-hcp, .missing { border: 2px solid red; background-color: #ffcccc; }
    body { background: #f5f5f5; color: #000; font-family: sans-serif; padding: 1rem; margin: 0 auto; max-width: 1200px; }
    h1 { color: #003300; font-size: 2rem; text-align: center; margin-bottom: 1rem; }
    nav { text-align: right; margin-bottom: 0.5rem; }
    .home-link { color: #000; font-weight: bold; text-decoration: none; }
    details#setup-controls { margin-bottom: 1rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; }
    .controls > div { background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 6px; flex: 1 1 200px; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    .controls-summary { cursor: pointer; font-weight: bold; font-size: 1.1em; }
    #table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; max-width: 100vw; margin-top: 1rem; }
    #table-container::after { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 20px; background: linear-gradient(to right, transparent, rgba(0,0,0,0.2)); pointer-events: none; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; table-layout: auto; }
    th, td { border: 1px solid #fff; padding: 0.5rem; text-align: center; white-space: nowrap; }
    th { background: rgba(255,255,255,0.2); }
    input[type="number"] { width: 3rem; }
    select, button { padding: 0.5rem 1rem; cursor: pointer; }
    button { background: #004c99; color: white; border: none; border-radius: 4px; }
    button:hover { background: #003d7a; }
    button:active { opacity: 0.8; transform: scale(0.98); }
    #button-group { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .stroke-info { font-size: 0.75em; color: #ccc; margin-top: 0.25rem; }
    @media (max-width: 768px) {
      .controls { flex-direction: column; }
      .controls > div { flex: 1 1 auto; }
      #button-group { flex-direction: column; }
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem; }
      input[type="number"] { width: 2rem; font-size: 0.75rem; }
      select, button { width: 100%; font-size: 0.8rem; }
      .stroke-info { font-size: 0.6em; }
    }
    @media (max-width: 480px) {
      body { padding: 0.5rem; }
      h1 { font-size: 1.5rem; }
      details#setup-controls summary { display: none; }
      .controls { display: flex; flex-direction: column; gap: 0.5rem; }
      .controls > div { flex: 1 1 100%; }
      #button-group { flex-direction: column; }
      select, button { width: 100%; }
      table { min-width: auto; table-layout: fixed; }
      th, td { white-space: normal; word-wrap: break-word; }
      #table-container::after { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <nav><a href="index.html" class="home-link">üè† Home</a></nav>
  </header>
  <main>
    <h1>Stableford Scorecard ‚Äì Multiple Courses</h1>
    <details id="setup-controls" open>
      <summary class="controls-summary">‚öôÔ∏è Setup Options</summary>
      <div class="controls">
        <div><label for="course-select">Course:</label><select id="course-select"><option value="Ritchings">Richings Park</option><option value="Thorney">Thorney Park</option></select></div>
        <div><label for="tee-select">Tee Colour:</label><select id="tee-select"><option value="white">White</option><option value="yellow">Yellow</option><option value="red">Red</option></select></div>
        <div id="player-checkboxes">
          <label>Players (max 4):</label>
          <label><input type="checkbox" name="player" value="Amrit"> Amrit</label>
          <label><input type="checkbox" name="player" value="Kam"> Kam</label>
          <label><input type="checkbox" name="player" value="Vish"> Vish</label>
          <label><input type="checkbox" name="player" value="Ravi"> Ravi</label>
          <label><input type="checkbox" name="player" value="Bal"> Bal</label>
          <label><input type="checkbox" name="player" value="Vick"> Vick</label>
          <label><input type="checkbox" name="player" value="Michael"> Michael</label>
          <label><input type="checkbox" name="player" value="Justy"> Justy</label>
          <label><input type="checkbox" name="player" value="Phuperjee"> Phuperjee</label>
          <label><input type="checkbox" name="player" value="Indy"> Indy</label>
          <label><input type="checkbox" name="player" value="Maj"> Maj</label>
          <label><input type="checkbox" name="player" value="Sama"> Sama</label>
        </div>
        <div><label>Holes:</label><label><input type="radio" name="holes" value="18" checked> Full 18</label><label><input type="radio" name="holes" value="9f"> Front 9</label><label><input type="radio" name="holes" value="9b"> Back 9</label></div>
      </div>
    </details>
    <div id="button-group">
      <button id="build">Build Scorecard</button>
      <button id="reset">Reset</button>
      <button id="save" disabled>Save Scorecard</button>
      <button id="download-image">üì∏ Save Scorecard as Image</button>
      <a href="view-saved-scores.html" id="view-saved-link" class="home-link">üìÑ View Past Scorecards</a>
    </div>
    <div id="created-time" aria-live="polite"></div>
    <div id="table-container"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    (function() {
      'use strict';
      const buildBtn = document.getElementById('build');
      const saveBtn = document.getElementById('save');
      const resetBtn = document.getElementById('reset');
      const downloadBtn = document.getElementById('download-image');
      const tableContainer = document.getElementById('table-container');
      const createdTime = document.getElementById('created-time');
      const courseSelect = document.getElementById('course-select');
      const teeSelect = document.getElementById('tee-select');
      const holeRadios = document.querySelectorAll('input[name="holes"]');
      const playerCheckboxes = document.querySelectorAll('input[name="player"]');
      let scorecardBuilt = false;
      let savedSuccessfully = false;

      function debounce(fn, delay = 200) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      const courses = {
        Ritchings: {
          par: [4,3,5,4,4,3,4,4,4,3,4,4,4,3,4,4,5,4],
          si:  [12,8,6,18,10,16,2,14,4,15,3,17,7,11,1,5,13,9],
          yards: {
            white: [365,140,495,350,370,160,385,375,360,155,380,370,395,145,400,360,510,375],
            yellow:[350,130,480,340,355,150,370,360,345,145,365,355,380,135,385,345,495,360],
            red:   [330,120,460,320,335,140,350,340,325,135,345,335,360,125,365,325,470,340]
          }
        },
        Thorney: {
          par: [5,4,4,3,5,4,4,3,5,4,4,3,5,4,4,3,5,4],
          si:  [9,15,1,17,5,13,3,11,7,16,2,14,6,18,4,12,8,10],
          yards: {
            white: [475,360,410,155,495,345,375,160,500,350,370,150,480,355,385,145,505,365],
            yellow:[460,345,395,145,480,330,360,150,485,335,355,140,465,340,370,135,490,350],
            red:   [440,320,370,130,450,305,335,135,455,310,330,125,435,315,345,120,460,325]
          }
        }
      };
      const teeSlope = { white:128, yellow:121, red:115 };

      buildBtn.addEventListener('click', () => {
        const players = [...playerCheckboxes].filter(cb => cb.checked).map(cb => cb.value);
        if (!players.length) return alert('‚ö†Ô∏è Please select at least one player.');
        if (players.length > 4) return alert('‚ö†Ô∏è Please select no more than 4 players.');
        if (scorecardBuilt) {
          let valid = true;
          players.forEach((_, i) => {
            const h = document.getElementById(`hcp-${i}`);
            if (!h || h.value === '' || isNaN(h.value) || parseInt(h.value,10) < 0) {
              h.classList.add('invalid-hcp'); valid = false;
            } else h.classList.remove('invalid-hcp');
          });
          if (!valid) return alert('‚ö†Ô∏è Enter valid HCP (0+).');
          if (!confirm('Rebuilding will erase all scores. Continue?')) return;
        }
        build(players);
        document.getElementById('setup-controls').open = false;
        scorecardBuilt = true;
        saveBtn.disabled = false;
      });

      resetBtn.addEventListener('click', () => {
        if (!confirm('‚ö†Ô∏è Reset scorecard? All data lost.')) return;
        scorecardBuilt = false;
        savedSuccessfully = false;
        tableContainer.innerHTML = '';
        createdTime.textContent = '';
        saveBtn.disabled = true;
      });

      saveBtn.addEventListener('click', () => {
        const inputs = tableContainer.querySelectorAll('tbody input[type="number"]');
        let allFilled = true;
        inputs.forEach(inp => {
          if (inp.value === '' || isNaN(parseInt(inp.value,10))) { inp.classList.add('missing'); allFilled = false; }
          else inp.classList.remove('missing');
        });
        if (!allFilled) return alert('‚ö†Ô∏è Enter all scores before saving.');
        savedSuccessfully = true;
        alert('‚úÖ Scorecard saved successfully.');
      });

      downloadBtn.addEventListener('click', () => {
        const node = tableContainer.firstElementChild;
        if (!node) return alert('‚ö†Ô∏è No scorecard to capture.');
        const origStyle = node.getAttribute('style')||'';
        node.style.backgroundColor = 'white'; node.style.color = 'black';
        node.querySelectorAll('th, td').forEach(c => { c.style.color = 'black'; c.style.backgroundColor = 'white'; c.style.borderColor = '#000'; });
        const h2c = typeof html2canvas==='function'?html2canvas:(html2canvas&&html2canvas.default?html2canvas.default:null);
        if (!h2c) { alert('‚ö†Ô∏è html2canvas library not found.'); node.setAttribute('style',origStyle); node.querySelectorAll('th, td').forEach(c=>c.removeAttribute('style')); return; }
        h2c(node,{scale:2}).then(canvas=>{const link=document.createElement('a'); link.download=`scorecard_${new Date().toISOString().split('T')[0]}.png`; link.href=canvas.toDataURL(); link.click();}).catch(err=>{console.error(err); alert('‚ö†Ô∏è Error capturing image: '+err.message);}).finally(()=>{node.setAttribute('style',origStyle); node.querySelectorAll('th, td').forEach(c=>c.removeAttribute('style'));});
      });

      function build(players) {
        const courseKey=courseSelect.value, tee=teeSelect.value;
        const {par,si,yards}=courses[courseKey], slope=teeSlope[tee];
        const holeVal=[...holeRadios].find(r=>r.checked).value;
        let idx=[...Array(18).keys()]; if(holeVal==='9f') idx=idx.slice(0,9); if(holeVal==='9b') idx=idx.slice(9);
        createdTime.textContent=`Scorecard created: ${new Date().toLocaleString('en-GB',{dateStyle:'short',timeStyle:'short'})}`;
        tableContainer.innerHTML='';
        const table=document.createElement('table');
        const thead=document.createElement('thead');
        let hdr1='<tr><th>Hole</th><th>Par</th><th style="color:red;">SI</th><th>Yards</th>';
        players.forEach((p,i)=>hdr1+=`<th colspan="2">${p}<br>HCP:<input id="hcp-${i}" type="number" value="0" min="0" max="36"></th>`);
        hdr1+='</tr>';
        let hdr2='<tr><th></th><th></th><th></th><th></th>';
        players.forEach(()=>hdr2+='<th>Shots</th><th>STB Score</th>'); hdr2+='</tr>';
        thead.innerHTML=hdr1+hdr2; table.appendChild(thead);
        const tbody=document.createElement('tbody');
        idx.forEach(h=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${h+1}</td><td>${par[h]}</td><td style="color:red;">${si[h]}</td><td>${yards[tee][h]}</td>`;
          players.forEach((_,pi)=>tr.innerHTML+=`<td><input data-player="${pi}" data-hole="${h}" type="number" min="0"></td><td class="pts-${pi}"><div class="points"></div><div class="stroke-info" data-player="${pi}" data-hole="${h}"></div></td>`);
          tbody.appendChild(tr);
        }); table.appendChild(tbody);
        const tfoot=document.createElement('tfoot');
        ['Front 9','Back 9','Overall'].forEach((lbl,ri)=>{let row=`<tr><td colspan="4">${lbl} Total</td>`;
          players.forEach((_,pi)=>row+=`<td id="str-${ri}-${pi}" style="font-weight:bold;"></td><td id="pts-${ri}-${pi}" style="font-weight:bold;"></td>`);
          row+='</tr>'; tfoot.innerHTML+=row;
        }); table.appendChild(tfoot); tableContainer.appendChild(table);
        players.forEach((_,i)=>{const hIn=document.getElementById(`hcp-${i}`); const adj=document.createElement('span'); adj.id=`adjhcp-${i}`; adj.style.marginLeft='0.5rem'; hIn.insertAdjacentElement('afterend',adj);
          const upd=()=>{const raw=parseInt(hIn.value,10)||0; const a=Math.round(raw*slope/113); adj.textContent=`Adj HCP: ${a}`;
            idx.forEach(h=>{const el=document.querySelector(`.stroke-info[data-player="${i}"][data-hole="${h}"]`); if(el){const strokes=a>=si[h]+18?2:a>=si[h]?1:0; el.textContent=`(${strokes})`; el.parentElement.style.backgroundColor=strokes>0?'rgba(255,165,0,0.6)':'';}});
          };
          hIn.addEventListener('input',()=>{upd(); debounce(()=>update(table,par,si,players,idx,slope))();}); upd();
        });
        tbody.querySelectorAll('input[type="number"]').forEach(inp=>inp.addEventListener('input',()=>{inp.classList.remove('missing'); debounce(()=>update(table,par,si,players,idx,slope))();}));
        update(table,par,si,players,idx,slope);
      }
      function update(table,par,si,players,idx,slope){ const tots=players.map(()=>({fS:0,fP:0,bS:0,bP:0,oS:0,oP:0}));
        table.querySelectorAll('tbody tr').forEach((tr,rIdx)=>{ const h=idx[rIdx]; const pr=par[h]; const sIdx=si[h]; const front=rIdx<9;
          players.forEach((_,pi)=>{const inp=tr.querySelector(`input[data-player="${pi}"][data-hole="${h}"]`); const sc=parseInt(inp.value,10); if(isNaN(sc)) return;
            const raw=parseInt(document.getElementById(`hcp-${pi}`).value,10)||0; const a=Math.round(raw*slope/113); const strokes=a>=sIdx+18?2:a>=sIdx?1:0;
            const net=sc-strokes; const pts=net<=pr-2?4:net===pr-1?3:net===pr?2:net===pr+1?1:0;
            tr.querySelector(`.pts-${pi} .points`).textContent=pts; tr.querySelector(`.pts-${pi} .stroke-info`).textContent=`(${strokes})`;
            tots[pi].oS+=sc; tots[pi].oP+=pts; if(front){tots[pi].fS+=sc; tots[pi].fP+=pts;}else{tots[pi].bS+=sc; tots[pi].bP+=pts;}});
        });
        tots.forEach((t,pi)=>{['f','b','o'].forEach((l,i)=>{document.getElementById(`str-${i}-${pi}`).textContent=i===0?t.fS:i===1?t.bS:t.oS;document.getElementById(`pts-${i}-${pi}`).textContent=i===0?t.fP:i===1?t.bP:t.oP;});});
      }
    })();
  </script>
</body>
</html>
