<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits – Scorecard Builder</title>
  <meta name="description" content="Create and save golf scorecards for your rounds with the Birdie Bush Bandits golf group.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules (loaded in specific order) -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modules
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Create header
      const headerElements = BBB_UI.createHeader({
        fixed: true,
        showHomeLinkText: true
      });
      
      document.body.insertBefore(headerElements.header, document.body.firstChild);
      
      // Get main content element
      const main = document.getElementById('main');
      main.appendChild(headerElements.mainWrapper);
      
      // Create page content
      const mainContent = document.createElement('div');
      
      // Create page title
      const titleContainer = BBB_UI.createPageTitle({
        title: 'Birdie Bush Bandits',
        showFoundedText: true,
        showGolfballs: true
      });
      mainContent.appendChild(titleContainer);
      
      // Add page subtitle
      const subtitle = document.createElement('h2');
      subtitle.textContent = 'Scorecard Builder';
      mainContent.appendChild(subtitle);
      
      // Create status message container
      const statusMessage = BBB_UI.createStatusMessage();
      mainContent.appendChild(statusMessage);
      
      // Create scorecard builder
      const scorecardBuilder = createScorecardBuilder();
      mainContent.appendChild(scorecardBuilder);
      
      // Add content to main wrapper
      headerElements.mainWrapper.appendChild(mainContent);
      
      /**
       * Create the scorecard builder UI
       * @returns {HTMLElement} - Scorecard builder element
       */
      function createScorecardBuilder() {
        // Create container
        const container = document.createElement('div');
        
        // Create setup details section
        const setupDetails = document.createElement('details');
        setupDetails.id = 'setup-controls';
        setupDetails.open = true;
        
        const setupSummary = document.createElement('summary');
        setupSummary.innerHTML = '⚙️ Setup Options';
        setupDetails.appendChild(setupSummary);
        
        // Setup controls
        const controls = document.createElement('div');
        controls.className = 'controls';
        
        // Course selector
        const courseDiv = document.createElement('div');
        const courseLabel = document.createElement('label');
        courseLabel.setAttribute('for', 'course-select');
        courseLabel.textContent = 'Course:';
        
        const courseSelect = document.createElement('select');
        courseSelect.id = 'course-select';
        
        // Add course options from config
        Object.keys(BBB_CONFIG.courses).forEach(courseName => {
          const option = document.createElement('option');
          option.value = BBB_CONFIG.courses[courseName].shortName;
          option.textContent = courseName;
          courseSelect.appendChild(option);
        });
        
        courseDiv.appendChild(courseLabel);
        courseDiv.appendChild(courseSelect);
        controls.appendChild(courseDiv);
        
        // Tee color selector
        const teeDiv = document.createElement('div');
        const teeLabel = document.createElement('label');
        teeLabel.setAttribute('for', 'tee-select');
        teeLabel.textContent = 'Tee Colour:';
        
        const teeSelect = document.createElement('select');
        teeSelect.id = 'tee-select';
        
        // Add tee options from config
        Object.keys(BBB_CONFIG.teeColors).forEach(teeKey => {
          const option = document.createElement('option');
          option.value = teeKey;
          option.textContent = BBB_CONFIG.teeColors[teeKey];
          teeSelect.appendChild(option);
        });
        
        teeDiv.appendChild(teeLabel);
        teeDiv.appendChild(teeSelect);
        controls.appendChild(teeDiv);
        
        // Player selectors
        const playersDiv = document.createElement('div');
        playersDiv.id = 'player-selects';
        
        const playersLabel = document.createElement('label');
        playersLabel.textContent = 'Players:';
        playersDiv.appendChild(playersLabel);
        
        const playersGrid = document.createElement('div');
        playersGrid.style.display = 'grid';
        playersGrid.style.gap = '0.5rem';
        
        // Create player selects
        for (let i = 1; i <= 4; i++) {
          const playerDiv = document.createElement('div');
          
          const playerLabel = document.createElement('label');
          playerLabel.setAttribute('for', `player-${i}`);
          playerLabel.textContent = `Player ${i}:`;
          
          const playerSelect = document.createElement('select');
          playerSelect.id = `player-${i}`;
          playerSelect.className = 'player-select';
          
          // Empty option
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '-- Select Player --';
          playerSelect.appendChild(emptyOption);
          
          // Add members from config
          BBB_CONFIG.members.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            playerSelect.appendChild(option);
          });
          
          // Add event listener to prevent duplicate selection
          playerSelect.addEventListener('change', updatePlayerOptions);
          
          playerDiv.appendChild(playerLabel);
          playerDiv.appendChild(playerSelect);
          playersGrid.appendChild(playerDiv);
        }
        
        playersDiv.appendChild(playersGrid);
        controls.appendChild(playersDiv);
        
        // Holes selection
        const holesDiv = document.createElement('div');
        
        const holesLabel = document.createElement('label');
        holesLabel.textContent = 'Holes:';
        holesDiv.appendChild(holesLabel);
        
        // Create radio buttons for hole selection
        const holeOptions = [
          { value: '18', label: 'Full 18' },
          { value: '9f', label: 'Front 9' },
          { value: '9b', label: 'Back 9' }
        ];
        
        holeOptions.forEach((option, index) => {
          const radioLabel = document.createElement('label');
          radioLabel.className = 'checkbox';
          
          const radioInput = document.createElement('input');
          radioInput.type = 'radio';
          radioInput.name = 'holes';
          radioInput.value = option.value;
          if (index === 0) radioInput.checked = true;
          
          radioLabel.appendChild(radioInput);
          radioLabel.appendChild(document.createTextNode(' ' + option.label));
          holesDiv.appendChild(radioLabel);
          
          // Add a space between options
          if (index < holeOptions.length - 1) {
            holesDiv.appendChild(document.createTextNode(' '));
          }
        });
        
        controls.appendChild(holesDiv);
        setupDetails.appendChild(controls);
        container.appendChild(setupDetails);
        
        // Add button group
        const buttonGroup = document.createElement('div');
        buttonGroup.id = 'button-group';
        
        // Build scorecard button
        const buildButton = BBB_UI.createButton({
          id: 'build',
          text: 'Build Scorecard',
          onClick: buildScorecard
        });
        
        // Reset button
        const resetButton = BBB_UI.createButton({
          id: 'reset',
          text: 'Reset',
          onClick: resetScorecard
        });
        
        // Save button
        const saveButton = BBB_UI.createButton({
          id: 'save',
          text: 'Save Scorecard',
          onClick: saveScorecard,
          disabled: true
        });
        
        // Download image button
        const downloadButton = BBB_UI.createButton({
          id: 'download-image',
          text: '📸 Save Scorecard as Image',
          onClick: downloadScorecardImage
        });
        
        buttonGroup.appendChild(buildButton);
        buttonGroup.appendChild(resetButton);
        buttonGroup.appendChild(saveButton);
        buttonGroup.appendChild(downloadButton);
        container.appendChild(buttonGroup);
        
        // Table container for scorecard
        const tableContainer = document.createElement('div');
        tableContainer.id = 'table-container';
        container.appendChild(tableContainer);
        
        // State variables
        let scorecardBuilt = false;
        let savedSuccessfully = false;
        
        // Load html2canvas script for image export
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
        
        /**
         * Load external script
         * @param {string} src - Script URL
         */
        function loadScript(src) {
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          document.head.appendChild(script);
        }
        
        /**
         * Update player options to prevent duplicate selections
         */
        function updatePlayerOptions() {
          const selectedPlayers = [];
          document.querySelectorAll('.player-select').forEach(select => {
            if (select.value) selectedPlayers.push(select.value);
          });
          
          document.querySelectorAll('.player-select').forEach(select => {
            const currentValue = select.value;
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
              if (option.value && option.value !== currentValue && selectedPlayers.includes(option.value)) {
                option.disabled = true;
                option.style.color = '#999';
              } else {
                option.disabled = false;
                option.style.color = '#000';
              }
            });
          });
        }
        
        /**
         * Build scorecard table
         */
        function buildScorecard() {
          // Get selected players
          const players = [];
          document.querySelectorAll('.player-select').forEach(select => {
            if (select.value) players.push(select.value);
          });
          
          if (!players.length) {
            BBB_UTILS.showMessage('Please select at least one player.', 'error');
            return;
          }
          
          // Clear table container
          tableContainer.innerHTML = '';
          
          // Create table
          const table = document.createElement('table');
          
          // Create caption
          const caption = document.createElement('caption');
          caption.textContent = 'Scorecard created: ' + new Date().toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' }) + 
                               ' | Course: ' + courseSelect.options[courseSelect.selectedIndex].text + 
                               ' | Tees: ' + teeSelect.options[teeSelect.selectedIndex].text;
          table.appendChild(caption);
          
          // Create header
          const thead = document.createElement('thead');
          let headerRow1 = document.createElement('tr');
          headerRow1.innerHTML = '<th>Hole</th><th>Par</th><th style="color:red;">SI</th><th>Yards</th>';
          
          players.forEach((player, index) => {
            headerRow1.innerHTML += `<th colspan="2">${player}<br>H:<input id="hcp-${index}" type="number" min="0" max="99" value="0" oninput="if(this.value.length>2) this.value=this.value.slice(0,2)"></th>`;
          });
          
          let headerRow2 = document.createElement('tr');
          headerRow2.innerHTML = '<th></th><th></th><th></th><th></th>';
          
          players.forEach(() => {
            headerRow2.innerHTML += '<th>Shots</th><th>Pts</th>';
          });
          
          thead.appendChild(headerRow1);
          thead.appendChild(headerRow2);
          table.appendChild(thead);
          
          // Create body
          const tbody = document.createElement('tbody');
          const holeSelection = document.querySelector('input[name="holes"]:checked').value;
          const courseData = getCourseData(courseSelect.value);
          const teeColor = teeSelect.value;
          
          // Determine which holes to show
          let holes = Array.from({ length: 18 }, (_, i) => i);
          if (holeSelection === '9f') holes = holes.slice(0, 9);
          if (holeSelection === '9b') holes = holes.slice(9);
          
          // Create rows for each hole
          holes.forEach(holeIndex => {
            const row = document.createElement('tr');
            
            // Hole info
            row.innerHTML = `
              <td>${holeIndex + 1}</td>
              <td>${courseData.par[holeIndex]}</td>
              <td style="color:red;">${courseData.si[holeIndex]}</td>
              <td>${courseData.yards[teeColor][holeIndex]}</td>
            `;
            
            // Player inputs
            players.forEach((_, playerIndex) => {
              row.innerHTML += `
                <td>
                  <input data-player="${playerIndex}" data-hole="${holeIndex}" type="number" min="0" max="999" oninput="if(this.value.length>3) this.value=this.value.slice(0,3)">
                </td>
                <td class="pts-${playerIndex}">
                  <div class="stroke-info" data-player="${playerIndex}" data-hole="${holeIndex}"></div>
                  <div class="points"></div>
                </td>
              `;
            });
            
            tbody.appendChild(row);
          });
          
          table.appendChild(tbody);
          
          // Create footer for totals
          const tfoot = document.createElement('tfoot');
          ['Front 9', 'Back 9', 'Total'].forEach((label, i) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="4">${label}</td>`;
            
            players.forEach((_, playerIndex) => {
              row.innerHTML += `<td id="shots-${i}-${playerIndex}"></td><td id="pts-${i}-${playerIndex}"></td>`;
            });
            
            tfoot.appendChild(row);
          });
          
          table.appendChild(tfoot);
          tableContainer.appendChild(table);
          
          // Setup handicap and scoring functionality
          players.forEach((_, playerIndex) => {
            // Get handicap input
            const handicapInput = document.getElementById(`hcp-${playerIndex}`);
            
            // Create span for course handicap
            const adjustedHandicapSpan = document.createElement('span');
            adjustedHandicapSpan.id = `adjhcp-${playerIndex}`;
            adjustedHandicapSpan.style.marginLeft = '0.5rem';
            handicapInput.insertAdjacentElement('afterend', adjustedHandicapSpan);
            
            // Update course handicap and strokes received
            const updateHandicapInfo = () => {
              const rawHandicap = parseInt(handicapInput.value, 10) || 0;
              const slopeRating = getSlopeRating(courseSelect.value, teeColor);
              const courseHandicap = Math.round(rawHandicap * slopeRating / 113);
              
              // Update displayed course handicap
              adjustedHandicapSpan.textContent = 'CH: ' + courseHandicap;
              
              // Update strokes received for each hole
              holes.forEach(holeIndex => {
                const si = courseData.si[holeIndex];
                const strokesReceived = (courseHandicap >= si + 18) ? 2 : (courseHandicap >= si ? 1 : 0);
                
                const strokeInfo = document.querySelector(`.stroke-info[data-player="${playerIndex}"][data-hole="${holeIndex}"]`);
                if (strokeInfo) {
                  strokeInfo.textContent = `(${strokesReceived} stroke${strokesReceived !== 1 ? 's' : ''})`;
                }
              });
              
              // Update scores/points
              debounce(updateScores, 200)();
            };
            
            // Add input handler to handicap input
            handicapInput.addEventListener('input', () => {
              if (handicapInput.value === '' || isNaN(parseInt(handicapInput.value, 10)) || parseInt(handicapInput.value, 10) < 0) {
                handicapInput.classList.add('invalid-hcp');
              } else {
                handicapInput.classList.remove('invalid-hcp');
                updateHandicapInfo();
              }
            });
            
            // Initial update
            updateHandicapInfo();
          });
          
          // Add input handlers to all score inputs
          const scoreInputs = table.querySelectorAll('tbody input[type="number"]');
          scoreInputs.forEach(input => {
            input.addEventListener('input', () => {
              input.classList.remove('missing');
              debounce(updateScores, 200)();
            });
          });
          
          // Enable save button
          document.getElementById('save').disabled = false;
          
          // Close setup controls
          document.getElementById('setup-controls').open = false;
          
          // Update state
          scorecardBuilt = true;
          savedSuccessfully = false;
          
          // Show success message
          BBB_UTILS.showMessage('Scorecard built successfully!', 'success');
        }
        
        /**
         * Reset scorecard
         */
        function resetScorecard() {
          if (scorecardBuilt && !window.confirm('Reset scorecard? All data will be lost.')) {
            return;
          }
          
          // Clear table container
          tableContainer.innerHTML = '';
          
          // Reset state
          scorecardBuilt = false;
          savedSuccessfully = false;
          
          // Disable save button
          document.getElementById('save').disabled = true;
          
          // Open setup controls
          document.getElementById('setup-controls').open = true;
          
          // Show message
          BBB_UTILS.showMessage('Scorecard reset.', 'success');
        }
        
        /**
         * Save scorecard
         */
        function saveScorecard() {
          if (!scorecardBuilt) {
            BBB_UTILS.showMessage('Please build a scorecard first.', 'error');
            return;
          }
          
          // Check that all inputs have values
          const inputs = tableContainer.querySelectorAll('tbody input[type="number"]');
          let allFilled = true;
          
          inputs.forEach(input => {
            if (input.value === '' || isNaN(parseInt(input.value, 10))) {
              input.classList.add('missing');
              allFilled = false;
            } else {
              input.classList.remove('missing');
            }
          });
          
          if (!allFilled) {
            BBB_UTILS.showMessage('Please enter all scores before saving.', 'error');
            return;
          }
          
          // Create scorecard object
          const scorecard = {
            date: new Date().toISOString(),
            course: courseSelect.value,
            tee: teeSelect.value,
            holes: document.querySelector('input[name="holes"]:checked').value,
            players: [],
            createdAt: new Date().toISOString()
          };
          
          // Get selected players
          const players = [];
          document.querySelectorAll('.player-select').forEach(select => {
            if (select.value) players.push(select.value);
          });
          
          // Get course data
          const courseData = getCourseData(courseSelect.value);
          const holeSelection = document.querySelector('input[name="holes"]:checked').value;
          
          // Determine which holes to show
          let holes = Array.from({ length: 18 }, (_, i) => i);
          if (holeSelection === '9f') holes = holes.slice(0, 9);
          if (holeSelection === '9b') holes = holes.slice(9);
          
          // Get player data
          players.forEach((player, playerIndex) => {
            const handicapInput = document.getElementById(`hcp-${playerIndex}`);
            const handicap = parseInt(handicapInput.value, 10) || 0;
            const slopeRating = getSlopeRating(courseSelect.value, teeSelect.value);
            const courseHandicap = Math.round(handicap * slopeRating / 113);
            
            // Get scores and calculate points
            const scores = [];
            const points = [];
            let totalShots = 0;
            let totalPoints = 0;
            
            holes.forEach(holeIndex => {
              const scoreInput = document.querySelector(`input[data-player="${playerIndex}"][data-hole="${holeIndex}"]`);
              const score = parseInt(scoreInput.value, 10) || 0;
              scores.push(score);
              totalShots += score;
              
              // Calculate points
              const par = courseData.par[holeIndex];
              const si = courseData.si[holeIndex];
              const strokesReceived = (courseHandicap >= si + 18) ? 2 : (courseHandicap >= si ? 1 : 0);
              const netScore = score - strokesReceived;
              
              let pointsValue = 0;
              if (netScore <= par - 3) pointsValue = 5;        // Albatross or better
              else if (netScore === par - 2) pointsValue = 4;  // Eagle
              else if (netScore === par - 1) pointsValue = 3;  // Birdie
              else if (netScore === par) pointsValue = 2;      // Par
              else if (netScore === par + 1) pointsValue = 1;  // Bogey
              
              points.push(pointsValue);
              totalPoints += pointsValue;
            });
            
            // Add player data to scorecard
            scorecard.players.push({
              name: player,
              handicap,
              courseHandicap,
              scores,
              points,
              totalShots,
              totalPoints
            });
          });
          
          // Save scorecard
          BBB_DB.saveScorecard(scorecard)
            .then(() => {
              BBB_UTILS.showMessage('Scorecard saved successfully!', 'success');
              savedSuccessfully = true;
            })
            .catch(err => {
              console.error('Error saving scorecard:', err);
              BBB_UTILS.showMessage('Error saving scorecard: ' + err.message, 'error');
            });
        }
        
        /**
         * Download scorecard as image
         */
        function downloadScorecardImage() {
          if (!tableContainer.firstElementChild) {
            BBB_UTILS.showMessage('No scorecard to capture.', 'error');
            return;
          }
          
          // Apply temporary styles for image capture
          const table = tableContainer.firstElementChild;
          const originalStyle = table.getAttribute('style') || '';
          
          table.style.backgroundColor = 'white';
          table.style.color = 'black';
          
          table.querySelectorAll('th, td').forEach(cell => {
            cell.style.color = 'black';
            cell.style.backgroundColor = 'white';
            cell.style.borderColor = '#000';
          });
          
          // Check if html2canvas is loaded
          if (typeof html2canvas !== 'function') {
            BBB_UTILS.showMessage('Image capture library not loaded. Please try again in a few seconds.', 'warning');
            
            // Restore original styles
            table.setAttribute('style', originalStyle);
            table.querySelectorAll('th, td').forEach(cell => cell.removeAttribute('style'));
            
            return;
          }
          
          // Create loading overlay
          const loadingOverlay = document.createElement('div');
          loadingOverlay.style.position = 'fixed';
          loadingOverlay.style.top = '0';
          loadingOverlay.style.left = '0';
          loadingOverlay.style.width = '100%';
          loadingOverlay.style.height = '100%';
          loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
          loadingOverlay.style.display = 'flex';
          loadingOverlay.style.justifyContent = 'center';
          loadingOverlay.style.alignItems = 'center';
          loadingOverlay.style.color = 'white';
          loadingOverlay.style.fontSize = '1.5rem';
          loadingOverlay.style.zIndex = '9999';
          loadingOverlay.textContent = 'Generating image...';
          document.body.appendChild(loadingOverlay);
          
          // Capture table
          html2canvas(table, { scale: 2 })
            .then(canvas => {
              // Create download link
              const link = document.createElement('a');
              link.download = `scorecard_${courseSelect.value}_${new Date().toISOString().split('T')[0]}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
              
              BBB_UTILS.showMessage('Image downloaded successfully!', 'success');
            })
            .catch(err => {
              console.error('Error capturing image:', err);
              BBB_UTILS.showMessage('Error capturing image: ' + err.message, 'error');
            })
            .finally(() => {
              // Restore original styles
              table.setAttribute('style', originalStyle);
              table.querySelectorAll('th, td').forEach(cell => cell.removeAttribute('style'));
              
              // Remove loading overlay
              document.body.removeChild(loadingOverlay);
            });
        }
        
        /**
         * Update scores and points
         */
        function updateScores() {
          if (!scorecardBuilt) return;
          
          // Get selected players
          const players = [];
          document.querySelectorAll('.player-select').forEach(select => {
            if (select.value) players.push(select.value);
          });
          
          // Create totals object for each player
          const totals = players.map(() => ({
            frontShots: 0,
            frontPoints: 0,
            backShots: 0,
            backPoints: 0,
            totalShots: 0,
            totalPoints: 0
          }));
          
          // Get hole selection
          const holeSelection = document.querySelector('input[name="holes"]:checked').value;
          
          // Determine which holes to show
          let holes = Array.from({ length: 18 }, (_, i) => i);
          if (holeSelection === '9f') holes = holes.slice(0, 9);
          if (holeSelection === '9b') holes = holes.slice(9);
          
          // Get course data
          const courseData = getCourseData(courseSelect.value);
          
          // Process each row (hole)
          tableContainer.querySelectorAll('tbody tr').forEach((row, rowIndex) => {
            if (rowIndex >= holes.length) return;
            
            const holeIndex = holes[rowIndex];
            const par = courseData.par[holeIndex];
            const si = courseData.si[holeIndex];
            const isFrontNine = holeIndex < 9;
            
            // Process each player
            players.forEach((_, playerIndex) => {
              // Get score input
              const scoreInput = row.querySelector(`input[data-player="${playerIndex}"][data-hole="${holeIndex}"]`);
              if (!scoreInput) return;
              
              const score = parseInt(scoreInput.value, 10);
              if (isNaN(score)) return;
              
              // Get handicap
              const handicapInput = document.getElementById(`hcp-${playerIndex}`);
              const handicap = parseInt(handicapInput.value, 10) || 0;
              const slopeRating = getSlopeRating(courseSelect.value, teeSelect.value);
              const courseHandicap = Math.round(handicap * slopeRating / 113);
              
              // Calculate strokes received
              const strokesReceived = (courseHandicap >= si + 18) ? 2 : (courseHandicap >= si ? 1 : 0);
              
              // Calculate net score and points
              const netScore = score - strokesReceived;
              let points = 0;
              
              if (netScore <= par - 3) points = 5;        // Albatross or better
              else if (netScore === par - 2) points = 4;  // Eagle
              else if (netScore === par - 1) points = 3;  // Birdie
              else if (netScore === par) points = 2;      // Par
              else if (netScore === par + 1) points = 1;  // Bogey
              
              // Update points display
              const pointsDiv = row.querySelector(`.pts-${playerIndex} .points`);
              if (pointsDiv) pointsDiv.textContent = points;
              
              // Update totals
              totals[playerIndex].totalShots += score;
              totals[playerIndex].totalPoints += points;
              
              if (isFrontNine) {
                totals[playerIndex].frontShots += score;
                totals[playerIndex].frontPoints += points;
              } else {
                totals[playerIndex].backShots += score;
                totals[playerIndex].backPoints += points;
              }
            });
          });
          
          // Update footer totals
          players.forEach((_, playerIndex) => {
            const frontShotsEl = document.getElementById(`shots-0-${playerIndex}`);
            const frontPointsEl = document.getElementById(`pts-0-${playerIndex}`);
            const backShotsEl = document.getElementById(`shots-1-${playerIndex}`);
            const backPointsEl = document.getElementById(`pts-1-${playerIndex}`);
            const totalShotsEl = document.getElementById(`shots-2-${playerIndex}`);
            const totalPointsEl = document.getElementById(`pts-2-${playerIndex}`);
            
            if (frontShotsEl) frontShotsEl.textContent = totals[playerIndex].frontShots || '';
            if (frontPointsEl) frontPointsEl.textContent = totals[playerIndex].frontPoints || '';
            if (backShotsEl) backShotsEl.textContent = totals[playerIndex].backShots || '';
            if (backPointsEl) backPointsEl.textContent = totals[playerIndex].backPoints || '';
            if (totalShotsEl) totalShotsEl.textContent = totals[playerIndex].totalShots || '';
            if (totalPointsEl) totalPointsEl.textContent = totals[playerIndex].totalPoints || '';