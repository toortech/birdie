<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stableford Scorecard ‚Äì Multiple Courses</title>
  <style>
    /* Validation & utility */
    .invalid-hcp, .missing { border: 2px solid red; background-color: #ffcccc; }

    /* Base styles */
    body { background: #f5f5f5; color: #000; font-family: sans-serif; padding: 1rem; margin: 0 auto; max-width: 1200px; }
    h1 { color: #003300; font-size: 2rem; text-align: center; margin-bottom: 1rem; }
    nav { text-align: right; margin-bottom: 0.5rem; }
    .home-link { color: #000; font-weight: bold; text-decoration: none; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .controls > div { background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 6px; flex: 1 1 200px; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    #table-container { overflow-x: auto; position: relative; max-width: 100vw; margin-top: 1rem; }
    #table-container::after { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 20px; background: linear-gradient(to right, transparent, rgba(0,0,0,0.2)); pointer-events: none; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; table-layout: auto; }
    th, td { border: 1px solid #fff; padding: 0.5rem; text-align: center; white-space: nowrap; }
    th { background: rgba(255,255,255,0.2); }
    input[type="number"] { width: 3rem; }
    select, button { padding: 0.25rem; width: 100%; cursor: pointer; }
    button { background: #004c99; color: white; border: none; border-radius: 4px; }
    button:hover { background: #003d7a; }
    #button-group { display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; }
    .stroke-info { font-size: 0.75em; color: #ccc; margin-top: 0.25rem; }
    .controls-summary { cursor: pointer; font-weight: bold; font-size: 1.1em; }

    @media (max-width: 768px) {
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem; }
      input[type="number"] { width: 2rem; font-size: 0.75rem; }
      select, button { font-size: 0.8rem; }
      .stroke-info { font-size: 0.6em; }
      .controls { flex-direction: column; }
      .controls > div { flex: 1 1 auto; }
      #table-container { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="home-link">üè† Home</a>
    </nav>
  </header>
  <main>
    <h1>Stableford Scorecard ‚Äì Multiple Courses</h1>
    <details id="setup-controls" open>
      <summary class="controls-summary">‚öôÔ∏è Setup Options</summary>
      <div class="controls">
        <div>
          <label for="course-select">Course:</label>
          <select id="course-select">
            <option value="Ritchings">Richings Park</option>
            <option value="Thorney">Thorney Park</option>
          </select>
        </div>
        <div>
          <label for="tee-select">Tee Colour:</label>
          <select id="tee-select">
            <option value="white">White</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
          </select>
        </div>
        <div id="player-checkboxes">
          <label>Players (max 4):</label>
          <label for="p-Amrit"><input id="p-Amrit" type="checkbox" name="player" value="Amrit"> Amrit</label>
          <label for="p-Kam"><input id="p-Kam" type="checkbox" name="player" value="Kam"> Kam</label>
          <label for="p-Vish"><input id="p-Vish" type="checkbox" name="player" value="Vish"> Vish</label>
          <label for="p-Ravi"><input id="p-Ravi" type="checkbox" name="player" value="Ravi"> Ravi</label>
          <label for="p-Bal"><input id="p-Bal" type="checkbox" name="player" value="Bal"> Bal</label>
          <label for="p-Vick"><input id="p-Vick" type="checkbox" name="player" value="Vick"> Vick</label>
          <label for="p-Michael"><input id="p-Michael" type="checkbox" name="player" value="Michael"> Michael</label>
          <label for="p-Justy"><input id="p-Justy" type="checkbox" name="player" value="Justy"> Justy</label>
          <label for="p-Phuperjee"><input id="p-Phuperjee" type="checkbox" name="player" value="Phuperjee"> Phuperjee</label>
          <label for="p-Indy"><input id="p-Indy" type="checkbox" name="player" value="Indy"> Indy</label>
          <label for="p-Maj"><input id="p-Maj" type="checkbox" name="player" value="Maj"> Maj</label>
          <label for="p-Sama"><input id="p-Sama" type="checkbox" name="player" value="Sama"> Sama</label>
        </div>
        <div>
          <label>Holes:</label>
          <label for="h-18"><input id="h-18" type="radio" name="holes" value="18" checked> Full 18</label>
          <label for="h-9f"><input id="h-9f" type="radio" name="holes" value="9f"> Front 9</label>
          <label for="h-9b"><input id="h-9b" type="radio" name="holes" value="9b"> Back 9</label>
        </div>
      </div>
    </details>
    <div id="button-group">
      <button id="build">Build Scorecard</button>
      <button id="reset">Reset</button>
      <button id="save" disabled>Save Scorecard</button>
      <button id="download-image">üì∏ Save Scorecard as Image</button>
      <a href="view-saved-scores.html" id="view-saved-link" class="home-link">üìÑ View Past Scorecards</a>
    </div>
    <div id="created-time" aria-live="polite"></div>
    <div id="table-container"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    (function(){
      'use strict';
      // Cached selectors
      const buildBtn = document.getElementById('build');
      const saveBtn = document.getElementById('save');
      const resetBtn = document.getElementById('reset');
      const downloadBtn = document.getElementById('download-image');
      const viewLink = document.getElementById('view-saved-link');
      const tableContainer = document.getElementById('table-container');
      const createdTime = document.getElementById('created-time');
      const courseSelect = document.getElementById('course-select');
      const teeSelect = document.getElementById('tee-select');
      const holeRadios = document.querySelectorAll('input[name="holes"]');
      const playerCheckboxes = document.querySelectorAll('#player-checkboxes input[type="checkbox"]');
      let scorecardBuilt = false;
      let savedSuccessfully = false;

      // Debounce utility
      function debounce(fn, delay = 200) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Course data
      const courses = {
        Ritchings: { par:[4,3,5,4,4,3,4,4,4,3,4,4,4,3,4,4,5,4], si:[12,8,6,18,10,16,2,14,4,15,3,17,7,11,1,5,13,9], yards:{ white:[365,140,495,350,370,160,385,375,360,155,380,370,395,145,400,360,510,375], yellow:[350,130,480,340,355,150,370,360,345,145,365,355,380,135,385,345,495,360], red:[330,120,460,320,335,140,350,340,325,135,345,335,360,125,365,325,470,340] } },
        Thorney:  { par:[5,4,4,3,5,4,4,3,5,4,4,3,5,4,4,3,5,4], si:[9,15,1,17,5,13,3,11,7,16,2,14,6,18,4,12,8,10],       yards:{ white:[475,360,410,155,495,345,375,160,500,350,370,150,480,355,385,145,505,365], yellow:[460,345,395,145,480,330,360,150,485,335,355,140,465,340,370,135,490,350], red:[440,320,370,130,450,305,335,135,455,310,330,125,435,315,345,120,460,325] } }
      };
      const teeSlope = { white:128, yellow:121, red:115 };

      // Event handlers
      buildBtn.addEventListener('click', () => {
        const players = [...playerCheckboxes].filter(cb=>cb.checked).map(cb=>cb.value);
        if (!players.length) return alert('‚ö†Ô∏è Please select at least one player.');
        if (players.length > 4) return alert('‚ö†Ô∏è Please select no more than 4 players.');

        if (scorecardBuilt) {
          // Validate existing HCP inputs before rebuild
          let valid = true;
          players.forEach((_, i) => {
            const h = document.getElementById(`hcp-${i}`);
            if (!h || h.value === '' || isNaN(h.value) || parseInt(h.value,10) < 0) {
              h?.classList.add('invalid-hcp');
              valid = false;
            } else {
              h.classList.remove('invalid-hcp');
            }
          });
          if (!valid) return alert('‚ö†Ô∏è Enter a valid handicap (0 or greater) for all players.');
          if (!confirm('Rebuilding will erase all scores. Continue?')) return;
        }

        build(players);
        document.getElementById('setup-controls').open = false;
        scorecardBuilt = true;
        saveBtn.disabled = false;
      });

      resetBtn.addEventListener('click', () => {
        if (!confirm('‚ö†Ô∏è Reset scorecard? All data lost.')) return;
        scorecardBuilt = false; savedSuccessfully = false;
        tableContainer.innerHTML = ''; createdTime.textContent = '';
        saveBtn.disabled = true;
      });

      viewLink.addEventListener('click', e => {
        if (scorecardBuilt && !savedSuccessfully) {
          e.preventDefault();
          alert('‚ö†Ô∏è Save before viewing past scorecards.');
        }
      });

      saveBtn.addEventListener('click', () => {
        const ins = tableContainer.querySelectorAll('tbody input[type=number]');
        let ok = true;
        ins.forEach(i => {
          if (i.value === '' || isNaN(parseInt(i.value,10))) {
            i.classList.add('missing'); ok = false;
          } else i.classList.remove('missing');
        });
        if (!ok) return alert('‚ö†Ô∏è Enter all scores before saving.');
        savedSuccessfully = true;
        alert('‚úÖ Scorecard saved.');
        // TODO: persist to localStorage/backend
      });

      window.addEventListener('beforeunload', e => {
        if (scorecardBuilt && !savedSuccessfully) { e.preventDefault(); e.returnValue = ''; }
      });

      downloadBtn.addEventListener('click', () => {
        const node = tableContainer.firstElementChild;
        if (!node) return alert('‚ö†Ô∏è No scorecard to capture.');
        const orig = node.getAttribute('style') || '';
        node.style.backgroundColor = 'white'; node.style.color = 'black';
        node.querySelectorAll('th, td').forEach(c => { c.style.color = 'black'; c.style.backgroundColor = 'white'; c.style.borderColor = '#000'; });
        html2canvas(node, { scale: 2 }).then(canvas => {
          const link = document.createElement('a');
          link.download = `scorecard_${new Date().toLocaleString('en-GB',{dateStyle:'short'})}.png`;
          link.href = canvas.toDataURL(); link.click();
          node.setAttribute('style', orig);
          node.querySelectorAll('th, td').forEach(c => c.removeAttribute('style'));
        });
      });

      // Build scorecard
      function build(players) {
        const courseKey = courseSelect.value;
        const tee = teeSelect.value;
        const { par, si, yards } = courses[courseKey];
        const slope = teeSlope[tee];
        const holeVal = [...holeRadios].find(r => r.checked).value;
        let idx = [...Array(18).keys()];
        if (holeVal === '9f') idx = idx.slice(0,9);
        if (holeVal === '9b') idx = idx.slice(9);

        createdTime.textContent = `Scorecard created: ${new Date().toLocaleString('en-GB',{dateStyle:'short',timeStyle:'short'})}`;
        tableContainer.innerHTML = '';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        let hdr1 = '<tr><th>Hole</th><th>Par</th><th style="color:red;">SI</th><th>Yards</th>';
        players.forEach((p,i) => hdr1 += `<th colspan="2">${p}<br>HCP:<input id="hcp-${i}" type="number" value="0" min="0" max="36"></th>`);
        hdr1 += '</tr>';
        let hdr2 = '<tr><th></th><th></th><th></th><th></th>';
        players.forEach(() => hdr2 += '<th>Shots</th><th>STB Score</th>');
        hdr2 += '</tr>';
        thead.innerHTML = hdr1 + hdr2;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        idx.forEach(h => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${h+1}</td><td>${par[h]}</td><td style="color:red;">${si[h]}</td><td>${yards[tee][h]}</td>`;
          players.forEach((_,pi) => {
            tr.innerHTML += `<td><input data-player="${pi}" data-hole="${h}" type="number" min="0"></td>` +
                            `<td class="pts-${pi}"><div class="points"></div><div class="stroke-info" data-player="${pi}" data-hole="${h}"></div></td>`;
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        const tfoot = document.createElement('tfoot');
        ['Front 9','Back 9','Overall'].forEach((lbl,ri) => {
          let row = `<tr><td colspan="4">${lbl} Total</td>`;
          players.forEach((_,pi) => row += `<td id="str-${ri}-${pi}" style="font-weight:bold;"></td><td id="pts-${ri}-${pi}" style="font-weight:bold;"></td>`);
          row += '</tr>';
          tfoot.innerHTML += row;
        });
        table.appendChild(tfoot);
        tableContainer.appendChild(table);

        // Handicap and update handlers
        players.forEach((_,i) => {
          const hIn = document.getElementById(`hcp-${i}`);
          const adjSpan = document.createElement('span');
          adjSpan.id = `adjhcp-${i}`; adjSpan.style.fontWeight = 'bold'; adjSpan.style.marginLeft = '0.5rem';
          hIn.insertAdjacentElement('afterend', adjSpan);
          const updateAdj = () => {
            const raw = parseInt(hIn.value,10) || 0;
            const adj = Math.round(raw * slope / 113);
            adjSpan.textContent = `Adj HCP: ${adj}`;
            idx.forEach(h => {
              const siH = si[h];
              let st = adj >= siH+18 ? 2 : (adj >= siH ? 1 : 0);
              const el = document.querySelector(`.stroke-info[data-player="${i}"][data-hole="${h}"]`);
              if (el) { el.textContent = `(${st} stroke${st!==1?'s':''})`; el.parentElement.style.backgroundColor = st>0 ? 'rgba(255,165,0,0.6)' : ''; }
            });
          };
          hIn.addEventListener('input', () => { updateAdj(); update(table,par,si,players,idx,slope); });
          updateAdj();
        });

        tbody.querySelectorAll('input[type=number]').forEach(inp => {
          inp.addEventListener('input', () => {
            inp.classList.remove('missing');
            const pi = inp.getAttribute('data-player');
            const hf = document.getElementById(`hcp-${pi}`);
            if (!hf || hf.value === '' || isNaN(hf.value) || parseInt(hf.value,10) < 0) {
              alert(`‚ö†Ô∏è Enter a valid handicap for player ${players[pi]}.`);
              inp.value = '';
              return;
            }
            debounce(() => update(table,par,si,players,idx,slope))();
          });
        });

        update(table, par, si, players, idx, slope);
      }

      // Update scores
      function update(table, par, siArr, players, idx, slope) {
        const tots = players.map(() => ({fS:0,fP:0,bS:0,bP:0,oS:0,oP:0}));
        table.querySelectorAll('tbody tr').forEach((tr,rIdx) => {
          const h = idx[rIdx]; const pr = par[h], sIdx = siArr[h]; const front = rIdx < 9;
          players.forEach((_,pi) => {
            const inp = tr.querySelector(`input[data-player="${pi}"][data-hole="${h}"]`);
            const sc = parseInt(inp.value,10);
            if (isNaN(sc)) return;
            const rawH = parseInt(document.getElementById(`hcp-${pi}`).value,10) || 0;
            const adjH = Math.round(rawH * slope / 113);
            const st = adjH >= sIdx+18 ? 2 : (adjH >= sIdx ? 1 : 0);
            const net = sc - st;
            let pts = net <= pr-2 ? 4 : net === pr-1 ? 3 : net === pr ? 2 : net === pr+1 ? 1 : 0;
            const pDiv = tr.querySelector(`.pts-${pi} .points`);
            const sDiv = tr.querySelector(`.pts-${pi} .stroke-info`);
            if (pDiv) pDiv.textContent = pts;
            if (sDiv) sDiv.textContent = `(${st} stroke${st!==1?'s':''})`;
            tots[pi].oS += sc; tots[pi].oP += pts;
            if (front) { tots[pi].fS += sc; tots[pi].fP += pts; } else { tots[pi].bS += sc; tots[pi].bP += pts; }
          });
        });
        tots.forEach((t,pi) => {
          ['f','b','o'].forEach((lab,i) => {
            document.getElementById(`str-${i}-${pi}`).textContent = i===2 ? t.oS : i===0 ? t.fS : t.bS;
            document.getElementById(`pts-${i}-${pi}`).textContent = i===2 ? t.oP : i===0 ? t.fP : t.bP;
          });
        });
      }
    })();
  </script>
</body>
</html>
