<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stableford Scorecard ‚Äì Multiple Courses</title>
  <style>
    body { background: #007BFF; color: white; font-family: sans-serif; padding: 1rem; margin: 0 auto; }
    h1 { color: #28A745; font-size: 2rem; text-align: center; margin-bottom: 1rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .controls > div { background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 6px; flex: 1 1 200px; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    #table-container { overflow-x: auto; min-height: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 600px; }
    th, td { border: 1px solid #fff; padding: 0.5rem; text-align: center; }
    th { background: rgba(255,255,255,0.2); }
    input[type="number"] { width: 3rem; }
    select { padding: 0.25rem; width: 100%; }
    button { padding: 0.5rem 1rem; font-size: 1rem; background: #28A745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #1e7e34; }
    #button-group { display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; }
    input.missing { border: 2px solid red; }
    .stroke-info { font-size: 0.75em; color: #ccc; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>Stableford Scorecard ‚Äì Multiple Courses</h1>

  <div class="controls">
    <div>
      <label for="course-select">Course:</label>
      <select id="course-select">
        <option value="Ritchings">Richings Park</option>
        <option value="Thorney">Thorney Park</option>
      </select>
    </div>
    <div>
      <label for="tee-select">Tee Colour:</label>
      <select id="tee-select">
        <option value="white">White</option>
        <option value="yellow">Yellow</option>
        <option value="red">Red</option>
      </select>
    </div>
    <div>
      <label>Players (max 4):</label>
      <div id="player-checkboxes" style="display:grid; grid-template-columns: repeat(2, minmax(120px, 1fr)); gap: 0.5rem; max-height: 150px; overflow-y: auto;">
        <label><input type="checkbox" name="player" value="Amrit"> Amrit</label>
        <label><input type="checkbox" name="player" value="Kam"> Kam</label>
        <label><input type="checkbox" name="player" value="Vish"> Vish</label>
        <label><input type="checkbox" name="player" value="Ravi"> Ravi</label>
        <label><input type="checkbox" name="player" value="Bal"> Bal</label>
        <label><input type="checkbox" name="player" value="Vick"> Vick</label>
        <label><input type="checkbox" name="player" value="Michael"> Michael</label>
        <label><input type="checkbox" name="player" value="Justy"> Justy</label>
        <label><input type="checkbox" name="player" value="Phuperjee"> Phuperjee</label>
        <label><input type="checkbox" name="player" value="Indy"> Indy</label>
      </div>
    </div>
    <div>
      <label>Holes:</label>
      <label><input type="radio" name="holes" value="18" checked> Full 18</label>
      <label><input type="radio" name="holes" value="9f"> Front 9</label>
      <label><input type="radio" name="holes" value="9b"> Back 9</label>
    </div>
  </div>

  <div id="button-group">
    <button id="build">Build Scorecard</button>
    <button id="reset">Reset</button>
  </div>

  <div style="text-align:center; margin-bottom: 1rem;">
    <a href="#" id="view-saved-link" style="text-decoration: underline; color: white;">üìÑ View Past Scorecards</a>
  </div>
  <div id="created-time" style="margin-top:0.5rem;font-style:italic;"></div>
  <div id="table-container"></div>
  <div style="text-align:center; margin-top: 1rem;">
    <button id="save" disabled>Save Scorecard</button>
  </div>

  <script>
let scorecardBuilt = false;
const buildBtn = document.getElementById('build');
const saveBtn = document.getElementById('save');
const resetBtn = document.getElementById('reset');
const tableContainer = document.getElementById('table-container');
const createdTime = document.getElementById('created-time');
const viewLink = document.getElementById('view-saved-link');

buildBtn.addEventListener('click', () => {
  if (scorecardBuilt) {
    alert('A scorecard has already been built. Please reset before building a new one.');
    return;
  }
  build();
  scorecardBuilt = true;
  saveBtn.disabled = false;
});

resetBtn.addEventListener('click', () => {
  if (confirm('‚ö†Ô∏è Are you sure you want to reset the scorecard? All entered data will be lost.')) {
    scorecardBuilt = false;
    tableContainer.innerHTML = '';
    createdTime.textContent = '';
    saveBtn.disabled = true;
  }
});

viewLink.addEventListener('click', (e) => {
  if (scorecardBuilt && !saveBtn.disabled) {
    e.preventDefault();
    alert('‚ö†Ô∏è Please save your current scorecard before viewing past ones.');
  } else {
    window.location.href = 'view-saved-scores.html';
  }
});

saveBtn.addEventListener('click', () => {
  const inputs = document.querySelectorAll('tbody input[type=number]');
  const incomplete = Array.from(inputs).some(inp => inp.value === '');
  if (incomplete) {
    alert('‚ö†Ô∏è Please complete all score entries before saving.');
    inputs.forEach(inp => {
      if (inp.value === '') inp.classList.add('missing');
    });
    return;
  }
  const scorecard = {
    date: new Date().toISOString(),
    course: document.getElementById('course-select').value,
    tee: document.getElementById('tee-select').value,
    holes: document.querySelector('input[name=holes]:checked').value,
    players: [...document.querySelectorAll('#player-checkboxes input[type=checkbox]:checked')].map(cb => cb.value),
    scores: [...document.querySelectorAll('tbody input[type=number]')].map(inp => ({
      player: inp.getAttribute('data-player'),
      hole: inp.getAttribute('data-hole'),
      value: inp.value
    })),
    handicaps: [...document.querySelectorAll('[id^="hcp-"]')].map(inp => ({
      player: inp.id.replace('hcp-', ''),
      hcp: inp.value
    }))
  };
  const existing = JSON.parse(localStorage.getItem('scorecards') || '[]');
  existing.push(scorecard);
  localStorage.setItem('scorecards', JSON.stringify(existing));
  const formattedDate = new Date(scorecard.date).toLocaleString();
  alert(`‚úÖ Scorecard saved for ${scorecard.course} (${scorecard.tee}) on ${formattedDate}`);
});

window.addEventListener('beforeunload', function (e) {
  if (scorecardBuilt && !saveBtn.disabled) {
    e.preventDefault();
    e.returnValue = 'You have unsaved scorecard data. Are you sure you want to leave?';
  }
});


function build() {
  const courses = {
    Ritchings: { par: [4,3,5,4,4,3,4,4,4,3,4,4,4,3,4,4,5,4], si: [12,8,6,18,10,16,2,14,4,15,3,17,7,11,1,5,13,9] },
    Thorney:   { par: [5,4,4,3,5,4,4,3,5,4,4,3,5,4,4,3,5,4], si: [9,15,1,17,5,13,3,11,7,16,2,14,6,18,4,12,8,10] }
  };
  const teeSlope = { white:128, yellow:121, red:115 };

  const courseKey = document.getElementById('course-select').value;
  const { par, si } = courses[courseKey];
  const tee = document.getElementById('tee-select').value;
  const slope = teeSlope[tee];
  const players = [...document.querySelectorAll('#player-checkboxes input[type=checkbox]:checked')].map(cb => cb.value);
  if (players.length > 4) {
    alert('‚ö†Ô∏è Please select no more than 4 players.');
    return;
  }
  const holes = document.querySelector('input[name=holes]:checked').value;
  let indices = [...Array(18).keys()];
  if (holes === '9f') indices = indices.slice(0,9);
  if (holes === '9b') indices = indices.slice(9);

  if (!players.length) {
    alert("Please select at least one player.");
    return;
  }

  createdTime.textContent = `Scorecard created: ${new Date().toLocaleString()}`;
  tableContainer.innerHTML = '';

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  let hdr1 = '<tr><th>Hole</th><th>Par</th><th style="color:red;">SI</th>';
  players.forEach((p,i) => hdr1 += `<th colspan="2">${p}<br>HCP:<input id="hcp-${i}" type="number" value="0" min="1" max="36"></th>`);
  hdr1 += '</tr>';
  let hdr2 = '<tr><th></th><th></th><th></th>';
  players.forEach(() => hdr2 += '<th>Score</th><th>Pts</th>');
  hdr2 += '</tr>';
  thead.innerHTML = hdr1 + hdr2;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  indices.forEach(i => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${par[i]}</td><td style="color:red;">${si[i]}</td>`;
    players.forEach((_,pi) => {
      tr.innerHTML += `<td><input data-player="${pi}" data-hole="${i}" type="number" min="0"></td>
                        <td class="pts-${pi}"><div class="points"></div><div class="stroke-info" data-player="${pi}" data-hole="${i}"></div></td>`;
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  const tfoot = document.createElement('tfoot');
  ['Front 9','Back 9','Overall'].forEach((lbl,ri) => {
    let row = `<tr><td colspan="3">${lbl} Total</td>`;
    players.forEach((_,pi) => row += `<td id="str-${ri}-${pi}" style="font-weight:bold;"></td><td id="pts-${ri}-${pi}" style="font-weight:bold;"></td>`);
    row += '</tr>';
    tfoot.innerHTML += row;
  });
  table.appendChild(tfoot);
  tableContainer.appendChild(table);

  players.forEach((_,i) => {
    const hcpInput = document.getElementById(`hcp-${i}`);
    const adjSpan = document.createElement('span');
    adjSpan.id = `adjhcp-${i}`;
    adjSpan.textContent = '0';
    hcpInput.insertAdjacentText('afterend', ' Adj:');
    hcpInput.insertAdjacentElement('afterend', adjSpan);
    function updateAdj() {
      const raw = parseInt(hcpInput.value,10) || 0;
      const adj = Math.round(raw * slope/113);
      adjSpan.textContent = adj;

      indices.forEach(h => {
        players.forEach((_, pi) => {
          const strokeInfo = document.querySelector(`.stroke-info[data-player="${pi}"][data-hole="${h}"]`);
          if (!strokeInfo) return;
          let strokes = 0;
          if (adj >= si[h]) strokes = 1;
          if (adj >= si[h] + 18) strokes = 2;
          strokeInfo.textContent = `(${strokes} stroke${strokes !== 1 ? 's' : ''})`;
          strokeInfo.parentElement.style.backgroundColor = strokes > 0 ? 'rgba(255,165,0,0.6)' : '';
        });
      });
    }
    hcpInput.addEventListener('input', () => { updateAdj(); update(table,par,si,players,indices,slope); });
    updateAdj();
  });

  tbody.querySelectorAll('input[type=number]').forEach(inp => inp.addEventListener('input', () => {
    const playerIndex = inp.getAttribute('data-player');
    const hcpField = document.getElementById(`hcp-${playerIndex}`);
    inp.classList.remove('missing');
    if (!hcpField || hcpField.value === '' || isNaN(hcpField.value) || parseInt(hcpField.value, 10) <= 0) {
      alert(`‚ö†Ô∏è Please enter a valid handicap for player ${players[playerIndex]} before scoring.`);
      inp.value = '';
      return;
    }
    update(table, par, si, players, indices, slope);
  }));

  update(table,par,si,players,indices,slope);
}

function update(table, par, siArr, players, indices, slope) {
  const totals = players.map(() => ({fS:0,fP:0,bS:0,bP:0,oS:0,oP:0}));
  table.querySelectorAll('tbody tr').forEach((tr,idx) => {
    const h = indices[idx];
    const pr = par[h], sidx = siArr[h];
    const front = idx < 9;
    players.forEach((_,pi) => {
      const inp = tr.querySelector(`input[data-player="${pi}"][data-hole="${h}"]`);
      const sc = parseInt(inp.value,10);
      const ptsCell = tr.querySelector(`.pts-${pi}`);
      if (isNaN(sc)) return;

      const rawHcp = parseInt(document.getElementById(`hcp-${pi}`).value,10)||0;
      const adjHcp = Math.round(rawHcp * slope/113);
      let strokes = 0;
      if (adjHcp >= siArr[h]) strokes = 1;
      if (adjHcp >= siArr[h] + 18) strokes = 2;
      const net = sc - strokes;

      let pts=0;
      if(net <= pr-2) pts=4;
      else if(net===pr-1) pts=3;
      else if(net===pr) pts=2;
      else if(net===pr+1) pts=1;

      const pointsDiv = ptsCell.querySelector('.points');
      const strokeInfo = ptsCell.querySelector('.stroke-info');
      if (pointsDiv) pointsDiv.textContent = pts;
      if (strokeInfo) strokeInfo.textContent = `(${strokes} stroke${strokes !== 1 ? 's' : ''})`;

      totals[pi].oS += sc;
      if(front) totals[pi].fS += sc; else totals[pi].bS += sc;
      totals[pi].oP += pts;
      if(front) totals[pi].fP += pts; else totals[pi].bP += pts;
    });
  });
  totals.forEach((t,pi) => [0,1,2].forEach(r => {
    document.getElementById(`str-${r}-${pi}`).textContent = r===0? t.fS: r===1? t.bS: t.oS;
    document.getElementById(`pts-${r}-${pi}`).textContent = r===0? t.fP: r===1? t.bP: t.oP;
  }));
}
</script>
</body>
</html>
