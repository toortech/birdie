<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birdie Bush Bandits â€“ Photo Gallery</title>
  <meta name="description" content="View photos from Birdie Bush Bandits golf outings and events.">
  <link rel="icon" type="image/svg+xml" href="bbb-logo.svg">
  <!-- Add Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Global CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Core Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/db.js"></script>
  <script src="js/ui.js"></script>
  
  <!-- Gallery specific styles -->
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
      }
    }
    
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .gallery-img:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .upload-section {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .upload-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
    }
    
    .upload-label::before {
      content: 'ðŸ“¸';
      font-size: 1.25rem;
    }
    
    .empty-gallery {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }
    
    /* Improved lightbox styles */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .lightbox-img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 4px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px; right: 25px;
      font-size: 2.5rem;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .lightbox-close:hover {
      opacity: 1;
    }
    
    .lightbox-caption {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
      max-width: 80%;
      text-align: center;
    }
    
    .upload-progress {
      margin-top: 1rem;
      width: 100%;
      max-width: 500px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      display: none;
      margin: 0 auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background-color: var(--bbb-secondary);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Image container and actions styles */
    .gallery-img-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .gallery-img-container:hover .image-actions {
      opacity: 1;
    }
    
    .image-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .image-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    .delete-btn {
      color: #ff6b6b;
    }
    
    .image-info {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      font-size: 0.8rem;
      border-top-left-radius: 8px;
    }
    
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .sort-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    /* Migration button */
    .migration-button {
      display: block;
      margin: 1rem auto;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Message styles */
    .info-message {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #0d47a1;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem auto;
      max-width: 600px;
      text-align: center;
    }
    
    /* Albums section styles */
    .albums-section {
      margin: 2rem 0;
    }

    .albums-title {
      margin-bottom: 1rem;
      color: var(--bbb-primary);
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .albums-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .album-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .album-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .album-thumbnail {
      height: 150px;
      background-color: #f0f0f0;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .album-info {
      padding: 1rem;
    }

    .album-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .album-count {
      font-size: 0.9rem;
      color: var(--bbb-text-muted);
    }

    /* Album actions */
    .album-actions {
      position: absolute;
      top: 0;
      right: 0;
      background-color: rgba(0,0,0,0.5);
      border-bottom-left-radius: 8px;
      padding: 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .album-card:hover .album-actions {
      opacity: 1;
    }

    .album-action-btn {
      background: none;
      border: none;
      color: white;
      font-size: 0.9rem;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
    }

    .album-action-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .delete-album-btn {
      color: #ff6b6b;
    }

    /* Add album/image modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 1100;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      max-width: 500px;
      width: 100%;
      padding: 2rem;
      position: relative;
    }

    .modal-title {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--bbb-primary);
      font-size: 1.5rem;
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
      border: none;
      background: none;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      background-color: #f0f0f0;
      color: #333;
      text-decoration: none;
      font-weight: 500;
    }

    .back-button:hover {
      background-color: #e0e0e0;
    }

    /* Badge for current album */
    .current-album-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background-color: var(--bbb-secondary);
      color: white;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-left: 1rem;
    }
    
    /* Empty album state */
    .empty-album {
      text-align: center;
      padding: 3rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 2rem;
    }

    /* Album selector */
    .album-selector {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      margin-right: 1rem;
    }
    
    /* Upload to album section */
    .upload-album-section {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .upload-album-label {
      font-size: 0.9rem;
      color: #666;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- Authentication Protection -->
  <script>
    // Check if BBB_AUTH is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for auth module to initialize
      setTimeout(function() {
        if (typeof BBB_AUTH !== 'undefined') {
          // If not authenticated and not on login page, redirect to login
          if (!BBB_AUTH.isAuthenticated && window.location.pathname.indexOf('login.html') === -1) {
            // Save the current URL to redirect back after login
            sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = 'login.html';
          }
        } else {
          console.error('BBB_AUTH module not found! Authentication check failed.');
        }
      }, 100); // Small delay to ensure modules are loaded
    });
  </script>
  
  <!-- Rest of your page content -->
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <main id="main"></main>

  <!-- Add Album Modal -->
  <div id="add-album-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h3 class="modal-title">Create New Album</h3>
      <form id="add-album-form">
        <div class="form-group">
          <label for="album-name">Album Name:</label>
          <input type="text" id="album-name" class="form-control" placeholder="Enter album name" required>
        </div>
        <div class="form-group">
          <label for="album-description">Description (optional):</label>
          <textarea id="album-description" class="form-control" placeholder="Enter description"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" id="cancel-add-album">Cancel</button>
          <button type="submit" class="btn">Create Album</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modules
      BBB_AUTH.init({
        cloudflareEnabled: BBB_CONFIG.cloudflareEnabled
      });
      
      BBB_DB.init({
        useCloudflare: BBB_CONFIG.cloudflareEnabled,
        localStoragePrefix: 'bbb_'
      });
      
      // Cloudflare worker URL - Your actual worker URL
      const CLOUDFLARE_API = 'https://bbb-gallery-worker.cf1demouk.workers.dev';
      
      // Default albums (will be supplemented by saved albums in DB)
      let defaultAlbums = [
        { id: 'all', title: 'All Photos', description: 'All photos in the gallery', thumbnail: 'images/photo1.jpg', count: 0, default: true },
        { id: 'events', title: 'Golf Events', description: 'Photos from our golf events', thumbnail: 'images/photo2.jpg', count: 0, default: true },
        { id: 'tournaments', title: 'Tournaments', description: 'Photos from tournaments', thumbnail: 'images/photo3.jpg', count: 0, default: true },
        { id: 'members', title: 'Member Photos', description: 'Photos of our members', thumbnail: 'images/photo4.jpg', count: 0, default: true }
      ];
      
      // Track the current album being viewed
      let currentAlbumId = 'all';
      
      // Get URL parameters to see if we need to show a specific album
      const urlParams = new URLSearchParams(window.location.search);
      const albumParam = urlParams.get('album');
      if (albumParam) {
        currentAlbumId = albumParam;
      }
      
      // Check if the user has access to the gallery
      const hasGalleryAccess = BBB_AUTH.isAuthenticated && 
        (BBB_AUTH.hasRole('gallery') || BBB_AUTH.hasRole('admin') || BBB_AUTH.hasRole('member'));
      
      if (!hasGalleryAccess) {
        // Show gallery login overlay
        showGalleryLogin();
      } else {
        // Already authenticated, initialize gallery
        initializeGallery();
      }
      
      /**
       * Show gallery login overlay
       */
      function showGalleryLogin() {
        const loginOverlay = document.createElement('div');
        loginOverlay.id = 'login-overlay';
        
        const loginBox = document.createElement('div');
        loginBox.id = 'login-box';
        
        const title = document.createElement('h2');
        title.textContent = 'Enter Password';
        
        const passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.id = 'pw-input';
        passwordInput.placeholder = 'Password';
        
        const errorMsg = document.createElement('div');
        errorMsg.id = 'error-msg';
        errorMsg.textContent = 'Incorrect password';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.9rem';
        errorMsg.style.display = 'none';
        errorMsg.style.marginTop = '0.5rem';
        
        const submitBtn = document.createElement('button');
        submitBtn.id = 'pw-submit';
        submitBtn.textContent = 'Unlock Gallery';
        submitBtn.className = 'btn';
        submitBtn.style.marginTop = '1rem';
        
        loginBox.appendChild(title);
        loginBox.appendChild(passwordInput);
        loginBox.appendChild(errorMsg);
        loginBox.appendChild(submitBtn);
        
        loginOverlay.appendChild(loginBox);
        document.body.appendChild(loginOverlay);
        
        // Focus password input
        setTimeout(() => passwordInput.focus(), 100);
        
        // Handle login events
        submitBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') handleLogin();
        });
        
        function handleLogin() {
          const password = passwordInput.value;
          
          BBB_AUTH.login('gallery', password)
            .then(() => {
              // Login successful
              loginOverlay.remove();
              initializeGallery();
            })
            .catch(err => {
              // Login failed
              console.error('Login error:', err);
              errorMsg.style.display = 'block';
            });
        }
      }
      
      /**
       * Initialize gallery after authentication
       */
      function initializeGallery() {
        // Create header
        const headerElements = BBB_UI.createHeader({
          fixed: true,
          showHomeLinkText: true
        });
        
        document.body.insertBefore(headerElements.header, document.body.firstChild);
        
        // Get main content element
        const main = document.getElementById('main');
        main.appendChild(headerElements.mainWrapper);
        
        // Create page content
        const mainContent = document.createElement('div');
        
        // Create page title
        const titleContainer = BBB_UI.createPageTitle({
          title: 'Birdie Bush Bandits',
          showFoundedText: true,
          showGolfballs: true
        });
        mainContent.appendChild(titleContainer);
        
        // Add page subtitle
        const subtitle = document.createElement('h2');
        subtitle.textContent = 'Photo Gallery';
        subtitle.id = 'gallery-title';
        mainContent.appendChild(subtitle);
        
        // Create status message container
        const statusMessage = BBB_UI.createStatusMessage();
        mainContent.appendChild(statusMessage);
        
        // Add description text
        const description = document.createElement('p');
        description.className = 'gallery-description';
        description.textContent = 'Browse photos from our golf outings and events. Click on any image to view it in full size.';
        mainContent.appendChild(description);
        
        // Create filter/search bar
        const filterBar = createFilterBar();
        mainContent.appendChild(filterBar);
        
        // Back button when viewing an album (initially hidden)
        const backButton = document.createElement('a');
        backButton.href = 'javascript:void(0)';
        backButton.className = 'back-button';
        backButton.textContent = 'â† Back to Albums';
        backButton.style.display = 'none';
        backButton.id = 'back-to-albums';
        backButton.addEventListener('click', () => {
          showAlbumsView();
        });
        mainContent.appendChild(backButton);
        
        // Image upload section
        const uploadSection = document.createElement('div');
        uploadSection.className = 'upload-section';
        
        // Add album selector for uploads
        const uploadAlbumSection = document.createElement('div');
        uploadAlbumSection.className = 'upload-album-section';
        uploadAlbumSection.style.display = 'none'; // Hide initially, show when viewing album
        
        const uploadAlbumLabel = document.createElement('span');
        uploadAlbumLabel.className = 'upload-album-label';
        uploadAlbumLabel.textContent = 'Upload to:';
        
        const albumSelector = document.createElement('select');
        albumSelector.className = 'album-selector';
        albumSelector.id = 'upload-album-selector';
        
        // Add album options
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Album...';
        albumSelector.appendChild(defaultOption);
        
        // Will be populated when albums are loaded
        
        uploadAlbumSection.appendChild(uploadAlbumLabel);
        uploadAlbumSection.appendChild(albumSelector);
        
        // Upload button
        const uploadLabel = document.createElement('label');
        uploadLabel.htmlFor = 'image-upload';
        uploadLabel.className = 'upload-label btn';
        uploadLabel.textContent = 'Upload Photos';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.id = 'image-upload';
        uploadInput.className = 'upload-input';
        uploadInput.setAttribute('accept', 'image/*');
        uploadInput.setAttribute('multiple', 'true');
        uploadInput.style.display = 'none';
        
        // Create album button (only for admins)
        const createAlbumButton = document.createElement('button');
        createAlbumButton.className = 'btn';
        createAlbumButton.textContent = 'Create Album';
        createAlbumButton.id = 'create-album-btn';
        
        if (BBB_AUTH.hasRole('admin')) {
          createAlbumButton.style.display = 'inline-block';
        } else {
          createAlbumButton.style.display = 'none';
        }
        
        createAlbumButton.addEventListener('click', showAddAlbumModal);
        
        uploadSection.appendChild(uploadAlbumSection);
        uploadSection.appendChild(uploadLabel);
        uploadSection.appendChild(uploadInput);
        uploadSection.appendChild(createAlbumButton);
        mainContent.appendChild(uploadSection);
        
        // Info message about cloudflare
        const infoMessage = document.createElement('div');
        infoMessage.className = 'info-message';
        infoMessage.textContent = 'Gallery images are now stored in the cloud for better performance and reliability.';
        mainContent.appendChild(infoMessage);
        
        // Add albums section
        const albumsSection = document.createElement('div');
        albumsSection.className = 'albums-section';
        albumsSection.id = 'albums-section';
        
        const albumsTitle = document.createElement('h3');
        albumsTitle.className = 'albums-title';
        albumsTitle.innerHTML = 'Photo Albums';
        albumsSection.appendChild(albumsTitle);
        
        // Create albums grid
        const albumsGrid = document.createElement('div');
        albumsGrid.className = 'albums-grid';
        albumsGrid.id = 'albums-grid';
        albumsSection.appendChild(albumsGrid);
        
        mainContent.appendChild(albumsSection);
        
        // Upload progress indicator
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress';
        progressContainer.id = 'upload-progress';
        
        const progressText = document.createElement('div');
        progressText.id = 'progress-text';
        progressText.textContent = 'Uploading photos...';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        
        const progressBarInner = document.createElement('div');
        progressBarInner.className = 'progress-bar-inner';
        progressBarInner.id = 'progress-bar-inner';
        
        progressBar.appendChild(progressBarInner);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBar);
        mainContent.appendChild(progressContainer);
        
        // Gallery container
        const galleryContainer = document.createElement('div');
        galleryContainer.id = 'gallery';
        galleryContainer.className = 'gallery';
        mainContent.appendChild(galleryContainer);
        
        // Lightbox for image viewing
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        
        const lightboxClose = document.createElement('span');
        lightboxClose.className = 'lightbox-close';
        lightboxClose.innerHTML = '&times;';
        
        const lightboxImg = document.createElement('img');
        lightboxImg.className = 'lightbox-img';
        lightboxImg.id = 'lightbox-img';
        lightboxImg.setAttribute('src', '');
        lightboxImg.setAttribute('alt', '');
        
        const lightboxCaption = document.createElement('div');
        lightboxCaption.id = 'lightbox-caption';
        lightboxCaption.className = 'lightbox-caption';
        
        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxImg);
        lightbox.appendChild(lightboxCaption);
        mainContent.appendChild(lightbox);
        
        // Add content to main wrapper
        headerElements.mainWrapper.appendChild(mainContent);
        
        // Load user custom albums from database
        loadUserAlbums().then(() => {
          // If we have an album parameter, show that album immediately
          if (albumParam) {
            const album = getAlbumById(albumParam);
            if (album) {
              viewAlbum(album);
            } else {
              // Album not found, show all albums
              showAlbumsView();
            }
          } else {
            // No album parameter, show the albums view
            showAlbumsView();
          }
        });
        
        // Setup event handlers
        setupEventHandlers();
        
        /**
         * Load user custom albums from database
         */
        async function loadUserAlbums() {
          try {
            // Custom endpoint to get all albums
            const response = await fetch(`${CLOUDFLARE_API}/albums`);
            
            if (!response.ok) {
              throw new Error(`Error fetching albums: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Merge with default albums
            if (data && Array.isArray(data) && data.length > 0) {
              // Filter out any user albums that match the default album IDs
              const userAlbums = data.filter(album => 
                !defaultAlbums.some(defaultAlbum => defaultAlbum.id === album.id)
              );
              
              // Update default albums with counts from API if provided
              defaultAlbums = defaultAlbums.map(defaultAlbum => {
                const apiAlbum = data.find(a => a.id === defaultAlbum.id);
                if (apiAlbum && apiAlbum.count !== undefined) {
                  return {
                    ...defaultAlbum,
                    count: apiAlbum.count
                  };
                }
                return defaultAlbum;
              });
              
              // Combine default and user albums
              const allAlbums = [...defaultAlbums, ...userAlbums];
              
              // Update the albums drop-down selector
              const albumSelector = document.getElementById('upload-album-selector');
              if (albumSelector) {
                // Clear existing options
                while (albumSelector.options.length > 1) {
                  albumSelector.remove(1);
                }
                
                // Add all albums except 'All Photos'
                allAlbums.filter(album => album.id !== 'all').forEach(album => {
                  const option = document.createElement('option');
                  option.value = album.id;
                  option.textContent = album.title;
                  albumSelector.appendChild(option);
                });
              }
              
              console.log("Loaded albums:", allAlbums);
              return allAlbums;
            }
            
            return defaultAlbums;
          } catch (err) {
            console.error('Error loading albums:', err);
            return defaultAlbums;
          }
        }
        
        /**
         * Create filter/search bar
         */
        function createFilterBar() {
          const filterBar = document.createElement('div');
          filterBar.className = 'filter-bar';
          
          // Search
          const searchContainer = document.createElement('div');
          searchContainer.className = 'search-container';
          
          const searchIcon = document.createElement('span');
          searchIcon.className = 'search-icon';
          searchIcon.innerHTML = 'ðŸ”';
          
          const searchInput = document.createElement('input');
          searchInput.type = 'text';
          searchInput.className = 'search-input';
          searchInput.placeholder = 'Search gallery...';
          searchInput.id = 'gallery-search';
          
          searchContainer.appendChild(searchIcon);
          searchContainer.appendChild(searchInput);
          
          // Sort
          const sortContainer = document.createElement('div');
          sortContainer.className = 'sort-container';
          
          const sortLabel = document.createElement('span');
          sortLabel.className = 'sort-label';
          sortLabel.textContent = 'Sort by:';
          
          const sortSelect = document.createElement('select');
          sortSelect.className = 'sort-select';
          sortSelect.id = 'gallery-sort';
          
          const sortOptions = [
            { value: 'newest', text: 'Newest first' },
            { value: 'oldest', text: 'Oldest first' },
            { value: 'name', text: 'Name (A-Z)' }
          ];
          
          sortOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            sortSelect.appendChild(optionEl);
          });
          
          sortContainer.appendChild(sortLabel);
          sortContainer.appendChild(sortSelect);
          
          filterBar.appendChild(searchContainer);
          filterBar.appendChild(sortContainer);
          
          return filterBar;
        }
        
        /**
         * Load and render all albums
         */
        async function showAlbumsView() {
          // Update current view
          currentAlbumId = 'all';
          
          // Update URL without reloading page
          const url = new URL(window.location);
          url.searchParams.delete('album');
          window.history.pushState({}, '', url);
          
          // Update page title
          const galleryTitle = document.getElementById('gallery-title');
          if (galleryTitle) {
            galleryTitle.textContent = 'Photo Gallery';
          }
          
          // Hide back button and album selection in upload
          const backButton = document.getElementById('back-to-albums');
          if (backButton) {
            backButton.style.display = 'none';
          }
          
          // Hide upload album section for selection
          const uploadAlbumSection = document.querySelector('.upload-album-section');
          if (uploadAlbumSection) {
            uploadAlbumSection.style.display = 'none';
          }
          
          // Show albums section
          const albumsSection = document.getElementById('albums-section');
          if (albumsSection) {
            albumsSection.style.display = 'block';
          }
          
          // Hide the gallery
          const galleryContainer = document.getElementById('gallery');
          if (galleryContainer) {
            galleryContainer.style.display = 'none';
          }
          
          // Reload albums
          const albums = await loadUserAlbums();
          
          // Render albums
          renderAlbums(albums);
        }
        
        /**
         * Render all albums in the grid
         * @param {Array} albums - Array of album objects
         */
        function renderAlbums(albums) {
          const albumsGrid = document.getElementById('albums-grid');
          if (!albumsGrid) return;
          
          // Clear existing albums
          albumsGrid.innerHTML = '';
          
          albums.forEach(album => {
            const albumCard = document.createElement('div');
            albumCard.className = 'album-card';
            albumCard.dataset.albumId = album.id;
            
            const albumThumb = document.createElement('div');
            albumThumb.className = 'album-thumbnail';
            
            // Use thumbnail if provided, otherwise use a placeholder
            if (album.thumbnail) {
              albumThumb.style.backgroundImage = `url('${album.thumbnail}')`;
            } else {
              albumThumb.style.backgroundColor = '#e9ecef';
              // Add a placeholder icon
              const placeholderIcon = document.createElement('div');
              placeholderIcon.style.position = 'absolute';
              placeholderIcon.style.top = '50%';
              placeholderIcon.style.left = '50%';
              placeholderIcon.style.transform = 'translate(-50%, -50%)';
              placeholderIcon.style.fontSize = '3rem';
              placeholderIcon.innerHTML = 'ðŸ“·';
              albumThumb.appendChild(placeholderIcon);
            }
            
            // Album actions for admins
            if (BBB_AUTH.hasRole('admin') && !album.default) {
              const albumActions = document.createElement('div');
              albumActions.className = 'album-actions';
              
              const editBtn = document.createElement('button');
              editBtn.className = 'album-action-btn';
              editBtn.innerHTML = 'âœï¸';
              editBtn.title = 'Edit Album';
              editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // TODO: Implement edit album functionality
                alert('Edit album functionality coming soon!');
              });
              
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'album-action-btn delete-album-btn';
              deleteBtn.innerHTML = 'ðŸ—‘ï¸';
              deleteBtn.title = 'Delete Album';
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteAlbum(album.id);
              });
              
              albumActions.appendChild(editBtn);
              albumActions.appendChild(deleteBtn);
              albumThumb.appendChild(albumActions);
            }
            
            const albumInfo = document.createElement('div');
            albumInfo.className = 'album-info';
            
            const albumTitle = document.createElement('div');
            albumTitle.className = 'album-title';
            albumTitle.textContent = album.title;
            
            const albumCount = document.createElement('div');
            albumCount.className = 'album-count';
            albumCount.textContent = album.count === undefined ? 'Loading...' : 
                                    album.count === 0 ? 'No photos' : 
                                    `${album.count} photo${album.count !== 1 ? 's' : ''}`;
            
            albumInfo.appendChild(albumTitle);
            albumInfo.appendChild(albumCount);
            
            albumCard.appendChild(albumThumb);
            albumCard.appendChild(albumInfo);
            
            // Add click handler to view album
            albumCard.addEventListener('click', () => {
              viewAlbum(album);
            });
            
            albumsGrid.appendChild(albumCard);
          });
        }
        
        /**
         * View a specific album
         * @param {Object} album - Album object
         */
        function viewAlbum(album) {
          // Update current album
          currentAlbumId = album.id;
          
          // Update URL without reloading page
          const url = new URL(window.location);
          url.searchParams.set('album', album.id);
          window.history.pushState({}, '', url);
          
          // Update page title
          const galleryTitle = document.getElementById('gallery-title');
          if (galleryTitle) {
            galleryTitle.textContent = `Photo Gallery - ${album.title}`;
          }
          
          // Show back button
          const backButton = document.getElementById('back-to-albums');
          if (backButton) {
            backButton.style.display = 'inline-block';
          }
          
          // Update album selector in upload section
          const albumSelector = document.getElementById('upload-album-selector');
          if (albumSelector) {
            // Select current album
            for (let i = 0; i < albumSelector.options.length; i++) {
              if (albumSelector.options[i].value === album.id) {
                albumSelector.selectedIndex = i;
                break;
              }
            }
          }
          
          // Show upload album section
          const uploadAlbumSection = document.querySelector('.upload-album-section');
          if (uploadAlbumSection) {
            uploadAlbumSection.style.display = album.id === 'all' ? 'none' : 'flex';
          }
          
          // Hide albums section
          const albumsSection = document.getElementById('albums-section');
          if (albumsSection) {
            albumsSection.style.display = 'none';
          }
          
          // Show the gallery
          const galleryContainer = document.getElementById('gallery');
          if (galleryContainer) {
            galleryContainer.style.display = 'grid';
          }
          
          // Load images for this album
          loadGalleryImages(album.id);
        }
        
        /**
         * Load gallery images from Cloudflare
         * @param {string} albumId - Album ID to load images for (optional, defaults to currentAlbumId)
         */
        function loadGalleryImages(albumId = currentAlbumId) {
          BBB_UTILS.showMessage('Loading gallery images...', 'info');
          
          // Check sort and search options
          const sortSelect = document.getElementById('gallery-sort');
          const searchInput = document.getElementById('gallery-search');
          
          const sortValue = sortSelect ? sortSelect.value : 'newest';
          const searchValue = searchInput ? searchInput.value.trim() : '';
          
          // Build the API URL with any search parameters
          let apiUrl = `${CLOUDFLARE_API}/images`;
          
          // Add query parameters
          const params = new URLSearchParams();
          
          if (searchValue) {
            params.append('search', searchValue);
          }
          
          if (albumId && albumId !== 'all') {
            params.append('album', albumId);
          }
          
          params.append('sort', sortValue);
          
          // Add params to URL if we have any
          if (params.toString()) {
            apiUrl += `?${params.toString()}`;
          }
          
          // Fetch from Cloudflare
          fetch(apiUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error fetching gallery: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // Convert to our format
              const images = data.map(img => ({
                id: img.id,
                src: `${CLOUDFLARE_API}/image/${img.id}`,
                alt: img.alt || 'Gallery image',
                uploadedAt: img.uploaded_at,
                uploadedBy: img.uploaded_by,
                album: img.album
              }));
              
              // Sort images
              if (sortValue === 'oldest') {
                images.sort((a, b) => new Date(a.uploadedAt) - new Date(b.uploadedAt));
              } else if (sortValue === 'name') {
                images.sort((a, b) => a.alt.localeCompare(b.alt));
              } else {
                // Default: newest first
                images.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
              }
              
              // Render gallery
              renderGallery(images);
              
              // Hide loading message
              BBB_UTILS.showMessage('', 'info');
            })
            .catch(err => {
              console.error('Error loading gallery images:', err);
              BBB_UTILS.showMessage('Error loading gallery images', 'error');
              
              // Show fallback gallery with preloaded images
              const preloadedImages = [
                { id: 'pre_1', src: 'images/photo1.jpg', alt: 'Band on the green' },
                { id: 'pre_2', src: 'images/photo2.jpg', alt: 'Group shot' },
                { id: 'pre_3', src: 'images/photo3.jpg', alt: 'Trophy presentation' },
                { id: 'pre_4', src: 'images/photo4.jpg', alt: 'Action shot' }
              ];
              
              renderGallery(preloadedImages);
            });
            
          // Check if we need to migrate images from localStorage
          checkMigrationNeeded();
        }
        
        /**
         * Render gallery with images
         * @param {Array} images - Array of image objects
         */
        function renderGallery(images) {
          const galleryElement = document.getElementById('gallery');
          galleryElement.innerHTML = '';
          
          // Create gallery
          images.forEach(image => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'gallery-img-container';
            imgContainer.dataset.id = image.id;
            
            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || 'Gallery image';
            img.className = 'gallery-img';
            img.setAttribute('loading', 'lazy'); // Add lazy loading
            
            // Add timestamp info
            const imageInfo = document.createElement('div');
            imageInfo.className = 'image-info';
            
            let uploadDate = 'Unknown date';
            if (image.uploadedAt) {
              uploadDate = new Date(image.uploadedAt).toLocaleDateString();
            }
            
            imageInfo.textContent = uploadDate;
            
            // Add action buttons
            const imageActions = document.createElement('div');
            imageActions.className = 'image-actions';
            
            // View button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'image-action-btn view-btn';
            viewBtn.innerHTML = 'ðŸ‘ï¸ View';
            viewBtn.addEventListener('click', () => {
              openLightbox(img);
            });
            
            // Delete button (only show if admin or image was uploaded by current user)
            const canDelete = BBB_AUTH.hasRole('admin') || 
                            (image.uploadedBy && BBB_AUTH.currentUser && 
                             image.uploadedBy === BBB_AUTH.currentUser.id);
            
            if (canDelete) {
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'image-action-btn delete-btn';
              deleteBtn.innerHTML = 'ðŸ—‘ï¸ Delete';
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent lightbox
                deleteImage(image.id);
              });
              imageActions.appendChild(deleteBtn);
            }
            
            imageActions.appendChild(viewBtn);
            
            // Add click handler for lightbox
            img.addEventListener('click', () => {
              openLightbox(img);
            });
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(imageInfo);
            imgContainer.appendChild(imageActions);
            
            galleryElement.appendChild(imgContainer);
          });
          
          // If no images, show message
          if (images.length === 0) {
            const noImages = document.createElement('div');
            noImages.className = 'empty-gallery';
            
            const noImagesIcon = document.createElement('div');
            noImagesIcon.innerHTML = 'ðŸ“·';
            noImagesIcon.style.fontSize = '3rem';
            noImagesIcon.style.marginBottom = '1rem';
            
            const noImagesText = document.createElement('p');
            noImagesText.textContent = 'No images in this album. Upload some photos or select a different album.';
            
            noImages.appendChild(noImagesIcon);
            noImages.appendChild(noImagesText);
            galleryElement.appendChild(noImages);
          }
          
          // Update album count in the database
          updateAlbumCount(currentAlbumId, images.length);
        }
        
        /**
         * Update album count in the database
         * @param {string} albumId - Album ID
         * @param {number} count - New count
         */
        function updateAlbumCount(albumId, count) {
          if (albumId === 'all') return; // Don't update count for 'all' album
          
          // Find the album in our array
          const album = getAlbumById(albumId);
          if (album) {
            album.count = count;
          }
          
          // TODO: Update album count on server if needed
        }
        
        /**
         * Get album by ID
         * @param {string} albumId - Album ID
         * @returns {Object|null} - Album object or null if not found
         */
        function getAlbumById(albumId) {
          // Check default albums first
          const defaultAlbum = defaultAlbums.find(a => a.id === albumId);
          if (defaultAlbum) return defaultAlbum;
          
          // TODO: Check custom albums if not found in defaults
          return null;
        }
        
        /**
         * Setup event handlers for gallery
         */
        function setupEventHandlers() {
          // Upload handler
          const uploadInput = document.getElementById('image-upload');
          uploadInput.addEventListener('change', handleImageUpload);
          
          // Search handler
          const searchInput = document.getElementById('gallery-search');
          searchInput.addEventListener('input', debounce(() => {
            loadGalleryImages();
          }, 500));
          
          // Sort handler
          const sortSelect = document.getElementById('gallery-sort');
          sortSelect.addEventListener('change', () => {
            loadGalleryImages();
          });
          
          // Album selector handler
          const albumSelector = document.getElementById('upload-album-selector');
          albumSelector.addEventListener('change', () => {
            // If an album is selected, update the current album
            if (albumSelector.value) {
              const album = getAlbumById(albumSelector.value);
              if (album) {
                viewAlbum(album);
              }
            }
          });
          
          // Lightbox close
          const lightboxClose = document.querySelector('.lightbox-close');
          lightboxClose.addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'none';
          });
          
          // Click outside lightbox to close
          document.getElementById('lightbox').addEventListener('click', e => {
            if (e.target === document.getElementById('lightbox')) {
              document.getElementById('lightbox').style.display = 'none';
            }
          });
          
          // ESC key to close lightbox
          document.addEventListener('keyup', e => {
            if (e.key === 'Escape') {
              document.getElementById('lightbox').style.display = 'none';
            }
          });
          
          // Modal close buttons
          const modalCloseButtons = document.querySelectorAll('.modal-close, #cancel-add-album');
          modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
              document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
              });
            });
          });
          
          // Add album form handler
          const addAlbumForm = document.getElementById('add-album-form');
          addAlbumForm.addEventListener('submit', handleAddAlbum);
        }
        
        /**
         * Debounce function to limit execution frequency
         * @param {Function} func - Function to debounce
         * @param {number} delay - Delay in milliseconds
         * @returns {Function} - Debounced function
         */
        function debounce(func, delay = 300) {
          let timerId;
          return function(...args) {
            clearTimeout(timerId);
            timerId = setTimeout(() => {
              func.apply(this, args);
            }, delay);
          };
        }
        
        /**
         * Open lightbox with image
         * @param {HTMLElement} img - Image element to show in lightbox
         */
        function openLightbox(img) {
          const lightbox = document.getElementById('lightbox');
          const lightboxImg = document.getElementById('lightbox-img');
          const lightboxCaption = document.getElementById('lightbox-caption');
          
          lightboxImg.src = img.src;
          lightboxCaption.textContent = img.alt;
          lightbox.style.display = 'flex';
        }
        
        /**
         * Show the add album modal
         */
        function showAddAlbumModal() {
          const modal = document.getElementById('add-album-modal');
          modal.style.display = 'flex';
          
          // Focus album name input
          setTimeout(() => {
            document.getElementById('album-name').focus();
          }, 100);
        }
        
        /**
         * Handle adding a new album
         * @param {Event} e - Form submit event
         */
        function handleAddAlbum(e) {
          e.preventDefault();
          
          const nameInput = document.getElementById('album-name');
          const descInput = document.getElementById('album-description');
          
          const name = nameInput.value.trim();
          const description = descInput.value.trim();
          
          if (!name) {
            BBB_UTILS.showMessage('Please enter an album name', 'error');
            return;
          }
          
          // Generate an ID from the name
          const id = 'album_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
          
          // Album data
          const albumData = {
            id,
            title: name,
            description,
            count: 0,
            created_at: new Date().toISOString(),
            created_by: BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'anonymous'
          };
          
          // Show loading message
          BBB_UTILS.showMessage('Creating album...', 'info');
          
          // Send to server
          fetch(`${CLOUDFLARE_API}/albums`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(albumData)
          })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error creating album: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // Add to our albums list
              defaultAlbums.push({
                ...albumData,
                default: false
              });
              
              // Close modal
              document.getElementById('add-album-modal').style.display = 'none';
              
              // Clear form
              nameInput.value = '';
              descInput.value = '';
              
              // Show success message
              BBB_UTILS.showMessage('Album created successfully!', 'success');
              
              // Reload albums view
              showAlbumsView();
            })
            .catch(err => {
              console.error('Error creating album:', err);
              BBB_UTILS.showMessage(`Error creating album: ${err.message}`, 'error');
            });
        }
        
        /**
         * Delete an album
         * @param {string} albumId - Album ID to delete
         */
        function deleteAlbum(albumId) {
          if (!confirm('Are you sure you want to delete this album? All images in the album will remain in the gallery.')) {
            return;
          }
          
          // Cannot delete default albums
          if (defaultAlbums.some(a => a.id === albumId && a.default)) {
            BBB_UTILS.showMessage('Cannot delete default albums', 'error');
            return;
          }
          
          BBB_UTILS.showMessage('Deleting album...', 'info');
          
          // Send delete request to server
          fetch(`${CLOUDFLARE_API}/albums/${albumId}`, {
            method: 'DELETE'
          })
            .then(response => {
              if (!response.ok) {
                throw new Error(`Error deleting album: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              // Remove from our albums list
              defaultAlbums = defaultAlbums.filter(a => a.id !== albumId);
              
              // Show success message
              BBB_UTILS.showMessage('Album deleted successfully!', 'success');
              
              // Reload albums view
              showAlbumsView();
            })
            .catch(err => {
              console.error('Error deleting album:', err);
              BBB_UTILS.showMessage(`Error deleting album: ${err.message}`, 'error');
            });
        }

        /**
         * Delete an image
         * @param {string} imageId - Image ID to delete
         */
        function deleteImage(imageId) {
          if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
            return;
          }
          
          BBB_UTILS.showMessage('Deleting image...', 'info');
          
          // For debugging
          console.log("Attempting to delete image:", imageId);
          console.log("Delete URL:", `${CLOUDFLARE_API}/images/${imageId}`);
          
          // FIXED: Changed the delete URL format to use images/[id] instead of delete/[id]
          fetch(`${CLOUDFLARE_API}/images/${imageId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => {
              console.log("Delete response status:", response.status);
              if (!response.ok) {
                throw new Error(`Error deleting image: ${response.status} ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              console.log("Delete response data:", data);
              if (data.success) {
                BBB_UTILS.showMessage('Image deleted successfully', 'success');
                
                // Remove image from DOM
                const imgContainer = document.querySelector(`.gallery-img-container[data-id="${imageId}"]`);
                if (imgContainer) {
                  imgContainer.remove();
                }
                
                // Reload gallery if needed
                if (document.querySelectorAll('.gallery-img-container').length === 0) {
                  loadGalleryImages();
                }
                
                // If we're viewing an album, update its count
                if (currentAlbumId !== 'all') {
                  const remainingImages = document.querySelectorAll('.gallery-img-container').length;
                  updateAlbumCount(currentAlbumId, remainingImages);
                }
              } else {
                BBB_UTILS.showMessage(`Error deleting image: ${data.error || 'Unknown error'}`, 'error');
              }
            })
            .catch(err => {
              console.error('Error deleting image:', err);
              BBB_UTILS.showMessage(`Error deleting image: ${err.message}`, 'error');
            });
        }
        
        /**
         * Handle image upload
         * @param {Event} e - Change event
         */
        function handleImageUpload(e) {
          const files = Array.from(e.target.files);
          
          if (files.length === 0) {
            return;
          }
          
          // Determine album to upload to
          let targetAlbum = null;
          
          // If we're viewing an album, use that
          if (currentAlbumId !== 'all') {
            targetAlbum = currentAlbumId;
          } else {
            // Check if an album is selected in the dropdown
            const albumSelector = document.getElementById('upload-album-selector');
            if (albumSelector && albumSelector.value) {
              targetAlbum = albumSelector.value;
            }
          }
          
          // Show progress container
          const progressContainer = document.getElementById('upload-progress');
          const progressBarInner = document.getElementById('progress-bar-inner');
          const progressText = document.getElementById('progress-text');
          
          progressContainer.style.display = 'block';
          progressBarInner.style.width = '0%';
          progressText.textContent = `Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...`;
          
          let uploadedCount = 0;
          const failedUploads = [];
          
          // Get current user if available
          const username = BBB_AUTH.currentUser ? BBB_AUTH.currentUser.id : 'anonymous';
          
          // Process each file
          files.forEach((file, index) => {
            // Validate file type
            if (!file.type.startsWith('image/')) {
              failedUploads.push({ file, error: 'Not an image file' });
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              return;
            }
            
            // Validate file size
            if (file.size > BBB_CONFIG.gallery.maxUploadSize) {
              failedUploads.push({ 
                file, 
                error: `File too large (max ${BBB_CONFIG.gallery.maxUploadSize / 1000000}MB)` 
              });
              updateUploadProgress(files.length, uploadedCount + failedUploads.length);
              return;
            }
            
            // Create form data for upload
            const formData = new FormData();
            formData.append('image', file);
            formData.append('alt', file.name.replace(/\.[^/.]+$/, '') || 'User uploaded photo');
            formData.append('username', username);
            
            // Add album if specified
            if (targetAlbum) {
              formData.append('album', targetAlbum);
            }
            
            // Upload to Cloudflare Worker
            fetch(`${CLOUDFLARE_API}/images`, {
              method: 'POST',
              body: formData
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Upload failed: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  uploadedCount++;
                } else {
                  failedUploads.push({ file, error: data.error || 'Upload failed' });
                }
                
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
                  finishUploads();
                }
              finishUploads();
                }
              })
              .catch(err => {
                console.error('Error uploading image:', err);
                failedUploads.push({ file, error: 'Failed to upload' });
                updateUploadProgress(files.length, uploadedCount + failedUploads.length);
                
                // Check if all uploads complete
                if (uploadedCount + failedUploads.length === files.length) {
